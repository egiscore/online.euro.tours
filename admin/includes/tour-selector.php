<?php
 class TourSelector { public $id = null; public $name = null; public $selected = null; public $class = 'element'; public $emptyVal = false; public $condition = false; public $lang = 'rus'; public function __construct($id, $name) { $this->id = $id; $this->name = $name; } public function render() { $titleField = $this->lang == 'rus' ? 'Name' : 'LName'; $tours = $this->getTours(); $html = "<select id='{$this->id}' name='{$this->name}' class='{$this->class}'>"; if ($this->emptyVal) { $html .= "<option value='{$this->emptyVal['value']}'>{$this->emptyVal['text']}</option>"; } if ($tours) { foreach ($tours as $tour) { if (!$tour['Visible'] && !Samo_Request::get('showAllTours')) { continue; } $selected = ($tour['TourInc'] == $this->selected) ? ' selected ' : ''; $html .= "<option value='{$tour['TourInc']}' {$selected}>{$tour['Tour'.$titleField]}</option>"; } } $html .= "</select>"; echo $html; } private function getTours() { $db = Samo_Registry::get('db'); $sql = 'exec ' . OFFICE_SQLSERVER . '.' . OFFICEDB . ".dbo.sp_executesql N'
        SELECT t.[name] AS [TourName], t.[lname] AS [TourLName], t.[Inc] AS [TourInc], [sale] AS [Visible]  
                FROM [dbo].[tour] t WHERE t.[inc] > 2"; if ($this->condition) { $sql .= " AND " . implode(' AND ', $this->condition); } $sql .= " ORDER BY [TourLName]'"; $result = $db->fetchAll($sql); if (!is_array($result) || !count($result)) { return false; } return $result; } } 