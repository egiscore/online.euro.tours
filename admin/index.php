<?php
 try { include_once '../properties.php'; ini_set('display_errors', 1); error_reporting(E_ALL); $cookie_path = defined('COOKIE_PATH') ? COOKIE_PATH : WWWROOT; ini_set('session.cookie_path', $cookie_path); ini_set('session.cookie_domain', COOKIE_DOMAIN); session_name(SESSION_NAME); session_start(); ob_start(); include_once _ROOT . 'admin/include.php'; include_once _ROOT . 'admin/includes/site/function.php'; include_once _ROOT . '/includes/admin.php'; set_time_limit(0); if (isset($_SESSION['samo_admin']) && isset($_SESSION['samo_admin']['LNG'])) { $LNG = $_SESSION['samo_admin']['LNG']; } else { $LNG = Samo_Request::lang(); } if (!in_array($LNG, array('rus', 'eng'))) { $LNG = 'rus'; } $language = array(); $dirname = _ROOT . 'admin/includes/lang'; include _ROOT . 'admin/includes/site/load_messages.php'; include_once _ROOT . 'admin/includes/functions.php'; $modules = array(); include_once _ROOT . 'admin/properties.php'; Samo_Datetime::lang($LNG); include_once _ROOT . 'admin/includes/site/classes/mssql/query.php'; $connected = false; $db = db_connect(null, null); try { $connected = $db->fetchOne("SELECT 1 AS connected"); } catch (DatabaseServer_Exception $e) { $e; } if (!$connected) { $db = find_available_server(); } if (!$db) { throw new RuntimeException('Database unavailable'); } $sql = 'SET CONCAT_NULL_YIELDS_NULL ON; SET ANSI_NULLS ON; SET ARITHABORT ON; SET ANSI_WARNINGS ON; SET ANSI_PADDING ON; SET IMPLICIT_TRANSACTIONS OFF;'; $db->query($sql); $SESSION = session_id(); if (isset($_GET['logout'])) { $_SESSION['samo_admin'] = null; session_write_close(); $sql = "EXEC " . OFFICE_SQLSERVER . "." . OFFICEDB . ".dbo.sp_executesql N'DELETE FROM [dbo].[online_user_session] WHERE [session] = @session', N'@session varchar(64)', " . $db->quote($SESSION); $db->query($sql); header('Location: ' . Samo_Url::route('admin'), true, 301); exit; } $FILE_INCLUDE = ''; $USER = 0; function get_sessionid_check($s) { $USER = &$GLOBALS['USER']; $db = Samo_Registry::get('db'); $sql = "EXEC " . OFFICE_SQLSERVER . "." . OFFICEDB . ".dbo.sp_executesql N'SELECT [Inc], [User] FROM [dbo].[online_user_session] WHERE [session] = @session', N'@session varchar(64)', " . $db->quote($s); if ($row = $db->fetchOneRow($sql)) { $USER = $row['User']; return $row['Inc']; } return ''; } if (get_sessionid_check($SESSION) == '') { include _ROOT . 'admin/home.php'; exit; } $sessCheck = checksession(); $USER = $sessCheck['Inc']; $USER_IS_ADMIN = $sessCheck['Admin']; $USER_NAME = $sessCheck['Name']; $_ACCESS = 0; if (substr($ALIAS, 0, 13) == 'set_rule_for_') { $alias_rule_module = substr($ALIAS, 13); extract($_POST); $ADD = $_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['ADD']) && $_POST['ADD'] == 1 ? 1 : 0; $EDIT = $_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['EDIT']) && $_POST['EDIT'] == 1 ? 1 : 0; $DELETE = $_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['DELETE']) && $_POST['DELETE'] == 1 ? 1 : 0; $SAVE = $_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['SAVE']) && $_POST['SAVE'] == 1 ? 1 : 0; $sql = $db->formatQuery($query['get_module_param'], array($alias_rule_module)); if (false !== ($res = $db->fetchAll($sql)) && count($res) == 1) { $row = $res[0]; $module_row = $row; $module_alias = $alias_rule_module; $dirname = _ROOT . 'admin/modules/' . $row['Path'] . '/lang'; include _ROOT . 'admin/includes/site/load_messages.php'; $FILE_INCLUDE = _ROOT . 'admin/editors/admin_rule.php'; } } else if (substr($ALIAS, 0, 10) == 'admin_for_') { $alias_rule_module = substr($ALIAS, 10); $_ACCESS = get_module_permission($alias_rule_module); $sql = $db->formatQuery($query['get_module_param'], array($alias_rule_module)); $module = $db->fetchRow($sql); $dirname = _ROOT . 'admin/modules/' . $module['Path'] . '/lang'; include _ROOT . 'admin/includes/site/load_messages.php'; $FILE_INCLUDE = _ROOT . 'admin/modules/' . $module['Path'] . '/' . $module['File_Include'] . '.php'; } else { $alias_rule_module = $ALIAS; switch ($ALIAS) { case 'home': case 'top_frame': case 'left_frame': case 'center_frame': if ($ALIAS !== 'home') { session_write_close(); } $FILE_INCLUDE = _ROOT . 'admin/' . $ALIAS . '.php'; break; case 'install_update': case 'managers': case 'system_status': $FILE_INCLUDE = _ROOT . 'admin/editors/' . $ALIAS . '.php'; break; case 'managers_rules': $FILE_INCLUDE = _ROOT . 'admin/editors/select_element.php'; break; case 'empty': $FILE_INCLUDE = _ROOT . 'admin/files/empty.php'; break; default: $sql = $db->formatQuery($query['get_module_param'], array($ALIAS)); $qres = $db->query($sql); if (1 == $db->numRows($qres)) { $row = $db->fetchRow(); $dirname = _ROOT . 'admin/modules/' . $row['Path'] . '/lang'; include _ROOT . 'admin/includes/site/load_messages.php'; $FILE_INCLUDE = _ROOT . 'admin/modules/' . $row['Path'] . '/' . $row['File_Include']; } else { echo Get_Message_Lang($LNG, 'page_not_found') . '<br>'; } break; } } if (!defined('INTERNET_USER')) { define('INTERNET_USER_UNDEFINED', true); $sql = $db->formatExec( OFFICE_SQLSERVER . '.' . OFFICEDB . '.dbo.up_WEB_3_default_usercode' ); $INTERNET_USER = $db->fetchOne($sql); define('INTERNET_USER', $INTERNET_USER); } if (INTERNET_USER === false && !in_array($ALIAS, ['home', 'top_frame', 'left_frame'])) { $dirname = _ROOT . 'admin/modules/config/lang'; include _ROOT . 'admin/includes/site/load_messages.php'; $FILE_INCLUDE = _ROOT . 'admin/modules/config/configuration.php'; } if (isset($FILE_INCLUDE) && file_exists($FILE_INCLUDE)) { include_once $FILE_INCLUDE; } else { echo Get_Message_Lang($LNG, 'module_file_not_found') . '<br>'; } } catch (Exception $e) { if (DEBUG) { $output = '[' . get_class($e) . "] " . $e->getMessage() . " [FILE= " . basename($e->getFile()) . ':' . $e->getLine() . ']' . PHP_EOL . $e->getTraceAsString(); } else { $message = ($e instanceof Samo_Exception) ? $e->getMessage() : 'mailto:' . FIRM_ADMIN_EMAIL; $output = 'Internal server error (' . $message . ')'; } echo $output; } if (DEBUG) { echo Samo_Registry::get('response')->output(); } 