<?php
include dirname(__FILE__) . '/properties.php'; if (!defined('ROUTES_PATH')) { define('ROUTES_PATH', _ROOT . 'routes.php'); } include ROUTES_PATH; try { include _ROOT . '/includes/common.php'; if (isset($_GET['page']) && strpos($_GET['page'], 'services/') !== false) { $_GET['_url'] = str_replace('services/', '/', $_GET['page']); $_SERVER['PHP_SELF'] = '/services/public/default.php'; unset($_GET['page']); return include _ROOT . 'services/public/default.php'; } $module = (isset($_GET['page']) && ($temp = explode('/', $_GET['page']))) ? $temp[0] : ((!isset($_GET['page'])) ? 'menu' : false); if ($module && !isset($routes[$module])) { $tmp = parse_url(Samo_Request::uri()); if (isset($tmp['path']) && !empty($tmp['path'])) { foreach ($routes as $_mod => $route) { if (isset($route['url']) && $route['url'] == $tmp['path']) { $module = $_mod; break; } } } } if (isset($routes[$module])) { Samo_Registry::set('module', $routes[$module]); if ($module != 'menu') { include _ROOT . '/includes/db.php'; try { db_connect($TOWNFROMINC, $STATEINC); } catch (Database_Exception $e) { throw new Samo_Exception($e->getMessage()); } } } else { Samo_Registry::get('response')->not_found(); } $module = Samo_Registry::get('module'); do { $try_again = false; $action = (isset($_GET['samo_action'])) ? $_GET['samo_action'] : 'default_action'; try { Samo_Loader::load_object(ucwords($module['controller'], '_')); Samo_Debug_Helper::proctitle($module['module'] . '::' . $action); $controller = Samo_Registry::get('controller'); if (method_exists($controller, $action)) { call_user_func(array($controller, $action)); } elseif (method_exists($controller, 'samo_action')) { call_user_func_array(array($controller, 'samo_action'), array($action)); } else { Samo_Registry::get('response')->not_found(); } } catch (Redirect_Exception $e) { echo $e; } catch (DatabaseServer_Exception $e) { $state = Samo_Request::get('STATEINC'); $townFrom = Samo_Request::get('TOWNFROMINC'); $controller = Samo_Registry::get('controller'); $requestedGeo = $state || $townFrom; if ($requestedGeo || null === $controller->model || !method_exists($controller->model, 'find_available_server') || !$controller->model->find_available_server()) { if ($requestedGeo) { $controller->warn_unavailable_direction(true); } if ($action == 'default_action' || $action == 'embed') { $controller->empty_form(true); } } else { $try_again = true; } } } while ($try_again == true); $controller->before_output(); Samo_Registry::get('response')->output(); $controller->after_output(); } catch (Samo_Exception $e) { try { $response = Samo_Registry::get('response'); $message = $e->getMessage(); if (DEBUG && 'dev' === APPMODE) { $exception_type = get_class($e); if ('Database_Exception' == $exception_type) { $message .= " [SQL= " . $e->getSql() . "] [Server=" . $e->getServer() . ']'; } $message = '[' . get_class($e) . "] " . $message . " [FILE= " . basename($e->getFile()) . ':' . $e->getLine() . ']' . PHP_EOL . $e->getTraceAsString(); } $view = Samo_Registry::get('view'); $view->error($message); } catch (Exception $e) { if (DEBUG && 'dev' === APPMODE) { $output = '[' . get_class($e) . "] " . $e->getMessage() . " [FILE= " . basename($e->getFile()) . ':' . $e->getLine() . ']' . PHP_EOL . $e->getTraceAsString(); } else { $message = ($e instanceof E_USER_ERROR) ? $e->getMessage() : 'mailto:' . FIRM_ADMIN_EMAIL; $output = 'Internal server error (' . $message . ')'; } throw new Samo_Exception($output); } } catch (Exception $e) { $message = 'mailto:' . FIRM_ADMIN_EMAIL; if (DEBUG) { $message = $e->getMessage(); } $output = 'Internal server error (' . $message . ')'; echo $output; } Samo_Registry::get('response')->finish(); 