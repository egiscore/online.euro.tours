<?php
if (!defined('ROUTES_PATH')) { define('ROUTES_PATH', _ROOT . 'routes.php'); } include_once ROUTES_PATH; include_once _ROOT . '/includes/common.php'; $registry = Samo_Registry::instance(); if (isset($registry['_POST'])) { $_POST = Samo_Registry::get('_POST'); } include_once _ROOT . '/includes/db.php'; function loadVarsForTemplate($module, $action, $env) { define('SAMO_REQUEST_DONT_FINISH', true); invokeModuleAction($module, $action, $env); $vars = Samo_Registry::get('view')->get_template_vars(); unset( $vars['logged'], $vars['SCRIPT_NAME'], $vars['WWWROOT'], $vars['routes'], $vars['content_for_layout'], $vars['UnreadMessages'], $vars['csrf_token'], $vars['error'], $vars['CURRENT_MODULE'] ); $result = array(); $date_fields = array('DateBeg', 'DateEnd', 'Born', 'PValid', 'ddate', 'PWhen'); ksort($vars); foreach ($vars as $name => $value) { if ($value !== false) { if (is_array($value) && count($value)) { $keys = array_keys($value); $values = (is_int($keys[0])) ? array_keys($value[$keys[0]]) : array_keys($value); $prefix = strtolower(preg_replace('~s$~', '', $name)) . '.'; } else { $prefix = ''; $values = array($name); } foreach ($values as $name) { if (in_array($name, $date_fields)) { $name .= '|date_format'; } $result[] = '$' . $prefix . $name; } } } foreach ($result as $opt) { $options[] = "<option value='" . $opt . "'>" . $opt . "</option>"; } return implode('', $options); } function fakeAuth($env, $module) { $return = array( 'samo_auth' => array( 'PartPassInc' => Samo::MAXLONGINT, 'Partner' => $env['PARTNER'], 'PARTNERGROUP' => Samo::MAXLONGINT, 'OfficialName' => 'admin_site_stub', 'Parttype' => 1, 'ParttypeName' => 'admin_site_stub', 'Administrator' => 1, 'type' => 'agency', 'permissions' => array( $module => 1, ), ) ); if (isset($env['CLAIM'])) { $storage = Samo_Registry::instance(); $claimInfo = (isset($storage['claimInfo'])) ? $storage['claimInfo'] : array(); $storage['claimInfo'] = $claimInfo; } return $return; } function invokeModuleAction($module, $action, $env) { $TOWNFROM = (isset($env['TOWNFROMINC'])) ? $env['TOWNFROMINC'] : ((isset($_GET['TOWNFROMINC'])) ? $_GET['TOWNFROMINC'] : TOWNFROMINC); $STATE = (isset($env['STATEINC'])) ? $env['STATEINC'] : ((isset($_GET['STATEINC'])) ? $_GET['STATEINC'] : 0); $__GET = $_GET; $__SESSION = $_SESSION; $_GET = $env; $_GET['samo_action'] = $action; $_GET['page'] = $module; $storage = Samo_Registry::instance(); $claimInfo = (isset($storage['claimInfo'])) ? $storage['claimInfo'] : array(); $routes = Samo_Registry::get('routes'); Samo_Registry::set('module', $routes[$module]); $samodb = db_connect($TOWNFROM, $STATE); $connected = false; try { $connected = $samodb->fetchOne("SELECT 1 AS connected"); } catch (DatabaseServer_Exception $e) { $e; } if (!$connected) { $samodb = find_available_server(); } if (!$samodb) { throw new RuntimeException('Database unavalable'); } $langs = array(_ROOT . 'includes/messages/messages_' . Samo_Request::lang() . '.php'); if (isset($routes[$module]) && isset($routes[$module]['path'])) { $langs[] = $routes[$module]['path'] . '/lang/messages_' . Samo_Request::lang() . '.php'; } $messages = array(); foreach ($langs as $lang) { if (file_exists($lang)) { include $lang; } } Samo_Registry::set('messages', $messages); if (isset($env['PARTNER'])) { $_SESSION = fakeAuth($env, $module); } Samo_Loader::load_object(ucwords($routes[$module]['controller'], '_')); ob_start(); try { call_user_func(array(Samo_Registry::get('controller'), $action)); } catch (Samo_Exception $e) { echo $e->getMessage(); } ob_end_clean(); $_GET = $__GET; $_SESSION = $__SESSION; $storage['claimInfo'] = $claimInfo; } function clear_module_templates($moduleName = null) { Samo_Loader::load_object('Samo_Tools')->clear_smarty_cache($moduleName); } function clear_cache($key = null) { $cache = new Samo_Cache(); if (null !== $key) { if (isset($cache[$key])) { unset($cache[$key]); } } else { $cache->purge(); } } function fckeditor_recover_tpl($source) { return preg_replace_callback( '~{([^}]*)}~', function ($tag) { return trim(html_entity_decode($tag[0], ENT_QUOTES, ini_get('default_charset'))); }, $source ); } function _admin_auth_() { if (PHP_SESSION_NONE == session_status()) { $cookie_path = defined('COOKIE_PATH') ? COOKIE_PATH : WWWROOT; ini_set('session.cookie_path', $cookie_path); ini_set('session.cookie_domain', COOKIE_DOMAIN); session_name(SESSION_NAME); session_start(); } $samodb = db_connect(TOWNFROMINC, 0); $sql = $samodb->formatExec('<OFFICEDB>.dbo.up_WEB_3_ADMIN_Get_User_Session', ['Session' => session_id()]); $user = $samodb->fetchOne($sql); unset($samodb); if (!$user) { header('HTTP/1.0 403 Forbidden', true, 403); exit; } return true; } 