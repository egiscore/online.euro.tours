<?php
 class Passport_Model extends Samo { protected $auth_required = array('agency'); public function checkPartgroup($partner) { if (defined('PARTNERGROUP') && intval(PARTNERGROUP)) { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_3_partner_partgroup', [ 'Partner' => $partner, 'Group' => PARTNERGROUP ] ); if (!$this->db->fetchOne($sql)) { return false; } } return true; } } class Passport_Controller extends Samo_Controller { protected $allow_js = false; public function default_action() { $this->persistent = array(); return true; } public function check_auth() { if ($result = parent::check_auth()) { if (!$this->model->checkPartgroup($_SESSION['samo_auth']['Partner'])) { $_SESSION['auth_error'] = $this->messages['ACCESS_DENIED']; $_SESSION['samo_auth'] = false; $this->view->clear_assign('logged'); return parent::check_auth(); } } return $result; } } 