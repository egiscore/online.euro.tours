<?php
 class Search_Api extends Api_Model { public $show_link_to_spog = true; public $show_stats_link = true; protected $_cacheHotels = null; protected $_cacheStargroups = null; protected $_cacheCheckins = null; protected $_cacheCurrency = null; protected $_cacheDates = null; protected $_cacheHotelsurl = null; protected $_cachePtypes = null; protected $today = null; protected $price_cache = 300; protected $hotel_type = null; protected $can_cross_freight_classes = null; protected $check_momentconfirm = null; const PARTITION_BY_CRC_PACKET = 255; const PARTITION_BY_CHECKIN = 128; const PARTITION_BY_NIGHTS = 64; const PARTITION_BY_HOTEL = 32; const PARTITION_BY_MEAL = 16; const PARTITION_BY_TOUR = 8; const PARTITION_BY_HTPLACE = 4; const PARTITION_BY_ROOM = 2; const PARTITION_BY_PTYPE = 1; const PACKET_FULL = 0; const PACKET_ONLY_FREIGHTS = 1; const PACKET_ONLY_HOTELS = 2; const ATTRIBUTE_HOTELTYPE_TAG = 2; public function __construct(Samo_Config $config, $callback = null) { parent::__construct($config, $callback); $this->frclasses = ['econom' => 1, 'busines' => 0, 'comfort' => 0, 'premium' => 0]; $this->today = Samo_Datetime::today(); $this->hotel_type = $this->hotelTypesFilter(); $this->field_type['integers'][] = 'PROGRAMINC'; $this->field_type['integers'][] = 'TOURS'; $this->field_type['integers'][] = 'UFILTER'; $this->field_type['string'][] = 'FORM'; $this->field_type['hexval'][] = 'CLAIM'; } public function currency() { $sCurrency = null; if ($rCurrency = $this->getParam('CURRENCY')) { $sCurrency = $rCurrency; } else { if (null === $this->_cacheCurrency) { foreach ($this->currency_list() as $currency) { if ($currency['Default']) { $sCurrency = $currency['Inc']; break; } } $this->_cacheCurrency = $sCurrency; } } if (!$sCurrency) { $sCurrency = $this->_cacheCurrency ? $this->_cacheCurrency : CURRENCYINC; } return $sCurrency; } private function currency_list() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'TOUR' => $this->getParam('TOURINC'), 'CATALOGDB' => $this->CATALOGDB, 'UserCode' => $this->internet_user(), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($currencys = $this->cache->get($cache_key))) { $res = $this->db->exec('<ONLINEDB>.dbo.up_WEB_4_search_CurrencyList', $params, true); if ($this->db->numRows($res)) { $currencys = $this->cache->set($cache_key, $this->db->fetchAll($res)); } else { $currencys = []; } } return $currencys; } protected function checkPrice($value) { if (!isset($value['bron'])) { $value['bron'] = $this->checkFreightsAvail($value); if ($this->check_momentconfirm && !(isset($value['Packet_Type']) && $value['Packet_Type'] == 2)) { if ($value['daynoconfirm'] == 0) { $value['daynoconfirm'] = 1; if ($value['bron']) { foreach ($value['freights'] as $row) { if (in_array($row['in'], ['Y', 'F']) && in_array($row['out'], ['Y', 'F'])) { $value['daynoconfirm'] = 0; break; } } } } } if (!intval($value['StopSaleHotel'])) { $value['color'] = 'white'; if ($value['daynoconfirm'] == 0) { $value['color'] = 'green'; } } else { $value['bron'] = false; $value['color'] = 'red'; $value['HotelAvailability'] = 'NNNN'; } if ($value['bron']) { foreach (['HotelInc', 'HtPlaceInc', 'RoomInc', 'MealInc', 'TownInc', 'StarInc'] as $row) { if (isset($value[$row]) && null === $value[$row]) { $value['bron'] = false; break; } } } if ($value['bron'] && false !== strpos($value['HotelAvailability'], 'N')) { $value['bron'] = false; } } return $value; } private function setFreightAvail($class, $direct, &$value) { $key_base = ucfirst(strtolower($class)) . ucfirst(strtolower($direct)); $value['freights'][$class][$direct] = 'N'; if ($value[$key_base] == 1) { $value['freights'][$class][$direct] = 'Y'; } elseif ($value[$key_base] == 2) { $value['freights'][$class][$direct] = 'F'; } elseif ($value[$key_base] == 3) { $value['freights'][$class][$direct] = 'R'; } else { if (in_array($value['TourRequest'], [1, 2]) && $value['FrWithout' . $key_base] == 1) { $value['freights'][$class][$direct] = 'R'; } } } private function checkFreightsAvail(&$data) { $avail = [0, 0]; foreach ($this->frclasses as $class => $count) { $_class = ucfirst($class); $in = $this->checkFreightWay($data, $_class . 'In'); $out = $this->checkFreightWay($data, $_class . 'Out'); $data[$class] = (int)($in || $out); if (!$this->can_cross_freight_classes && (!$in || !$out)) { $in = $out = 0; } $avail[0] += $in; $avail[1] += $out; } return $avail[0] > 0 && $avail[1] > 0; } private function checkFreightWay(&$data, $classway = 'EconomIn') { return ((int)$data[$classway] > 0 || ($data['FrWithout' . $classway] == 1 && in_array($data['TourRequest'], [1, 2]))); } public function getMealsByGroups($groups) { $return = []; if (is_string($groups)) { $meals = explode(',', $groups); } elseif (is_int($groups)) { $meals = [$groups]; } elseif (is_array($groups)) { $meals = $groups; } else { return []; } foreach ($meals as $idx => $mealinc) { if (!intval($mealinc)) { unset($meals[$idx]); } } if (!empty($meals)) { $sql = $this->db->formatExec( "<ONLINEDB>.dbo.up_WEB_3_search_getMealsByGroups", [ 'GROUP_LIST' => $meals, ] ); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = $row['MealInc']; } } } return array_unique($return); } public function getRoomsByGroups($groups) { $return = []; if (is_string($groups)) { $rooms = explode(',', $groups); } elseif (is_int($groups)) { $rooms = [$groups]; } elseif (is_array($groups)) { $rooms = $groups; } else { return []; } foreach ($rooms as $idx => $roominc) { if (!intval($roominc)) { unset($rooms[$idx]); } } if (!empty($rooms)) { $sql = $this->db->formatExec( "<ONLINEDB>.dbo.up_WEB_3_search_getRoomsByGroups", [ 'GROUP_LIST' => $rooms, ] ); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = $row['RoomInc']; } } } return array_unique($return); } private function getProgramInc() { $defaults = []; if ($group = $this->getParam('PROGRAMGROUPINC')) { if (isset($this->_cachePtypes[$group])) { $defaults = $this->_cachePtypes[$group]; } else { if ($data = $this->_getPROGRAMS()) { foreach ($data as $row) { $defaults[] = $row['id']; } } else { $defaults = null; } $this->_cachePtypes[$group] = $defaults; } } $program = $this->getParam('PROGRAMINC'); if ($program) { if ($group) { $programExists = array_filter( $defaults, function ($row) use ($program) { return in_array($row, $program); } ); if (!count($programExists)) { return null; } return implode(',', $program); } else { return implode(',', $program); } } return ($defaults) ? implode(',', $defaults) : null; } public function getStarsByGroups($stars = []) { $return = []; if (!empty($stars)) { $sql = $this->db->formatExec( "<ONLINEDB>.dbo.up_WEB_3_search_getStarsByGroups", [ 'GROUP_LIST' => $stars, ] ); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = $row['StarInc']; } } } return array_unique($return); } public function checkin($var) { $checkinString = $this->getValidDates(); if (is_array($var)) { $this->defaults['CHECKIN_BEG'] = $this->_getCHECKIN($var); $this->defaults['CHECKIN_BEG'] = $this->defaults['CHECKIN_BEG']['value']; $var = 'CHECKIN_BEG'; } $value = $this->defaults[$var]; if ($value->is_null()) { $value = Samo_Datetime::today(); } $return = ['validDates' => $checkinString['sdays'], 'startDate' => $this->today, 'value' => $value]; if (version_compare(Samo_Request::api_version(), '2.0') >= 0) { $return['validDates'] = str_replace(['0', '1', '2'], ['N', 'R', 'Y'], $return['validDates']); $return['startDate'] = $return['startDate']->format('Y-m-d'); $return['value'] = $return['value']->format('Y-m-d'); } return $return; } private function setTypeIcons($mapHotel, &$return) { ksort($mapHotel); $hotels = array_keys($mapHotel); $params = [ 'HotelList' => $hotels, 'Order_by_name' => $this->getConfig('ORDER_BY_NAME'), ]; $attr = $icons = []; $cacheKey = serialize($params); if (false === ($data = $this->cache->get($cacheKey))) { $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_5_hotel_icons', $params); if (false !== $res = $this->db->fetchAll($sql)) { foreach ($res as $row) { if ($row['icon']) { if (!isset($icons[$row['id']])) { $icons[$row['id']] = $row; } } if (isset($icons[$row['id']])) { $attr[$row['Hotel']][] = &$icons[$row['id']]; } } $this->cache->set($cacheKey, [$icons, $attr]); } } else { list($icons, $attr) = $data; } if ($icons) { foreach ($attr as $inc => $row) { foreach ($mapHotel[$inc] as $key) { $return['prices'][$key]['attributes'] = $row; } } } } protected function setProgramTypeIcons(&$return) { $ptypeList = array_map( function ($price) { return $price['programTypeKey']; }, $return['prices'] ); $ptypeList = array_unique($ptypeList); sort($ptypeList); $cacheKey = __METHOD__ . implode('_', $ptypeList); if (false === ($icons = $this->cache->get($cacheKey))) { $sql = $this->db->formatExec( '<ONLINEDB>.dbo.up_WEB_4_search_ptypeList', ['ptypeList' => implode(',', $ptypeList)] ); if ($icons = $this->db->fetchAllWithKey($sql, 'programTypeKey')) { $this->cache->set($cacheKey, $icons); } } foreach ($return['prices'] as &$row) { $row['programTypeIcon'] = (isset($icons[$row['programTypeKey']])) ? $icons[$row['programTypeKey']]['programTypeIcon'] : null; $row['programTypeNote'] = (isset($icons[$row['programTypeKey']])) ? $icons[$row['programTypeKey']]['programTypeNote'] : null; } } private function getValidDates() { if (null === $this->_cacheDates) { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'DATEBEG' => $this->today, 'PTYPE' => $this->getProgramInc(), 'TOUR' => $this->getParam('TOURINC'), 'TOURIST_COUNT' => $this->getParam('ADULT', 0) + $this->getParam('CHILD', 0), 'UserCode' => $this->internet_user(), 'CatalogDB' => $this->CATALOGDB, ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($this->_cacheDates = $this->cache->get($cache_key))) { $return = ['sdays' => '']; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_5_search_CheckinString', $params); if (false !== ($row = $this->db->fetchRow($sql))) { $return['sdays'] = rtrim($row['sdays'], '0'); } $this->_cacheDates = $this->cache->set($cache_key, $return, 300); } } return $this->_cacheDates; } private function getFilter() { $moment_confirm = $this->getParam('MOMENT_CONFIRM'); $freight = $this->getParam('FREIGHT'); $hstopsale = $this->getParam('FILTER'); $packet = $this->getParam('PACKET'); $child_in_bed = $this->getParam('CHILD_IN_BED'); $result = ''; $result .= ($child_in_bed) ? 1 : 0; $result .= ($this->_callback && $this->getParam('SHOW_THEBEST')) ? 1 : 0; $result .= ($moment_confirm) ? 1 : 0; $result .= 0; $result .= ($this->getParam('ACTION') == 'STATS') ? 1 : 0; $result .= ($this->getParam('THE_BEST')) ? 1 : 0; $result .= 0; $result .= (self::PACKET_ONLY_HOTELS == $packet || Samo::TOWNFROMHOTELINC == $this->getParam('TOWNFROMINC')) ? 1 : 0; $result .= (self::PACKET_ONLY_FREIGHTS == $packet) ? 1 : 0; $result .= ($freight || ($moment_confirm && $this->check_momentconfirm)) ? 1 : 0; $result .= ($hstopsale || ($moment_confirm && $this->check_momentconfirm)) ? 1 : 0; $result .= '0'; return bindec($result); } protected function _getPacketAttributes() { $return = []; if (false !== ($res = $this->_getUfilters())) { foreach ($res as $row) { $return['uf' . $row['id']] = $row; } } return $return; } protected function _getUfilters() { $return = []; if ($this->getConfig('SEARCH_UFILTER', 'online_config', 0)) { $tour_list = $this->getTourList(null, null, null); $tours = Samo_Array::array_unique($tour_list, 'id'); $tours = (!empty($tours)) ? implode(',', $tours) : null; $ptype_list = $this->_getPROGRAMS(); $ptypes = Samo_Array::array_unique($ptype_list, 'id'); $ptypes = (!empty($ptypes)) ? implode(',', $ptypes) : null; $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'tour' => $tours, 'ptype' => $ptypes, 'order_by_name' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEBST_FillUfilterList', $params); $return = []; if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $row['selected'] = 0; $row['url'] = Samo_Url::parse($row['url']); $return[] = $row; } } $this->cache->set($cache_key, $return); } $return = $this->setSelected($return, $this->getParam('UFILTER')); } return $return; } public function getUFILTER() { $return = 0; $selectedFilters = $this->getParam('UFILTER'); if (!empty($selectedFilters)) { $availableFilters = $this->_getUfilters(); if (!empty($availableFilters)) { foreach ($availableFilters as $ufilter) { if ($ufilter['selected']) { $return += pow(2, ((int)$ufilter['id'] - 1)); } } } } return $return; } private function getSurcharge(&$data, $class, $direction, $postfix) { $surcharge = null; $index = substr($class, 0, 1) . $postfix; if (isset($data[$index]) && $data[$index] > 0) { $surcharge = $data[$index]; $data['freights'][$class]['surcharge'][$direction] = [ 'price' => $data[$index], 'currencyAlias' => $data['cAlias_' . $postfix], 'currencyKey' => $data['cInc_' . $postfix], 'converted' => $this->convertPrice($data[$index], $data['cInc_' . $postfix], $this->currency(), $data['cAlias_' . $postfix]), ]; } return $surcharge; } private function getNote($row) { $note = []; if (isset($row['StopSaleDateBeg']) && $row['StopSaleDateEnd']) { if ($row['StopSaleDateBeg']->not_null() && $row['StopSaleDateEnd']->not_null()) { $note[] = sprintf($this->messages('PRICE_STOPSALE_PERIOD'), $row['StopSaleDateBeg']->format('date'), $row['StopSaleDateEnd']->format('date')); if (isset($row['StopSaleRoom']) && $row['StopSaleRoom'] > 0) { $note[] = sprintf($this->messages('PRICE_STOPSALE_ROOM'), isset($row['RoomLName']) ? $row['RoomLName'] : null); } if (isset($row['StopSaleHtPlace']) && $row['StopSaleHtPlace'] > 0) { $note[] = sprintf($this->messages('PRICE_STOPSALE_HTPLACE'), isset($row['HtPlaceLName']) ? $row['HtPlaceLName'] : null); } if (isset($row['StopSaleRDateEnd']) && $row['StopSaleRDateEnd']->not_null()) { $note[] = sprintf($this->messages('PRICE_STOPSALE_RDATEEND'), $row['StopSaleRDateEnd']->format('date')); } if ($stop = isset($row['StopNote']) ? $row['StopNote'] : null) { $note[] = $stop; } } } if (isset($row['StopSaleSpog']) && $row['StopSaleSpog'] > 0) { $note[] = sprintf($this->messages('PRICE_STOPSALE_SPO'), isset($row['FullNumber']) ? $row['FullNumber'] : null); } return implode("\n", $note); } public function getParam($param = null, $default = null, $real = false) { $return = parent::getParam($param, $default); if ($param == 'TOWNS' && empty($return)) { $param = 'TOWNTO'; $return = parent::getParam($param, $default); } if ($param == 'CATCLAIM' && empty($return)) { $return = parent::getParam('CLAIM', $default); } if ($param == 'TOURINC') { if (null === $return && $real == false) { $tourlist = $this->getParam('TOURS'); if ($tourlist) { return implode(',', $tourlist); } $type = $this->getParam('TOURTYPE'); $partner = $this->getParam('INCOMINGPARTNER'); if ($type || $partner) { $this->getTourList(null, $type, $partner); if (!empty($this->defaults['TOURLIST'])) { return implode(',', $this->defaults['TOURLIST']); } } } } return $return; } protected function getTourList($inc = null, $tourtype = null, $incomingpartner = null, $orderByName = null) { if (!$this->config('SEARCH_INCOMINGPARTNER_FILTER', 'online_config')) { $this->defaults['INCOMINGPARTNER'] = (isset($this->defaults['INCOMINGPARTNER'])) ? $this->defaults['INCOMINGPARTNER'] : []; } if (null === $orderByName) { $orderByName = $this->getConfig('ORDER_BY_NAME'); } $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'TOURTYPE' => $tourtype === false ? null : ((null === $tourtype) ? $this->getParam('TOURTYPE') : $tourtype), 'INCOMINGPARTNER' => $incomingpartner === false ? null : implode(',', null === $incomingpartner ? $this->getParam('INCOMINGPARTNER') : $incomingpartner), 'ORDER_BY_NAME' => $orderByName, 'CATALOGDB' => $this->CATALOGDB, ]; $cache_key = 'ST:TOURINC:' . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_Tour', $params); $return = []; if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['TourInc'], 'name' => $row['TourLName'], 'nameAlt' => $row['TourName'], 'type' => $row['TourTypeLName'], 'typeAlt' => $row['TourTypeName'], 'typeKey' => $row['TourTypeInc'], 'partner' => $row['TourPartnerLName'], 'partnerAlt' => $row['TourPartnerName'], 'partnerKey' => $row['TourPartnerInc'], 'selected' => 0, ]; } } $this->cache->set($cache_key, $return, $this->price_cache); } $this->defaults['TOURLIST'] = []; foreach ($return as $key => $row) { $this->defaults['TOURLIST'][] = $row['id']; if ($row['id'] == $inc) { $return[$key]['selected'] = 1; } } return $return; } protected function getServiceTitle($row, $name_suffix = 'LName') { $props = $geo = []; foreach (['Hotel' . $name_suffix, 'Meal' . $name_suffix, 'Airline' . $name_suffix, 'Class' . $name_suffix] as $idx) { if (isset($row[$idx]) && !empty($row[$idx])) { $props[] = $row[$idx]; } } foreach (['SrcTown' . $name_suffix, 'TrgTown' . $name_suffix] as $idx) { if (isset($row[$idx]) && !empty($row[$idx])) { $geo[] = $row[$idx]; } } $description = implode(', ', $props) . (count($geo) ? (((count($props)) ? ', ' : '') . implode('—>', $geo)) : ''); if (strlen($description)) { $description = sprintf('(%s)', $description); } return sprintf("%s %s", $row['Service' . $name_suffix], $description); } protected function _getTOURS($orderByName = null) { return $this->getTourList($this->getParam('TOURINC', null, true), null, null, $orderByName); } protected function _getTOUR_TYPES() { $cache_key = __METHOD__ . $this->getParam('TOWNFROMINC') . '_' . $this->getParam('STATEINC'); if (false === ($data = $this->cache->get($cache_key))) { $data = []; if ($tours = $this->getTourList(null, false, false)) { foreach ($tours as $tour) { if (isset($tour['typeKey'])) { if (!isset($data[$tour['typeKey']])) { $data[$tour['typeKey']] = [ 'id' => $tour['typeKey'], 'name' => $tour['type'], 'nameAlt' => $tour['typeAlt'], 'tours' => [], 'selected' => 0, ]; } $data[$tour['typeKey']]['tours'][] = $tour['id']; } } } $data = array_values($data); $this->cache->set($cache_key, $data, $this->price_cache); } $result = $this->setSelected($data, $this->getParam('TOURTYPE')); if (is_array($result)) { usort( $result, function ($a, $b) { return strnatcmp($a['name'], $b['name']); } ); } return $result; } protected function _getINCOMING_PARTNERS() { $cache_key = __METHOD__ . '_' . $this->getParam('TOWNFROMINC') . '_' . $this->getParam('STATEINC'); if (false === ($data = $this->cache->get($cache_key))) { $data = []; if ($tours = $this->getTourList(null, false, false)) { foreach ($tours as $tour) { if (isset($tour['partnerKey'])) { if (!isset($data[$tour['partnerKey']])) { $data[$tour['partnerKey']] = [ 'id' => $tour['partnerKey'], 'name' => $tour['partner'], 'nameAlt' => $tour['partnerAlt'], 'tours' => [], 'selected' => 0, ]; } $data[$tour['partnerKey']]['tours'][] = $tour['id']; } } } $data = $this->cache->set($cache_key, array_values($data), $this->price_cache); } $result = $this->setSelected($data, $this->getParam('INCOMINGPARTNER')); if (is_array($result)) { usort( $result, function ($a, $b) { return strnatcmp($a['name'], $b['name']); } ); } return $result; } protected function _getCHECKIN($var = 'CHECKIN_BEG') { $value = $this->getParam($var); if (!is_object($value) || $value->is_null()) { $value = Samo_Datetime::today(); } $checkinString = $this->getValidDates(); $return = [ 'start' => $this->today, 'value' => $value, 'valid' => $checkinString['sdays'], 'items' => [], ]; $current = $this->today->copy(); $days = strlen($checkinString['sdays']); for ($i = 0; $i < $days; $i++) { if ($checkinString['sdays'][$i] != '0') { $return['items'][] = [ 'checkin' => $current->format('sql'), 'selected' => empty($return['items']) ? 1 : 0, ]; } $current->modify('+1 day'); } if (version_compare(Samo_Request::api_version(), '2.0') >= 0) { $return['valid'] = str_replace(['0', '1', '2', '3'], ['N', 'R', 'Y', 'F'], $return['valid']); $return['start'] = $return['start']->format('Y-m-d'); $return['value'] = $return['value']->format('Y-m-d'); if ('json' == Samo_Request::api_format()) { unset($return['items']); } } return $return; } private function _setCHECKINS() { if (!$this->_cacheCheckins) { $this->_cacheCheckins = $this->getValidDates(); } if (!$this->_cacheCheckins) { return false; } $offset = $this->getParam('MINDAYSBEFORE', 0); $CHECKIN_BEG = $this->getParam('CHECKIN_BEG'); if ($CHECKIN_BEG->is_null() || ($offset && $CHECKIN_BEG->diff() < $offset)) { $sdays = str_pad(strval($this->_cacheCheckins['sdays']), $offset + 1, '0'); $posMany = strpos($sdays, '2', $offset); $posFew = strpos($sdays, '3', $offset); $pos = ($posMany === false && $posFew === false) ? false : (($posFew === false) ? $posMany : (($posMany === false) ? $posFew : min($posMany, $posFew))); if (false === $pos) { $pos = strpos($sdays, '1', $offset); } if (false === $pos) { $pos = $offset; } $CHECKIN_BEG = Samo_Datetime::today()->add_days($pos); } $offset = $CHECKIN_BEG->diff(); $maxperiod = $this->getParam('MAXPERIOD'); $CHECKIN_END = $this->getParam('CHECKIN_END'); if ($CHECKIN_END->is_null() || (null !== $maxperiod && $CHECKIN_END->diff($CHECKIN_BEG) > $maxperiod)) { $sdays = strval($this->_cacheCheckins['sdays']); if ($offset < 0) { $correction = abs($offset); $sdays = str_pad('', $correction, '0') . $sdays; $offset = 0; } else { $correction = 0; } $sdays = str_pad($sdays, $offset + $maxperiod + 1, '0'); $sdays = str_replace(['2', '3'], '1', $sdays); if (null !== $maxperiod) { $pos = strrpos(substr($sdays, 0, $offset + $maxperiod + 1), '1', $offset); if (false === $pos) { $pos = $offset + $maxperiod; } } elseif ($this->getParam('CHECKIN_BEG')->is_null()) { $pos = strpos($sdays, '1', $offset + 1); } else { $pos = strpos($sdays, '1', $offset); } if (false === $pos) { $pos = $offset; } $CHECKIN_END = Samo_Datetime::today()->add_days($pos - $correction); } if ($CHECKIN_END->lt($CHECKIN_BEG)) { $CHECKIN_END = $CHECKIN_BEG->copy(); } $this->setParams('CHECKIN_BEG', $CHECKIN_BEG); $this->setParams('CHECKIN_END', $CHECKIN_END); return $this->checkin('CHECKIN_BEG'); } protected function _getCHECKIN_BEG() { $this->_setCHECKINS(); return $this->checkin('CHECKIN_BEG'); } protected function _getCHECKIN_END() { $this->_setCHECKINS(); return $this->checkin('CHECKIN_END'); } protected function _getNIGHTS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CHECKIN_BEG' => $this->getParam('CHECKIN_BEG'), 'CHECKIN_END' => $this->getParam('CHECKIN_END'), 'TOUR' => $this->getParam('TOURINC'), 'TOURIST_COUNT' => $this->getParam('ADULT', 0) + $this->getParam('CHILD', 0), 'CATALOGDB' => $this->CATALOGDB, 'UserCode' => $this->internet_user(), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = [ 'nights' => [], 'places' => [], 'default' => [ 'from' => intval($this->tour_config('night_from', 'search')), 'till' => intval($this->tour_config('night_till', 'search')), ], ]; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_6_search_Nights', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return['nights'][] = (int)$row['Nights']; if (array_key_exists('Places', $row) && $row['Places']) { $return['places'][] = (int)$row['Nights']; } } } if (empty($return['nights'])) { $return['nights'] = range(min($return['default']['from'], 1), 31); } $this->cache->set($cache_key, $return); } return $return; } protected function _getNIGHTS_FROM() { if (!($data = $this->getParam('NIGHTS_FROM'))) { $data = $this->_getNIGHTS(); $data = $data['default']['from']; } return $this->setParams('NIGHTS_FROM', intval($data)); } protected function _getNIGHTS_TILL() { if (!($data = $this->getParam('NIGHTS_TILL'))) { $data = $this->_getNIGHTS(); $data = $data['default']['till']; } return $this->setParams('NIGHTS_TILL', intval($data)); } protected function _getMIN_PEOPLE() { if (!($data = $this->getParam('MIN_PEOPLE'))) { $data = $this->tour_config('MIN_PEOPLE', 'search'); } return $this->setParams('MIN_PEOPLE', intval($data)); } protected function _getMIN_CHILD() { if (!($data = $this->getParam('MIN_CHILD'))) { $data = $this->tour_config('MIN_CHILD', 'search'); } return $this->setParams('MIN_CHILD', intval($data)); } protected function _getMAX_PEOPLE() { if (!($data = $this->getParam('MAX_PEOPLE'))) { $data = $this->tour_config('MAX_PEOPLE', 'search'); } return $this->setParams('MAX_PEOPLE', intval($data)); } protected function _getMAX_CHILD() { if (!($data = $this->getParam('MAX_CHILD'))) { $data = $this->tour_config('MAX_CHILD', 'search'); } return $this->setParams('MAX_CHILD', intval($data)); } protected function _getDefaultAges() { return [ $this->tour_config('CHILD_SMALL_AGES', 'search'), $this->tour_config('CHILD_MIDDLE_AGES', 'search'), $this->tour_config('CHILD_BIG_AGES', 'search'), ]; } protected function _getADULT() { if (null === ($data = $this->getParam('ADULT'))) { $data = intval($this->tour_config('ADULTCOUNT', 'search')); if ($data < 0) { $data = 0; } elseif ($data > ($max = $this->_getMAX_PEOPLE())) { $data = $max; } } return $this->setParams('ADULT', $data); } protected function _getCHILD() { if (null === ($data = $this->getParam('CHILD'))) { $data = intval($this->tour_config('CHILDCOUNT', 'search')); if ($data < 0) { $data = 0; } elseif ($data > ($max = $this->_getMAX_CHILD())) { $data = $max; } } return $this->setParams('CHILD', $data); } public function _getADULTS() { return [ 'min' => $this->_getMIN_PEOPLE(), 'max' => $this->_getMAX_PEOPLE(), 'default' => intval($this->tour_config('ADULTCOUNT', 'search')), ]; } public function _getCHILDS() { return [ 'min' => $this->_getMIN_CHILD(), 'max' => $this->_getMAX_CHILD(), 'default' => intval($this->tour_config('CHILDCOUNT', 'search')), ]; } protected function _getCURRENCIES() { $return = []; $currency = $this->currency(); $selected = null; $default = null; $version = Samo_Request::api_version(); foreach ($this->currency_list() as $data) { if ($data['Inc'] == $currency) { $selected = $data['Inc']; } if ($data['Default']) { $default = $data['Inc']; } $return[$data['Inc']] = [ 'id' => $data['Inc'], 'name' => ('1.0' == $version) ? $data['LName'] : $data['Alias'], 'nameAlt' => ('1.0' == $version) ? $data['Name'] : $data['Alias'], 'rates' => [], 'selected' => 0, ]; if ('1.0' == $version) { $return[$data['Inc']]['alias'] = $data['Alias']; } } if ($return) { if ($selected) { $return[$selected]['selected'] = 1; } elseif ($default) { $return[$default]['selected'] = 1; } else { foreach ($return as $key => $val) { $return[$key]['selected'] = 1; break; } } if (null === $this->_cacheRates) { $this->_cacheRates = $this->getCurrencyRates(); } foreach ($return as $key => $row) { if (isset($this->_cacheRates[$row['id']])) { $return[$key]['rates'] = []; $rates = $this->_cacheRates[$row['id']]; foreach ($return as $_row) { if (isset($rates[$_row['id']])) { $rate = [ 'id' => $_row['id'], 'nominal' => 1, 'value' => $rates[$_row['id']], ]; if ('1.0' == $version) { $rate['alias'] = $_row['alias']; } else { $rate['name'] = $_row['name']; } $return[$key]['rates'][] = $rate; } } } } } return array_values($return); } protected function _getPROGRAM_GROUPS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'TOUR' => $this->getParam('TOURINC'), 'CATALOGDB' => $this->CATALOGDB, 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_GroupPType', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'selected' => 0, ]; } } $return = $this->cache->set($cache_key, $return, $this->price_cache); } return $this->setSelected($return, $this->getParam('PROGRAMGROUPINC')); } protected function _getPROGRAMS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'TOUR' => $this->getParam('TOURINC'), 'PROGRAMGROUP' => $this->getParam('PROGRAMGROUPINC'), 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_PType', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'selected' => 0, ]; } } $return = $this->cache->set($cache_key, $return, $this->price_cache); } $program = $this->getParam('PROGRAMINC'); return $this->setSelected($return, $program); } protected function _getPACKET_TYPES() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'TOUR' => $this->getParam('TOURINC'), 'PTYPE' => $this->getProgramInc(), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_Packet_Type', $params); $return = []; if (false !== ($res = $this->db->fetchAll($sql))) { $return = $res; } $return = $this->cache->set($cache_key, $return, $this->price_cache); } $result = [ self::PACKET_FULL => ['id' => self::PACKET_FULL, 'name' => 'Complete package', 'nameAlt' => $this->messages('FILTER_FULL_PACKET'), 'available' => 0, 'selected' => 0], self::PACKET_ONLY_FREIGHTS => ['id' => self::PACKET_ONLY_FREIGHTS, 'name' => 'Only flights', 'nameAlt' => $this->messages('FILTER_AVIATICKET_ONLY'), 'available' => 0, 'selected' => 0], self::PACKET_ONLY_HOTELS => ['id' => self::PACKET_ONLY_HOTELS, 'name' => 'Only accommodation', 'nameAlt' => $this->messages('FILTER_HOTEL_ONLY'), 'available' => 0, 'selected' => 0], ]; $selected_exists = false; if ($return) { $current = $this->getParam('PACKET'); foreach ($return as $packet) { $filter = ($packet['packet_type']) ? $packet['packet_type'] : self::PACKET_FULL; if (!$selected_exists && ($filter == $current)) { $selected_exists = $result[$filter]['selected'] = 1; } $result[$filter]['available'] = 1; } } if (!$selected_exists && 1 == count($return)) { $available = reset($return); $result[$available['packet_type']]['selected'] = 1; $this->setParams('PACKET', $available['packet_type']); } return $result; } protected function _getTOWNS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'PTYPE' => $this->getProgramInc(), 'TOUR' => $this->getParam('TOURINC'), 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), 'CATALOGDB' => $this->CATALOGDB, ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_Townto', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['TownInc'], 'name' => $row['TownLName'], 'nameAlt' => $row['TownName'], 'region' => $row['RegionLName'], 'regionAlt' => $row['RegionName'], 'regionKey' => $row['RegionInc'], 'regionSelected' => 0, 'selected' => 0, ]; } } $this->cache->set($cache_key, $return, $this->price_cache); } $group_selected = []; $selected = $this->getParam('TOWNS'); foreach ($return as $idx => $row) { if (in_array($row['id'], $selected)) { $return[$idx]['selected'] = 1; $group_selected[] = $row['regionKey']; } } foreach ($return as $idx => $data) { $return[$idx]['regionSelected'] = in_array($data['regionKey'], $group_selected) ? 1 : 0; } return $return; } protected function _getSTARS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_GroupStar', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'selected' => 0, ]; } } $return = $this->cache->set($cache_key, $return); } return $this->setSelected($return, $this->getParam('STARS')); } protected function _getHOTEL_TYPES() { $params = [ 'TownFrom' => $this->getParam('TOWNFROMINC'), 'State' => $this->getParam('STATEINC'), 'Tour' => $this->getParam('TOURINC'), 'PType' => $this->getProgramInc(), 'HotelTypeTag' => self::ATTRIBUTE_HOTELTYPE_TAG, 'Order_by_name' => $this->getConfig('ORDER_BY_NAME'), 'CatalogDB' => $this->CATALOGDB, ]; $cache_key = __METHOD__ . '_' . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_6_search_Hotel_type', $params); $return = $this->db->fetchAll($sql); if ($return) { foreach ($return as &$row) { $row['selected'] = 0; unset($row['Version']); } unset($row); } $return = $this->cache->set($cache_key, $return ? array_values($return) : []); } return $this->setSelected($return, $this->getParam('HOTELTYPES')); } protected function _getHOTELS($is_api2 = null) { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'TOUR' => $this->getParam('TOURINC'), 'PTYPE' => $this->getProgramInc(), 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($result = $this->cache->get($cache_key))) { $result = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_Hotel', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $result[] = [ 'id' => (int)$row['HotelInc'], 'name' => $row['HotelLName'], 'nameAlt' => $row['HotelName'], 'townKey' => (int)$row['TownInc'], 'star' => $row['StarLName'], 'starAlt' => $row['StarName'], 'starKey' => $row['StarInc'], 'starGroupList' => $row['GroupStarList'], 'typeList' => $row['HotelTypeList'], 'selected' => 0, ]; } } $result = $this->cache->set($cache_key, $result, $this->price_cache); } $is_api2 = (null === $is_api2) ? version_compare(Samo_Request::api_version(), '2.0') >= 0 : $is_api2; if ($result && $is_api2) { foreach ($result as &$hotel) { $hotel['starGroupList'] = explode(',', $hotel['starGroupList']); $hotel['typeList'] = explode(',', $hotel['typeList']); } } return $this->setSelected($result, $this->getParam('HOTELS')); } protected function hotelList($townList, $starList, $typeList) { $result = []; $hotelList = $this->getParam('HOTELS'); $allHotels = $this->_getHOTELS($is_api2 = true); if ($allHotels && ($hotelList || $townList || $starList || $typeList)) { foreach ($allHotels as $row) { if ( (!count($hotelList) || in_array($row['id'], $hotelList)) && (!count($typeList) || count(array_intersect($row['typeList'], $typeList))) && (!count($townList) || in_array($row['townKey'], $townList)) && (!count($starList) || in_array($row['starKey'], $starList)) ) { $result[] = $row['id']; } } } return $result; } protected function _getMEALS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . '_' . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_GroupMeal', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'selected' => 0, ]; } } $return = $this->cache->set($cache_key, $return); } return $this->setSelected($return, $this->getParam('MEALS')); } protected function _getROOMS() { $params = [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CATALOGDB' => $this->CATALOGDB, 'ORDER_BY_NAME' => $this->getConfig('ORDER_BY_NAME'), ]; $cache_key = __METHOD__ . '_' . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $return = []; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_4_search_GroupRoom', $params); if (false !== ($res = $this->db->fetchAll($sql))) { foreach ($res as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'selected' => 0, ]; } } $return = $this->cache->set($cache_key, $return); } return $this->setSelected($return, $this->getParam('ROOMS')); } protected function _getFREIGHT() { if (!($data = $this->getParam('FREIGHT'))) { if (($data = intval($this->tour_config('places', 'search'))) < 0) { $data = 0; } } return $this->setParams('FREIGHT', $data); } protected function _getFILTER() { if (null === $data = $this->getParam('FILTER')) { if (($data = intval($this->tour_config('stop_selling', 'search'))) < 0) { $data = 0; } } return $this->setParams('FILTER', $data); } protected function _getMOMENT_CONFIRM() { if (null === $data = $this->getParam('MOMENT_CONFIRM')) { if (($data = intval($this->tour_config('moment_confirm', 'search'))) < 0) { $data = 0; } } return $this->setParams('moment_confirm', $data); } protected function _getCHILD_IN_BED() { if (null === $data = $this->getParam('CHILD_IN_BED')) { if (($data = intval($this->tour_config('child_in_bed', 'search'))) < 0) { $data = 0; } } return $this->setParams('CHILD_IN_BED', $data); } protected function _getALL() { $return = []; $versions = [ '1.0' => [ 'TOURS', 'TOUR_TYPES', 'INCOMING_PARTNERS', 'CHECKIN_BEG', 'CHECKIN_END', 'NIGHTS_FROM', 'NIGHTS_TILL', 'MAX_PEOPLE', 'ADULT', 'CHILD', 'CURRENCIES', 'PROGRAMS', 'PROGRAM_GROUPS', 'PACKET_TYPES', 'TOWNS', 'STARS', 'HOTEL_TYPES', 'HOTEL_ATTRIBUTES', 'HOTELS', 'MEALS', 'FREIGHT', 'FILTER', 'MOMENT_CONFIRM', 'CHILD_IN_BED', 'UFILTERS', ], '2.0' => [ ['TOWNFROMS', 'TOWNFROMINC'], ['STATES', 'STATEINC'], 'TOURS', 'TOUR_TYPES', 'INCOMING_PARTNERS', 'CHECKIN_BEG', 'CHECKIN_END', 'ADULTS', 'CHILDS', 'CURRENCIES', 'PROGRAMS', 'PROGRAM_GROUPS', 'PACKET_TYPES', 'TOWNS', 'STARS', 'HOTEL_TYPES', 'HOTEL_ATTRIBUTES', 'HOTELS', 'MEALS', 'FREIGHT', 'FILTER', 'MOMENT_CONFIRM', 'NIGHTS', 'CHILD_IN_BED', 'UFILTERS', ], ]; $version = Samo_Request::api_version(); if (isset($versions[$version])) { $methods = $versions[$version]; foreach ($methods as $name) { $param = false; if (is_array($name)) { list($name, $param) = $name; } $method = '_get' . $name; if (method_exists($this, $method)) { $result = $this->$method(); $return[$name] = $result; if ($result && $param && !$this->defaults[$param]) { $firstRow = reset($result); $firstValue = $firstRow['id']; $this->setParams($param, $firstValue); } } } } else { throw new Samo_Exception('Unsupported version: ' . $version); } return $return; } protected function nameOrLname($row, $entity, $orderToUseLname) { $result = null; if (isset($orderToUseLname)) { if ($orderToUseLname && isset($row[$entity . 'LName'])) { $result = $row[$entity . 'LName']; } elseif (isset($row[$entity . 'Name'])) { $result = $row[$entity . 'Name']; } } return $result; } protected function _getPRICES($costfix = true) { $mapHotel = $map_program_type = []; $return = ['prices' => []]; if ($this->getParam('INCOMINGPARTNER') || $this->getParam('TOURTYPE')) { if (!$this->_getTOURS()) { return $return; } } if ($this->getParam('UFILTER')) { if (!$this->_getPacketAttributes()) { return $return; } } $ptype = $this->getProgramInc(); if (!$ptype && $this->getParam('PROGRAMGROUPINC')) { return $return; } $currency = $this->currency(); $mealInc = $this->getParam('MEALINC'); $mealGroups = $this->getParam('MEALS'); $mealList = []; if ($mealGroups) { $mealList = $this->getMealsByGroups($mealGroups); if (!$mealList) { return $return; } } $mealList = array_unique(array_merge($mealInc, $mealList)); $roomInc = $this->getParam('ROOMINC'); $roomGroups = $this->getParam('ROOMS'); $roomList = []; if ($roomGroups) { $roomList = $this->getRoomsByGroups($roomGroups); if (!$roomGroups) { return $return; } } $roomList = array_unique(array_merge($roomInc, $roomList)); $starInc = $this->getParam('STARINC'); $starGroups = $this->getParam('STARS'); $starList = []; if ($starGroups) { $starList = $this->getStarsByGroups($starGroups); if (!$starList) { return $return; } } $starList = array_unique(array_merge($starInc, $starList)); $townList = $this->getParam('TOWNS'); $typeList = $this->getParam('HOTELTYPES'); $hotels = $this->getParam('HOTELS'); $hotelList = $this->hotelList($townList, $starList, $typeList); if (!$hotelList && ($hotels || $townList || $starList || $typeList)) { if (!($this->_callback && $this->getParam('SHOW_THEBEST'))) { return $return; } } $this->check_momentconfirm = (bool)$this->config('CHECK_MOMENTCONFIRM', 'online_config'); if ($token = Samo_Request::get('oauth_token')) { $this->setParams('FORM', 'ROBOT:' . $token); } $params = [ 'CHECKIN_BEG' => $this->getParam('CHECKIN_BEG'), 'CHECKIN_END' => $this->getParam('CHECKIN_END'), 'NIGHTMIN' => $this->getParam('NIGHTS_FROM'), 'NIGHTMAX' => $this->getParam('NIGHTS_TILL'), 'SEARCH_BY_HOTEL_NIGHTS' => $this->getConfig('SEARCH_BY_HOTEL_NIGHTS', 'online_config', 0), 'MEALLIST' => $mealList ? implode(',', $mealList) : null, 'ROOMLIST' => $roomList ? implode(',', $roomList) : null, 'STARLIST' => $starList ? implode(',', $starList) : null, 'HOTELLIST' => ($hotelList) ? implode(',', $hotelList) : null, 'ADULT' => $this->getParam('ADULT'), 'CHILD' => $this->getParam('CHILD'), 'COSTMIN' => $this->getParam('COSTMIN'), 'COSTMAX' => $this->getParam('COSTMAX'), 'FILTER' => $this->getFilter(), 'UFILTER' => $this->getUFILTER(), 'PRICE_PAGE' => ($page = $this->getParam('PRICEPAGE')) ? $page : 1, 'SORT_TYPE' => $this->getParam('SORT_TYPE'), 'RecOnPage' => ($recOnPage = $this->getParam('REC_ON_PAGE')) ? $recOnPage : $this->getConfig('REC_ON_PAGE'), 'CATALOGDB' => $this->CATALOGDB, 'TOUR' => $this->getParam('TOURINC'), 'MAXRECORD' => $this->getParam('MAXRECORD'), 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'PTYPE' => $ptype, 'ROOM' => ($room = $this->getParam('ROOMINC')) ? reset($room) : null, 'HTPLACE' => $this->getParam('HTPLACEINC'), 'TOWNTO' => ($townList) ? implode(',', $townList) : null, 'CURRENCY' => $currency, 'HOTELS_ANY' => $this->getParam('HOTELS_ANY'), 'PARTITION_PRICE' => $this->getParam('PARTITION_PRICE'), 'UserCode' => $this->internet_user(), ]; if (($child = $this->getParam('CHILD')) && ($ages = $this->getParam('AGES'))) { for ($i = 1; $i <= min(3, $child); $i++) { $age = array_shift($ages); $params['AGE' . $i] = $age; } } $registry = Samo_Registry::instance(); $logger = (isset($registry['logger'])) ? $registry['logger'] : null; $priceCache = Samo_Loader::load_object('Samo_Price_Cache', $this->config, $logger); $form = (($form = $this->getParam('FORM')) ? $form : 'PRICE') . (DEBUG ? '[DEBUG]' : ''); if (false === ($return = $priceCache->searchResult($params))) { $return = ['prices' => []]; $params['FORM'] = $form; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_3_search_Price', $params); if (false !== ($res = $this->db->query($sql))) { if (false !== ($rows = $this->db->fetchAll($res))) { if (null === $this->_cacheRates) { $this->_cacheRates = $this->getCurrencyRates(); } $this->can_cross_freight_classes = (bool)$this->config('FREIGHT_CROSS_CLASSES', 'bron'); $show_old_price = (bool)$this->config('SHOW_OLD_PRICE', 'online_config'); $surcharge_count = 0; $max_pages = 0; $currency = $this->currency(); $packetAttributes = $this->_getPacketAttributes(); $orderToUseLname = $this->getConfig('ORDER_BY_NAME') == 0 ? true : false; foreach ($rows as $row) { if (empty($return['prices'])) { if (isset($row['error']) && in_array($row['error'], [2, 101, 102])) { $return['part'] = true; } elseif (isset($row['result']) && $row['result']) { $return['part'] = true; } else { $return['part'] = false; } } if (isset($row['error'])) { $return['error'] = $row['error']; $return['errorParam'] = $row['error_param']; break; } if (isset($row['HotelInc'])) { $mapHotel[$row['HotelInc']][] = count($return['prices']); } foreach ($this->frclasses as $class => $count) { $this->setFreightAvail($class, 'in', $row); $this->setFreightAvail($class, 'out', $row); } foreach (['busines', 'comfort', 'premium'] as $key) { $key_base_in = ucfirst(strtolower($key)) . 'In'; $key_base_out = ucfirst(strtolower($key)) . 'Out'; $surcharge_in = $row[$key_base_in] ? $this->getSurcharge($row, $key, 'in', 'surcharge_arrival') : null; $surcharge_out = $row[$key_base_out] ? $this->getSurcharge($row, $key, 'out', 'surcharge_departure') : null; if ($surcharge_in || $surcharge_out) { $surcharge_currency = [ 'Inc' => ($surcharge_in) ? $row['cInc_surcharge_arrival'] : $row['cInc_surcharge_departure'], 'Alias' => ($surcharge_in) ? $row['cAlias_surcharge_arrival'] : $row['cAlias_surcharge_departure'], ]; $row['freights'][$key]['surcharge']['total'] = [ 'price' => $this->roundPrice($surcharge_in + $surcharge_out), 'currencyAlias' => $surcharge_currency['Alias'], 'currencyKey' => $surcharge_currency['Inc'], 'converted' => $this->convertPrice($surcharge_in + $surcharge_out, $surcharge_currency['Inc'], $currency, $surcharge_currency['Alias']), ]; $surcharge_count++; } else { unset($row['freights'][$key]['surcharge']); } } $row = $this->checkPrice($row); foreach ($this->frclasses as $class => $count) { $this->frclasses[$class] = $count + $row[$class]; } $bron = isset($row['bron']) ? $row['bron'] : 0; $price = isset($row['Price']) ? $row['Price'] : null; $priceOld = (isset($row['PriceOld']) && $bron) ? $row['PriceOld'] : null; $convertedPrice = $this->convertPrice($price, $row['currencyInc'], $currency, $row['currencyAlias']); $result = [ 'id' => isset($row['Cat_Claim']) ? $row['Cat_Claim'] : null, 'claim' => null, 'checkIn' => isset($row['CheckIn']) ? $row['CheckIn'] : null, 'checkOut' => isset($row['CheckOut']) ? $row['CheckOut'] : null, 'nights' => isset($row['Nights']) ? $row['Nights'] : null, 'hnights' => isset($row['HNights']) ? $row['HNights'] : null, 'adult' => isset($row['Adult']) ? $row['Adult'] : null, 'child' => isset($row['Child']) ? $row['Child'] : null, 'tour' => $this->nameOrLname($row, 'Tour', $orderToUseLname), 'tourAlt' => isset($row['TourName']) ? $row['TourName'] : null, 'tourKey' => isset($row['TourInc']) ? $row['TourInc'] : null, 'tourRequest' => isset($row['TourRequest']) ? $row['TourRequest'] : null, 'tourUrl' => isset($row['TourUrl']) ? Samo_Url::parse($row['TourUrl']) : null, 'programType' => $this->nameOrLname($row, 'ProgramType', $orderToUseLname), 'programTypeAlt' => isset($row['ProgramTypeLName']) ? $row['ProgramTypeLName'] : null, 'programTypeKey' => isset($row['ProgramTypeInc']) ? $row['ProgramTypeInc'] : null, 'programTypeUrl' => isset($row['ProgramTypeUrl']) ? $row['ProgramTypeUrl'] : null, 'programTypeOld' => $this->nameOrLname($row, 'ProgramTypeOld', $orderToUseLname), 'programTypeOldAlt' => isset($row['ProgramTypeOldLName']) ? $row['ProgramTypeOldLName'] : null, 'programTypeOldKey' => isset($row['ProgramTypeOldInc']) ? $row['ProgramTypeOldInc'] : null, 'programTypeOldUrl' => isset($row['ProgramTypeOldUrl']) ? $row['ProgramTypeOldUrl'] : null, 'partnerIncoming' => isset($row['PartnerIncomingLName']) ? $row['PartnerIncomingLName'] : null, 'partnerIncomingAlt' => isset($row['PartnerIncomingName']) ? $row['PartnerIncomingName'] : null, 'partnerIncomingKey' => isset($row['PartnerIncomingInc']) ? $row['PartnerIncomingInc'] : null, 'town' => $this->nameOrLname($row, 'HotelTown', $orderToUseLname), 'townAlt' => isset($row['HotelTownName']) ? $row['HotelTownName'] : null, 'townKey' => isset($row['TownInc']) ? $row['TownInc'] : null, 'hotel' => isset($row['HotelLName']) ? $row['HotelLName'] : null, 'hotelAlt' => isset($row['HotelName']) ? $row['HotelName'] : null, 'hotelKey' => isset($row['HotelInc']) ? $row['HotelInc'] : null, 'hotelAvailability' => isset($row['HotelAvailability']) ? $row['HotelAvailability'] : null, 'star' => $this->nameOrLname($row, 'Star', $orderToUseLname), 'starAlt' => isset($row['StarName']) ? $row['StarName'] : null, 'starKey' => isset($row['StarInc']) ? $row['StarInc'] : null, 'starGroup' => isset($row['GroupStarName']) ? $row['GroupStarName'] : null, 'starGroupAlt' => isset($row['GroupStarName']) ? $row['GroupStarName'] : null, 'starGroupKey' => isset($row['GroupStarInc']) ? $row['GroupStarInc'] : null, 'meal' => $this->nameOrLname($row, 'Meal', $orderToUseLname), 'mealAlt' => isset($row['MealName']) ? $row['MealName'] : null, 'mealKey' => isset($row['MealInc']) ? $row['MealInc'] : null, 'mealNote' => isset($row['MealNote']) ? $row['MealNote'] : null, 'mealUrl' => isset($row['MealUrl']) ? $row['MealUrl'] : null, 'mealGroup' => isset($row['GroupMealName']) ? $row['GroupMealName'] : null, 'mealGroupAlt' => isset($row['GroupMealName']) ? $row['GroupMealName'] : null, 'mealGroupKey' => isset($row['GroupMealInc']) ? $row['GroupMealInc'] : null, 'room' => $this->nameOrLname($row, 'Room', $orderToUseLname), 'roomAlt' => isset($row['RoomName']) ? $row['RoomName'] : null, 'roomKey' => isset($row['RoomInc']) ? $row['RoomInc'] : null, 'htPlace' => $this->nameOrLname($row, 'HtPlace', $orderToUseLname), 'htPlaceAlt' => isset($row['HtPlaceName']) ? $row['HtPlaceName'] : null, 'htPlaceKey' => isset($row['HtPlaceInc']) ? $row['HtPlaceInc'] : null, 'priceOld' => ($show_old_price && $price < $priceOld) ? $priceOld : null, 'price' => $price, 'currency' => isset($row['currencyAlias']) ? $row['currencyAlias'] : null, 'currencyKey' => isset($row['currencyInc']) ? $row['currencyInc'] : null, 'convertedPriceOld' => ($show_old_price && $price < $priceOld) ? $this->convertPrice($priceOld, $row['currencyInc'], $currency, $row['currencyAlias']) : null, 'convertedPrice' => $convertedPrice, 'convertedCurrencyKey' => $currency, 'convertedPriceNumber' => intval($convertedPrice), 'spo' => isset($row['FullNumber']) ? $row['FullNumber'] : null, 'spoKey' => isset($row['Spog']) ? $row['Spog'] : null, 'spoNote' => isset($row['SpogNote']) ? $row['SpogNote'] : null, 'spoMaxCommission' => isset($row['SpogMaxCommission']) ? $row['SpogMaxCommission'] : null, 'spoFixCommission' => isset($row['SpogFixCommission']) ? $row['SpogFixCommission'] : null, 'spoAddCommission' => isset($row['SpogAddCommission']) ? $row['SpogAddCommission'] : null, 'spoEarlyBooking' => isset($row['SpogEarlyBooking']) ? $row['SpogEarlyBooking'] : null, 'stopSale' => isset($row['StopSaleHotel']) && $row['StopSaleHotel'], 'StopSaleDateBeg' => isset($row['StopSaleDateBeg']) && $row['StopSaleDateBeg'] ? $row['StopSaleDateBeg'] : null, 'StopSaleDateEnd' => isset($row['StopSaleDateEnd']) && $row['StopSaleDateEnd'] ? $row['StopSaleDateEnd'] : null, 'stopSpog' => isset($row['StopSaleSpog']) && $row['StopSaleSpog'] > 0, 'spoValid' => isset($row['ValidDate']) ? $row['ValidDate'] : null, 'spoDateEnd' => isset($row['SpogDateEnd']) ? $row['SpogDateEnd'] : null, 'packetType' => isset($row['Packet_Type']) ? $row['Packet_Type'] : null, 'hotelUrl' => isset($row['WWW']) ? ((strpos($row['WWW'], 'http') === 0) ? Samo_Url::parse($row['WWW']) : $row['WWW']) : null, 'attributes' => [], 'listTime' => isset($row['ListTime']) ? $row['ListTime'] : null, 'bron' => $bron ? $bron : null, 'momentConfirm' => isset($row['daynoconfirm']) ? ($row['daynoconfirm'] === 0) : false, 'crossTour' => isset($row['CrossTour']) ? $row['CrossTour'] : null, 'best' => isset($row['the_best']) ? $row['the_best'] : null, 'paymentschedule' => isset($row['paymentschedule']) ? $row['paymentschedule'] : null, 'stats' => ($this->show_stats_link && null != $row['Cat_Claim']), 'color' => isset($row['color']) ? $row['color'] : null, 'freights' => isset($row['freights']) ? $row['freights'] : null, 'townFromKey' => $this->getParam('TOWNFROMINC'), 'stateKey' => $this->getParam('STATEINC'), 'note' => $this->getNote($row), 'from_the_best' => isset($row['from_the_best']) ? $row['from_the_best'] : null, 'roomNote' => isset($row['roomNote']) ? $row['roomNote'] : null, 'packetAttributes' => $this->processPacketAttributes($row, $packetAttributes), ]; if (version_compare(Samo_Request::api_version(), '2.0') >= 0) { $result['checkIn'] = $result['checkIn']->format('Y-m-d'); $result['checkOut'] = $result['checkOut']->format('Y-m-d'); $result['spoValid'] = $result['spoValid']->format('Y-m-d'); $result['spoDateEnd'] = $result['spoDateEnd']->format('Y-m-d'); } $max_pages = max($max_pages, (isset($row['Pages']) ? $row['Pages'] : 1)); $return['prices'][] = $result; } $return['pager'] = [ 'current' => ($current = $this->getParam('PRICEPAGE')) ? $current : 1, 'total' => $max_pages, ]; if (!empty($mapHotel)) { $this->setTypeIcons($mapHotel, $return); } $this->setProgramTypeIcons($return); if (!empty($return['prices'])) { foreach ($this->frclasses as $class => $count) { $return['freights'][$class] = ($count > 0); } $return['surcharge'] = ($surcharge_count > 0); } } } $priceCache->saveResult($return); } elseif (1 == $this->config('EnableStats', 'search')) { $params['duration'] = round((microtime(true) - $_SERVER['REQUEST_TIME_FLOAT']) * 1000); $params['cached'] = 1; $params['FORM'] = $form; $sql = $this->db->formatExec('<ONLINEDB>.dbo.up_WEB_3_search_Price_stats', $params); $res = $this->db->query($sql); $this->db->freeResult($res); } if (isset($return['prices']) && count($return['prices'])) { foreach ($return['prices'] as &$price) { if ($currency != $price['convertedCurrencyKey']) { $price['convertedCurrencyKey'] = $currency; $price['convertedPriceOld'] = $this->convertPrice($price['priceOld'], $price['currencyKey'], $currency); $price['convertedPrice'] = $this->convertPrice($price['price'], $price['currencyKey'], $currency); $price['convertedPriceNumber'] = intval($price['convertedPrice']); } if (strpos($price['hotelUrl'], 'http') !== 0) { $price['hotelUrl'] = Samo_Url::parse($price['hotelUrl']); } } } return $return; } protected function processPacketAttributes($row, $packetAttributes) { $return = []; foreach ($packetAttributes as $attribute => $meta) { if (isset($row[$attribute]) && $row[$attribute] == 1) { $return[] = $meta; } } return $return; } protected function _getPACKET() { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_4_search_PacketContent', [ 'Cat_Claim' => $this->getParam('CATCLAIM'), 'UserCode' => $this->internet_user(), ] ); $return = []; if (false !== ($res = $this->db->fetchAll($sql))) { $types = ['H' => 'hotel', 'F' => 'freight', 'I' => 'insure', 'S' => 'service', 'V' => 'visa']; foreach ($res as $row) { $return[] = [ 'type' => isset($types[$row['Type']]) ? $types[$row['Type']] : null, 'name' => $row['LName'], 'nameAlt' => $row['Name'], 'id' => $row['Inc'], 'dateBeg' => $row['DateBeg'], 'dateEnd' => $row['DateEnd'], 'url' => Samo_Url::parse($row['Www']), 'color' => $row['stopsale'] ? 'red' : 'white', ]; } } return $return; } protected function _getPAYMENTS_SCHEDULE() { $result = []; $sql = $this->db->formatExec( '<OFFICEDB>.[dbo].[up_WEB_3_payment_schedule]', [ 'Cat_Claim' => $this->getParam('CATCLAIM'), ] ); if ($data = $this->db->fetchAll($sql)) { foreach ($data as $row) { $result[] = [ 'date' => $row['pdate'], 'percent' => $row['percent'], ]; } } return $result; } protected function _getADDITIONAL_SERVICES() { if (false !== ($offer = $this->_prepareOffer($tourinfo))) { $currency = $this->currency(); $old = $new = []; if (false !== ($tmp = $offer->available_services($new, $old, 1, 1))) { $rate = 1; if ($rates = $this->getCurrencyRates()) { if (isset($rates[$tourinfo['Currency']]) && isset($rates[$tourinfo['Currency']][$currency])) { $rate = $rates[$tourinfo['Currency']][$currency]; $tourinfo['Currency'] = $currency; $tourinfo['Alias'] = $rates[$tourinfo['Currency']]['Name']; } } $result = []; $calc_price = $this->getConfig('SHOW_COST_SERVICE_REQUIRED', 'bron'); foreach ($tmp as $row) { if ($row['Packet'] == false) { if (!isset($result[$row['ServiceTypeInc']])) { $result[$row['ServiceTypeInc']] = [ 'id' => $row['ServiceTypeInc'], 'name' => $row['ServiceTypeLName'], 'nameAlt' => $row['ServiceTypeName'], 'services' => [], ]; } $result[$row['ServiceTypeInc']]['services'][] = [ 'id' => $row['ServiceInc'], 'name' => $row['ServiceName'], 'nameAlt' => $row['ServiceName'], 'title' => $this->getServiceTitle($row, 'LName'), 'titleAlt' => $this->getServiceTitle($row, 'Name'), 'dateBeg' => $row['DateBeg'], 'dateEnd' => $row['DateEnd'], 'Required' => $row['Required'], 'townSrc' => $row['SrcTownLName'], 'townSrcAlt' => $row['SrcTownName'], 'townSrcKey' => $row['SrcTownInc'], 'townTrg' => $row['TrgTownLName'], 'townTrgAlt' => $row['TrgTownName'], 'townTrgKey' => $row['TrgTownInc'], 'hotel' => $row['HotelLName'], 'hotelAlt' => $row['HotelName'], 'hotelKey' => $row['HotelInc'], 'meal' => $row['MealLName'], 'mealAlt' => $row['MealName'], 'mealKey' => $row['MealInc'], 'airline' => $row['AirlineLName'], 'airlineAlt' => $row['AirlineName'], 'airlineKey' => $row['AirlineInc'], 'url' => $row['ServiceUrl'], 'price' => (!$row['Packet'] && !$row['Required']) ? $this->roundPrice($row['price'] * $rate) : ($calc_price && !$row['Packet'] ? $this->roundPrice($row['price'] * $rate) : ''), 'currency' => $tourinfo['Alias'], 'currencyKey' => $tourinfo['Currency'], ]; } } return array_values($result); } } return false; } private function _prepareOffer(&$tourinfo) { $claim = $this->getParam('CATCLAIM'); if (!$claim) { return false; } $packetInfo = Samo_Loader::load_object('Packet_Info', $this->config); $find_by_cat_claim_result = $packetInfo->find_by_cat_claim($claim, null); if ($find_by_cat_claim_result) { $tourinfo = $packetInfo->instance(); $claimDocument['peoples'] = []; for ($i = 1; $i < $tourinfo['Adult'] + $tourinfo['Child'] + $tourinfo['Infant'] + 1; $i++) { if ($i - 1 < $tourinfo['Adult']) { $human = 'MRS'; } elseif ($i - 1 < $tourinfo['Adult'] + $tourinfo['Child']) { $human = 'CHD'; } elseif ($i - 1 < $tourinfo['Adult'] + $tourinfo['Child'] + $tourinfo['Infant']) { $human = 'INF'; } $claimDocument['peoples'][] = [ 'key' => $i, 'human' => $human, 'sex' => 0, 'bornplaceKey' => Samo::MAXLONGINT, 'nationalityKey' => Samo::MAXLONGINT, ]; } $clients = []; for ($i = 1; $i < $tourinfo['PeopleCount'] + 1; $i++) { $clients[] = [ 'peopleKey' => $i, 'common' => -$i, ]; } $claimDocument['transports'] = []; $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_4_bron_PacketFreight', [ 'Cat_Claim' => $tourinfo['Cat_Claim'], 'UserCode' => $this->internet_user(), ] ); if (false !== ($packetFreight = $this->db->fetchAll($sql))) { $freightin = null; foreach ($packetFreight as $idx => $routeinfo) { $last = ($idx == (count($packetFreight) - 1)); $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_5_bron_FreightOnline', [ 'Cat_Claim' => $tourinfo['Cat_Claim'], 'TOUR' => $tourinfo['TourInc'], 'DateBeg' => $routeinfo['DateBeg'], 'DateEnd' => $routeinfo['DateEnd'], 'Source' => $routeinfo['Source'], 'Target' => $routeinfo['Target'], 'SPOG' => $tourinfo['Spog'], 'ROUTEINDEX' => $routeinfo['RouteIndex'], 'FREIGHTIN' => ($last) ? $freightin : null, 'NIGHTS' => $tourinfo['Nights'], 'PEOPLECOUNT' => $tourinfo['PeopleCount'], 'crosstour' => $tourinfo['crosstour'], 'business' => null, 'STOPTIME' => null, 'UserCode' => $this->internet_user(), 'PacketClass' => $routeinfo['Class'], ] ); if (false !== ($freights = $this->db->fetchAll($sql))) { foreach ($freights as $freight) { if (null === $freightin) { $freightin = $freight['Inc']; } $claimDocument['transports'][] = [ 'key' => $freight['Inc'], 'classKey' => $freight['ClassInc'], 'frplaceKey' => $freight['FrPlaceInc'], 'datebeg' => $freight['DateBeg'], 'dateend' => $freight['DateEnd'], 'count' => $tourinfo['PeopleCount'], 'addinfant' => 0, 'clients' => $clients, 'partner' => $freight['Partner'], ]; } } } } $res = $this->db->exec( '<OFFICEDB>.dbo.up_WEB_5_bron_PacketHotel', [ 'Cat_Claim' => $tourinfo['Cat_Claim'], 'UserCode' => $this->internet_user(), ], true ); if (false !== $res) { $clients_hotel = array_map( function ($el) { $el['common'] = -1; return $el; }, $clients ); while (false !== ($hotel = $this->db->fetchRow($res))) { if ($hotel['StopSale']) { throw new Bron_Exception(sprintf($this->messages('TOUR_HOTEL_STOPSALE'), $hotel['HotelLName']), 6); } $claimDocument['hotels'][] = [ 'key' => $hotel['HotelInc'], 'roomKey' => $hotel['RoomInc'], 'htplaceKey' => $hotel['HtPlaceInc'], 'datebeg' => $hotel['DateBeg'], 'dateend' => $hotel['DateEnd'], 'count' => 1, 'mealKey' => $hotel['MealInc'], 'addinfant' => 0, 'routeIndex' => $hotel['RouteIndex'], 'clients' => $clients_hotel, 'partner' => $hotel['Partner'], ]; } $this->db->freeResult($res); } $claimDocument['services'] = []; $res = $this->db->exec( '<OFFICEDB>.dbo.up_WEB_4_bron_PacketService', [ 'Cat_Claim' => $tourinfo['Cat_Claim'], 'UserCode' => $this->internet_user(), ], true ); if (false !== $res) { while (false !== ($service = $this->db->fetchRow($res))) { $claimDocument['services'][] = [ 'type' => 'stOther', 'key' => $service['ServiceInc'], 'datebeg' => $service['DateBeg'], 'dateend' => $service['DateEnd'], 'count' => $tourinfo['PeopleCount'], 'mealKey' => $service['MealInc'], 'addinfant' => 0, 'hotelKey' => $service['HotelInc'], 'departureTownKey' => $service['SrcTownInc'], 'arrivalTownKey' => $service['TrgTownInc'], 'transportCompanyKey' => $service['AirlineInc'], 'classKey' => $service['ClassInc'], 'routeIndex' => $service['RouteIndex'], 'packet' => 1, 'clients' => $clients, 'partner' => $service['Partner'], 'serviceTypeKey' => $service['ServiceTypeInc'], 'serviceCategoryKey' => $service['ServiceCategoryInc'], ]; } } $offer = Samo_Loader::load_object('Bron_Claim', $this->config, Samo_Loader::load_object('Packet_Info', $this->config)->load_from_array($tourinfo), 0); $offer->load_from_array($claimDocument); $offer->partpass = null; $offer->internet_partner = $this->getConfig('INTERNET_PARTNER'); $offer->calctype = 0; $offer->cat_claim = $claim; return $offer; } return false; } protected function _getPRICE_DYNAMICS() { $catClaim = $this->getParam('CATCLAIM'); $sql = $this->db->formatExec( '<ONLINEDB>.[dbo].[up_WEB_3_search_PriceInfo]', [ 'TOWNFROM' => $this->getParam('TOWNFROMINC'), 'STATE' => $this->getParam('STATEINC'), 'CURRENCY' => $this->currency(), 'CATALOGDB' => $this->CATALOGDB, 'Cat_Claim' => $catClaim, ] ); $orderToUseLname = $this->getConfig('ORDER_BY_NAME') == 0 ? true : false; $result = []; if ($info = $this->db->fetchRow($sql)) { $defaults = $this->defaults; $datebeg = $info['CheckIn']; $this->setParams('CHECKIN_BEG', $info['hotelCheckIn']); $this->setParams('CHECKIN_END', $info['hotelCheckIn']); $this->setParams('HOTELS', $info['HotelInc']); $this->setParams('PROGRAMINC', $info['Ptype']); $nights = $info['Nights']; $hnights = $info['HNights']; $this->setParams('NIGHTS_FROM', $hnights); $this->setParams('NIGHTS_TILL', $hnights); $this->setParams('MEALINC', $info['MealInc']); $this->setParams('ROOMINC', $info['RoomInc']); $this->setParams('ADULT', $info['Adult']); $this->setParams('CHILD', $info['Child']); $this->setParams('TOURINC', $info['TourInc']); $this->setParams('HTPLACEINC', $info['HtPlaceInc']); $this->setParams('PACKET', $info['Packet']); $info['convertedPrice'] = $this->convertPrice($info['Price'], $info['CurrencyPrice'], $info['CurrencyInc'], $info['CurrencyAlias']); $result = [ 'id' => $catClaim, 'townFrom' => $this->nameOrLname($info, 'TownFrom', $orderToUseLname), 'townFromAlt' => isset($info['TownFromName']) ? $info['TownFromName'] : null, 'townFromKey' => isset($info['TownFromInc']) ? $info['TownFromInc'] : null, 'state' => $this->nameOrLname($info, 'State', $orderToUseLname), 'stateAlt' => isset($info['StateName']) ? $info['StateName'] : null, 'stateKey' => isset($info['StateInc']) ? $info['StateInc'] : null, 'tour' => $this->nameOrLname($info, 'Tour', $orderToUseLname), 'tourAlt' => isset($info['TourName']) ? $info['TourName'] : null, 'tourKey' => isset($info['TourInc']) ? $info['TourInc'] : null, 'tourUrl' => isset($info['TourUrl']) ? Samo_Url::parse($info['TourUrl']) : null, 'spog' => isset($info['SpogInc']) ? $info['SpogInc'] : null, 'programTypeKey' => isset($info['programTypeKey']) ? $info['programTypeKey'] : null, 'programTypeUrl' => isset($info['ProgramTypeUrl']) ? $info['ProgramTypeUrl'] : null, 'programType' => isset($info['programType']) ? $info['programType'] : null, 'programTypeIcon' => isset($info['programTypeIcon']) ? $info['programTypeIcon'] : null, 'programTypeNote' => isset($info['programTypeNote']) ? $info['programTypeNote'] : null, 'datebeg' => $datebeg->copy(), 'dateout' => isset($info['DateOut']) ? $info['DateOut'] : null, 'nights' => $nights, 'hnights' => $hnights, 'adult' => $this->getParam('ADULT'), 'child' => $this->getParam('CHILD'), 'hotel' => isset($info['HotelLName']) ? $info['HotelLName'] : null, 'hotelAlt' => isset($info['HotelName']) ? $info['HotelName'] : null, 'hotelKey' => isset($info['HotelInc']) ? $info['HotelInc'] : null, 'hotelUrl' => isset($info['HotelUrl']) ? Samo_Url::parse($info['HotelUrl']) : null, 'hotelNote' => isset($info['HotelNote']) ? $info['HotelNote'] : null, 'star' => $this->nameOrLname($info, 'Star', $orderToUseLname), 'starAlt' => isset($info['StarName']) ? $info['StarName'] : null, 'starKey' => isset($info['StarInc']) ? $info['StarInc'] : null, 'meal' => $this->nameOrLname($info, 'Meal', $orderToUseLname), 'mealAlt' => isset($info['MealName']) ? $info['MealName'] : null, 'mealKey' => isset($info['MealInc']) ? $info['MealInc'] : null, 'mealNote' => isset($info['MealNote']) ? $info['MealNote'] : null, 'room' => $this->nameOrLname($info, 'Room', $orderToUseLname), 'roomAlt' => isset($info['RoomName']) ? $info['RoomName'] : null, 'roomKey' => isset($info['RoomInc']) ? $info['RoomInc'] : null, 'htPlace' => $this->nameOrLname($info, 'HtPlace', $orderToUseLname), 'htPlaceAlt' => isset($info['HtPlaceName']) ? $info['HtPlaceName'] : null, 'htPlaceKey' => isset($info['HtPlaceInc']) ? $info['HtPlaceInc'] : null, 'packet' => isset($info['Packet']) ? $info['Packet'] : $this->getParam('PACKET'), 'currency' => isset($info['CurrencyAlias']) ? $info['CurrencyAlias'] : null, 'currencyKey' => isset($info['CurrencyInc']) ? $info['CurrencyInc'] : null, 'crossTour' => isset($info['CrossTour']) ? $info['CrossTour'] : null, 'minPrice' => 0, 'maxPrice' => 0, 'minPercent' => ($minPercent = $this->getParam('MIN_PERCENT')) ? $minPercent : 0.15, 'maxHeight' => ($maxHeight = $this->getParam('MAX_HEIGHT')) ? $maxHeight : 85, 'prices' => [], 'months' => [], 'Price' => isset($info['Price']) ? $info['Price'] : null, 'convertedPrice' => $info['convertedPrice'], 'HotelCheckinTime' => $info['HotelCheckinTime'], 'HotelCheckoutTime' => $info['HotelCheckoutTime'], 'stopSale' => false, 'StopSaleDateBeg' => null, 'StopSaleDateEnd' => null, 'gdsUse' => $info['gdsUse'], ]; if ($result['crossTour'] == false) { $this->defaults['FREIGHT'] = 0; $this->defaults['FILTER'] = 0; $this->defaults['MOMENT_CONFIRM'] = 0; $this->defaults['CHILD_IN_BED'] = 0; $this->defaults['REC_ON_PAGE'] = ($count = $this->getParam('COUNT')) ? $count : 50; $this->setParams('NIGHTS_FROM', $info['Nights']); $this->setParams('NIGHTS_TILL', $info['Nights']); $this->defaults['ACTION'] = 'STATS'; if (($data = $this->_getPRICES()) && !empty($data['prices'])) { $first = reset($data['prices']); $minPrice = $maxPrice = $result['minPrice'] = $result['maxPrice'] = $first['price']; $_price = null; foreach ($data['prices'] as $price) { $minPrice = ($price['price'] < $minPrice) ? $price['price'] : $minPrice; $maxPrice = ($price['price'] > $maxPrice) ? $price['price'] : $maxPrice; if ($price['id'] == $catClaim && $price['stopSale']) { $result['stopSale'] = true; $result['StopSaleDateBeg'] = $price['StopSaleDateBeg']; $result['StopSaleDateEnd'] = $price['StopSaleDateEnd']; } if (null === $_price && ($price['id'] == $catClaim || $price['checkIn']->eq($result['datebeg']))) { $_price = $price; $result['id'] = $price['id']; } } $result['minPrice'] = $this->convertPrice($minPrice, $first['currencyKey'], $this->currency(), $first['currency']); $result['maxPrice'] = $this->convertPrice($maxPrice, $first['currencyKey'], $this->currency(), $first['currency']); $price_parts = explode(' ', $first['convertedPrice']); $currency = end($price_parts); foreach ($data['prices'] as $price) { $result['prices'][] = [ 'id' => $price['id'], 'day' => $price['checkIn']->format('j'), 'checkIn' => $price['checkIn'], 'checkOut' => $price['checkOut'], 'nights' => $price['nights'], 'hnights' => $price['hnights'], 'price' => $price['price'], 'convertedPrice' => $price['convertedPrice'], 'convertedPriceNumber' => $price['convertedPriceNumber'], 'priceDiff' => $this->roundPrice($price['price'] - $_price['price']), 'convertedPriceDiff' => $this->roundPrice($price['convertedPriceNumber'] - $_price['convertedPriceNumber']) . ' ' . $currency, 'currency' => $price['currency'], 'currencyKey' => $price['currencyKey'], 'convertedCurrencyKey' => $price['convertedCurrencyKey'], 'color' => $price['color'] = (isset($price['bron']) && $price['bron'] == false && $price['color'] != 'red') ? 'pink' : ($price['color'] == 'blank' ? 'blank' : ($price['color'])), 'bron' => $price['bron'], 'note' => $price['note'], 'stopSale' => $price['stopSale'], 'stopSpog' => $price['stopSpog'], ]; } } } $hmon = $this->hotelMonitor($info); $result['hotel_monitor'] = $hmon; $this->defaults = $defaults; } return $result; } public function hotelMonitor($info) { $result = []; $checkin = $this->getParam('CHECKIN_BEG'); $nights = $this->getParam('NIGHTS_TILL'); $today = Samo_Datetime::today(); $start = $diff = $checkin->diff($today); $start = ($start - 2 >= 0) ? $start - 2 : (($start - 2 == -1) ? $start - 1 : 0); $length = $nights + ($start >= 2 ? 2 : ($start == 0 ? $diff : $start)) + 3; $sdays = substr($info['sdays_rest'], $start, $length); $strlen = strlen($sdays); for ($i = 0; $i < $strlen; $i++) { $date = $today->copy()->add_days($start + $i); if ($sdays[$i] > $info['BlockMaxValue']) { $status = 'Y'; } elseif ($sdays[$i] > $info['BlockMinValue'] && $sdays[$i] <= $info['BlockMaxValue']) { $status = 'F'; } elseif ($info['allow_overbooking']) { $status = 'R'; } else { $status = 'N'; } $result[$i] = [ 'date' => $date, 'status' => $status, ]; } return count($result) ? $result : false; } protected function _getCOMMISSIONS() { $result = []; if (false !== ($offer = $this->_prepareOffer($tourinfo))) { $claim = $this->getParam('CATCLAIM'); $currency = $this->getParam('CURRENCY'); $xml = $offer->claim_document(); $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_3_search_PartnerProfit', [ 'Cat_Claim' => $claim, 'Partner' => $this->getPartner(), 'INTERNET_PARTNER' => $this->getConfig('INTERNET_PARTNER'), 'Mediator' => $this->claim_mediator(), 'ClaimDocument' => $xml, 'currency_search' => $currency, 'debug' => 0, 'UserCode' => $this->internet_user(), ] ); if ($data = $this->db->fetchRow($sql)) { $commission = $data['Commission']; $result[] = ['title' => $this->messages('TOUR_COMMISSION_COMMISSION'), 'value' => $data['Commission'] . '%' . ($data['Commission_money'] > 0 ? '&nbsp;(' . $data['Commission_money'] . '&nbsp;' . $data['CurrencyAlias'] . ')' : '')]; if ($data['InternetPartnerCommission'] > 0) { $result[] = ['title' => $this->messages('TOUR_COMMISSION_INTERNET_PARTNER_COMMISSION'), 'value' => $data['InternetPartnerCommission'] . '%' . ($data['InternetPartnerCommission_money'] > 0 ? '&nbsp;(' . $data['InternetPartnerCommission_money'] . '&nbsp;' . $data['CurrencyAlias'] . ')' : '')]; } if ($data['EarlyCommission'] > 0) { $commission += $data['EarlyCommission']; $result[] = ['title' => $this->messages('TOUR_COMMISSION_EARLY_COMMISSION'), 'value' => $data['EarlyCommission'] . '%' . ($data['EarlyCommission_money'] > 0 ? '&nbsp;(' . $data['EarlyCommission_money'] . '&nbsp;' . $data['CurrencyAlias'] . ')' : '')]; } if ($data['MediatorCommission'] > 0) { $result[] = ['title' => $this->messages('TOUR_COMMISSION_MEDIATOR_COMMISSION'), 'value' => $data['MediatorCommission'] . '%' . ($data['MediatorCommission_money'] > 0 ? '&nbsp;(' . $data['MediatorCommission_money'] . '&nbsp;' . $data['CurrencyAlias'] . ')' : '')]; } if ($data['BonusValue'] > 0) { $result[] = ['title' => $this->messages('BONUS_VALUE'), 'value' => $data['BonusValue'] . '&nbsp;' . $data['CurrencyAlias']]; } } } return $result; } } 