<?php
 function smarty_function_imgload($params, &$smarty) { $HOST = (defined('ASSETS_HOST')) ? ASSETS_HOST : Samo_Request::host(); $currentWwwroot = $smarty->getTemplateVars('WWWROOT'); $WWWROOT = ($smarty->getTemplateVars('INTERNAL_FULL_PATHS') && strpos($currentWwwroot, 'http') !== 0) ? Samo_Request::scheme() . '://' . $HOST . $currentWwwroot : $currentWwwroot; $smarty->loadPlugin('smarty_shared_fileversion'); if (!isset($params['file']) || !strlen($params['file'])) { throw new Exception('imgload: param "file" not set'); } $base = (isset($params['base']) && file_exists(_ROOT . $params['base']) && is_dir(_ROOT . $params['base'])) ? $params['base'] : 'public/pict/'; $base = ($_base = trim($base, '/ ')) && !empty($_base) ? $_base . '/' : ''; $file = trim($params['file'], '/ '); $required = (isset($params['required'])) ? (bool)$params['required'] : true; $realFile = _ROOT . $base . $file; $return = ''; if (!file_exists($realFile) && isset($params['default'])) { $file = $params['default']; $realFile = _ROOT . $base . $file; } if (file_exists($realFile) && is_file($realFile) && getimagesize($realFile)) { $versionedFile = $file . smarty_fileversion($realFile); $path = $WWWROOT . $base . $versionedFile; $width = (isset($params['width']) && intval($params['width'])) ? ' width="' . intval($params['width']) . '"' : ''; $height = (isset($params['height']) && intval($params['height'])) ? ' height="' . intval($params['height']) . '"' : ''; $alt = (isset($params['title']) && strlen($params['title'])) ? ' title="' . Samo_String::set($params['title'])->safehtml() . '"' : ((isset($params['alt']) && strlen($params['alt'])) ? ' alt="' . Samo_String::set($params['alt'])->safehtml() . '"' : ' alt=""'); $class = (isset($params['class']) && strlen($params['class'])) ? ' class="' . Samo_String::set($params['class'])->safehtml() . '"' : ''; $attrs = (isset($params['attrs']) && strlen($params['attrs'])) ? ' ' . $params['attrs'] : ''; $br_after = (!isset($params['inline']) || $params['inline'] == false) ? '<br/>' : ''; $return = '<img src="' . $path . '" ' . $class . $width . $height . $alt . $attrs . '/>' . $br_after . PHP_EOL; } elseif ($required) { throw new Exception('imgload: file ' . $file . ' not exists'); } return $return; } 