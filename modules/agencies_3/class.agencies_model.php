<?php
 class Agencies_Model extends Samo { protected $api_name = 'Agencies_Api'; public function construct() { parent:: construct(); $this->defaults['INC'] = Samo_Utils::ifs(Samo_Request::intval('INC'), null); $this->defaults['QUERY'] = Samo_Utils::ifs(Samo_Request::get('QUERY'), null); $this->defaults['TOWN'] = Samo_Utils::ifs(Samo_Request::intval('TOWN'), null); $this->defaults['PARTNER'] = Samo_Utils::ifs(Samo_Request::intval('PARTNER'), null); $this->defaults['METROSTATION'] = Samo_Utils::ifs(Samo_Request::intval('METROSTATION'), null); } public function getTOWNS() { $result = $this->api()->getTOWNS(); $this->setSelected($result, $this->defaults['TOWN']); return $this->groupItems($this->searchTerms($result), 'state'); } public function getMETROSTATIONS() { $result = ($this->defaults['TOWN']) ? $this->api()->getMETROSTATIONS() : []; $this->setSelected($result, $this->defaults['METROSTATION']); return ["id" => 0, "name" => ""] + $this->groupItems($this->searchTerms($result), 'metroline'); } private function setSelected(&$items, $selected) { if (null !== $selected) { foreach ($items as &$item) { if ($item['id'] == $selected) { $item['selected'] = 1; } } } } private function searchTerms($towns) { if ($towns) { foreach ($towns as &$town) { $terms = []; foreach ($town as $value) { if (!intval($value)) { $terms[] = $value; } } $town['tags'] = array_unique($terms); } } return $towns; } private function groupItems($items, $groupKey) { if (!$items) { return $items; } $data = []; foreach ($items as $row) { if (!isset($data[$row[$groupKey]])) { $data[$row[$groupKey]] = []; } $data[$row[$groupKey]][] = $row; } return $data; } public function search() { $result = $this->api()->getSearch(); return $result; } public function info() { $result = $this->api()->getInfo(); return $result; } } 