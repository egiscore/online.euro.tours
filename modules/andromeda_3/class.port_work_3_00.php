<?php
 class port_work_3_00 extends port_work { public $version = '3.0'; protected $groupid = null; protected function getSTATE() { $model = $this->_loadModel('search'); if ($states = $model->getState( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'STATE'); foreach ($states as $state) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $state['id']); setAttribute($item, 'name', strConvert($state['nameAlt'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getTOWNFROM() { $model = $this->_loadModel('search'); if ($towns = $model->getTownFrom( array( 'STATEINC' => $this->_getDomNodeContentXPath('STATEINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'TOWNFROM'); foreach ($towns as $town) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $town['id']); setAttribute($item, 'name', strConvert($town['nameAlt'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getTOWN() { $model = $this->_loadModel('search'); if ($result = $model->getTown( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'TOWN'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['nameAlt'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getSTAR() { $model = $this->_loadModel('search'); if ($result = $model->getGroupStar( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false) ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'STAR'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['name'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getMEAL() { $model = $this->_loadModel('search'); if ($result = $model->getGroupMeal( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false) ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'MEAL'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['name'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getHOTEL() { $model = $this->_loadModel('search'); if ($result = $model->getHotel( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ), true ) ) { $stars = array(); $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'HOTEL'); foreach ($result as $row) { $stars[$row['starKey']] = $row['starAlt']; $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['nameAlt'])); setAttribute($item, 'categoryid', $row['starKey']); $starGroupList = $row['starGroupList']; $starGroupInc = is_array($starGroupList) ? $starGroupList : explode(',', $starGroupList); setAttribute($item, 'starid', strConvert(reset($starGroupInc))); setAttribute($item, 'townid', $row['townKey']); if ($starGroupList) { setAttribute($item, 'starlist', is_array($starGroupList) ? implode(',', $starGroupList) : $starGroupList); } if ($row['typeList']) { setAttribute($item, 'typelist', is_array($row['typeList']) ? implode(',', $row['typeList']) : $row['typeList']); } } $ds = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($ds, 'name', 'CATEGORY'); foreach ($stars as $id => $name) { $item = appendChild($ds, createElement($this->xml, 'i')); setAttribute($item, 'id', $id); setAttribute($item, 'name', strConvert($name)); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getCHECKIN() { $model = $this->_loadModel('search'); if ($result = $model->getCheckIn( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'CHECKIN'); foreach ($result['items'] as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'checkin', $row['checkin']); if ($row['selected']) { setAttribute($item, 'selected', 'true'); } } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getPACKETTYPE() { $model = $this->_loadModel('search'); if ($result = $model->getPacketType( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'PACKETTYPE'); foreach ($result as $row) { if ($row['available']) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $this->_convert_packet_type($row['id'])); setAttribute($item, 'name', strConvert($row['name'])); } } } return $this->xml; } protected function getHOTELTYPE() { $model = $this->_loadModel('search'); if ($result = $model->getHotelType( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'HOTELTYPE'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['nameAlt'])); if ($row['note']) { setAttribute($item, 'note', strConvert($row['note'])); } if ($row['icon']) { setAttribute($item, 'icon', strConvert($row['icon'])); } } } return $this->xml; } protected function getPROGRAM() { $model = $this->_loadModel('search'); if ($result = $model->getPrograms( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()'), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()', null), 'SPOINC' => $this->_getDomNodeContentXPath('SPO/text()', null), ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'PROGRAM'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['nameAlt'])); } } return $this->xml; } protected function getTOUR() { $model = $this->_loadModel('search'); if ($result = $model->getTour( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()'), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false) ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'TOUR'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['nameAlt'])); } } return $this->xml; } protected function getCURRENCY() { $model = $this->_loadModel('search'); if ($result = $model->getCurrency( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($ds, 'name', 'CURRENCY'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['id']); setAttribute($item, 'name', strConvert($row['alias'])); if (!empty($row['rates'])) { foreach ($row['rates'] as $r) { $rate = appendChild($item, createElement($this->xml, 'rate')); setAttribute($rate, 'id', $r['id']); setAttribute($rate, 'name', strConvert($r['alias'])); setAttribute($rate, 'nominal', $r['nominal']); setAttribute($rate, 'value', $r['value']); } } } } return $this->xml; } protected function getCURRENCYRATE() { $model = $this->_loadModel('search'); $result = $model->currencyRates(); if (count($result)) { $ds = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($ds, 'name', 'CURRENCYRATE'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['Inc']); setAttribute($item, 'name', strConvert($row['Name'])); $this->_compound_Rates($row['Inc'], $result, $item); } } return $this->xml; } protected function _compound_Rates($currency, $rates, $currencyNode) { if (isset($rates[$currency])) { foreach ($rates[$currency] as $currency_to => $rate) { if (isset($rates[$currency_to])) { $rate = array_merge($rates[$currency_to], array('Rate' => $rate)); $this->_compound_Rate($rate, $currencyNode); } } } return true; } protected function _compound_Rate($row, $currencyNode) { $rate = appendChild($currencyNode, createElement($this->xml, 'rate')); setAttribute($rate, 'id', $row['Inc']); setAttribute($rate, 'name', strConvert($row['Name'])); setAttribute($rate, 'nominal', 1); setAttribute($rate, 'value', $row['Rate']); return true; } protected function getDURATION() { $model = $this->_loadModel('search'); $result = $model->getNights( array( 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOURINC' => $this->_getDomNodeContentXPath('TOURINC/text()') ) ); if ($result) { $ds = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($ds, 'name', 'DURATION'); foreach ($result['nights'] as $nights) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'nights', $nights); if ($result['default']['from'] == $nights || $result['default']['till'] == $nights) { setAttribute($item, 'selected', true); } } } } protected function getALL() { $actions = array( 'CHECKIN', 'STAR', 'TOWN', 'HOTEL', 'MEAL', 'PACKETTYPE', 'HOTELTYPE', 'TOUR', 'PROGRAM', 'CURRENCY', 'DURATION', ); foreach ($actions as $action) { $res = $this->{'get' . $action}(); if (is_soap_fault($res)) { return ($res); } } return $this->xml; } protected function getPRICE() { $filter = $this->_getDomNodeContentXPath('FILTER/text()', 1) * 2; $model = $this->_loadModel('search'); $HOTELTYPES = $this->_getDomNodeContentXPath('HOTELTYPES/HOTELTYPE/text()'); if (!$HOTELTYPES) { $HOTELTYPES = $this->_getDomNodeContentXPath('TYPES/TYPE/text()'); } if ($result = $model->getPrices( array( 'SPOINC' => $this->_getDomNodeContentXPath('SPO/text()', null), 'CHECKIN_BEG' => $this->_getDomNodeContentXPath('CHB/text()', false, 'string'), 'CHECKIN_END' => $this->_getDomNodeContentXPath('CHE/text()', false, 'string'), 'HOTELS' => $this->_getDomNodeContentXPath('HOTELS/HOTEL/text()'), 'HOTELTYPES' => $HOTELTYPES, 'NIGHTS_FROM' => $this->_getDomNodeContentXPath('NIGHTMIN/text()', false), 'NIGHTS_TILL' => $this->_getDomNodeContentXPath('NIGHTMAX/text()', false), 'MEALS' => $this->_getDomNodeContentXPath('MEALS/MEAL/text()'), 'MEALINC' => $this->_getDomNodeContentXPath('MLS/ML/text()'), 'ADULT' => $this->_getDomNodeContentXPath('ADULT/text()', 2), 'CHILD' => $this->_getDomNodeContentXPath('CHILD/text()', 0), 'AGES' => $this->_getDomNodeContentXPath('AGES/AGE/text()'), 'CURRENCY' => $this->_getDomNodeContentXPath('CURRENCY/text()', null), 'COSTMIN' => $this->_getDomNodeContentXPath('COSTMIN/text()'), 'COSTMAX' => $this->_getDomNodeContentXPath('COSTMAX/text()'), 'PACKET' => $this->_convert_packet_type($this->_getDomNodeContentXPath('PACKETTYPE/text()')), 'FILTER' => (true == (2 & $filter)), 'FREIGHT' => (true == (4 & $filter)), 'THE_BEST' => (true == (64 & $filter)), 'ACTION' => (true == (128 & $filter)) ? 'STATS' : 'PRICES', 'MOMENT_CONFIRM' => (true == (512 & $filter)), 'TOURINC' => $this->_getDomNodeContentXPath('TOUR/text()', null), 'TOURS' => $this->_getDomNodeContentXPath('TOURS/TOUR/text()', null), 'PROGRAMINC' => $this->_getDomNodeContentXPath('PROGRAM/text()', null), 'TOWNFROMINC' => $this->TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false), 'STATEINC' => $this->STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false), 'TOWNTO' => $this->_getDomNodeContentXPath('TOWNS/TOWN/text()'), 'STARS' => $this->_getDomNodeContentXPath('STARS/STAR/text()'), 'STARINC' => $this->_getDomNodeContentXPath('SRS/SR/text()'), 'PRICEPAGE' => $this->_getDomNodeContentXPath('PRICE_PAGE/text()', 1), 'REC_ON_PAGE' => $this->_getDomNodeContentXPath('RPP/text()', null), 'PARTITION_PRICE' => $this->_getDomNodeContentXPath('GROUP_BY/text()', null) ) ) ) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); $this->_compoundPrices($result, $ds, 'i'); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function _compoundPrices($rows, $parentNode, $nodeName = 'price') { setAttribute($parentNode, 'name', 'PRICE'); foreach ($rows['prices'] as $row) { $node = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPrice($row, $node); } setAttribute($parentNode, 'pcount', $rows['pager']['total']); setAttribute($parentNode, 'more_maxrecord', $rows['result']); return true; } protected function _compoundPricePlaceStatus($price, $priceNode, $statusNodeName = 'ps') { $map = array(); $class_map = array( array(0, 'e', 'Econom', 'эконом'), array(1, 'b', 'Busines', 'бизнес'), array(2, 'c', 'Comfort', 'комфорт'), array(3, 'p', 'Premium', 'премиум'), ); foreach ((array)$price['freights'] as $key => $row) { $map[substr($key, 0, 1)] = $row; } foreach ($class_map as $class) { $place = appendChild($priceNode, createElement($this->xml, $statusNodeName)); setAttribute($place, 'classKey', $class[0]); setAttribute($place, 'class', strConvert($class[3])); setAttribute($place, 'in', $map[$class[1]]['in'] == 'Y' ? 1 : ($map[$class[1]]['in'] == 'N' ? 2 : 3)); setAttribute($place, 'out', $map[$class[1]]['out'] == 'Y' ? 1 : ($map[$class[1]]['out'] == 'N' ? 2 : 3)); setAttribute($place, 'directStatus', $map[$class[1]]['in']); setAttribute($place, 'backStatus', $map[$class[1]]['out']); if ($map[$class[1]]['surcharge']) { setAttribute($place, 'surcharge', round($map[$class[1]]['surcharge']['total']['price'])); } } return true; } protected function getCOUNTRY() { $model = $this->_loadModel('bron'); if ($result = $model->getCountry()) { $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'COUNTRY'); foreach ($result as $row) { $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $row['StateInc']); setAttribute($item, 'name', strConvert($row['StateLName'])); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getFREIGHT_FOR_BRON() { $CLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('CLAIM/text()', false, 'string')); $model = $this->_loadModel('bron'); $this->AUTH($model); $DIRECTION = $this->_getDomNodeContentXPath('DIRECTION/text()', 0); if ($DIRECTION == 0) { $FREIGHTIN = $this->_getDomNodeContentXPath('FREIGHTIN/text()'); $FREIGHTINPLACE = $this->_getDomNodeContentXPath('FRPLACE/text()'); } else { $FREIGHTIN = $this->_getDomNodeContentXPath('FREIGHTIN/text()', false); $FREIGHTINPLACE = $this->_getDomNodeContentXPath('FRPLACE/text()', false); } $model->setVar(array('catClaim' => $CLAIM)); if (!$row = $model->getPacketInfo()) { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } if ($DIRECTION != 0) { $freightIn = array( 'FreightInc' => $FREIGHTIN, 'OnlineClass' => $FREIGHTINPLACE, ); } else { $freightIn = false; } if ($freights = $model->getFreight($DIRECTION, $freightIn)) { $freights = array(array_shift($freights)); $ds = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($ds, 'name', 'FREIGHTS'); $this->_compoundPacketTransports($freights, $ds, 'i'); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function _calcsave() { if ($this->answerValue == 1) { $SAVE = 1; } else { $SAVE = 0; } return $SAVE; } protected function getCLAIM_LIST() { $model = $this->_loadModel('claim'); $this->AUTH($model); $CLAIMTYPE = $this->_getDomNodeContentXPath('CLAIMTYPE/text()', false, 'int'); $CLAIMBEG = $this->_getDomNodeContentXPath('CLAIMBEG/text()'); $CLAIMEND = $this->_getDomNodeContentXPath('CLAIMEND/text()'); $DATEBEG = $this->_getDomNodeContentXPath('DATEBEG/text()', null, 'date'); $DATEEND = $this->_getDomNodeContentXPath('DATEEND/text()', null, 'date'); $FIO = $this->_getDomNodeContentXPath('FIO/text()', null, 'string'); $PAGE = $this->_getDomNodeContentXPath('PAGE/text()'); $RPP = $this->_getDomNodeContentXPath('RPP/text()'); $CLAIMLIST = $this->_getDomNodeContentXPath('CLAIMS/CLAIM/text()'); $SELF = $this->_getDomNodeContentXPath('SELF/text()', null); $model->setVar( array( 'CLAIMTYPE' => $CLAIMTYPE, 'CLAIMBEG' => $CLAIMBEG, 'CLAIMEND' => $CLAIMEND, 'DATEBEG' => $DATEBEG, 'DATEEND' => $DATEEND, 'FIO' => $FIO, 'PAGE' => $PAGE, 'RPP' => $RPP, 'CLAIMLIST' => $CLAIMLIST, 'SELF' => $SELF, ) ); if (false !== ($res = $model->getClaims())) { $claims_node = appendChild($this->dr, createElement($this->xml, 'dataset')); setAttribute($claims_node, 'name', 'CLAIM'); if (!is_null($pageInfo = $model->getClaimsPageInfo())) { setAttribute($claims_node, 'page', $pageInfo['Page']); setAttribute($claims_node, 'pcount', $pageInfo['Pages']); } $this->_compoundClaims($res, $claims_node, 'i'); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function _compoundClaims($rows, $parentNode, $nodeName = 'claim') { foreach ($rows as $key => $row) { $claimNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundClaim($row, $claimNode); } return true; } protected function _compoundClaim($row, $claimNode) { setAttribute($claimNode, 'id', $row['Inc']); setAttribute($claimNode, 'guid', '{' . strConvert($row['Guid']) . '}'); if ($row['status']) { setAttribute($claimNode, 'status', $row['status']); } if ($row['paystatus']) { setAttribute($claimNode, 'paystatus', $row['paystatus']); } if (isset($row['ReasonLName']) && trim($row['ReasonLName']) != '') { setAttribute($claimNode, 'reason', strConvert($row['ReasonLName'])); } if (isset($row['ConfirmedDate']) && !$row['ConfirmedDate']->is_null()) { setAttribute($claimNode, 'confirmeddate', getDate112($row['ConfirmedDate'])); } if (isset($row['RequestCancelDate']) && !$row['RequestCancelDate']->is_null()) { setAttribute($claimNode, 'requestcanceldate', getDate112($row['RequestCancelDate'])); } if (isset($row['CancelDate']) && !$row['CancelDate']->is_null()) { setAttribute($claimNode, 'canceldate', getDate112($row['CancelDate'])); } setAttribute($claimNode, 'confirmed', @$row['Confirmed']); setAttribute($claimNode, 'unread', @$row['Unread']); setAttribute($claimNode, 'st_status', @$row['Status']); setAttribute($claimNode, 'cdate', getDate112($row['CDate'])); if (!$row['EDate']->is_null()) { setAttribute($claimNode, 'edate', getDate112($row['EDate'])); } setAttribute($claimNode, 'datebeg', getDate112($row['DateBeg'])); setAttribute($claimNode, 'dateend', getDate112($row['DateEnd'])); if ($row['SpogFullNumber'] != '') { setAttribute($claimNode, 'sponumber', strConvert($row['SpogFullNumber'])); } if ($row['TotalCommission'] >= 0) { setAttribute($claimNode, 'comission', round($row['TotalCommission'], 2)); } if (!$row['PDate']->is_null()) { setAttribute($claimNode, 'paydate', getDate112($row['PDate'])); } if ($row['PartnerComment'] != '') { setAttribute($claimNode, 'note', strConvert(Samo_String::set($row['PartnerComment'])->safehtml())); } if (array_key_exists('Catalog', $row)) { setAttribute($claimNode, 'cost', $row['Catalog']); setAttribute($claimNode, 'net', $row['Amount']); setAttribute($claimNode, 'debt', $row['Debt']); setAttribute($claimNode, 'currency', strConvert($row['CurrencyAlias'])); } setAttribute($claimNode, 'cancancel', $row['CanCancel']); if (array_key_exists('PhysBuyer', $row)) { $buyer = $row['PhysBuyer']; $buyerNode = appendChild($claimNode, createElement($this->xml, 'buyer')); $this->_compoundBuyer($buyer, $buyerNode); } setAttribute($claimNode, 'self', (isset($row['self']) && $row['self']) ? 1 : 0); setAttribute($claimNode, 'tourKey', $row['TourInc']); setAttribute($claimNode, 'tourName', strConvert($row['TourLName'])); setAttribute($claimNode, 'stateKey', $row['StateInc']); setAttribute($claimNode, 'stateName', strConvert($row['StateLName'])); return true; } protected function _compoundPacketHotels($rows, $parentNode, $nodeName = 'hotel') { foreach ($rows as $row) { $ht = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPacketHotel($row, $ht); } return true; } protected function _compoundPacketHotel($row, $hotelNode) { $this->_compound_Hotel($row, $hotelNode); if (isset($row['Price']) && ($row['Price'] != '')) { setAttribute($hotelNode, 'price', $row['Price']); setAttribute($hotelNode, 'net', $row['Net']); setAttribute($hotelNode, 'cost', $row['Cost']); } return true; } protected function _compoundClaimHotels($rows, $parentNode, $nodeName = 'hotel') { foreach ($rows as $row) { $ht = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundClaimHotel($row, $ht); } return true; } protected function _compoundClaimHotel($row, $hotelNode) { $this->_compound_Hotel($row, $hotelNode); setAttribute($hotelNode, 'roomcount', $row['RCount']); setAttribute($hotelNode, 'pcount', $row['PCount']); $this->_compoundClients($row, $hotelNode); return true; } protected function _compound_Hotel($row, $hotelNode) { setAttribute($hotelNode, 'uid', $row['uid']); setAttribute($hotelNode, 'inc', $row['HotelInc']); setAttribute($hotelNode, 'name', strConvert($row['HotelLName'])); setAttribute($hotelNode, 'datebeg', getDate112($row['DateBeg'])); setAttribute($hotelNode, 'dateend', getDate112($row['DateEnd'])); setAttribute($hotelNode, 'starKey', $row['StarInc']); setAttribute($hotelNode, 'star', strConvert($row['StarLName'])); setAttribute($hotelNode, 'cityKey', $row['TownInc']); setAttribute($hotelNode, 'city', strConvert($row['TownLName'])); setAttribute($hotelNode, 'stateKey', $row['StateInc']); setAttribute($hotelNode, 'state', strConvert($row['StateLName'])); setAttribute($hotelNode, 'roomKey', $row['RoomInc']); setAttribute($hotelNode, 'room', strConvert($row['RoomLName'])); setAttribute($hotelNode, 'htplaceKey', $row['HtPlaceInc']); setAttribute($hotelNode, 'htplace', strConvert($row['HtPlaceLName'])); setAttribute($hotelNode, 'mealKey', $row['MealInc']); setAttribute($hotelNode, 'meal', strConvert($row['MealLName'])); return true; } protected function _compoundPacketTransports($rows, $parentNode, $nodeName = 'transport') { if (!is_array($rows)) { $rows = array($rows); } foreach ($rows as $key => $row) { $transportNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPacketTransport($row, $transportNode); } return true; } protected function _compoundPacketTransport($row, $transportNode) { $row['ClassLName'] .= ($row['Request']) ? ' <по запросу>' : ''; $this->_compound_Transport($row, $transportNode); setAttribute($transportNode, 'class', $row['ClassInc']); setAttribute($transportNode, 'classname', strConvert($row['ClassLName'])); setAttribute($transportNode, 'frplace', $row['OnlineClass']); setAttribute($transportNode, 'time', $row['SrcTime']); setAttribute($transportNode, 'request', $row['Request']); if (isset($row['Price']) && ($row['Price'] != '')) { setAttribute($transportNode, 'price', $row['Price']); setAttribute($transportNode, 'net', $row['Net']); setAttribute($transportNode, 'cost', $row['Cost']); setAttribute($transportNode, 'currency', $row['Currency']); } return true; } protected function _compoundClaimTransports($rows, $parentNode, $nodeName = 'transport') { foreach ($rows as $key => $row) { $transportNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundClaimTransport($row, $transportNode); } return true; } protected function _compoundClaimTransport($row, $transportNode) { $this->_compound_Transport($row, $transportNode); setAttribute($transportNode, 'classKey', $row['ClassInc']); setAttribute($transportNode, 'class', strConvert($row['ClassLName'])); setAttribute($transportNode, 'frplaceKey', $row['FrPlaceInc']); setAttribute($transportNode, 'frplace', strConvert($row['FrPlaceLName'])); setAttribute($transportNode, 'cityfrom', strConvert($row['TownSrcLName'])); setAttribute($transportNode, 'cityto', strConvert($row['TownTrgLName'])); $this->_compoundClients($row, $transportNode); return true; } protected function _compound_Transport($row, $transportNode) { setAttribute($transportNode, 'uid', $row['uid']); setAttribute($transportNode, 'inc', $row['FreightInc']); setAttribute($transportNode, 'name', strConvert($row['FreightLName'])); setAttribute($transportNode, 'direction', $row['RouteIndex']); setAttribute($transportNode, 'type', $row['Type']); setAttribute($transportNode, 'datebeg', getDate112($row['DateBeg'])); setAttribute($transportNode, 'dateend', getDate112($row['DateEnd'])); if (isset($row['SrcPortInc'])) { if (isset($row['TownSrcInc'])) { setAttribute($transportNode, 'srcStateKey', $row['StateSrcInc']); setAttribute($transportNode, 'srcState', strConvert($row['StateSrcLName'])); setAttribute($transportNode, 'trgStateKey', $row['StateTrgInc']); setAttribute($transportNode, 'trgState', strConvert($row['StateTrgLName'])); setAttribute($transportNode, 'srcTownKey', $row['TownSrcInc']); setAttribute($transportNode, 'srcTown', strConvert($row['TownSrcLName'])); setAttribute($transportNode, 'trgTownKey', $row['TownTrgInc']); setAttribute($transportNode, 'trgTown', strConvert($row['TownTrgLName'])); } if (isset($row['SrcTownInc'])) { setAttribute($transportNode, 'srcStateKey', $row['SrcStateInc']); setAttribute($transportNode, 'srcState', strConvert($row['SrcStateLName'])); setAttribute($transportNode, 'trgStateKey', $row['TrgStateInc']); setAttribute($transportNode, 'trgState', strConvert($row['TrgStateLName'])); setAttribute($transportNode, 'srcTownKey', $row['SrcTownInc']); setAttribute($transportNode, 'srcTown', strConvert($row['SrcTownLName'])); setAttribute($transportNode, 'trgTownKey', $row['TrgTownInc']); setAttribute($transportNode, 'trgTown', strConvert($row['TrgTownLName'])); } setAttribute($transportNode, 'srcPortKey', $row['SrcPortInc']); setAttribute($transportNode, 'srcPort', strConvert($row['SrcPortAlias'])); setAttribute($transportNode, 'trgPortKey', $row['TrgPortInc']); setAttribute($transportNode, 'trgPort', strConvert($row['TrgPortAlias'])); setAttribute($transportNode, 'srcTime', strConvert($row['SrcTime'])); setAttribute($transportNode, 'trgTime', strConvert($row['TrgTime'])); } return true; } protected function _compoundPacketServices($rows, $parentNode, $nodeName = 'service') { foreach ($rows as $key => $row) { $serviceNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $tmp_name = $row['ServiceTypeLName'] . ': ' . $row['ServiceLName']; if ($row['TranTypeLName'] != '') { $tmp_name .= ' (' . $row['TranTypeLName'] . ')'; } $row['name'] = $tmp_name; $this->_compoundPacketService($row, $serviceNode); } return true; } protected function _compoundPacketService($row, $serviceNode) { $this->_compound_Service($row, $serviceNode); if (true === $row['Packet']) { setAttribute($serviceNode, 'inpacket', 1); } else { setAttribute($serviceNode, 'inpacket', 0); } if (true === $row['Required']) { setAttribute($serviceNode, 'required', 1); } else { setAttribute($serviceNode, 'required', 0); } if (isset($row['ServiceRouteIndex'])) { setAttribute($serviceNode, 'routeindex', $row['ServiceRouteIndex']); } if (isset($row['ServiceTypeInc'])) { setAttribute($serviceNode, 'servicetype', $row['ServiceTypeInc']); } if (isset($row['Price']) && ($row['Price'] != '')) { setAttribute($serviceNode, 'price', $row['Price']); setAttribute($serviceNode, 'net', $row['Net']); setAttribute($serviceNode, 'cost', $row['Cost']); } return true; } protected function _compoundClaimServices($rows, $parentNode, $nodeName = 'service') { foreach ($rows as $key => $row) { $serviceNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $tmp_name = $row['ServiceTypeLName'] . ': ' . $row['ServiceLName']; if ($row['TranTypeLName'] != '') { $tmp_name .= ' (' . $row['TranTypeLName'] . ')'; } $row['name'] = $tmp_name; $this->_compoundClaimService($row, $serviceNode); } return true; } protected function _compoundClaimService($row, $serviceNode) { $this->_compound_Service($row, $serviceNode); $this->_compoundClients($row, $serviceNode); if (isset($row['ServiceType'])) { setAttribute($serviceNode, 'servicetype', $row['ServiceType']); } return true; } protected function _compound_Service($row, $serviceNode) { setAttribute($serviceNode, 'uid', $row['uid']); setAttribute($serviceNode, 'inc', $row['inc']); setAttribute($serviceNode, 'type', $row['type']); setAttribute($serviceNode, 'name', strConvert($row['name'])); setAttribute($serviceNode, 'datebeg', getDate112($row['DateBeg'])); setAttribute($serviceNode, 'dateend', getDate112($row['DateEnd'])); if (isset($row['ServicePrivate'])) { setAttribute($serviceNode, 'hidden', $row['ServicePrivate']); } else { setAttribute($serviceNode, 'hidden', 0); } return true; } protected function _compoundPacketInsures($rows, $parentNode, $nodeName = 'insure') { foreach ($rows as $key => $row) { $row['type'] = 1; $row['name'] = $row['StateLName'] . ': ' . $row['InsureLName']; $insureNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPacketService($row, $insureNode); } return true; } protected function _compoundClaimInsures($rows, $parentNode, $nodeName = 'insure') { foreach ($rows as $key => $row) { $row['type'] = 1; $row['name'] = $row['StateLName'] . ': ' . $row['InsureLName']; $insureNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundClaimService($row, $insureNode); } return true; } protected function _compoundPacketVisas($rows, $parentNode, $nodeName = 'visa') { foreach ($rows as $key => $row) { $row['type'] = 2; $row['name'] = $row['StateLName'] . ': ' . $row['VisaLName'] . ' (' . $row['VisaDays'] . ')'; $visaNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPacketService($row, $visaNode); } return true; } protected function _compoundClaimVisas($rows, $parentNode, $nodeName = 'visa') { foreach ($rows as $key => $row) { $row['type'] = 2; $row['name'] = $row['StateLName'] . ': ' . $row['VisaLName'] . ' (' . $row['VisaDays'] . ')'; $visaNode = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundClaimService($row, $visaNode); } return true; } protected function _compoundClients($row, $parentNode) { $clientsNode = appendChild($parentNode, createElement($this->xml, 'clients')); if (isset($row['peoples'])) { foreach ($row['peoples'] as $people) { $clientNode = appendChild($clientsNode, createElement($this->xml, 'client')); setAttribute($clientNode, 'idx', $people['Index'] + 1); if (trim($people['Common']) != '') { setAttribute($clientNode, 'common', $people['Common']); } } } return true; } protected function _compoundPeoples($rows, $parentNode, $nodeName = 'people') { foreach ($rows as $row) { $people_node = appendChild($parentNode, createElement($this->xml, $nodeName)); $this->_compoundPeople($row, $people_node); } return true; } protected function _compoundPeople($row, $peopleNode) { setAttribute($peopleNode, 'index', $row['Index'] + 1); setAttribute($peopleNode, 'human', strConvert($row['Human'])); setAttribute($peopleNode, 'name', strConvert($row['Name'])); setAttribute($peopleNode, 'lname', strConvert($row['LName'])); setAttribute($peopleNode, 'born', getDate112($row['Born'])); setAttribute($peopleNode, 'pserie', strConvert($row['PSerie'])); setAttribute($peopleNode, 'pnumber', strConvert($row['PNumber'])); setAttribute($peopleNode, 'pvalid', getDate112($row['PValid'])); setAttribute($peopleNode, 'pexpire', getDate112($row['PValid'])); if (isset($row['PIssue']) && (trim($row['PIssue']))) { setAttribute($peopleNode, 'pgiven', getDate112($row['PIssue'])); } if (isset($row['PGiven']) && (trim($row['PGiven']))) { setAttribute($peopleNode, 'pgivenorg', strConvert($row['PGiven'])); } if (isset($row['Male'])) { setAttribute($peopleNode, 'sex', ($row['Male']) ? 'MALE' : 'FEMALE'); setAttribute($peopleNode, 'male', $row['Male']); } if (isset($row['StateInc'])) { setAttribute($peopleNode, 'nationality', $row['StateInc']); } if (isset($row['PlaceOfBornInc'])) { setAttribute($peopleNode, 'placeborn', $row['PlaceOfBornInc']); } return true; } protected function _excludeServerKey($value) { if (strlen($value) < 21) { $value = str_pad($value, 20, 0, STR_PAD_LEFT); $STATE = (int)substr($value, 0, -15); if ($STATE) { $this->STATE = $STATE; } $value = substr($value, -15); $TOWNFROM = (int)substr($value, 0, -10); if ($TOWNFROM) { $this->TOWNFROM = $TOWNFROM; } $value = substr($value, -10); $value = (int)$value; } return $value; } protected function _includeServerKey($value) { if (strlen($value) < 11) { $value = $this->STATE . str_pad($this->TOWNFROM, 5, 0, STR_PAD_LEFT) . str_pad($value, 10, 0, STR_PAD_LEFT); } return $value; } protected function getREPL_INIT() { $model = $this->_loadModel('export'); if (false !== ($res = $model->replInit())) { $ds = appendChild($this->dr, createElement($this->xml, "replInit")); foreach ($res as $key => $val) { $rp = appendChild($ds, createElement($this->xml, "replProc")); setAttribute($rp, 'serverAlias', $val['serverAlias']); setAttribute($rp, 'serverDB', $val['serverDB']); setAttribute($rp, 'replData', $val['replData']); setAttribute($rp, 'replType', $val['replType']); } return $this->xml; } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } } protected function getREPL_SEND() { $PROCNAME = $this->_getDomNodeContentXPath('PROCNAME/text()', false, 'string'); $STARTPOINT = $this->_getDomNodeContentXPath('STARTPOINT/text()', null, 'string'); $CLEARPOINT = $this->_getDomNodeContentXPath('CLEARPOINT/text()', null, 'string'); $CLEAR = $this->_getDomNodeContentXPath('CLEAR/text()', null); $LIMIT = $this->_getDomNodeContentXPath('LIMIT/text()', null); $model = $this->_loadModel('export'); $model->setVar( array( 'PROCNAME' => $PROCNAME, 'STARTPOINT' => $STARTPOINT, 'CLEARPOINT' => $CLEARPOINT, 'LIMIT' => $LIMIT, 'CLEAR' => $CLEAR ) ); if (false !== ($res = $model->replSend())) { return $res['XML']; } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } } protected function _compoundBuyer($buyer, $buyerNode) { setAttribute($buyerNode, 'name', strConvert($buyer['name'])); if (isset($buyer['born']) && ($buyer['born'])) { setAttribute($buyerNode, 'born', getDate112($buyer['born'])); } setAttribute($buyerNode, 'pserie', strConvert($buyer['pserie'])); setAttribute($buyerNode, 'pnumber', strConvert($buyer['pnumber'])); if ($buyer['givendate']) { setAttribute($buyerNode, 'pgiven', getDate112($buyer['givendate'])); } if ($buyer['pgiven']) { setAttribute($buyerNode, 'pgivenorg', strConvert($buyer['pgiven'])); } if ($buyer['pcodegiven']) { setAttribute($buyerNode, 'pgivencode', strConvert($buyer['pcodegiven'])); } if ($buyer['address']) { setAttribute($buyerNode, 'address', strConvert($buyer['address'])); } setAttribute($buyerNode, 'phone', strConvert($buyer['phones'])); setAttribute($buyerNode, 'email', strConvert($buyer['email'])); return $buyerNode; } protected function AUTH($model) { $PARTNER = $this->_getDomNodeContentXPath('PARTNER/text()'); $PARTPASS = $this->_getDomNodeContentXPath('PARTPASS/text()'); if (is_null($PARTNER) || is_null($PARTPASS) || (false == ($res = $model->getPartnerInc($PARTNER, $PARTPASS)))) { $NAME = $this->_getDomNodeContentXPath('NAME/text()', null, 'string'); $PSW = $this->_getDomNodeContentXPath('PSW/text()', null, 'string'); if (is_null($NAME) || is_null($PSW) || (false == ($res = $model->authPartner($NAME, $PSW)))) { throw new Andr_Exception(1000); } } return $res; } protected function getPARTNER() { $model = $this->_loadModel('claim'); $partner = $this->AUTH($model); $ds = appendChild($this->dr, createElement($this->xml, "dataset")); setAttribute($ds, 'name', 'PARTNER'); $item = appendChild($ds, createElement($this->xml, "i")); setAttribute($item, 'id', $partner['Partner']); setAttribute($item, 'name', strConvert($partner['OfficialName'])); setAttribute($item, 'partpass', $partner['PartPassInc']); $commission = $model->partnerCommission(); if ($commission) { setAttribute($item, 'commission', round($commission, 2)); } return $this->xml; } protected function getDOCUMENTS() { $CLAIM = $this->_getDomNodeContentXPath('CLAIM/text()', false, 'int'); $this->AUTH($this->_loadModel('claim')); $NAME = null; $PSW = null; $xml = simplexml_import_dom($this->xml->documentElement, 'Andr_Xml'); $dataset = $xml->addChild('dataset')->addAttribute('name', 'DOCUMENT'); try { $docs = Samo_Loader::load_object('Claim_Documents', $NAME, $PSW); if ($docs = $docs->index($CLAIM)) { foreach ($docs as $doc) { $dataset->addChild('i')->addAttributes($doc); } } return $this->xml; } catch (Samo_Exception $e) { if ($e->getCode() == 1000) { throw new Andr_Exception($e->getCode()); } else { throw $e; } } } protected function getDOCUMENT_URL() { $CLAIM = $this->_getDomNodeContentXPath('CLAIM/text()', false, 'int'); $this->AUTH($this->_loadModel('claim')); $NAME = null; $PSW = null; $ID = $this->_getDomNodeContentXPath('DOCUMENTID/text()', false, 'string'); try { $docs = Samo_Loader::load_object('Claim_Documents', $NAME, $PSW); $xml = simplexml_import_dom($this->xml->documentElement, 'Andr_Xml'); if ($document = $docs->get($ID)) { $xml->addChild('document')->addAttribute('url', $document); } return $this->xml; } catch (Samo_Exception $e) { if (in_array($e->getCode(), array(1000, 3500))) { throw new Andr_Exception($e->getCode()); } else { throw $e; } } } protected function getCLAIM_OFFER() { $NAME = $this->_getDomNodeContentXPath('NAME/text()', null, 'string'); $PSW = $this->_getDomNodeContentXPath('PSW/text()', null, 'string'); $model = $this->_loadModel('claim'); $model->getPartnerCode($NAME, $PSW); $CLAIM = $this->_getDomNodeContentXPath('CLAIM/text()', false, 'int'); $GUID = $this->_getDomNodeContentXPath('GUID/text()', false, 'string'); return $this->CLAIM_OFFER($model, $CLAIM, $GUID); } protected function getCLAIM_CANCEL() { $NAME = $this->_getDomNodeContentXPath('NAME/text()', null, 'string'); $PSW = $this->_getDomNodeContentXPath('PSW/text()', null, 'string'); $model = $this->_loadModel('claim'); $model->getPartnerCode($NAME, $PSW); $CLAIM = $this->_getDomNodeContentXPath('CLAIM/text()', false, 'int'); $GUID = $this->_getDomNodeContentXPath('GUID/text()', false, 'string'); $model->setVar( array( 'claim' => $CLAIM, 'guid' => $GUID, ) ); if (false !== ($model->claimCancel())) { return $this->CLAIM_OFFER($model, $CLAIM, $GUID); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getCLAIM_SAVE() { $NAME = $this->_getDomNodeContentXPath('NAME/text()', null, 'string'); $PSW = $this->_getDomNodeContentXPath('PSW/text()', null, 'string'); $model = $this->_loadModel('claim'); $model->getPartnerCode($NAME, $PSW); $claimDocument = reset($this->_getDomNodeContentXPath('claim/claimDocument', false, 'DOMElement')); $CLAIM = $this->_getDomNodeContentXPath('@providerNumber', false, 'int', $claimDocument); $GUID = $this->_getDomNodeContentXPath('@guid', false, 'guid', $claimDocument); $CONTENT = $this->_getBronResultRequestContent($claimDocument); $model->setVar( array( 'claim' => $CLAIM, 'guid' => $GUID, 'peoples' => $CONTENT['peoples'], ) ); $model->claimEdit(); return $this->CLAIM_OFFER($model, $CLAIM, $GUID); } protected function CLAIM_OFFER($model, $CLAIM, $GUID) { $model->setVar( array( 'claim' => $CLAIM, 'guid' => $GUID, ) ); if (false !== ($claimInfo = $model->getClaimInfo())) { $xml = simplexml_import_dom($this->xml, 'Andr_Xml'); $xml_claim = $xml->addChild('claim')->addAttribute('version', $this->version); $xml_checkFields = $xml_claim->addChild('checkFields'); $xml_claimDocument = $xml_claim->addChild('claimDocument'); $xml_variants = $xml_claim->addChild('variants'); $this->_set_ClaimInfo($claimInfo, $xml_claimDocument); $this->_set_ClaimMoneys($claimInfo, $xml_claimDocument); $this->_set_ClaimPeoples($model->getPeoples(), $xml_claimDocument); $this->_set_ClaimBuyer($model->getBuyer(), $xml_claimDocument); $xml_claimDocument->addChild('hotels'); $this->_set_ClaimHotels($model->getHotels(), $xml_claim); $xml_claimDocument->addChild('transports'); $this->_set_ClaimTransports($model->getFreights(), $xml_claim); $xml_claimDocument->addChild('services'); $this->_set_ClaimServices($model->getServices(), $xml_claim); $this->_set_ClaimInsures($model->getInsures(), $xml_claim); $this->_set_ClaimVisas($model->getVisas(), $xml_claim); $this->_set_ClaimPeopleFields($model->getTouristFields($claimInfo['TourInc']), $xml_checkFields); $this->_set_Groups($xml_claim); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getBRON_PRICE() { return $this->CALC(false); } protected function getBRON_CHECK() { return $this->CALC(true); } protected function _checkPromoCodeForExists($claimDocument) { if ($promoCode = $this->_getDomNodeContentXPath('@promoCode', '', 'string', $claimDocument)) { $_POST['promo_codetext'] = $promoCode; } return $promoCode; } protected function CALC($strict_check = null) { $claimDocument = reset($this->_getDomNodeContentXPath('claim/claimDocument', false, 'DOMElement')); $CLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('@catalogKey', false, 'string', $claimDocument)); $promoCode = $this->_checkPromoCodeForExists($claimDocument); $model = $this->_loadModel('bron'); $this->AUTH($model); $GUID = $this->_getDomNodeContentXPath('@guid', false, 'guid', $claimDocument); $xml = reset($this->_getDomNodeContentXPath('claim', false, 'DOMElement')); $xml = $this->xml->importNode($xml, true); $this->xml->documentElement->appendChild($xml); $xml = simplexml_import_dom($xml, 'Andr_Xml'); $CONTENT = $this->_getBronResultRequestContent($claimDocument); $model->setVar(array('catClaim' => $CLAIM)); $model->setVar( array( 'guid' => $GUID, 'peoples' => $CONTENT['peoples'], 'hotels' => $model->getHotel(), 'freights' => $CONTENT['transports'], 'services' => $CONTENT['services'], 'insures' => $CONTENT['insures'], 'visas' => $CONTENT['visas'], 'buyer' => $CONTENT['buyer'], 'promoCode' => $promoCode ) ); if (false != ($res = ($strict_check) ? $model->checkReservation() : $model->calcReservation())) { $xml->claimDocument->remove('moneys'); $this->_set_PacketMoneys($res, $xml->claimDocument); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } return $this->xml; } protected function getBRON() { $this->answerValue = 1; return $this->getBRON_RESULT(); } protected function getBRON_RESULT() { $claimDocument = reset($this->_getDomNodeContentXPath('claim/claimDocument', false, 'DOMElement')); $CATCLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('@catalogKey', false, 'string', $claimDocument)); $promoCode = $this->_checkPromoCodeForExists($claimDocument); $model = $this->_loadModel('bron'); $this->AUTH($model); $GUID = $this->_getDomNodeContentXPath('@guid', false, 'guid', $claimDocument); $NOTE = strDeConvert($this->_getDomNodeContentXPath('note/text()', null, 'string', $claimDocument)); $CONTENT = $this->_getBronResultRequestContent($claimDocument); $SAVE = $this->_calcsave(); $model->setVar(array('catClaim' => $CATCLAIM)); $model->getPacketInfo(); $model->setVar( array( 'save' => $SAVE, 'guid' => $GUID, 'note' => $NOTE, 'peoples' => $CONTENT['peoples'], 'hotels' => $model->getHotel(), 'freights' => $CONTENT['transports'], 'services' => $CONTENT['services'], 'insures' => $CONTENT['insures'], 'visas' => $CONTENT['visas'], 'buyer' => $CONTENT['buyer'], 'promoCode' => $promoCode ) ); if (false !== ($res = $model->getReservation())) { $model = $this->_loadModel('claim'); return $this->CLAIM_OFFER($model, $res['Claim'], $res['GUID']); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } } protected function getCHANGE_SERVICE() { $CATCLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('claim/claimDocument/@catalogKey', false, 'string')); $model = $this->_loadModel('bron'); $model->setVar('catClaim', $CATCLAIM); $this->AUTH($model); $xml = reset($this->_getDomNodeContentXPath('claim', false, 'DOMElement')); $xml = $this->xml->importNode($xml, true); $this->xml->documentElement->appendChild($xml); $xml = simplexml_import_dom($xml, 'Andr_Xml'); $UID_NEW = $this->_getDomNodeContentXPath('UID_NEW/text()', null, 'string'); if (is_null($UID_NEW)) { return $this->xml; } $UID_OLD = $this->_getDomNodeContentXPath('UID_OLD/text()', null, 'string'); if (is_null($UID_OLD)) { return $this->xml; } $new_item = $xml->xpath("//*[@uid='$UID_NEW']"); $new_item = reset($new_item); if ($new_item->getName() != 'transport') { return $this->xml; } $old_item = $xml->xpath("//*[@uid='$UID_OLD']"); $old_item = reset($old_item); if ($old_item->getName() != 'transport') { return $this->xml; } $new_item_group = intval($new_item['groupId']); $depend_transports = array(); $depend_services = array(); $depend_groups = $xml->xpath("//groups/group[contains(@headGroups,'$new_item_group')]"); foreach ($depend_groups as $depend_group) { $depend_group_id = strval($depend_group['id']); $depend_items_selected = $xml->xpath("//claimDocument/*/*[@groupId='" . $depend_group_id . "']"); $depend_items = array_merge($depend_items_selected, $xml->xpath("//variants/*/*[@groupId='$depend_group_id']")); $depend = array( 'group' => $depend_group, 'items' => $depend_items, 'selected' => $depend_items_selected, ); if ($depend_items) { if (reset($depend_items)->getName() == 'transport') { $depend_transports[$depend_group_id] = $depend; } else { $depend_services[$depend_group_id] = $depend; } foreach ($depend_items as $depend_item) { $depend_item->remove(); } } } foreach ($depend_transports as $depend_group_id => $depend_transport) { $depend_item = reset($depend_transport['selected']); $DIRECTION = intval($depend_item['direction']); $freightIn = array( 'FreightInc' => intval($new_item['key']), 'OnlineClass' => intval($new_item['onlineClassKey']), ); if (!$freights = $model->getFreight($DIRECTION, $freightIn)) { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } $have_selected = false; foreach ($freights as $_freight => $freight) { $freights[$_freight]['_selected'] = false; if ($freight['uid'] == strval($depend_item['uid'])) { $freights[$_freight]['_selected'] = true; $have_selected = true; } } if (!$have_selected) { $freights[0]['_selected'] = true; } foreach ($freights as $_freight => $freight) { $freight['GroupId'] = $depend_group_id; if ($freight['_selected']) { $this->_set_PacketTransport($freight, $xml->claimDocument->transports->addChild('transport')); } else { $this->_set_PacketTransport($freight, $xml->variants->transports->addChild('transport')); } } } if (count($depend_services)) { $transports = array(); $_claimDocument = $this->_getDomNodeContentXPath('//claim/claimDocument', false, 'DOMElement', $this->xml->documentElement); $_claimDocument = reset($_claimDocument); $this->_parseClaimDocumentTransports($_claimDocument, $transports); $model->setVar('freights', $transports); $services = $model->reloadServices(); foreach ($services as & $service) { foreach ($depend_services as $depend_group_id => $depend_service) { if ((strval($depend_service['group']['description']) == strConvert($service['ServiceTypeName'])) || (strval($depend_service['group']['description']) == strConvert($service['ServiceTypeLName'])) ) { $service['_group_id'] = $depend_group_id; } } } $this->_set_PacketServices($services, $xml); } return $this->xml; } protected function getOFFER() { return $this->getPACKET(); } protected function getModelClaim($claim) { $model = $this->_loadModel('claim'); $this->AUTH($model); $model->setVar( array( 'catClaim' => $claim ) ); return $model; } protected function getEXTERNAL_FREIGHTS() { $claimDocument = reset($this->_getDomNodeContentXPath('claim/claimDocument', false, 'DOMElement')); $CLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('@catalogKey', false, 'string', $claimDocument)); $xml = reset($this->_getDomNodeContentXPath('claim', false, 'DOMElement')); $xml = $this->xml->importNode($xml, true); $this->xml->documentElement->appendChild($xml); $xml = simplexml_import_dom($xml, 'Andr_Xml'); $model = $this->getModelClaim($CLAIM); $class = $this->_getDomNodeContentXPath('CLASS/text()', null, 'string'); $inf = $this->_getDomNodeContentXPath('INF/text()', null, 'string'); $fGuid = (string)$xml->claimDocument['externalFreightsId']; $rows = $model->getExternalFreights($class, $inf, false, $fGuid); if (!isset($xml->claimDocument->transports)) { $xml->claimDocument->addChild('transports'); } if (!isset($xml->variants)) { $xml->addChild('variants'); } if (!isset($xml->variants->transports)) { $xml->variants->addChild('transports'); } foreach ($xml->xpath('//transport[@external!=0]') as $tr) { $tr->remove(); } $this->_set_ExternalTransports($rows, $xml); $xml->claimDocument['externalFreightsId'] = ''; $this->_set_Groups($xml); return $this->xml; } protected function getPACKET() { $CLAIM = $this->_excludeServerKey($this->_getDomNodeContentXPath('CLAIM/text()', false, 'string')); $model = $this->_loadModel('bron'); $this->AUTH($model); $model->setVar(array('catClaim' => $CLAIM)); if (!$packetInfo = $model->getPacketInfo()) { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } $xml = simplexml_import_dom($this->xml, 'Andr_Xml'); $xml_claim = $xml->addChild('claim')->addAttribute('version', $this->version); $xml_checkFields = $xml_claim->addChild('checkFields'); $xml_claimDocument = $xml_claim->addChild('claimDocument'); $xml_variants = $xml_claim->addChild('variants'); $this->_set_PacketInfo($packetInfo, $xml_claimDocument); $this->_set_PacketMoneys($packetInfo, $xml_claimDocument); $xml_notes = $xml_claim->addChild('notes'); $this->_set_PacketNotes($packetInfo, $xml_notes); $this->_set_PacketPeoples($packetInfo, $xml_claimDocument); $this->_set_PacketPeopleFields($model->getTouristFields($packetInfo['TourInc']), $xml_checkFields); $xml_claimDocument->addChild('hotels'); $xml_variants->addChild('hotels'); if (false !== ($hotels = $model->getHotel())) { if (count($hotels)) { $this->_set_PacketHotels($hotels, $xml_claim); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } $xml_claimDocument->addChild('transports'); $xml_variants->addChild('transports'); if ($packetInfo['FreightExternal'] != Bron_Model::FREIGHT_REGULAR_ONLY) { if (false !== ($transports = $model->getAllRoutesFreights())) { if (count($transports) != 0) { $this->_set_PacketTransports($transports, $xml_claim); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } } $xml_claimDocument->addChild('services'); $xml_variants->addChild('services'); if (false !== ($services = $model->getTypesServices())) { $this->_set_PacketServices($services, $xml_claim); } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } if (false !== ($insures = $model->getTypesInsures())) { if (count($insures)) { $this->_set_PacketInsures($insures, $xml_claim); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } if (false !== ($visaInfo = $model->getVisa())) { if (count($visaInfo)) { $this->_set_PacketVisas($visaInfo, $xml_claim); } } else { $error = $model->popError(); throw new SoapFault($error['code'], strConvert($error['message']), 'PHP', $error['options']); } $this->_set_Groups($xml_claim); return $this->xml; } protected function _set_ClaimInfo($row, $xml) { $this->_set_Info($row, $xml); $xml->addAttributes( array( 'guid' => '{' . $row['Guid'] . '}', 'providerNumber' => $row['Inc'], 'cdate' => getDateTimeXml($row['CDate']), 'edate' => getDateTimeXml($row['EDate']), 'payDate' => getDateXml($row['PDate']), 'prepayDate' => getDateXml($row['PPDate']), 'confirmedDate' => getDateTimeXml($row['ConfirmedDate']), 'rdate' => getDateTimeXml($row['CDate']), ) ); if ($row['PartnerComment']) { $xml->addChild('note', strConvert($row['PartnerComment'])); } } protected function _set_PacketInfo($row, $xml) { $this->_set_Info($row, $xml); $xml->addAttributes( array( 'catalogKey' => $this->_includeServerKey($row['Cat_Claim']), 'peopleCount' => $row['PeopleCount'], 'adult' => $row['Adult'], 'child' => $row['Child'], 'infant' => $row['Infant'], 'cdate' => null, 'payDate' => null, 'prepayDate' => null, 'freeinfant' => $row['freeinfant'], 'freightExternal' => $row['FreightExternal'], 'existsPromoCode' => $row['ExistPromoCode'] ) ); } protected function _set_Info($row, $xml) { $xml->addAttributes( array( 'condition' => $this->_claim_condition($row), 'currency' => strConvert($row['CurrencyAlias']), 'currencyKey' => $row['Currency'], 'status' => $this->_claim_status($row), 'payStatus' => $this->_claim_paystatus($row), 'datebeg' => getDateXml($row['DateBeg']), 'dateend' => getDateXml($row['DateEnd']), 'nights' => $row['Nights'], 'docDeadline' => null, 'comissionPercent' => $row['TotalCommission'], 'townFromKey' => $row['TownFromInc'], 'townFrom' => strConvert($row[nameorlname('TownFrom')]), 'stateKey' => $row['StateInc'], 'state' => strConvert($row[nameorlname('State')]), 'tourKey' => $row['TourInc'], 'tour' => strConvert($row[nameorlname('Tour')]), 'spoKey' => (($row['Spog'] != '') && ($row['Spog'] > 0)) ? $row['Spog'] : null, 'spo' => (($row['Spog'] != '') && ($row['Spog'] > 0)) ? strConvert($row['SpogFullNumber']) : null, ) ); return true; } protected function _claim_condition($row) { if (isset($row['status'])) { $status = 'ccBooked'; } else { $status = 'ccOffer'; } return $status; } protected function _claim_status($row) { if (isset($row['status'])) { $status = $row['status']; if ($status == 2) { $status = 'csProcessed'; } elseif ($status == 3) { $status = 'csUnconfirmed'; } elseif ($status == 4) { $status = 'csConfirmed'; } elseif ($status == 5) { $status = 'csCancelled'; } elseif ($status == 6) { $status = 'csAwaitingCancel'; } else { $status = 'csNotReaded'; } } else { $status = 'csNotActivated'; } return $status; } protected function _claim_paystatus($row) { if (isset($row['paystatus'])) { $status = $row['paystatus']; if ($status == 2) { $status = 'psPartiallyPaid'; } elseif ($status == 3) { $status = 'psPaid'; } elseif ($status == 4) { $status = 'psPenalty'; } elseif ($status == 5) { $status = 'psPartiallyPaidPenalty'; } elseif ($status == 6) { $status = 'psPaidPenalty'; } else { $status = 'psNotPaid'; } } else { $status = 'psNotPaid'; } return $status; } protected function _set_ClaimMoneys($row, $xml) { return $this->_set_Moneys($row['money'], $xml); } protected function _set_PacketMoneys($row, $xml) { return $this->_set_Moneys($row['money'], $xml); } protected function _set_Moneys($row, $xml) { $xml = $xml->addChild('moneys'); $isClaimCurrency = true; foreach ($row as $key => $val) { $xml_money = $xml->addChild('money'); $price = isset($val['Amount_to_pay_person']) ? $val['Amount_to_pay_person'] : $val['Catalog']; $xml_money->addAttributes( array( 'price' => $price, 'showBuyerPrice' => null, 'cost' => $price, 'net' => (isset($val['Amount'])) ? $val['Amount'] : null, 'debt' => (isset($val['Debt'])) ? $val['Debt'] : null, 'currencyKey' => $val['CurrencyInc'], 'currency' => strConvert($val['CurrencyAlias']), 'isClaimCurrency' => $isClaimCurrency, 'paid' => (isset($val['Paid'])) ? $val['Paid'] : null, 'rate' => (!$isClaimCurrency) ? $val['rateex'] : null, 'priceForCommiss' => (isset($val['CostForCommiss'])) ? $val['CostForCommiss'] : null, ) ); $isClaimCurrency = false; } return true; } protected function _set_PacketNotes($row, $xml) { if (isset($row['TourNote']) && trim($row['TourNote'])) { $xml->addChild('tourNote', strConvert(Samo_String::set($row['TourNote'])->trim()->safehtml())); } if (isset($row['SpogNote']) && trim($row['SpogNote'])) { $xml->addChild('spogNote', strConvert(Samo_String::set($row['SpogNote'])->trim()->safehtml())); } if (isset($row['SpogMessage']) && trim($row['SpogMessage'])) { $xml->addChild('spogMessage', strConvert(Samo_String::set($row['SpogMessage'])->trim()->safehtml())); } } protected function _set_ClaimPeoples($row, $xml) { $xml = $xml->addChild('peoples'); foreach ($row as $people) { $xml_people = $xml->addChild('people'); $xml_people->addAttributes( array( 'key' => $people['Index'] + 1, 'iid' => $people['Inc'], 'age' => (in_array($people['Human'], array('MR', 'MRS'))) ? 'ADL' : $people['Human'], 'sex' => ($people['Male']) ? 'MALE' : 'FEMALE', 'human' => strConvert($people['Human']), 'name' => strConvert($people['Name']), 'lname' => strConvert($people['LName']), 'born' => getDateXml($people['Born']), 'pserie' => strConvert($people['PSerie']), 'pnumber' => strConvert($people['PNumber']), 'pexpire' => getDateXml($people['PValid']), 'pgiven' => getDateXml($people['PIssue']), 'pgivenorg' => strConvert($people['PGiven']), 'pgivencode' => null, 'nationality' => ($people['StateName']) ? strConvert($people['StateName']) : null, 'nationalityKey' => $people['StateInc'], 'bornplace' => ($people['PlaceOfBornName']) ? strConvert($people['PlaceOfBornName']) : null, 'bornplaceKey' => $people['PlaceOfBornInc'], 'address' => ($people['Address']) ? strConvert($people['Address']) : null, 'phone' => ($people['Phones']) ? strConvert($people['Phones']) : null, 'email' => ($people['Email']) ? strConvert($people['Email']) : null, 'mobile' => ($people['Faxes']) ? strConvert($people['Faxes']) : null, ) ); } } protected function _set_PacketPeoples($row, $xml) { $xml = $xml->addChild('peoples'); $people_count = $row['PeopleCount'] + $row['freeinfant_checked']; for ($i = 1; $i <= $people_count; $i++) { $xml_people = $xml->addChild('people'); $xml_people->addAttributes( array( 'key' => $i, 'age' => ($i <= $row['Adult']) ? 'ADL' : (($i <= $row['Adult'] + $row['Child']) ? 'CHD' : 'INF'), ) ); } } protected function _set_ClaimBuyer($row, $xml) { if ($row) { $xml = $xml->addChild('buyer')->addAttributes( array( 'age' => null, 'sex' => null, 'human' => null, 'name' => strConvert($row['name']), 'lname' => null, 'born' => getDateXml($row['born']), 'pserie' => strConvert($row['pserie']), 'pnumber' => strConvert($row['pnumber']), 'pexpire' => null, 'pgiven' => getDateXml($row['givendate']), 'pgivenorg' => strConvert($row['pgiven']), 'pgivencode' => strConvert($row['pcodegiven']), 'address' => strConvert($row['address']), 'phone' => strConvert($row['phones']), 'email' => strConvert($row['email']), 'mobile' => strConvert($row['phones']), 'peopleKey' => null, ) ); } } protected function _set_ClaimPeopleFields($row, $xml) { $this->_set_PeopleFields($row, $xml, null); } protected function _set_PacketPeopleFields($row, $xml) { $this->_set_PeopleFields($row, $xml, false); } protected function _set_PeopleFields($row, $xml, $readonly) { $xml = $xml->addChild('people'); foreach ($row as $key => $val) { if (!is_null($readonly)) { $val['readonly'] = $readonly; } $xml_field = $xml->addChild($key); $xml_field->addAttributes( array( 'required' => $val['required'], 'readOnly' => $val['readonly'], 'visible' => $val['visible'], 'regular' => ($val['pattern']) ? strConvert($val['pattern']) : null, 'message' => ($val['pattern']) ? strConvert($val['patternTitle']) : null, ) ); } return true; } protected function _set_ClaimHotels($row, $xml) { $xml = $xml->claimDocument->hotels; foreach ($row as $key => $val) { $val['GroupId'] = $this->_new_group( array( 'type' => 'hotel', 'required' => true, 'oneItem' => true, 'description' => strConvert('Проживание'), ) ); $this->_set_ClaimHotel($val, $xml->addChild('hotel')); } } protected function _set_ClaimHotel($row, $xml) { $this->_set_Hotel($row, $xml); $this->_set_Clients($row, $xml); } protected function _set_PacketHotels($row, $xml) { $xml = $xml->claimDocument->hotels; foreach ($row as $key => $val) { $val['GroupId'] = $this->_new_group( array( 'type' => 'hotel', 'required' => true, 'oneItem' => true, 'description' => strConvert('Проживание'), ) ); $this->_set_PacketHotel($val, $xml->addChild('hotel')); } } protected function _set_PacketHotel($row, $xml) { $this->_set_Hotel($row, $xml); } protected function _set_Hotel($row, $xml) { $xml->addAttributes( array( 'uid' => $row['uid'], 'groupId' => $row['GroupId'], 'key' => $row['HotelInc'], 'name' => strConvert($row[nameorlname('Hotel')]), 'url' => strConvert(@$row['WWW']), 'datebeg' => getDateXml($row['DateBeg']), 'dateend' => getDateXml($row['DateEnd']), 'starKey' => $row['StarInc'], 'star' => strConvert($row[nameorlname('Star')]), 'townKey' => $row['TownInc'], 'town' => strConvert($row[nameorlname('Town')]), 'stateKey' => $row['StateInc'], 'state' => strConvert($row[nameorlname('State')]), 'roomKey' => $row['RoomInc'], 'room' => strConvert($row[nameorlname('Room')]), 'htplaceKey' => $row['HtPlaceInc'], 'htplace' => strConvert($row[nameorlname('HtPlace')]), 'mealKey' => $row['MealInc'], 'meal' => strConvert($row[nameorlname('Meal')]), 'roomCount' => null, ) ); } protected function _set_ClaimTransports($row, $xml) { $xml = $xml->claimDocument->transports; $keys = array_keys($row); $_first = reset($keys); $_last = end($keys); foreach ($row as $_freight => $freight) { $freight['GroupId'] = $this->_new_group( array( 'type' => 'transport', 'required' => true, 'oneItem' => true, 'description' => strConvert(($_freight == $_first) ? 'Прямой рейс' : (($_freight == $_last) ? 'Обратный рейс' : 'Перелет')), ) ); $this->_set_ClaimTransport($freight, $xml->addChild('transport')); } } protected function _set_ClaimTransport($row, $xml) { $this->_set_Transport($row, $xml); $this->_set_Clients($row, $xml); } protected function _set_ExternalTransports($rows, $xml) { $xml_transports = $xml->claimDocument->transports; $xml_vtransports = $xml->variants->transports; $groupid0 = $this->_new_group( array( 'type' => 'transport', 'required' => true, 'oneItem' => true, 'description' => strConvert('Регулярный прямой рейс'), ) ); $groupid1 = $this->_new_group( array( 'type' => 'transport', 'required' => true, 'oneItem' => true, 'description' => strConvert('Регулярный обратный рейс'), ) ); $groupid2 = $this->_new_group( array( 'type' => 'transport', 'required' => false, 'oneItem' => false, 'description' => strConvert('Регулярный рейс'), ) ); $this->_edit_group($groupid2, array('headGroups' => array($groupid1, $groupid0))); foreach ($rows as $_row => $row) { $row['GroupId'] = $row['RouteIndex'] ? $groupid1 : $groupid0; if ($row['Selected']) { $this->_set_Transport($row, $xml_transports->addChild('transport')); } else { $this->_set_Transport($row, $xml_vtransports->addChild('transport')); } } } protected function _set_PacketTransports($row, $xml) { $xml_transports = $xml->claimDocument->transports; $xml_vtransports = $xml->variants->transports; foreach ($row as $_route => $route) { $groupid = $this->_new_group( array( 'type' => 'transport', 'required' => true, 'oneItem' => true, 'description' => strConvert($route['IsFirst'] ? 'Прямой рейс' : ($route['IsLast'] ? 'Обратный рейс' : 'Перелет')), ) ); if ($route['IsFirst']) { $firstgroup = $groupid; } if (!$route['IsFirst']) { $this->_edit_group($groupid, array('headGroups' => array($firstgroup))); } foreach ($route['freights'] as $_freight => $freight) { $freight['GroupId'] = $groupid; if ($_freight == 0) { $this->_set_PacketTransport($freight, $xml_transports->addChild('transport')); } else { $this->_set_PacketTransport($freight, $xml_vtransports->addChild('transport')); } } } } protected function _set_PacketTransport($row, $xml) { if ($row['Request']) { $row['ClassName'] .= ' <по запросу>'; $row['ClassLName'] .= ' <по запросу>'; } $this->_set_Transport($row, $xml); } protected function _set_Transport($row, $xml) { $xml->addAttributes( array( 'uid' => $row['uid'], 'groupId' => $row['GroupId'], 'datebeg' => getDateXml($row['DateBeg']), 'dateend' => getDateXml($row['DateEnd']), 'key' => $row['FreightInc'], 'name' => strConvert($row[nameorlname('Freight')]), 'type' => $this->_transport_type($row['Type']), 'classKey' => $row['ClassInc'], 'class' => strConvert($row[nameorlname('Class')]), 'frplaceKey' => $row['FrPlaceInc'], 'frplace' => strConvert($row[nameorlname('FrPlace')]), 'direction' => $row['RouteIndex'], 'external' => isset($row['External']) ? $row['External'] : null, 'partnerKey' => isset($row['Partner']) ? $row['Partner'] : null, 'onlineClassKey' => isset($row['OnlineClass']) ? $row['OnlineClass'] : null, 'transportCompanyKey' => $row['AirlineInc'], 'transportCompany' => strConvert($row[nameorlname('Airline')]), 'externalOfferId' => isset($row['OfferId']) ? $row['OfferId'] : null, ) ); $this->_set_TransportPoint($row, $xml->addChild('departure'), 'Src'); $this->_set_TransportPoint($row, $xml->addChild('arrival'), 'Trg'); if (isset($row['Details']) && $row['Details']) { $xml->addChild('details'); foreach ($row['Details'] as $d) { foreach ($d as $d1 => $d2) { if ($d2 instanceof Samo_Datetime) { $d[$d1] = getDateXml($d2); } $d[$d1] = strConvert($d2); } $xml->details->addChild('detail')->addAttributes($d); } } return true; } protected function _set_TransportPoint($row, $xml, $type) { if (isset($row[$type . 'StateInc'])) { $xml->addAttributes( array( 'stateKey' => $row[$type . 'StateInc'], 'state' => strConvert($row[$type . nameorlname('State')]), 'townKey' => $row[$type . 'TownInc'], 'town' => strConvert($row[$type . nameorlname('Town')]), ) ); } else { $xml->addAttributes( array( 'stateKey' => $row['State' . $type . 'Inc'], 'state' => strConvert($row[str_replace('State', 'State' . $type, nameorlname('State'))]), 'townKey' => $row['Town' . $type . 'Inc'], 'town' => strConvert($row[str_replace('Town', 'Town' . $type, nameorlname('Town'))]), ) ); } $xml->addAttributes( array( 'portKey' => $row[$type . 'PortInc'], 'port' => strConvert($row[$type . nameorlname('Port')]), 'time' => ($row[$type . 'Time']) ? $row[$type . 'Time'] . (($row[$type . 'TimeDelta']) ? ' +' . $row[$type . 'TimeDelta'] : '') : null, ) ); } protected function _transport_type($type) { $return = null; if (!is_null($type)) { $types = array( array('type' => 1, 'alias' => 'ttAvia'), array('type' => 2, 'alias' => 'ttBus'), array('type' => 3, 'alias' => 'ttTrain'), array('type' => 4, 'alias' => 'ttShip'), array('type' => 5, 'alias' => 'ttCar'), array('type' => 6, 'alias' => 'ttOther'), ); if (is_int($type)) { $key = 'type'; $val = 'alias'; } else { $key = 'alias'; $val = 'type'; } foreach ($types as $src) { if ($src[$key] == $type) { $return = $src[$val]; break; } } } return $return; } private function _filter_hidden_services($services) { return array_filter( $services, function ($service) { return (!isset($service['ServicePrivate']) || !$service['ServicePrivate']); } ); } protected function _set_ClaimServices($row, $xml) { $xml = $xml->claimDocument->services; $row = $this->_filter_hidden_services($row); foreach ($row as $service) { $service['GroupId'] = $this->_new_group( array( 'type' => 'service', 'required' => true, 'oneItem' => true, 'description' => strConvert($service[nameorlname('ServiceType')]), ) ); $this->_set_ClaimService($service, $xml->addChild('service')); } } protected function _set_ClaimService($row, $xml) { $row['name'] = $row[nameorlname('ServiceType')] . ': ' . $row[nameorlname('Service')]; if ($row[nameorlname('TranType')] != '') { $row['name'] .= ' (' . $row[nameorlname('TranType')] . ')'; } $this->_set_Service($row, $xml); $this->_set_Clients($row, $xml); } protected function _set_PacketServices($row, $xml) { $xml_services = $xml->claimDocument->services; $xml_vservices = $xml->variants->services; foreach ($row as $servtype) { if (!$services = $this->_filter_hidden_services($servtype['services'])) { continue; } if (!isset($servtype['_group_id'])) { $groupid = $this->_new_group( array( 'type' => 'service', 'required' => (true == $servtype['Required']), 'oneItem' => false, 'description' => strConvert($servtype[nameorlname('ServiceType')]), ) ); foreach ($this->groups as $__group => $_group) { if (false !== in_array($_group['type'], array('hotel', 'transport'))) { $this->_edit_group($groupid, array('headGroups' => array($__group))); } } } else { $groupid = $servtype['_group_id']; } foreach ($services as $service) { $service['GroupId'] = $groupid; if ($service['Packet'] || $service['Required']) { $this->_set_PacketService($service, $xml_services->addChild('service')); } else { $this->_set_PacketService($service, $xml_vservices->addChild('service')); } } } } protected function _set_PacketService($row, $xml) { if ($row['Required'] && $row['Remove']) { $row['Required'] = 0; } $row['name'] = $row[nameorlname('ServiceType')] . ': ' . $row[nameorlname('Service')]; if ($row[nameorlname('TranType')] != '') { $row['name'] .= ' (' . $row[nameorlname('TranType')] . ')'; } $row['name'] .= ' ' . $row['AirlineName']; $this->_set_Service($row, $xml); $xml->addAttributes( array( 'servicetype' => $row['ServiceTypeInc'], ) ); } protected function _set_Service($row, $xml) { switch ($row['type']) { case 1: $type = 'stInsurance'; break; case 2: $type = 'stVisa'; break; case 3: $type = 'stTransfer'; break; case 4: $type = 'stExcursion'; break; default: $type = 'stOther'; break; } $row['url'] = (isset($row['url']) && trim($row['url'])) ? strConvert(trim($row['url'])) : null; $xml->addAttributes( array( 'uid' => $row['uid'], 'groupId' => $row['GroupId'], 'datebeg' => getDateXml($row['DateBeg']), 'dateend' => getDateXml($row['DateEnd']), 'key' => $row['inc'], 'name' => strConvert($row['name']), 'type' => $type, 'price' => $row['Price'], 'currencyAlias' => $row['Price'] ? strConvert($row['CurrencyAlias']) : null, 'required' => isset($row['Required']) ? (true == $row['Required']) : true, 'remove' => isset($row['Remove']) ? (true == $row['Remove']) : true, 'hidden' => (isset($row['ServicePrivate'])) ? (true == $row['ServicePrivate']) : false, 'url' => $row['url'], 'arrivalTownKey' => ($row['type'] == 2 && isset($row['arrivalTownKey'])) ? $row['arrivalTownKey'] : null, ) ); } protected function _set_ClaimInsures($row, $xml) { $xml = $xml->claimDocument->services; foreach ($row as $insure) { $insure['GroupId'] = $this->_new_group( array( 'type' => 'service', 'required' => true, 'oneItem' => true, 'description' => strConvert($insure[nameorlname('InsureType')]), ) ); $this->_set_ClaimInsure($insure, $xml->addChild('service')); } } protected function _set_ClaimInsure($row, $xml) { $this->_set_Insure($row, $xml); $this->_set_Clients($row, $xml); } protected function _set_PacketInsures($row, $xml) { $xml_services = $xml->claimDocument->services; $xml_vservices = $xml->variants->services; foreach ($row as $type) { $groupid = $this->_new_group( array( 'type' => 'service', 'required' => ($type['Required']) ? true : false, 'oneItem' => ($type['Required'] < 2) ? true : false, 'description' => strConvert($type[nameorlname('InsureType')]), 'personal' => (!$type['Required']) ? true : null, ) ); foreach ($type['insures'] as $insure) { $insure['GroupId'] = $groupid; if ($insure['Packet'] || $insure['Required']) { $this->_set_PacketInsure($insure, $xml_services->addChild('service')); } else { $this->_set_PacketInsure($insure, $xml_vservices->addChild('service')); } } } } protected function _set_PacketInsure($row, $xml) { $this->_set_Insure($row, $xml); } protected function _set_Insure($row, $xml) { $row['type'] = 1; $row['name'] = $row[nameorlname('State')] . ': ' . $row[nameorlname('Insure')]; $row['Required'] = $row['Required'] && !$row['Remove']; $row['url'] = $row['InsureUrl']; $this->_set_Service($row, $xml); } protected function _set_ClaimVisas($row, $xml) { $xml = $xml->claimDocument->services; foreach ($row as $visa) { $visa['GroupId'] = $this->_new_group( array( 'type' => 'service', 'required' => true, 'oneItem' => true, 'description' => strConvert('Виза'), 'personal' => true, ) ); $this->_set_ClaimVisa($visa, $xml->addChild('service')); } } protected function _set_ClaimVisa($row, $xml) { $this->_set_Visa($row, $xml); $this->_set_Clients($row, $xml); } protected function _set_PacketVisas($row, $xml) { $xml_services = $xml->claimDocument->services; $xml_vservices = $xml->variants->services; $groupid = $this->_new_group( array( 'type' => 'service', 'required' => false, 'oneItem' => true, 'description' => strConvert('Виза'), 'personal' => true, ) ); foreach ($row as $_visa => $visa) { $visa['GroupId'] = $groupid; if ($visa['Packet']) { $this->_set_PacketVisa($visa, $xml_services->addChild('service')); } else { $this->_set_PacketVisa($visa, $xml_vservices->addChild('service')); } } } protected function _set_PacketVisa($row, $xml) { $this->_set_Visa($row, $xml); } protected function _set_Visa($row, $xml) { $row['type'] = 2; $row['name'] = $row[nameorlname('VisaTown')] . ': ' . $row[nameorlname('Visa')] . (($row['VisaDays']) ? sprintf(' (%d d)', $row['VisaDays']) : ''); if (isset($row['VisaTownInc'])) { $row['arrivalTownKey'] = $row['VisaTownInc']; } $this->_set_Service($row, $xml); } protected function _set_Groups($xml) { if (!isset($xml->groups)) { $xml_groups = $xml->addChild('groups'); } else { $xml_groups = $xml->groups; } foreach ($this->groups as $group) { unset($group['type']); if (isset($group['headGroups']) && (is_array($group['headGroups']))) { $group['headGroups'] = implode(',', $group['headGroups']); } $xml_group = $xml_groups->addChild('group'); $xml_group->addAttributes($group); } } protected function _set_Clients($row, $xml) { $xml = $xml->addChild('clients'); if (isset($row['peoples'])) { foreach ($row['peoples'] as $people) { $xml_client = $xml->addChild('client')->addAttributes( array( 'peopleKey' => $people['Index'] + 1, 'common' => isset($people['Common']) ? $people['Common'] : null, ) ); } } } protected function _new_group($group) { if (is_null($this->groupid)) { $exists_groups = $this->xml->EvalXPath('//groups/group/@id'); if ((false !== $exists_groups) && count($exists_groups)) { $ids = array(); foreach ($exists_groups as $exists_group) { $ids[] = intval($exists_group->value); } $this->groupid = max($ids) + 1; } else { $this->groupid = 10; } } $group['id'] = $this->groupid; $this->groups[$this->groupid] = $group; $this->groupid++; return $group['id']; } protected function _edit_group($groupid, $group) { if (isset($this->groups[$groupid])) { $this->groups[$groupid] = array_merge_recursive($this->groups[$groupid], $group); return $groupid; } return false; } protected function _getBronResultRequestContent($claimDocument = null) { return $this->_parseClaimDocument($claimDocument); } protected function _parseClaimDocument($claimDocument) { $peoples = array(); $this->_parseClaimDocumentPeoples($claimDocument, $peoples); $transports = array(); $this->_parseClaimDocumentTransports($claimDocument, $transports); $services = array(); $insures = array(); $visas = array(); $this->_parseClaimDocumentServices($claimDocument, $services, $insures, $visas); $buyer = null; $this->_parseClaimDocumentBuyer($claimDocument, $buyer); return array( 'peoples' => $peoples, 'transports' => $transports, 'services' => $services, 'insures' => $insures, 'visas' => $visas, 'buyer' => $buyer, ); } protected function _parseClaimDocumentPeoples($claimDocument, & $peoples) { $peopleNodes = $this->_getDomNodeContentXPath('peoples/people', false, 'DOMElement', $claimDocument); foreach ($peopleNodes as $peopleNode) { $people = array(); $people['ID'] = $ID = $this->_getDomNodeContentXPath('@key', false, 'int', $peopleNode); $people['SEX'] = $SEX = $this->_getDomNodeContentXPath('@sex', 'MALE', 'string', $peopleNode); $people['AGE'] = $AGE = $this->_getDomNodeContentXPath('@age', 'ADL', 'string', $peopleNode); $people['HUMAN'] = $HUMAN = $this->_getDomNodeContentXPath('@human', null, 'string', $peopleNode); if (!$HUMAN) { $people['HUMAN'] = ($AGE == 'ADL') ? (($SEX == 'MALE') ? 'MR' : 'MRS') : $AGE; } $NAME = trim(strDeConvert($this->_getDomNodeContentXPath('@name', '', 'string', $peopleNode))); $people['NAME'] = editName($NAME); $LNAME = trim(strDeConvert($this->_getDomNodeContentXPath('@lname', '', 'string', $peopleNode))); $people['LNAME'] = editName($LNAME); $people['BORN'] = $this->_getDomNodeContentXPath('@born', '', 'date', $peopleNode); $people['PSERIE'] = trim(strDeConvert($this->_getDomNodeContentXPath('@pserie', '', 'string', $peopleNode))); $people['PNUMBER'] = trim(strDeConvert($this->_getDomNodeContentXPath('@pnumber', '', 'string', $peopleNode))); $people['PVALID'] = $this->_getDomNodeContentXPath('@pexpire', '', 'date', $peopleNode); $people['PGIVEN'] = $this->_getDomNodeContentXPath('@pgiven', '', 'date', $peopleNode); $people['PGIVENORG'] = trim(strDeConvert($this->_getDomNodeContentXPath('@pgivenorg', '', 'string', $peopleNode))); $people['PGIVENCODE'] = trim(strDeConvert($this->_getDomNodeContentXPath('@pgivencode', null, 'string', $peopleNode))); $people['PLACEBORN'] = $this->_getDomNodeContentXPath('@bornplaceKey', null, 'int', $peopleNode); $people['NATIONALITY'] = $this->_getDomNodeContentXPath('@nationalityKey', null, 'int', $peopleNode); $people['ADDITIONAL'] = $this->_getDomNodeContentXPath('@additional', null, 'boolean', $peopleNode) ? 1 : 0; $people['INFANT_PLACE'] = $this->_getDomNodeContentXPath('@place', null, 'boolean', $peopleNode) ? 1 : 0; $people['ADDRESS'] = trim(strDeConvert($this->_getDomNodeContentXPath('@address', null, 'string', $peopleNode))); $people['PHONE'] = trim(strDeConvert($this->_getDomNodeContentXPath('@phone', null, 'string', $peopleNode))); $people['EMAIL'] = trim(strDeConvert($this->_getDomNodeContentXPath('@email', null, 'string', $peopleNode))); $people['MOBILE'] = trim(strDeConvert($this->_getDomNodeContentXPath('@mobile', null, 'string', $peopleNode))); $people['VEXPIRE'] = $this->_getDomNodeContentXPath('@vexpire', null, 'date', $peopleNode); $people['PLACEBORNDETAIL'] = trim(strDeConvert($this->_getDomNodeContentXPath('@bornplaceDetail', null, 'string', $peopleNode))); $people['INN'] = trim(strDeConvert($this->_getDomNodeContentXPath('@inn', null, 'string', $peopleNode))); $peoples[$ID] = $people; } } protected function _parseClaimDocumentTransports($claimDocument, & $transports) { $transportNodes = $this->_getDomNodeContentXPath('transports/transport', array(), 'DOMElement', $claimDocument); foreach ($transportNodes as $transportNode) { $transport = array(); $transport['uid'] = $this->_getDomNodeContentXPath('@uid', null, 'string', $transportNode); $transport['RouteIndex'] = $this->_getDomNodeContentXPath('@direction', false, 'int', $transportNode); $transport['inc'] = $this->_getDomNodeContentXPath('@key', false, 'int', $transportNode); $transport['OnlineClass'] = $this->_getDomNodeContentXPath('@onlineClassKey', false, 'int', $transportNode); $transport['DateBeg'] = $this->_getDomNodeContentXPath('@datebeg', false, 'date', $transportNode); $transport['DateEnd'] = $this->_getDomNodeContentXPath('@dateend', false, 'date', $transportNode); $transport['ClassInc'] = $this->_getDomNodeContentXPath('@classKey', false, 'int', $transportNode); $transport['External'] = $this->_getDomNodeContentXPath('@external', 0, 'int', $transportNode); $transport['Partner'] = $this->_getDomNodeContentXPath('@partnerKey', 0, 'int', $transportNode); $transport['Name'] = strDeConvert($this->_getDomNodeContentXPath('@name', null, 'string', $transportNode)); $clients = $this->_getDomNodeContentXPath('clients/client/@peopleKey', null, 'int', $transportNode); if ((string)$clients != '') { $transport['peoples'] = explode(',', $clients); } $transports[] = $transport; } } protected function _parseClaimDocumentServices($claimDocument, & $services, & $insures, & $visas) { $serviceNodes = $this->_getDomNodeContentXPath('services/service', array(), 'DOMElement', $claimDocument); foreach ($serviceNodes as $serviceNode) { $service = array(); $service['uid'] = $this->_getDomNodeContentXPath('@uid', null, 'string', $serviceNode); $service['inc'] = $this->_getDomNodeContentXPath('@key', false, 'int', $serviceNode); $service['DateBeg'] = $this->_getDomNodeContentXPath('@datebeg', false, 'date', $serviceNode); $service['DateEnd'] = $this->_getDomNodeContentXPath('@dateend', false, 'date', $serviceNode); $service['Type'] = $TYPE = $this->_getDomNodeContentXPath('@type', false, 'string', $serviceNode); $service['Name'] = strDeConvert($this->_getDomNodeContentXPath('@name', null, 'string', $serviceNode)); $clients = $this->_getDomNodeContentXPath('clients/client/@peopleKey', null, 'int', $serviceNode); if ((string)$clients != '') { $service['peoples'] = explode(',', $clients); } switch ($TYPE) { case 'stInsurance': $insures[] = $service; break; case 'stVisa': $visas[] = $service; break; default: $services[] = $service; break; } } } protected function _parseClaimDocumentBuyer($claimDocument, & $buyer) { $buyerNode = $this->_getDomNodeContentXPath('buyer', null, 'DOMElement', $claimDocument); if ($buyerNode) { $buyerNode = reset($buyerNode); $buyer = array(); $buyer['SEX'] = $SEX = $this->_getDomNodeContentXPath('@sex', 'MALE', 'string', $buyerNode); $buyer['AGE'] = $AGE = $this->_getDomNodeContentXPath('@age', 'ADL', 'string', $buyerNode); $buyer['HUMAN'] = $HUMAN = $this->_getDomNodeContentXPath('@human', null, 'string', $buyerNode); if (!$HUMAN) { $buyer['HUMAN'] = ($AGE == 'ADL') ? (($SEX == 'MALE') ? 'MR' : 'MRS') : $AGE; } $buyer['NAME'] = strDeConvert($this->_getDomNodeContentXPath('@name', '', 'string', $buyerNode)); $buyer['LNAME'] = strDeConvert($this->_getDomNodeContentXPath('@lname', '', 'string', $buyerNode)); $buyer['BORN'] = $this->_getDomNodeContentXPath('@born', null, 'date', $buyerNode); $buyer['PSERIE'] = strDeConvert($this->_getDomNodeContentXPath('@pserie', null, 'string', $buyerNode)); $buyer['PNUMBER'] = strDeConvert($this->_getDomNodeContentXPath('@pnumber', null, 'string', $buyerNode)); $buyer['PVALID'] = $this->_getDomNodeContentXPath('@pexpire', null, 'date', $buyerNode); $buyer['PGIVEN'] = $this->_getDomNodeContentXPath('@pgiven', null, 'date', $buyerNode); $buyer['PGIVENORG'] = strDeConvert($this->_getDomNodeContentXPath('@pgivenorg', null, 'string', $buyerNode)); $buyer['PGIVENCODE'] = strDeConvert($this->_getDomNodeContentXPath('@pgivencode', null, 'string', $buyerNode)); $buyer['ADDRESS'] = strDeConvert($this->_getDomNodeContentXPath('@address', null, 'string', $buyerNode)); $buyer['PHONE'] = strDeConvert($this->_getDomNodeContentXPath('@phone', null, 'string', $buyerNode)); $buyer['EMAIL'] = strDeConvert($this->_getDomNodeContentXPath('@email', null, 'string', $buyerNode)); $buyer['MOBILE'] = strDeConvert($this->_getDomNodeContentXPath('@mobile', null, 'string', $buyerNode)); } } protected function getCLAIM_STATUS() { $guid = $this->_getDomNodeContentXPath('GUID/text()', null, 'guid'); if (null === $guid) { $guid = explode(',', $this->_getDomNodeContentXPath('RESERVATIONS/GUID/text()', false, 'guid')); } else { $guid = array($guid); } $model = $this->_loadModel('claim'); $RESERVATIONS = Andr_Xml::factory('<RESERVATIONS/>')->addChilds(array('GUID' => $guid))->asXml(); $model->setVar('RESERVATIONS', $RESERVATIONS); $reservations = $model->getClaimStatus(); $xml = Andr_Xml::factory($this->xml); $dataset = $xml->addChild('dataset')->addAttribute('name', 'RESERVATION'); foreach ($reservations as $row) { $dataset->addChild('i')->addAttributes( array( 'guid' => '{' . $row['Guid'] . '}', 'condition' => $this->_claim_condition($row), 'status' => $this->_claim_status($row), 'payStatus' => $this->_claim_paystatus($row), 'cdate' => getDateTimeXml($row['CDate']), 'rdate' => getDateTimeXml($row['CDate']), 'edate' => getDateTimeXml($row['EDate']), 'confirmedDate' => getDateTimeXml($row['ConfirmedDate']), ) ); } return $this->xml; } protected function _compoundPrice($price, $priceNode) { setAttribute($priceNode, 'id', $this->_includeServerKey($price['id'])); setAttribute($priceNode, 'checkIn', getDate112($price['checkIn'])); setAttribute($priceNode, 'nights', $price['nights']); setAttribute($priceNode, 'tourNights', $price['nights']); setAttribute($priceNode, 'stayNights', null !== $price['hnights'] ? $price['hnights'] : $price['nights']); setAttribute($priceNode, 'tour', strConvert($price['tourAlt'])); if (isset($price['tourUrl']) && strlen($price['tourUrl'])) { setAttribute($priceNode, 'tourUrl', strConvert($price['tourUrl'])); } setAttribute($priceNode, 'tourKey', $price['tourKey']); if (isset($price['programTypeKey']) && $price['programTypeKey'] > 1) { if (isset($price['programTypeAlt']) && strlen($price['programTypeAlt'])) { setAttribute($priceNode, 'program', strConvert($price['programTypeAlt'])); } if (isset($price['programTypeUrl']) && strlen($price['programTypeUrl'])) { setAttribute($priceNode, 'programUrl', strConvert($price['programTypeUrl'])); } setAttribute($priceNode, 'programKey', $price['programTypeKey']); } setAttribute($priceNode, 'town', strConvert($price['townAlt'])); setAttribute($priceNode, 'townKey', $price['townKey']); setAttribute($priceNode, 'hotel', strConvert($price['hotelAlt'])); setAttribute($priceNode, 'hotelKey', $price['hotelKey']); setAttribute($priceNode, 'star', strConvert($price['starAlt'])); setAttribute($priceNode, 'starKey', $price['starKey']); setAttribute($priceNode, 'meal', strConvert($price['mealAlt'])); if (isset($price['mealUrl']) && strlen($price['mealUrl'])) { setAttribute($priceNode, 'mealUrl', strConvert($price['mealUrl'])); } if (isset($price['mealNote']) && strlen($price['mealNote'])) { setAttribute($priceNode, 'mealNote', strConvert($price['mealNote'])); } setAttribute($priceNode, 'mealKey', $price['mealKey']); setAttribute($priceNode, 'room', strConvert($price['roomAlt'])); setAttribute($priceNode, 'roomKey', $price['roomKey']); setAttribute($priceNode, 'htplace', strConvert($price['htPlaceAlt'])); setAttribute($priceNode, 'htplaceKey', $price['htPlaceKey']); setAttribute($priceNode, 'price', $price['price']); if (isset($price['priceOld']) && $price['priceOld']) { setAttribute($priceNode, 'priceOld', $price['priceOld']); } setAttribute($priceNode, 'currency', strConvert(@$price['currency'])); setAttribute($priceNode, 'currencyKey', @$price['currencyKey']); if ($price['spoKey'] > 0) { setAttribute($priceNode, 'spo', strConvert($price['spo'])); setAttribute($priceNode, 'spoKey', $price['spoKey']); if (isset($price['spoValid']) && $price['spoValid'] && $price['spoValid']->not_null()) { setAttribute($priceNode, 'spoValid', getDateTimeXml($price['spoValid'])); } } if ($price['momentConfirm'] > 0) { setAttribute($priceNode, 'momentConfirm', $price['momentConfirm']); } if ($price['stopSale']) { setAttribute($priceNode, 'stopSale', 1); } if (array_key_exists('packetType', $price)) { setAttribute($priceNode, 'packetType', $this->_convert_packet_type($price['packetType'])); } if ($price['hotelUrl']) { setAttribute($priceNode, 'hotelUrl', strConvert(Samo_Url::parse($price['hotelUrl']))); } if (isset($price['listTime']) && strlen($price['listTime'])) { setAttribute($priceNode, 'departureTimes', strConvert($price['listTime'])); } if (isset($price['partnerIncomingKey'])) { setAttribute($priceNode, 'incoming', strConvert($price['partnerIncomingAlt'])); setAttribute($priceNode, 'incomingKey', $price['partnerIncomingKey']); } if (isset($price['crossTour']) && $price['crossTour']) { setAttribute($priceNode, 'crossTour', 1); } $this->_compoundPriceHotelAttributes($price, $priceNode); $this->_compoundPricePlaceStatus($price, $priceNode, 'placeStatus'); return true; } protected function _compoundPriceHotelAttributes($price, $priceNode) { if (isset($price['attributes'])) { $attributesNode = appendChild($priceNode, createElement($this->xml, 'hotelTypes')); foreach ($price['attributes'] as $attribute) { $attributeNode = appendChild($attributesNode, createElement($this->xml, 'hotelType')); setAttribute($attributeNode, 'id', $attribute['id']); setAttribute($attributeNode, 'name', strConvert($attribute['name'])); } } return true; } protected function getCLAIM_PAYMENT() { $NAME = $this->_getDomNodeContentXPath('NAME/text()', null, 'string'); $PSW = $this->_getDomNodeContentXPath('PSW/text()', null, 'string'); $model = $this->_loadModel('claim'); $CLAIM = $this->_getDomNodeContentXPath('CLAIM/text()', false, 'int'); $GUID = $this->_getDomNodeContentXPath('GUID/text()', false, 'string'); $model->getPartnerCode($NAME, $PSW); $model->setVar( array( 'claim' => $CLAIM, 'guid' => $GUID, ) ); $xml = Andr_Xml::factory($this->xml); $dataset = $xml->addChild('payments'); if ($payments = $model->getClaimPayment()) { foreach ($payments as $row) { $item = $dataset->addChild('payment')->addAttributes( array( 'id' => '{' . $row['Guid'] . '}', 'guid' => '{' . $row['ClaimGuid'] . '}', 'pdate' => getDateXml($row['Date']), 'cash' => (true == $row['Cash']), ) ); if (trim($row['Note'])) { $item->addChild('note', strConvert($row['Note'])); } if (trim($row['Invoice']) && $row['InvoiceDate']->not_null()) { $item->addAttributes( array( 'invoice' => strConvert(trim($row['Invoice'])), 'invoiceDate' => getDateXml($row['InvoiceDate']), ) ); } $item->addChild('value')->addAttributes( array( 'sum' => $row['RealPay'], 'currency' => strConvert($row['RealCurrencyAlias']), 'currencyKey' => $row['RealCurrencyInc'], 'rate' => $row['Rate'], ) ); $item->addChild('reservationValue')->addAttributes( array( 'sum' => $row['Pay'], 'currency' => strConvert($row['CurrencyAlias']), 'currencyKey' => $row['CurrencyInc'], 'rate' => round(1, 4), ) ); $item->addChild('payer')->addAttributes( array( 'name' => strConvert($row['PayerName']), 'inn' => strConvert($row['PayerInn']), 'legal' => true, ) ); $item->addChild('payee')->addAttributes( array( 'name' => strConvert($row['PayeeName']), 'inn' => strConvert($row['PayeeInn']), 'legal' => true, ) ); } } return $this->xml; } protected function getPRICE_INFO() { $model = $this->_loadModel('search'); $this->TOWNFROM = $TOWNFROM = $this->_getDomNodeContentXPath('TOWNFROMINC/text()', false); $this->STATE = $STATE = $this->_getDomNodeContentXPath('STATEINC/text()', false); $params = array( 'TOWNFROMINC' => $TOWNFROM, 'STATEINC' => $STATE, 'CATCLAIM' => $this->_excludeServerKey($this->_getDomNodeContentXPath('CLAIM/text()', false, 'string')), 'CURRENCY' => $this->_getDomNodeContentXPath('CURRENCY/text()', null), ); $res = $model->getSTATS($params); $xml = simplexml_import_dom($this->xml, 'Andr_Xml'); if ($res['priceDynamics']) { $this->_set_priceDynamics($res['priceDynamics'], $xml); } if ($res['hotelAvailability']) { $this->_set_hotelAvailability($res['hotelAvailability'], $xml); } if ($res['transportAvailability']) { $this->_set_transportAvailability($res['transportAvailability'], $xml); } return $this->xml; } protected function _set_priceDynamics($rows, $xml) { $priceDynamycs = $xml->addChild('priceDynamycs'); foreach ($rows as $key => $row) { if (!$row['id']) { $priceDynamycs->addChild('price')->addAttributes( [ 'id' => intval($row['id']), 'checkIn' => getDateXml($row['checkIn']), ] ); continue; } $priceDynamycs->addChild('price')->addAttributes( [ 'id' => $row['id'], 'checkIn' => getDateXml($row['checkIn']), 'price' => $row['price'], 'currencyKey' => $row['currencyKey'], 'currency' => strConvert($row['currency']), 'bron' => ($row['bron']) ? true : false, ] ); } } protected function _set_hotelAvailability($rows, $xml) { $hotelAvailability = $xml->addChild('hotelAvailability'); foreach ($rows as $row) { $hotelAvailability->addChild('placeStatus')->addAttributes( [ 'date' => getDateXml($row['date']), 'status' => $row['status'], ] ); } } protected function _set_transportAvailability($rows, $xml) { $place_map = array( 'yesplace' => 'Y', 'noplace' => 'N', 'yesnoplace' => 'F', 'requestplace' => 'R', ); $class_map = array( array(0, 'e', 'Econom', 'эконом'), array(1, 'b', 'Busines', 'бизнес'), array(2, 'c', 'Comfort', 'комфорт'), array(3, 'p', 'Premium', 'премиум'), ); $transportAvailability = $xml->addChild('transportAvailability'); $transportAvailability->addAttribute('format', (isset($rows['routes'])) ? '1' : '2'); foreach (array('direct', 'back') as $direction) { if (isset($rows[$direction]) && count($rows[$direction]) > 0) { $xml_direction = $transportAvailability->addChild($direction . 'Transports'); foreach ($rows[$direction] as $key => $row) { $xml_item = $xml_direction->addChild('transport')->addAttributes( [ 'key' => $row['key'], 'name' => strConvert($row['name']), 'datebeg' => getDateXml($row['date']), 'dateend' => getDateXml($row['date']), 'transportCompanyKey' => $row['transportCompanyKey'], 'transportCompany' => strConvert($row['transportCompany']), 'transportTypeKey' => $row['transportTypeKey'], 'transportType' => strConvert($row['transportType']), ] ); foreach (array('departure', 'arrival') as $direct) { $xml_item->addChild($direct) ->addAttribute('portKey', $row[$direct]['portKey']) ->addAttribute('port', strConvert($row[$direct]['port'])) ->addAttribute('time', $row[$direct]['time']); } foreach ($class_map as $class) { $xml_item->addChild('placeStatus')->addAttributes( [ 'classKey' => $class[0], 'class' => strConvert($class[3]), 'status' => $place_map[$row['places'][$class[0]]['status']], ] ); } } } } if (isset($rows['routes'])) { $xml_routes = $transportAvailability->addChild('transports'); foreach ($rows['routes'] as $key => $row) { $info = $row['info']; $xml_route = $xml_routes->addChild('route')->addAttributes( [ 'sourceTown' => strConvert($info['sourceTown']), 'targetTown' => strConvert($info['targetTown']), 'date' => getDateXml($info['date']), ] ); foreach ($row['freights'] as $freight) { $xml_item = $xml_route->addChild('transport')->addAttributes( [ 'key' => $freight['key'], 'name' => strConvert($freight['name']), 'transportCompanyKey' => $freight['transportCompanyKey'], 'transportCompany' => strConvert($freight['transportCompany']), 'transportTypeKey' => $freight['transportTypeKey'], 'transportType' => strConvert($freight['transportType']), ] ); foreach (array('departure', 'arrival') as $direct) { $xml_item->addChild($direct) ->addAttribute('portKey', $freight[$direct]['portKey']) ->addAttribute('port', strConvert($freight[$direct]['port'])) ->addAttribute('time', $freight[$direct]['time']); } foreach ($class_map as $class) { $xml_item->addChild('placeStatus')->addAttributes( [ 'classKey' => $class[0], 'class' => strConvert($class[3]), 'status' => $freight['places'][$class[0]]['status'], ] ); } } } } } } 