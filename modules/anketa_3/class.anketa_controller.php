<?php
 class Anketa_Controller extends Samo_Controller { public function construct() { try { if ($this->model->action !== 'ANKETA_SAMOTOUR') { $this->model->is_enabled(); } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } public function default_action() { try { $_SESSION['anketa'][$this->model->defaults['PEOPLE']] = array(); if (false !== ($result = $this->model->getAnketa($save = false))) { if (in_array($this->model->defaults['anketa'], array('greece_mow', 'uae_mow', 'greece_pegas_com_ua'))) { $this->view->assign('MAXLONGINT', Samo::MAXLONGINT); $this->view->assign('TouristInfo', $result); } else { $this->view->assign('fields', $this->model->fields_anketa); } $this->model->get_print_anketa(); $template = _ROOT . 'data/anketa/anketa_' . $this->model->defaults['anketa'] . '.tpl'; $this->view ->assign('print_anketa', $this->model->print_anketa) ->assign('enable_save', $this->model->defaults['enable_save']) ->assign('external', $this->model->external) ->assign('visaforminputed', $this->model->defaults['people_info']['visaforminputed']['value']->not_null()) ->assign('warn_about_visaforminputed', $this->model->defaults['warn_about_visaforminputed']) ->assign('model', $this->model->defaults); $show_anketa = true; $routes = Samo_Registry::get('routes'); if (isset($routes['edit_tourist'])) { if (!$this->model->defaults['people_info']['visaforminputed']['value']->not_null()) { $this->load_messages($routes['edit_tourist']); $edit_tourist = Samo_Loader::load_object('Edit_Tourist_Model'); $exception = false; try { $edit_tourist->check($this->model->defaults['PEOPLE']); } catch (Samo_People_Exception $e) { $exception = true; foreach ($e->getErrors() as $key => $val) { $this->view->message($key, 'error'); } } if (!Samo_Request::intval('accept') || $exception) { $show_anketa = false; $tourist = $edit_tourist->find($this->model->defaults['PEOPLE'], true); $this->view->assign('TOURIST', $tourist); $this->view->popup_template('form.tpl', $this->messages['CHECK_DATA'], 400, 340, false); } } } if ($show_anketa) { $this->view->assign('content_for_layout', $this->view->fetch($template)); } $this->view->js_var('samo.anketa_function', 'samo.' . $this->model->defaults['anketa']); $this->view->js_call_onready('samo.' . $this->model->defaults['anketa']); parent::default_action(); } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } public function SAVE() { try { if (false !== ($result = $this->model->putAnketa())) { $this->view->element_text('#anketa', $this->messages['ANKETA_SAVED']); Samo_Registry::get('response')->refresh(); } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } public function LOAD_CHILDREN() { try { if (false !== ($result = $this->model->LoadChildren())) { $child_count = count($result); for ($i = 1; $i <= $child_count; $i++) { $this->view->element_value('#Child' . $i . 'Surname', $result[$i]['ChildSurname']) ->element_value('#Child' . $i . 'Name', $result[$i]['ChildName']) ->element_value('#Child' . $i . 'Born', $result[$i]['ChildBorn']); } } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } public function LOAD_RESIZE_PICTURE() { $type = Samo_Request::strval('PICTURE_TYPE'); try { $this->model->PutFile($type); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").style.width', $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['newwidth'] . 'px'); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").style.height', $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['newheight'] . 'px'); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").src', $this->model->defaults[$type . '_url_tmp']); $this->view->js_call('parent.samo.image_select', $type, $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['view_width'], $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['view_height'], $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['max_view_width'], $_SESSION['anketa'][$this->model->defaults['PEOPLE']][$type]['max_view_height']); } catch (Samo_Exception $e) { $this->view->js_call('alert', $e->getMessage()); } } public function CROP_PICTURE() { $type = Samo_Request::strval('PICTURE_TYPE'); try { $this->model->CropPicture($type); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").style.width', $this->model->defaults['photo'][$type]['tpl_width'] . 'px'); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").style.height', $this->model->defaults['photo'][$type]['tpl_height'] . 'px'); $this->view->js_var('top.document.getElementById("' . $type . '_anketa").src', $this->model->defaults['photo'][$type]['url_small'] . '?t=' . Samo_Request::time()); $this->view->js_call('parent.samo.return_show', $type); } catch (Samo_Exception $e) { $this->view->js_call('alert', $e->getMessage()); } } public function render_pdf() { $return = array('guid' => Samo_Request::strval('guid')); try { $model = $this->model; $model->is_enabled(); $code = uniqid(); $pdf_file = sprintf('dnl/anketa_%s_%s.pdf', $model->defaults['PEOPLE'], $code); $fpdf_tpl_data = 'anketa_' . $model->defaults['anketa'] . '.fpdf'; if (false !== ($result = $model->getAnketa($save = true))) { if (isset($this->model->defaults['photo']['Photo'])) { $this->view->assign('photo_url', $this->model->defaults['photo']['Photo']['url_small']); } if (isset($this->model->defaults['photo']['ID'])) { $this->view->assign('page1_url', $this->model->defaults['photo']['ID']['url_small']); } if (in_array($this->model->defaults['anketa'], array('greece_mow', 'uae_mow', 'greece_pegas_com_ua'))) { $this->view ->assign('complete', true) ->assign('people', $result) ->assign('anketa', $model->defaults['fields']) ->assign('claiminfo', $model->defaults['claim_info']) ->render_fpdf($fpdf_tpl_data, $pdf_file); } else { $this->model->MoveFields(); $this->view ->assign('complete', true) ->assign('fields', $this->model->fields_anketa) ->assign('claiminfo', $model->defaults['claim_info']) ->render_fpdf($fpdf_tpl_data, $pdf_file); } $return['url'] = WWWROOT . $pdf_file; } } catch (Samo_Exception $e) { $return['error'] = $e->getMessage(); } return $return; } public function ANKETA_SAMOTOUR() { $result = $this->model->defaults['EXTERNAL'] === 1 ? $this->model->getExternalDocument() : $this->render_pdf(); if (isset($result['url'])) { $this->model->History_Print_Anketa(); } $this->view->js_call('samo.download_result', $result); } } 