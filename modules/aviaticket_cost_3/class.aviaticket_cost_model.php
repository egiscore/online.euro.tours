<?php
 class Aviaticket_Cost_Model extends Samo_Claim { protected $auth_required = array('agency', 'person'); public $external = 0; public function construct($claim = null, $people = null, $order = null) { $this->messages = Samo_Registry::get('messages'); return parent::construct($claim, $people, $order); } public function markIssued($claim = null, $people = null, $order = null, $opeople = null, $docum = '') { $this->defaults['CLAIM'] = $claim; return $this->SaveAviaTicket_Cost(); } public function is_enabled() { $clRefer = Samo_Loader::load_object('Cl_Refer_Model', $this->config); $clRefer->construct(); $documents = $clRefer->documentList(null, null, DocCategory::TICKET_COST); if (count($documents)) { $document = reset($documents); $data = $document['data']; if ($data['Enabled']) { return true; } elseif ($data['Reason']) { return ErrorCode::toException($data['Reason']); } } $messages = Samo_Registry::get('messages'); throw new Samo_Exception($messages['CL_DOC_PRINT_DISABLED'], 402); } public function SaveAviaTicket_Cost() { if (false !== ($result = $this->ticket_cost())) { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_4_Aviaticket_cost_Save', [ 'Claim' => $this->defaults['CLAIM'], 'UserCode' => $this->internet_user(), 'Partpass' => $this->getPartPassInc(), ] ); if (false !== ($res = $this->db->query($sql))) { return $result; } } return false; } public function ticket_cost() { $sql = $this->cost_query(); if ($result = $this->db->fetchRow($sql)) { $result['cost_int'] = floor($result['cost']); $result['cost_float'] = round(($result['cost'] - floor($result['cost'])) * 100); $result['cost_float'] = ($result['cost_float'] == 0) ? '00' : $result['cost_float']; $result['dbeg_format'] = $result['dateend']->format('Y') > $result['datebeg']->format('Y') ? 'd F Y' : 'd F'; return $result; } $messages = Samo_Registry::get('messages'); throw new Samo_Exception($messages['CL_DOC_AVIATICKET_COST_UNKNOWN'], 404); } protected function cost_query() { return $this->db->formatExec('<OFFICEDB>.dbo.up_WEB_3_claim_CostFreight', ['Claim' => $this->defaults['CLAIM']]); } public function get_template_aviaticket_cost() { $claim = $this->claimInfo(); $res = $this->get_settings_printform($doccategory = 7, $partner = $claim['OwnerInc'], $tour = null, $state = null, $inszone = null, $contracttype = null, $agreement_year = null, $email_type = null, $online_bank = null, $owner = $claim['OwnerInc']); if ($res) { return true; } return $this->messages['TEMPLATE_NOT_INSTALL']; } protected function getExternalDocumentInit() { if ($this->defaults['CLAIM']) { return $this->getExternalDocumentJob(sprintf('aviaticket_cost_%d.pdf', $this->defaults['CLAIM']), sprintf('aviaticket_cost_%d_%%s_%%s.pdf', $this->defaults['CLAIM'])); } throw new Samo_Exception($this->messages['CANNOT_PRINT']); } protected function getExternalDocumentParams() { if (!$this->SaveAviaTicket_Cost() || (true !== $this->get_template_aviaticket_cost())) { throw new Samo_Exception($this->messages['ACCESS_DENIED']); } $params = array( 'claim' => $this->defaults['CLAIM'], 'template' => $this->defaults['template'] ); return $params; } } 