<?php
 class Bron_Claim extends Samo_EnvLoader { const CALC_AND_SAVE = 1; const CALC_WITHOUT_SAVE = 0; const SERVCATEGORY_INFANT_SUPPLEMENT = 6; const SERVCATEGORY_SEATS_SUPPLEMENT = 7; const FAREKEY_ONEWAY = 2; const VISA_OWN = -1; protected $orders = array(); protected $peoples = array(); protected $claimDocument = array(); protected $_allowed_params = array(); protected $_configured_params = array(); protected $_str_params = array(); protected $_cacheClaimtext = null; protected $buyer = null; protected $infant_services = array(); protected $additional_infant = null; public function __construct(Samo_Config $config, Packet_Info $packetinfo = null, $strict_check = true) { parent::__construct($config, $packetinfo, $strict_check); $this->_allowed_params = array( 'tour', 'claim', 'spog', 'lng', 'note', 'partpass', 'user_to_message', 'noteclaim', 'owner', 'internet_partner', 'calctype', 'cat_claim', 'useunreadfornote', 'developer', 'nights', 'claimnote', 'ip', 'log_priority', 'claimdocument', 'guid', 'mediator', 'claim_owner', 'external_freight', 'oauth_token', 'contacts', 'reklama' ); } public function customer_rules() { } protected function sort_peoples(& $peoples) { $sorting = ['MR', 'MRS', 'CHD', 'INF', 'AINF']; usort( $peoples, function (Samo_People $a, Samo_People $b) use ($sorting) { $ahuman = ($a->ADDITIONAL) ? 'AINF' : ($a->HUMAN ? $a->HUMAN : 'INF'); $bhuman = ($b->ADDITIONAL) ? 'AINF' : ($b->HUMAN ? $b->HUMAN : 'INF'); $asort = array_search($ahuman, $sorting); $bsort = array_search($bhuman, $sorting); if ($asort != $bsort) { return ($asort < $bsort) ? -1 : 1; } else { if ($a->BORN->is_null() && $b->BORN->is_null()) { return abs($a->inc) < abs($b->inc) ? -1 : 1; } elseif ($a->BORN->is_null()) { return -1; } elseif ($b->BORN->is_null()) { return 1; } elseif ($a->BORN->lt($b->BORN)) { return -1; } elseif ($b->BORN->lt($a->BORN)) { return 1; } else { return abs($a->inc) < abs($b->inc) ? -1 : 1; } } } ); } protected function clear_peoples_human(& $peoples) { foreach ($peoples as $people) { $people->HUMAN = ''; } } protected function set_peoples_human(& $peoples, $adult_count, $child_count) { foreach (array_values($peoples) as $index => $people) { if ($index < $adult_count) { if ($people->is_infant_age()) { $people->HUMAN = 'INF'; } elseif ($people->is_child_age()) { $people->HUMAN = 'CHD'; } else { $people->HUMAN = ($people->MALE) ? 'MR' : 'MRS'; } } elseif ($index < $adult_count + $child_count) { if ($people->is_infant_age()) { $people->HUMAN = 'INF'; } else { $people->HUMAN = 'CHD'; } } else { $people->HUMAN = 'INF'; } } } protected function set_peoples_age(& $peoples, $ages) { foreach ($peoples as $index => $people) { if ($people->ADDITIONAL) { $ages[] = $people->infant_age() - 1; } } sort($ages); foreach (array_reverse($peoples) as $index => $people) { if (count($ages)) { $people->set_age(array_shift($ages)); } else { break; } } } public function add_people(Samo_People $people) { $people->packetInfo($this->packetinfo); $people->strict_check($this->strict_check); $this->peoples[] = $people; $setage = false; $sethuman = false; if (count($this->peoples) >= $this->packetinfo['PeopleCount']) { $setage = true; foreach ($this->peoples as $people) { if ($people->BORN->not_null()) { $setage = false; } if (!$people->HUMAN) { $sethuman = true; } } } if ($sethuman) { $this->clear_peoples_human($this->peoples); } $this->sort_peoples($this->peoples); if ($setage) { $this->set_peoples_age($this->peoples, $this->packetinfo->ages()); } elseif ($people->ADDITIONAL && $people->BORN->is_null()) { $people->set_age($people->infant_age() - 1); } if ($sethuman) { $this->set_peoples_human($this->peoples, $this->packetinfo['Adult'], $this->packetinfo['Child']); } if ($setage || $sethuman) { foreach ($this->peoples as $people) { $people->self_test(); } } } public function add_order(Bron_Order $order) { $this->orders[$order->id] = $order; } public function get_orders() { return $this->orders; } public function add_buyer(Samo_Buyer $buyer) { $this->buyer = $buyer; } public function load_from_array($claimDocument) { if (isset($claimDocument['peoples'])) { $_PEOPLES = $claimDocument['peoples']; $peopleStub = Samo_Loader::load_object('Samo_People', $this->config, $this->packetinfo, false); $peopleStub->fields(); foreach ($_PEOPLES as $_people) { $people = clone $peopleStub; $people->load_from_array($_people); $people->strict_check($this->strict_check); $this->add_people($people); $people->self_test(); } unset($_people, $_PEOPLES); } $order_counter = -1; foreach (array('transports' => 'F', 'hotels' => 'H') as $docIndex => $type) { if (isset($claimDocument[$docIndex])) { $_ORDERS = $claimDocument[$docIndex]; foreach ($_ORDERS as $_order) { $order_counter++; $_order['type'] = $type; $_order['id'] = $order_counter; $order = Samo_Loader::load_object('Bron_Order', $this->config, $this->packetinfo, $this->strict_check); $order->load_from_array($_order); $this->add_order($order); } } } if (isset($claimDocument['services'])) { $_ORDERS = $claimDocument['services']; foreach ($_ORDERS as $_order) { if ($_order['key'] != 0) { $order_counter++; switch ($_order['type']) { case 'stVisa': $type = 'V'; break; case 'stInsurance': $type = 'I'; if (isset($order1['headUid'])) { $type = 'IE'; } break; case 'stOther': default: $type = 'S'; break; } $_order['type'] = $type; $_order['id'] = $order_counter; $order = Samo_Loader::load_object('Bron_Order', $this->config, $this->packetinfo, $this->strict_check); $order->load_from_array($_order); $this->add_order($order); } } } if (isset($claimDocument['buyer'])) { $_buyer = Samo_Loader::load_object('Samo_Buyer', $this->config, $this->packetinfo, ($this->log_priority != 'andromeda') ? $this->strict_check : false); $_buyer->load_from_array($claimDocument['buyer']); if ($_buyer->self_test()) { $this->buyer = $_buyer; } } elseif (isset($_SESSION['samo_auth']) && false !== $_SESSION['samo_auth']) { if ($_SESSION['samo_auth']['type'] == 'person' && $_SESSION['samo_auth']['PhysBuyerInc'] > 0) { $_buyer = Samo_Loader::load_object('Samo_Buyer', $this->config, $this->packetinfo, ($this->log_priority != 'andromeda') ? $this->strict_check : false); $_buyer->inc = $_SESSION['samo_auth']['PhysBuyerInc']; $this->buyer = $_buyer; } } unset($_order); $this->self_test(); } public function Is_Additional_infant() { if (!isset($this->additional_infant) || is_null($this->additional_infant)) { $this->additional_infant = false; foreach ($this->peoples as $_people) { if ($_people->ADDITIONAL) { $this->additional_infant = true; } } } return $this->additional_infant; } public function available_services(& $old = array(), & $new = array(), $calc_price = 0, $all_serv = 1) { $old_services = array(); $new_services = array(); $this->infant_services = array(); $db = $this->db(); $xml = $this->claimdocument; $this->additional_infant = $this->Is_Additional_infant(); $sql = $db->formatExec( '<OFFICEDB>.dbo.up_WEB_6_bron_GetServiceAvailable', [ 'ClaimDocument' => $xml, 'calc_price' => $calc_price, 'all_serv' => $all_serv, 'Cat_Claim' => $this->cat_claim, ] ); if (false !== ($res = $db->query($sql))) { while (false !== ($row = $db->fetchRow($res))) { $row['select_tourist'] = isset($row['select_tourist']) ? $row['select_tourist'] : 0; $row['Offered'] = isset($row['Offered']) ? $row['Offered'] : 0; $row['error'] = isset($row['error']) ? $row['error'] : 0; $row['ServiceNote'] = isset($row['ServiceNote']) ? $row['ServiceNote'] : ''; $uid = md5(implode('|', array('S', $row['ServiceInc'], $row['DateBeg']->format('sql'), $row['DateEnd']->format('sql'), 'stOther', $row['HotelInc'], $row['MealInc'], $row['RoomInc'], $row['SrcTownInc'], $row['TrgTownInc'], $row['AirlineInc'], $row['FreightInc'], $row['ClassInc'], $row['RouteIndex']))); $row['uid'] = $uid; $row['soft_uid'] = md5(implode('|', array('S', $row['ServiceInc'], $row['DateBeg']->format('sql'), $row['DateEnd']->format('sql')))); $row['Selected'] = 0; if ($row['Input']) { $old_services[$uid] = $row; } else { $new_services[$uid] = $row; } } } $service_counter = count($this->orders); foreach ($new_services as $new_uid => $new_service) { if (!$new_service['error']) { if ($new_service['Required']) { $new_service['Selected'] = 1; } foreach ($old_services as $old_service) { if ($old_service['uid'] == $new_uid) { $new_service['Selected'] = 1; } elseif ( ($new_service['ServiceInc'] == $old_service['ServiceInc']) && ($new_service['DateBeg'] == $old_service['DateBeg']) && ($new_service['DateEnd'] == $old_service['DateEnd']) && ($new_service['RouteIndex'] == $old_service['RouteIndex']) ) { $new_service['Selected'] = 1; } } } if ($new_service['ServiceCategoryInc'] == self::SERVCATEGORY_INFANT_SUPPLEMENT && $this->additional_infant) { $service_counter++; $clients = array(); foreach ($this->peoples as $_people) { if ($_people->ADDITIONAL) { $clients[] = array( 'peopleKey' => $_people->inc, 'common' => $_people->inc, ); break; } } $_order = array( 'type' => 'S', 'id' => $service_counter, 'key' => $new_service['ServiceInc'], 'datebeg' => $new_service['DateBeg'], 'dateend' => $new_service['DateEnd'], 'count' => 1, 'mealKey' => $new_service['MealInc'], 'roomKey' => $new_service['RoomInc'], 'addinfant' => 0, 'hotelKey' => $new_service['HotelInc'], 'departureTownKey' => $new_service['SrcTownInc'], 'arrivalTownKey' => $new_service['TrgTownInc'], 'transportCompanyKey' => $new_service['AirlineInc'], 'transportKey' => $new_service['FreightInc'], 'classKey' => $new_service['ClassInc'], 'routeIndex' => $new_service['RouteIndex'], 'packet' => $new_service['Packet'], 'partner' => $new_service['Partner'], 'serviceTypeKey' => $new_service['ServiceTypeInc'], 'serviceCategoryKey' => $new_service['ServiceCategoryInc'], 'clients' => $clients, ); $order = Samo_Loader::load_object('Bron_Order', $this->config, $this->packetinfo, $this->strict_check); $order->load_from_array($_order); $this->add_order($order); } else { if ($new_service['ServicePrivate']) { if ($new_service['Required'] || $new_service['Packet']) { $new_services[$new_uid]['Selected'] = 1; $orders = $this->get_orders(); $exist = false; foreach ($orders as $service) { if ('S' == $service->type && $new_service['ServiceInc'] == $service->inc) { $exist = true; break; } } if (!$exist) { $service_counter++; $clients = array(); foreach ($this->peoples as $_people) { $clients[] = array( 'peopleKey' => $_people->inc, 'common' => $_people->inc, ); } $_order = array( 'type' => 'S', 'id' => $service_counter, 'key' => $new_service['ServiceInc'], 'datebeg' => $new_service['DateBeg'], 'dateend' => $new_service['DateEnd'], 'count' => $this->packetinfo['PeopleCount'], 'mealKey' => $new_service['MealInc'], 'roomKey' => $new_service['RoomInc'], 'addinfant' => (int)$this->additional_infant, 'hotelKey' => $new_service['HotelInc'], 'departureTownKey' => $new_service['SrcTownInc'], 'arrivalTownKey' => $new_service['TrgTownInc'], 'transportCompanyKey' => $new_service['AirlineInc'], 'transportKey' => $new_service['FreightInc'], 'classKey' => $new_service['ClassInc'], 'routeIndex' => $new_service['RouteIndex'], 'packet' => $new_service['Packet'], 'partner' => $new_service['Partner'], 'serviceTypeKey' => $new_service['ServiceTypeInc'], 'serviceCategoryKey' => $new_service['ServiceCategoryInc'], 'clients' => $clients, ); $order = Samo_Loader::load_object('Bron_Order', $this->config, $this->packetinfo, $this->strict_check); $order->load_from_array($_order); $this->add_order($order); } } } else { if ($new_service['Selected'] && !isset($old_services[$new_uid])) { $new[] = $new_service; } $new_services[$new_uid] = $new_service; } } } unset($new_service); foreach ($old_services as $old_uid => $old_service) { if (!isset($new_services[$old_uid]) || (!$new_services[$old_uid]['Selected'])) { $old[] = $old_service; } } foreach ($new_services as $new_uid => $new_service) { if ($new_service['ServicePrivate'] || ($new_service['ServiceCategoryInc'] == self::SERVCATEGORY_INFANT_SUPPLEMENT && $this->additional_infant)) { unset($new_services[$new_uid]); } } $result = array_values($new_services); $geo = array('HotelInc', 'SrcTownInc', 'TrgTownInc'); foreach ($old as $old_uid => $old_service) { foreach ($new as $new_uid => $new_service) { if ($old_service['soft_uid'] == $new_service['soft_uid']) { foreach ($geo as $attr) { if ((!$old_service[$attr] && $new_service[$attr] > 0) || ($old_service[$attr] > 0 && !$new_service[$attr]) ) { unset($old[$old_uid], $new[$new_uid]); continue; } } } } } return $result; } public function __set($param, $value) { $param = strtolower($param); if ('claimdocument' == $param) { return $this->load_from_array($value); } if (in_array($param, $this->_allowed_params)) { return $this->_configured_params[$param] = $value; } else { throw new E_NOTICE('Undefined index: ' . $param); } } public function __isset($param) { return (array_key_exists($param, $this->_configured_params) || array_key_exists($param, $this->_allowed_params)); } public function __get($param) { $param = strtolower($param); if (isset($this->_configured_params[$param])) { $return = $this->_configured_params[$param]; } else { switch ($param) { case 'tour': $return = $this->packetinfo['TourInc']; break; case 'spog': $return = $this->packetinfo['Spog']; break; case 'lng': $return = $this->langId(); break; case 'internet_partner': $return = $this->config(strtoupper($param)); break; case 'owner': $return = $this->config('FIRMCODE'); break; case 'user': throw new Exception('Using property "user" detected'); case 'ip': $return = Samo_Request::remote_addr(); break; case 'nights': $return = $this->packetinfo['Nights']; break; case 'useunreadfornote': case 'calctype': $return = 0; break; case 'log_priority': $return = 'info'; break; case 'claimdocument': $return = $this->claim_document(); break; case 'oauth_token': $return = Samo_Request::get('oauth_token'); break; case 'promo_codetext': $return = Samo_Request::post('promo_codetext'); break; default: if (in_array($param, $this->_allowed_params)) { $return = null; } else { throw new E_NOTICE('Undefined property: ' . $param); } break; } $this->_configured_params[$param] = $return; } return $return; } public function self_test() { if ($this->strict_check) { if (isset($this->packetinfo['PeopleCount']) && $peopleCount = count($this->peoples)) { if ($peopleCount < $this->packetinfo['PeopleCount']) { throw new Samo_Exception('Incorrect number of tourists', 400); } } foreach ($this->orders as $order) { if ('V' == $order->type && $order->inc == self::VISA_OWN) { $people = Samo_Loader::load_object('Samo_People', $this->config, $this->packetinfo, $this->strict_check); $vexpire_required = count($people->load(null, array('Field' => 'VEXPIRE', 'Required' => 1))) > 0; if ($vexpire_required) { foreach ($this->peoples as $people) { if (isset($order->peoples[$people->inc]) && $people->VEXPIRE->is_null()) { $people->add_error('TOURIST_EMPTY_FIELD', 'VEXPIRE'); return $people->errors(); } } } } } foreach ($this->peoples as $child) { if (($child->HUMAN == 'CHD' || $child->HUMAN == 'INF') && $child->mustBeAdultPassport()) { $found = false; foreach ($this->peoples as $adult) { if ($adult->inc != $child->inc && ($adult->HUMAN == 'MR' || $adult->HUMAN == 'MRS')) { $fields = ['PSERIE', 'PNUMBER', 'PGIVEN', 'PVALID', 'PGIVENORG']; $found_fields = 0; foreach ($fields AS $field) { if ($adult->$field == $child->$field) { $found_fields++; } } $found = ($found_fields == count($fields)); break; } } if (!$found) { $child->add_error('TOURIST_INCORRECT_PGIVEN', 'PGIVEN'); return $child->errors(); } } } } return true; } public function PacketServices() { $service_packet = array(); $packet = $this->packetinfo; if ($packet['Cat_Claim_Inc']) { $sql = $this->db()->formatExec( '<OFFICEDB>.dbo.up_WEB_4_bron_PacketService', [ 'Cat_Claim' => $packet['Cat_Claim'], 'UserCode' => $this->internet_user(), ] ); if (false !== ($res = $this->db()->query($sql))) { while (false !== ($row = $this->db()->fetchRow($res))) { if (!isset($service_packet[$row['ServiceTypeInc']])) { $service_packet[$row['ServiceTypeInc']] = array( 'Inc' => $row['ServiceTypeInc'], 'Name' => $row['ServiceTypeName'], 'LName' => $row['ServiceTypeLName'], 'Services' => array() ); } $service = array( 'Inc' => $row['ServiceInc'], 'Name' => $row['ServiceName'], 'LName' => $row['ServiceLName'], 'ServiceName' => $row['ServiceName'], 'ServiceLName' => $row['ServiceLName'], 'ServicePrivate' => $row['ServicePrivate'], 'selected' => $row['Selected'], 'required' => $row['Required'], 'DateBeg' => $row['DateBeg'], 'DateEnd' => $row['DateEnd'], 'Url' => $row['ServiceUrl'], 'Packet' => $row['Packet'], 'RouteIndex' => $row['RouteIndex'], 'hotelKey' => $row['HotelInc'], 'mealKey' => $row['MealInc'], 'roomKey' => $row['RoomInc'], 'departureTownKey' => $row['SrcTownInc'], 'arrivalTownKey' => $row['TrgTownInc'], 'transportCompanyKey' => $row['AirlineInc'], 'classKey' => $row['ClassInc'], 'Partner' => $row['Partner'], 'ServiceTypeInc' => $row['ServiceTypeInc'], 'ServiceCategoryInc' => $row['ServiceCategoryInc'], 'attrs' => 'data-name="' . $row['ServiceLName'] . '" data-datebeg="' . $row['DateBeg']->format('sql') . '" data-dateend="' . $row['DateEnd']->format('sql') . '" data-hotelKey="' . $row['HotelInc'] . '" data-mealKey="' . $row['MealInc'] . '" data-roomKey="' . $row['RoomInc'] . '" data-departureTownKey="' . $row['SrcTownInc'] . '" data-arrivalTownKey="' . $row['TrgTownInc'] . '" data-transportCompanyKey="' . $row['AirlineInc'] . '" data-classKey="' . $row['ClassInc'] . '" data-packet="' . $row['Packet'] . '" data-route="' . $row['RouteIndex'] . '" ', ); $_inc = $row['ServiceInc'] . md5($service['DateBeg']->format('sql') . $service['DateEnd']->format('sql') . $row['HotelInc'] . $row['SrcTownInc'] . $row['TrgTownInc'] . $service['RouteIndex']); $service_packet[$row['ServiceTypeInc']]['Services'][$_inc] = $service; } } } return (count($service_packet)) ? $service_packet : false; } public function _getServMustBron() { $return = array(); $sql = $this->db()->formatExec('<ONLINEDB>.dbo.up_WEB_3_bron_ServMustBron', ['Tour' => $this->packetinfo['TourInc']]); if (false !== ($res = $this->db()->fetchAll($sql))) { $return = $res; } return $return; } public function _getServTypeMustBron() { $sql = $this->db()->formatExec( '<OFFICEDB>.dbo.up_WEB_4_bron_ServTypeMustBron', [ 'Tour' => $this->packetinfo['TourInc'], ] ); return $this->db()->fetchAllWithKey($sql, 'ServiceTypeInc'); } public function service_title($row, $name_suffix = 'LName') { if (isset($row['ServicePrivate']) && $row['ServicePrivate'] && !DEBUG) { return 'noname'; } $title = array(); $title[] = $row['Service' . $name_suffix]; $_props = array('TranType' . $name_suffix); foreach ($_props as $idx) { if (isset($row[$idx]) && !empty($row[$idx])) { $title[] = '[' . $row[$idx] . ']'; } } $props = array(); $geo = array(); $_props = array('Hotel' . $name_suffix, 'Room' . $name_suffix, 'Meal' . $name_suffix, 'Airline' . $name_suffix, 'Class' . $name_suffix); foreach ($_props as $idx) { if (isset($row[$idx]) && !empty($row[$idx])) { $props[] = $row[$idx]; } } $_props = array('SrcTown' . $name_suffix, 'TrgTown' . $name_suffix); foreach ($_props as $idx) { if (isset($row[$idx]) && !empty($row[$idx])) { $geo[] = $row[$idx]; } } $description = implode(', ', $props) . ((count($geo)) ? ((count($props)) ? ', ' : '') . implode('—>', $geo) : ''); if (strlen($description)) { $title[] = sprintf('(%s)', $description); } return implode(' ', $title); } public function calc_save($mode = self::CALC_WITHOUT_SAVE, & $return, & $errorMessage) { $calc_result = false; $return = false; $packet_services = null; $this->customer_rules(); $db = $this->db(); $packet = $this->packetinfo; $this->additional_infant = $this->Is_Additional_infant(); if ($packet['Cat_Claim_Inc']) { $packet_services = $this->PacketServices(); if ($packet_services) { $clients = array(); foreach ($this->peoples as $_people) { $clients[] = array( 'peopleKey' => $_people->inc, 'common' => $_people->inc, ); } $service_counter = count($this->orders); foreach ($packet_services as $packet_servtype) { foreach ($packet_servtype['Services'] as $packet_service) { if ($packet_service['ServicePrivate']) { $service_counter++; $_order = array( 'type' => 'S', 'id' => $service_counter, 'key' => $packet_service['Inc'], 'datebeg' => $packet_service['DateBeg'], 'dateend' => $packet_service['DateEnd'], 'count' => $packet['PeopleCount'], 'mealKey' => $packet_service['mealKey'], 'roomKey' => $packet_service['roomKey'], 'addinfant' => (int)$this->additional_infant, 'hotelKey' => $packet_service['hotelKey'], 'departureTownKey' => $packet_service['departureTownKey'], 'arrivalTownKey' => $packet_service['arrivalTownKey'], 'transportCompanyKey' => $packet_service['transportCompanyKey'], 'transportKey' => null, 'classKey' => $packet_service['classKey'], 'routeIndex' => $packet_service['RouteIndex'], 'packet' => $packet_service['Packet'], 'partner' => $packet_service['Partner'], 'serviceTypeKey' => $packet_service['ServiceTypeInc'], 'serviceCategoryKey' => $packet_service['ServiceCategoryInc'], 'clients' => $clients, ); $order = Samo_Loader::load_object('Bron_Order', $this->config, $packet, $this->strict_check); $order->load_from_array($_order); $this->add_order($order); } } } } } $old = array(); $new = array(); if ($packet['Cat_Claim_Inc']) { if (false !== ($available_services = $this->available_services($old, $new, 0, 1))) { if (count($old) > 0) { foreach ($old as $old_service) { if ($old_service['error'] > 0) { throw new Bron_Service_Exception(null, 7, $service = $old_service); } } $service = reset($old); throw new Bron_Exception(sprintf($this->messages('BRON_SERVICE_POST_ERROR_3'), $this->service_title($service)), 3); } } $services_must_bron = $this->_getServMustBron(); $orders = $this->get_orders(); if (count($services_must_bron) > 0) { foreach ($services_must_bron as $service_must_bron) { $exist = false; if (count($orders) > 0) { foreach ($orders as $service) { if ('S' == $service->type && $service_must_bron['ServiceInc'] == $service->inc) { $exist = true; break; } } } if (!$exist) { $flag = true; if ($service_must_bron['conditional']) { $flag = false; foreach ($available_services as $row) { if ($service_must_bron['ServiceInc'] == $row['ServiceInc'] && !$row['error']) { $flag = true; } } } if ($flag) { throw new Bron_Exception(sprintf($this->messages('BRON_SERVICE_POST_ERROR_2'), $this->service_title($service_must_bron)), 2); } } } } if ($packet_services) { foreach ($packet_services as $packet_servtype) { foreach ($packet_servtype['Services'] as $packet_service) { if ($packet_service['required']) { $exist = false; if (count($orders) > 0) { foreach ($orders as $service) { if ('S' == $service->type && $packet_service['Inc'] == $service->inc) { $exist = true; break; } } } if (!$exist) { throw new Bron_Exception(sprintf($this->messages('BRON_SERVICE_POST_ERROR_4'), $this->service_title($packet_service)), 4); } } } } } $stmb = $this->_getServTypeMustBron(); if ($stmb) { $tmp_array = array(); foreach ($stmb as $stmb1) { $exist = false; if (count($orders) > 0) { foreach ($orders as $service) { if ('S' == $service->type) { if (!isset($tmp_array[$service->inc])) { $tmp_array[$service->inc] = $service->serviceTypeKey; } if ($stmb1['ServiceTypeInc'] == $tmp_array[$service->inc]) { $exist = true; } } } } if (!$exist) { $exception = true; if ($stmb1['Conditional']) { $exception = false; foreach ($available_services as $row) { if ($stmb1['ServiceTypeInc'] == $row['ServiceTypeInc']) { $exception = true; break; } } } if ($exception) { throw new Bron_Exception(sprintf($this->messages('BRON_SERVICE_POST_ERROR_5'), $stmb1['ServiceTypeLName']), 5); } } } unset($tmp_array); } } $orders = $this->get_orders(); if (count($orders) > 0) { foreach ($orders as $_order) { if ('F' == $_order->type) { foreach ($_order->peoples as $people => $common) { if (isset($_order->seats[$people]) && isset($_order->seats_service[$people]) && isset($_order->seats_service[$people]['serviceinc']) && $_order->seats_service[$people]['serviceinc'] > 0) { $clients = array(); $clients[] = array( 'peopleKey' => $people, 'common' => $people, ); $seats_service_order = array( 'type' => 'S', 'id' => count($this->orders) + 1, 'key' => $_order->seats_service[$people]['serviceinc'], 'datebeg' => $_order->datebeg, 'dateend' => $_order->dateend, 'count' => 1, 'mealKey' => null, 'roomKey' => null, 'addinfant' => null, 'hotelKey' => null, 'departureTownKey' => isset($_order->seats_service[$people]['servicedeparture']) ? $_order->seats_service[$people]['servicedeparture'] : null, 'arrivalTownKey' => isset($_order->seats_service[$people]['servicearrival']) ? $_order->seats_service[$people]['servicearrival'] : null, 'transportCompanyKey' => $_order->partner(), 'transportKey' => $_order->transportKey, 'classKey' => $_order->placebig, 'routeIndex' => $_order->seats_service[$people]['routeindex'], 'packet' => null, 'partner' => $_order->seats_service[$people]['partner'], 'serviceTypeKey' => null, 'serviceCategoryKey' => self::SERVCATEGORY_SEATS_SUPPLEMENT, 'clients' => $clients, 'seatKey' => $_order->seats[$people], ); $order = Samo_Loader::load_object('Bron_Order', $this->config, $this->packetinfo, $this->strict_check); $order->load_from_array($seats_service_order); $this->add_order($order); } } } } } if ($packet['Cat_Claim_Inc']) { if (false !== ($insures = $this->available_insures())) { foreach ($insures as $insure) { $insure['Required'] = ($insure['Required'] && !$insure['Remove']) || ($insure['Packet'] && !$insure['Remove']); if ($insure['Required']) { $exist = false; if (count($orders) > 0) { foreach ($orders as $order) { if ('I' == $order->type && $insure['InsureInc'] == $order->inc) { $exist = true; break; } } } if (!$exist) { throw new Bron_Exception(sprintf($this->messages('BRON_SERVICE_POST_ERROR_6'), $insure['InsureName']), 6); } } } } } $this->_configured_params['claimdocument'] = null; $sql = $db->formatExec( '<OFFICEDB>.dbo.up_WEB_7_bron_calc_save', [ 'Tour' => $this->tour, 'Spog' => $this->spog, 'Save' => $mode, 'Check' => $this->strict_check, 'Note' => $this->note, 'PartPass' => $this->partpass, 'UserCode' => $this->internet_user(), 'NOTECLAIM' => $this->note, 'Owner' => $this->owner, 'INTERNET_PARTNER' => $this->internet_partner, 'CalcType' => $this->calctype, 'Cat_Claim' => $this->cat_claim, 'UseUnreadForNote' => $this->useunreadfornote, 'Nights' => $this->nights, 'ClaimNote' => $this->claimnote, 'IP' => $this->ip, 'ClaimDocument' => $this->claimdocument, 'LangId' => $this->lng, 'Guid' => $this->guid, 'oauth_token' => $this->oauth_token, 'promo_codetext' => $this->promo_codetext, ] ); $log = array( 'partpass' => $this->partpass, 'sql' => $sql, 'claiminc' => ($this->cat_claim) ? $this->cat_claim : -1, 'message' => ($mode == self::CALC_AND_SAVE) ? 'SAVE' : 'CALC', 'priority' => $this->log_priority, 'claimdocument' => $this->claimdocument, ); $msgid = $db->web_log_table($log); $e = null; try { $res = $db->query($sql); $return = $db->fetchRow($res); $log['result']['return'] = $return; if ($return) { if (!array_key_exists('promo_sum', $return)) { $return['promo_sum'] = 0; $return['promo_currency'] = ''; } if (array_key_exists('ExternalFreightMessage', $return) && strlen($return['ExternalFreightMessage']) > 0) { $log['result']['return']['ExternalFreightMessage'] = '<skipped from log/>'; } if (array_key_exists('ExternalFreightNote', $return) && strlen($return['ExternalFreightNote']) > 0) { $log['result']['return']['ExternalFreightNote'] = '<skipped from log />'; } if (array_key_exists('error', $return)) { $errorMessage = (null !== $return['error'] && !empty($return['error'])) ? $return['error'] : 'Unknown error'; if (array_key_exists('log_message', $return)) { $log['result']['message'] = $return['log_message']; } $return = null; } else { $log['claim'] = ($mode == self::CALC_AND_SAVE) ? $return['Claim'] : null; $calc_result = true; } $return['stop_bron'] = 0; if ($db->nextResult($res)) { if (false !== ($messages = $db->fetchAll($res))) { $return['result_messages'] = $messages; $arr = array_column($messages, 'stop_bron'); $return['stop_bron'] = (!empty($arr)) ? max($arr) : 0; } } } else { throw new Database_Exception('Unexpected return value', 500, $db); } } catch (Database_Exception $e) { $log['result']['error'] = $db->lastError(); } $db->web_log_table($log, $msgid); if ($e) { throw $e; } $return = $this->claimFixCost($return); return $calc_result; } protected function claimFixCost($result) { if (is_array($result) && array_key_exists('Claim', $result) && $result['Claim'] > 0) { $this->andromeda_ugly_hack(); $claim = Samo_Loader::load_object('Samo_Claim'); if ($this->buyer) { $_SESSION['samo_auth']['ClaimList'][] = $result['Claim']; } $claim->construct($result['Claim']); if (false !== ($costs = $claim->claimCost())) { $cost = reset($costs); $result['Currency_Alias'] = $cost['CurrencyAlias']; $result['PriceStr'] = isset($cost['Amount_to_pay_person']) ? $cost['Amount_to_pay_person'] : $cost['Catalog']; $result['SumCommission'] = $cost['Commiss']; } } return $result; } public function claim_document() { $packet = $this->packetinfo; $claimDocument = new Samo_SimpleXMLElement('<claimDocument></claimDocument>'); $claimDocument->addAttribute('condition', 'ccBooked'); $claimDocument->addAttribute('status', 'csNotReaded'); $claimDocument->addAttribute('payStatus', 'psNotPaid'); $claimDocument->addAttribute('townFromKey', $packet['TownFromInc']); $claimDocument->addAttribute('spoKey', $packet['Spog']); $claimDocument->addAttribute('stateKey', $packet['StateInc']); $claimDocument->addAttribute('datebeg', $packet['CheckIn']); $claimDocument->addAttribute('comissionPercent', $packet['TotalCommission']); $claimDocument->addAttribute('tourKey', $packet['TourInc']); $claimDocument->addAttribute('catalogKey', $packet['Cat_Claim_Inc']); $claimDocument->addAttribute('peopleCount', $packet['PeopleCount']); $claimDocument->addAttribute('nights', $packet['Nights']); $claimDocument->addAttribute('crcPacket', (isset($packet['crc_packet']) ? $packet['crc_packet'] : null)); if (isset($packet['Revision'])) { $claimDocument->addAttribute('revisionKey', $packet['Revision']); } if ($this->mediator) { $claimDocument->addAttribute('mediatorKey', $this->mediator); } if ($this->contacts) { $claimDocument->addChildWithCDATA('contacts', $this->contacts); } if ($this->reklama) { $claimDocument->addChild('reklama', $this->reklama); } if ($this->buyer) { $buyer = $claimDocument->addChild('buyer'); if ($this->buyer->inc > 0) { $buyer->addAttribute('key', $this->buyer->inc); } else { $buyer->addStringAttribute('name', $this->buyer->NAME); $buyer->addStringAttribute('address', $this->buyer->ADDRESS); $buyer->addStringAttribute('pserie', $this->buyer->PSERIE); $buyer->addStringAttribute('pnumber', $this->buyer->PNUMBER); $buyer->addAttribute('pgiven', $this->buyer->PGIVEN); $buyer->addStringAttribute('pgivenorg', $this->buyer->PGIVENORG); $buyer->addStringAttribute('pgivencode', $this->buyer->PGIVENCODE); $buyer->addStringAttribute('mobile', $this->buyer->MOBILE); $buyer->addStringAttribute('phone', $this->buyer->MOBILE); $buyer->addStringAttribute('email', $this->buyer->EMAIL); $buyer->addAttribute('born', $this->buyer->BORN); $buyer->addStringAttribute('smsmailing', $this->buyer->SMSMAILING); $buyer->addStringAttribute('emailing', $this->buyer->EMAILING); } } if ($this->claim_owner) { $claimDocument->addAttribute('ownerKey', $this->claim_owner); } $peoples = $claimDocument->addChild('peoples'); foreach ($this->peoples as $_people) { $people = $peoples->addChild('people'); $people->addAttribute('key', abs($_people->inc)); $people->addAttribute('sex', ($_people->MALE) ? 'MALE' : 'FEMALE'); $people->addAttribute('human', $_people->HUMAN); $people->addAttribute('age', $_people->xmlage()); $people->addStringAttribute('name', $_people->NAME); $people->addStringAttribute('lname', $_people->LNAME); $people->addAttribute('born', $_people->BORN); $people->addStringAttribute('pserie', $_people->PSERIE); $people->addStringAttribute('pnumber', $_people->PNUMBER); $people->addAttribute('pexpire', $_people->PVALID); $people->addAttribute('vexpire', $_people->VEXPIRE); $people->addAttribute('pgiven', $_people->PGIVEN); $people->addStringAttribute('pgivenorg', $_people->PGIVENORG); $people->addAttribute('nationalityKey', $_people->NATIONALITY); $people->addAttribute('bornplaceKey', $_people->PLACEBORN); $people->addStringAttribute('address', $_people->ADDRESS); $people->addStringAttribute('phone', $_people->PHONE); $people->addStringAttribute('mobile', $_people->MOBILE); $people->addStringAttribute('email', $_people->EMAIL); $people->addStringAttribute('bornplaceDetail', $_people->PLACEBORNDETAIL); $people->addStringAttribute('inn', $_people->INN); if ($_people->ADDITIONAL) { $people->addAttribute('additional', 1); } } $hotels = $claimDocument->addChild('hotels'); $transports = $claimDocument->addChild('transports'); $services = $claimDocument->addChild('services'); $claimDateEnd = Samo_Datetime::null(); $fare = true; foreach ($this->orders as $_order) { switch ($_order->type) { case 'H': $hotel = $hotels->addChild('hotel'); $hotel->addAttribute('uid', $_order->uid()); $hotel->addAttribute('key', $_order->inc); $hotel->addAttribute('datebeg', $_order->datebeg); $hotel->addAttribute('dateend', $_order->dateend); $hotel->addAttribute('roomKey', $_order->placebig); $hotel->addAttribute('htplaceKey', $_order->place); $hotel->addAttribute('mealKey', $_order->mealKey); $hotel->addAttribute('count', $_order->count); $hotel->addAttribute('cureKey', 1); $hotel->addAttribute('addinfant', $_order->ainfant); $hotel->addAttribute('routeIndex', $_order->routeIndex); $clients = $hotel->addChild('clients'); foreach ($_order->peoples as $people => $common) { $client = $clients->addChild('client'); $client->addAttribute('peopleKey', abs($people)); $client->addAttribute('common', $common); } break; case 'F': $uid_new = $_order->uid($with_id = false); if (!isset($uid_old)) { $uid_old = $uid_new; } elseif ($uid_old != $uid_new) { $fare = false; } $transport = $transports->addChild('transport'); $transport->addAttribute('uid', $_order->uid()); $transport->addAttribute('key', $_order->inc); $transport->addAttribute('datebeg', $_order->datebeg); $transport->addAttribute('dateend', $_order->dateend); $transport->addAttribute('classKey', $_order->placebig); $transport->addAttribute('frplaceKey', $packet['FrplaceInc']); $transport->addAttribute('fareKey', $_order->fareKey); $transport->addAttribute('count', $_order->count); $transport->addAttribute('addinfant', $_order->ainfant); $transport->addAttribute('partnerKey', $_order->partner()); $transport->addAttribute('htplaceKey', (isset($packet['HtPlaceInc']) ? $packet['HtPlaceInc'] : null)); $transport->addAttribute('roomKey', (isset($packet['RoomInc']) ? $packet['RoomInc'] : null)); $transport->addAttribute('mealKey', (isset($packet['MealInc']) ? $packet['MealInc'] : null)); $transport->addAttribute('hotelKey', (isset($packet['HotelInc']) ? $packet['HotelInc'] : null)); $transport->addAttribute('external', $_order->external); $clients = $transport->addChild('clients'); foreach ($_order->peoples as $people => $common) { $client = $clients->addChild('client'); $client->addAttribute('peopleKey', abs($people)); $client->addAttribute('common', $common); if (isset($_order->seats[$people])) { $client->addAttribute('seatKey', $_order->seats[$people]); } } break; default: $this->claim_document_add_service($services, $_order); } if ($claimDateEnd->is_null() || $_order->dateend->gt($claimDateEnd)) { $claimDateEnd = $_order->dateend; } } if (('tickets' == $this->log_priority) && ($fare)) { foreach ($transports->children() as $transport) { $transport->addAttribute('fareKey', self::FAREKEY_ONEWAY); } } if ($this->peoples && $this->config('SEAT_YOUNGEST_INFANT_WITH_ADULT', 'bron')) { $infant = end($this->peoples); if (!$infant->ADDITIONAL && $infant->is_infant_age()) { $this->claim_document_add_transport_for_infant($claimDocument, $infant); } } $ic = $claimDocument->xpath("//services/service[@type='stInsurance' and not(not(@headUid))]"); foreach ($ic as $node_instcust) { $ins = $claimDocument->xpath("//services/service[@type='stInsurance' and not(@headUid)]"); foreach ($ins as $node) { if ((string)$node_instcust['headUid'] == (string)$node['key'] && (string)$node_instcust['datebeg'] == (string)$node['datebeg'] && (string)$node_instcust['dateend'] == (string)$node['dateend']) { $cl_ins = array(); foreach ($node_instcust->clients->client as $c) { $cl_ins[] = (int)$c['peopleKey']; } $cl_med = array(); foreach ($node->clients->client as $c) { $cl_med[] = (int)$c['peopleKey']; } if (!count(array_diff($cl_ins, $cl_med))) { $node_instcust['headUid'] = (string)$node['uid']; break; } } } } $claimDocument->addAttribute('dateend', $claimDateEnd->is_null() ? $packet['CheckOut'] : $claimDateEnd); $return = $claimDocument->asXML(); return $return; } protected function claim_document_add_service(& $services, $_order) { $service = $services->addChild('service'); $service->addAttribute('uid', $_order->uid()); $service->addAttribute('key', $_order->inc); $service->addAttribute('datebeg', $_order->datebeg); $service->addAttribute('dateend', $_order->dateend); $service->addAttribute('type', $_order->xmltype()); $service->addAttribute('count', $_order->count); $service->addAttribute('addinfant', $_order->ainfant); if ($_order->hotelKey) { $service->addAttribute('hotelKey', $_order->hotelKey); } if ($_order->mealKey) { $service->addAttribute('mealKey', $_order->mealKey); } if ($_order->roomKey) { $service->addAttribute('roomKey', $_order->roomKey); } if ($_order->departureTownKey) { $service->addAttribute('departureTownKey', $_order->departureTownKey); } if ($_order->arrivalTownKey) { $service->addAttribute('arrivalTownKey', $_order->arrivalTownKey); } if ($_order->transportCompanyKey) { $service->addAttribute('transportCompanyKey', $_order->transportCompanyKey); } if ($_order->transportKey) { $service->addAttribute('transportKey', $_order->transportKey); } if ($_order->classKey) { $service->addAttribute('classKey', $_order->classKey); } if ($_order->packet) { $service->addAttribute('packet', $_order->packet); } $service->addAttribute('routeIndex', $_order->routeIndex); $service->addAttribute('partnerKey', $_order->partner()); if ($_order->headUid) { $service->addAttribute('headUid', $_order->headUid); } if ($_order->seatKey) { $service->addAttribute('seatKey', $_order->seatKey); } if ($_order->hotelUid) { $service->addAttribute('hotel_uid', $_order->hotelUid); } $clients = $service->addChild('clients'); foreach ($_order->peoples as $people => $common) { $client = $clients->addChild('client'); $client->addAttribute('peopleKey', abs($people)); $client->addAttribute('common', $common); } } protected function claim_document_add_transport_for_infant($claimDocument, $infant) { $infant_key = abs($infant->inc); $tps = $claimDocument->xpath('//transport/clients/client[@peopleKey="' . $infant_key . '"]/../..'); foreach ($tps as $tp) { if (intval($tp['count']) < 2 || intval($tp['count']) != count($tp->clients->client)) { continue; } $parent_key = null; if (intval($tp['count']) == 2) { $tpi = $tp; } else { $tpi = clone $tp; $claimDocument->transports->import($tpi); foreach ($tp->xpath('./clients/client') as $client) { $people_key = intval($client['peopleKey']); if ($people_key == $infant_key) { $client->remove(); } elseif (!$parent_key) { $parent_key = $people_key; $client->remove(); } } $tp['count'] = count($tp->clients->client); } $tpi['uid'] = md5(strval($tpi['uid']) . 'addinfant'); $tpi['count'] = 1; $tpi['addinfant'] = 1; foreach ($tpi->xpath('./clients/client') as $client) { $people_key = intval($client['peopleKey']); if ($people_key == $infant_key) { $client['common'] = -1; unset($client['seatKey']); } elseif (!$parent_key || $people_key == $parent_key) { $client['common'] = -1; $parent_key = $people_key; } else { $client->remove(); } } } } private function andromeda_ugly_hack() { $registry = Samo_Registry::instance(); if (!isset($registry['cache'])) { Samo_Registry::load('cache', 'Samo_Cache'); Samo_Registry::load('request', 'Samo_Request'); Samo_Registry::load('response', 'Samo_Response'); Samo_Registry::load('view', 'Samo_View'); } if (!isset($registry['messages'])) { $this->messages(''); } } public function available_insures() { $db = $this->db(); $packet = $this->packetinfo; $xml = $this->claimdocument; $result = array(); $sql = $db->formatExec( '<OFFICEDB>.dbo.up_WEB_6_bron_GetInsureAvailable', [ 'Cat_Claim' => $packet['Cat_Claim'], 'ClaimDocument' => $xml, 'UserCode' => $this->internet_user(), 'LangId' => $this->lng, ] ); $db->errorField('error'); if (false !== ($res = $db->query($sql))) { while (false !== ($row = $db->fetchRow($res))) { $row['inscusts'] = array(); $row['type'] = 'stInsurance'; $row['Required'] = $row['Required'] || ($row['Packet'] && !$row['Remove']); $result[] = $row; } while (false !== ($row = $db->fetchRow($res))) { foreach ($result as &$main_insure) { if ($row['Insure'] == $main_insure['InsureInc']) { $row['type'] = 'stInsurance'; $main_insure['inscusts'][] = $row; break; } } } } $db->errorField(''); return (count($result)) ? $result : false; } } 