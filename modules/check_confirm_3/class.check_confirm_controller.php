<?php
 class Check_Confirm_Controller extends Samo_Controller { protected $embeddable = array('default_action'); public function default_action() { if (!(isset($_GET['DOLOAD']) && $this->is_embedable() && Samo_Request::get('samo_action') == 'embed')) { $res = array('claim_required' => $this->model->defaults['claim_required'], 'pnumber_required' => $this->model->defaults['pnumber_required'], 'fio_required' => $this->model->defaults['fio_required']); $this->view->assign('fields', $res) ->js_var('samo.claim_required', $this->model->defaults['claim_required']) ->js_var('samo.pnumber_required', $this->model->defaults['pnumber_required']) ->js_var('samo.fio_required', $this->model->defaults['fio_required']); } if (isset($_GET['DOLOAD'])) { $this->check(); } parent::default_action(); } public function check_popup() { if ($this->get_confirm()) { $this->default_app_env(); $this->view->render('popup'); } else { $this->view->error($this->messages['CLAIM_NOT_FOUND']); } } public function check() { $embedable = $this->is_embedable() && Samo_Request::get('samo_action') == 'embed'; $doload = Samo_Request::get('DOLOAD'); try { $confirm = $this->get_confirm(); $this->view->assign('is_embedable', $embedable); if (!$embedable || !$doload) { $this->view->popup_template('resultset.tpl', $this->messages['PAGE_TITLE'], ($confirm) ? 700 : 600, ($confirm) ? 180 : 50); } if ($confirm && !$doload) { $this->view->js_call('samo.phones'); } } catch (Samo_Exception $e) { $this->view->assign('is_embedable', $embedable) ->assign('is_error', $e->getMessage()); if (!$embedable || !$doload) { $this->view->popup_message($e->getMessage(), $this->messages['PAGE_TITLE'], 350, 100, true); } } } private function get_confirm() { if (false !== ($result = $this->model->check_confirm())) { $this->auth_init(); $_SESSION['check_confirm_auth'] = $this->model->check_auth($result['Claim'], $result['pnumber']); if ($this->model->defaults['pnumber_required'] && $this->model->defaults['claim_required'] && (!isset($_SESSION['samo_auth']) || $_SESSION['samo_auth'] == false)) { $_SESSION['samo_auth'] = $_SESSION['check_confirm_auth']; } $this->view->assign('confirmation', $result); return true; } return false; } public function SAVE_PHONES() { try { $this->auth_init(); if (isset($_SESSION['check_confirm_auth']) && $_SESSION['check_confirm_auth'] != false) { $old_auth = isset($_SESSION['samo_auth']) ? $_SESSION['samo_auth'] : false; $_SESSION['samo_auth'] = $_SESSION['check_confirm_auth']; $this->model->save_phones(); $this->view->popup_close(); $_SESSION['samo_auth'] = $old_auth; } } catch (Samo_People_Exception $e) { $errors = $e->getErrors(); foreach ($errors as $error => $fields) { $this->view->message($error, 'error'); foreach ($fields as $field) { $this->view->add_class('[name*="' . $field['FormField'] . '"]', 'error'); } } Samo_Registry::get('response')->output(); } } } 