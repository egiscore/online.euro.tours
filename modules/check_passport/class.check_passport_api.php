<?php
 class Check_Passport_Api extends Api_Model { public function __construct(Samo_Config $config, $callback = null) { parent::__construct($config, $callback); $this->field_type['integer'][] = 'VISAINC'; $this->field_type['integer'][] = 'CITIZENSHIP'; $this->field_type['integer'][] = 'BORNPLACE'; $this->field_type['integer'][] = 'NIGHTS'; } protected function _getResult() { $this->db->errorField('error'); $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEBST_passport_check', [ 'State' => $this->getParam('STATEINC'), 'PlaceOfBorn' => $this->getParam('BORNPLACE'), 'Citizenship' => $this->getParam('CITIZENSHIP'), 'CheckIn' => $this->getParam('CHECKIN'), 'Nights' => $this->getParam('NIGHTS'), 'UserCode' => $this->internet_user(), 'Visa' => null, 'Pvaliddate' => $this->getParam('PVALIDDATE'), ] ); $result = []; $return = $this->db->fetchOneRow($sql); $this->db->errorField(false); $result['allow'] = ($return['isok'] && $return['allow'] < 2) ? 1 : 0; $result['validDate'] = $return['valid_date']; $result['ruleNote'] = $return['rule_note']; $result['visaRequired'] = $return['allow'] == 1 ? 1 : 0; unset($return); return $result; } private function countries($selected) { $people = Samo_Loader::load_object('Samo_People', $this->config); return $people->states($selected); } public function _getCITIZENSHIPS() { return $this->countries($this->getParam('CITIZENSHIP')); } public function _getBORNPLACES() { return $this->countries($this->getParam('BORNPLACE')); } protected function _getALL() { $result = array(); foreach (array( 'TOWNFROMS', 'STATES', 'CITIZENSHIPS', 'BORNPLACES', ) as $row) { $method = '_get' . $row; if (method_exists($this, $method)) { $result[$row] = $this->$method(); } } return $result; } protected function filterTownFrom($town) { return (Samo::TOWNFROMHOTELINC != $town['id']); } } 