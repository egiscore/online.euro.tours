<?php
 class Claim_Act_Model extends Samo { public $auth_required = array('agency'); protected $messages = []; public function construct($act = null) { $this->messages = Samo_Registry::get('messages'); if ($_SESSION['samo_auth']['permissions']['print_act'] == 0) { throw new Samo_Exception($this->messages['ACCESS_DENIED'], 403); } $this->defaults['ACT_INC'] = Samo_Utils::ifs($act, Samo_Request::intval('act')); } public function acts() { $sql = $this->db->formatExec('<OFFICEDB>.dbo.up_GetActList', ['partpass' => $this->getPartPassInc()]); $result = Samo_Utils::ifs($this->db->fetchAll($sql), array()); foreach ($result as &$act) { $act['DateBeg'] = $act['datefrom']; $act['DateEnd'] = $act['datetill']; $act['DDate'] = $act['ddate']; } uasort( $result, function($a, $b) { return $a['DateBeg']->gt($b['DateBeg']); } ); return $result; } public function act($act = null) { $act = (is_null($act)) ? $this->defaults['ACT_INC'] : $act; if ($act) { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_SelectForActReport', [ 'ActInc' => $act, 'User' => $this->internet_user(), ] ); $acts = Samo_Utils::ifs($this->db->fetchAll($sql), array()); $partners = array($this->getPartner()); if ($_SESSION['samo_auth']['Administrator'] && $_SESSION['samo_auth']['PARTNERGROUP'] > 0) { $sql = $this->db->formatExec( "<OFFICEDB>.dbo.up_WEB_3_group_partners", [ 'PartnerGroup' => $_SESSION['samo_auth']['PARTNERGROUP'], ] ); $partners = array_keys( $this->db->fetchAllWithKey($sql, 'PartnerInc') ); } foreach ($acts as &$result) { foreach ($result as $key => $val) { $key = str_replace('$', '_', $key); $result[$key] = $val; } if (!in_array($result['d_partner'], $partners)) { throw new Samo_Exception($this->messages['ACCESS_DENIED'], 401); } $result['Partner'] = $this->_getPartnerInfo($result['d_partner'], false); $result['Owner'] = $this->getPartnerInfo($result['d_owner']); } return $acts; } return false; } public function get_template_claim_act() { $res = $this->get_settings_printform($doccategory = 6, $partner = null, $tour = null, $state = null, $inszone = null, $contracttype = null, $agreement_year = null); if ($res) { return true; } return $this->messages['TEMPLATE_NOT_INSTALL']; } protected function getExternalDocumentInit() { if ($this->defaults['ACT_INC']) { return $this->getExternalDocumentJob(sprintf('act_%d', $this->defaults['ACT_INC']), sprintf('act_%%s_%%s.pdf')); } throw new Samo_Exception($this->messages['CANNOT_PRINT']); } protected function getExternalDocumentParams() { if (true !== ($res = $this->get_template_claim_act())) { throw new Samo_Exception($this->messages['TEMPLATE_NOT_INSTALL']); } $info = pathinfo($this->defaults['template']); if ($this->external !== true) { throw new Samo_Exception($this->messages['CANNOT_PRINT']); } $params = array( 'inc' => $this->defaults['ACT_INC'], 'template' => $info['filename'], 'USER' => $this->internet_user(), 'partpass' => $this->getPartPassInc(), ); return $params; } } 