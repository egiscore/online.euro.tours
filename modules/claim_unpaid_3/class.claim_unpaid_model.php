<?php
 class Claim_Unpaid_Model extends Samo_Claim { protected $auth_required = array('agency'); public function claim_list() { $this->defaults['DEPOSIT'] = Samo_Utils::ifs(Samo_Request::intval('DEPOSIT'), null); $this->defaults['DEPOSIT_SUM'] = null; $this->defaults['DEPOSIT_CURRENCY_ALIAS'] = null; $pay_variant_link = null; $routes = Samo_Registry::get('routes'); $tomorrow = Samo_Datetime::parse('tomorrow'); if (isset($routes['pay_variant'])) { $pay_variant_link = $routes['pay_variant']['url']; } $res_deposit_claim = array(); $res_deposit_claim_index = array(); if (!is_null($this->defaults['DEPOSIT'])) { $deposit = Samo_Loader::load_object('Deposit_Model', $this->config); $deposit->construct(); $deposit->mail = 'claim_unpaid'; $_GET['PINC'] = $this->defaults['DEPOSIT']; $deposit->check_Deposit(); $res = $deposit->getCaims_by_payment(); foreach ($res as $row) { $res_deposit_claim[$row['claim']] = $row; $res_deposit_claim_index[] = $row['claim']; } $dep = $deposit->defaults['DEPOSIT']; $this->defaults['DEPOSIT_SUM'] = $dep['rest']; $this->defaults['DEPOSIT_CURRENCY_ALIAS'] = $dep['currency_alias']; $this->claimcost_datetype = 'DATE'; $this->claimcost_rate_date = $dep['pdate']; } $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEBST_claim_Unpaid', [ 'Partpass' => $this->defaults['PARTPASS'], 'Rate_Type' => $this->claimcost_rate_type, 'CurrType' => $this->claimcost_currtype, 'DateType' => $this->claimcost_datetype, 'Rate_Date' => $this->claimcost_rate_date, 'Calc' => intval(is_null($this->defaults['DEPOSIT'])), 'UserCode' => $this->internet_user(), 'LangId' => Samo_Request::langid(), 'FilterEarlyCommission' => Samo_Request::bitval('EARLYCOMISSION'), 'FilterPayNearFuture' => Samo_Request::bitval('NEARFUTURE'), ] ); if ($res = $this->db->fetchAll($sql)) { foreach ($res as $key => &$row) { $enable_pay = (isset($routes['pay_variant']) && (1 == $row['Confirmed']) && $row['RequestCancelDate']->is_null() && (is_null($this->defaults['DEPOSIT']) || (isset($res_deposit_claim[$row['Claim']]) && $res_deposit_claim[$row['Claim']]['Debt'] > 0))); if (is_null($this->defaults['DEPOSIT']) || (in_array($row['Claim'], $res_deposit_claim_index) && $enable_pay) ) { if ($row['rate_dateex']->ne($tomorrow)) { $row['rate_dateex'] = Samo_Datetime::null(); } $params = array(); $params['CLAIM'] = $row['Claim']; $row['pay_variant_link'] = $pay_variant_link . http_build_query($params); $row['enable_pay'] = $enable_pay; if (!is_null($this->defaults['DEPOSIT'])) { $row['Debt_now'] = $row['Debt'] = $res_deposit_claim[$row['Claim']]['Debt']; $row['Amount_now'] = $res_deposit_claim[$row['Claim']]['Amount']; $row['CurrencyAlias'] = $deposit->defaults['DEPOSIT']['currency_alias']; } } else { unset($res[$key]); } } } return $res; } } 