<?php
 class Currency_Api extends Api_Model { public function __construct(Samo_Config $config, $callback = null) { $this->field_type['datetime'] = ['DATEBEG', 'DATEEND']; parent::__construct($config, $callback); } public function _getCURRENCIES() { $cache_key = __METHOD__; if (false === ($return = $this->cache->get($cache_key))) { $return = []; if (false !== ($list = $this->db->fetchAll('<ONLINEDB>.dbo.up_WEB_3_currency_list'))) { $return = []; foreach ($list as $row) { $return[] = [ 'id' => $row['Inc'], 'name' => $row['Alias'], ]; } } $this->cache->set($cache_key, $return); } return $return; } public function _getRates() { $params = [ 'Currency' => $this->getParam('CURRENCY'), 'Base' => $this->getParam('CURRENCYBASE'), 'DateBeg' => $this->getParam('DATEBEG'), 'DateEnd' => $this->getParam('DATEEND'), 'UserCode' => $this->internet_user(), ]; $cache_key = __METHOD__ . implode('_', $params); if (false === ($return = $this->cache->get($cache_key))) { $sql = $this->db->formatExec('<OFFICEDB>.dbo.up_WEB_3_currency_rates', $params); if (false !== ($rates = $this->db->fetchAll($sql))) { $return = array(); foreach ($rates as $row) { $return[] = array( 'currencyKey' => $row['CurrencyInc'], 'currency' => $row['CurrencyName'], 'currencyAlt' => $row['CurrencyName'], 'currencyBaseKey' => $row['CurrencyBaseInc'], 'currencyBase' => $row['CurrencyBaseName'], 'currencyBaseAlt' => $row['CurrencyBaseName'], 'date' => $row['Date'], 'dateRate' => $row['RateDate'], 'rate' => $row['BankRate'], 'change' => $row['ChangeValue'], ); } $this->cache->set($cache_key, $return); } } return $return; } } 