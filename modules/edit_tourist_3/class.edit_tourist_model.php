<?php
 class Edit_Tourist_Model extends Samo_Claim { protected $claim = null; protected $last_error = null; protected function packetInfo($inc) { parent::construct(null, $inc); $packetInfo = Samo_Loader::load_object('Packet_Info', $this->config); $packetInfo->load_from_claim( $this->claimInfo(), array( 'ADMINISTRATOR' => $this->defaults['ADMINISTRATOR'], 'PARTNER' => $this->defaults['PARTNER'], 'PARTPASS' => $this->defaults['PARTPASS'], 'PARTNERGROUP' => $this->defaults['PARTNERGROUP'] ) ); return $packetInfo; } public function check($inc) { $this->last_error = null; $people = Samo_Loader::load_object('Samo_People', $this->config, $this->packetInfo($inc)); $people->load($inc); $people->self_test(); return true; } public function save($inc, $params) { $people = Samo_Loader::load_object('Samo_People', $this->config, $this->packetInfo($inc), true); $people->is_exists($inc); if (!$this->is_enable($people)) { throw new Samo_Exception($this->last_error, 1); } return $people->save($inc, $params); } public function last_error() { return $this->last_error; } public function find($inc) { $this->last_error = null; $people = Samo_Loader::load_object('Samo_People', $this->config, $this->packetInfo($inc)); $return = $people->load($inc); if (!$this->is_enable($people)) { foreach ($return as &$fields) { foreach ($fields as &$field) { $field['Editable'] = 0; } } } return $return; } protected function is_enable(Samo_People $_people) { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_4_edit_tourist_Check', [ 'People' => $_people->inc, 'LangId' => Samo_Request::langid(), 'UserCode' => $this->internet_user(), ] ); $result = true; if (false !== ($row = $this->db->fetchRow($sql))) { $this->last_error = $row['Reason']; $result = $row['Status'] == 0; } return $result; } } 