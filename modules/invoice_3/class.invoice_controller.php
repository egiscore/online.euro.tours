<?php
 class Invoice_Controller extends Samo_Controller { public function CHECK() { try { $this->model->is_enabled(); $this->model->get_template_invoice(); $this->view->js_call_if_exists('samo.invoice_print', $this->model->defaults['CLAIM'], $this->model->external); } catch (Samo_Exception $e) { $this->view->js_call_if_exists('samo.invoice_error', $this->model->defaults['CLAIM'], $e->getMessage()); } } public function default_action() { try { $this->model->get_template_invoice(); if ($this->model->external) { $this->PDF_SAMOTOUR(); } else { $this->model->invoice(); $this->assign(); $this->default_app_env(); $this->view->full_paths(true)->assign('WWWROOT', Samo_Url::route('/')); $this->view->assign('content_for_layout', $this->view->fetch($this->model->defaults['template'])); $response = Samo_Registry::get('response'); if ($response->respond_to_js()) { $content = $this->view->fetch('layout.tpl'); $prefix = 'invoice_' . $this->model->defaults['CLAIM']; $ext = 'html'; $url = Samo_Utils::tempFile($prefix, $ext, $content); $this->view->js_call('samo.download_result', array('guid' => Samo_Request::find('guid'), 'label' => '', 'url' => $url)); } else { $this->view->render('layout'); } } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } protected function assign() { $model = $this->model; $this->view ->assign('CLAIM', $model->defaults['CLAIM']) ->assign('owner_info', $model->defaults['OWNER_INFO']) ->assign('partner_info', $model->defaults['AGENCY_INFO']) ->assign('invoice', $model->defaults['INVOICE']) ->assign('als', $model->defaults['als']); } } 