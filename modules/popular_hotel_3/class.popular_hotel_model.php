<?php
 class Popular_Hotel_Model extends Search_Tour_Model { public function construct() { $this->defaults['STATEINC'] = (isset($_GET['STATEINC']) && intval($_GET['STATEINC'])) ? intval($_GET['STATEINC']) : ((isset($_COOKIE['pSTATEINC']) && intval($_COOKIE['pSTATEINC'])) ? intval($_COOKIE['pSTATEINC']) : $this->getConfig('STATE_DEFAULT')); $this->defaults['PERIOD'] = (isset($_GET['PERIOD']) && ($period = intval($_GET['PERIOD']))) ? $period : 1; $this->cacheFile = SMARTY_COMPILE_DIR . '/pop_' . $this->townFrom() . '_' . $this->defaults['STATEINC'] . '_' . $this->defaults['PERIOD'] . '.php'; $this->cachePeriod = 1800; } public function getResult() { if ($this->is_cached()) { $data = $this->getCache(); } else { if ($data = $this->fetchData()) { $this->putCache($data); } } return $data; } protected function fetchData() { $sql = $this->db->formatExec( '<OFFICEDB>.dbo.up_WEB_3_popular_hotel', [ 'TownFrom' => $this->townFrom(), 'State' => $this->defaults['STATEINC'], 'Period' => $this->defaults['PERIOD'], ] ); return $this->db->fetchAll($sql); } protected function is_cached() { return (false !== ($mtime = @filemtime($this->cacheFile)) && ($mtime + $this->cachePeriod) > $_SERVER['REQUEST_TIME']); } protected function getCache() { $data = false; include $this->cacheFile; return $data; } protected function putCache($data) { $content = '<' . '?php' . PHP_EOL . '$data = ' . var_export($data, true) . ';' . PHP_EOL . '?' . '>'; return Samo_Utils::writeFile($this->cacheFile, $content); } } 