<?php
 class Register_Agency_Controller extends Samo_Controller { public $model; public function construct() { $this->auth_init(); } public function default_action() { $partner = $this->model->get_fields_partner(); $partpass = $this->model->get_fields_partpass(); $registerByInn = false; $useDadata = $this->model->getConfig('PermitAutofillByINN', 'Online', 0); $inn = Samo_Request::strval('INN', 10, 12); $getInn = $inn && is_numeric($inn) && Samo_Validate::Partner_inn($inn) ? $inn : ''; if (defined('REGISTER_BY_INN') && REGISTER_BY_INN && $useDadata) { if ($russiaInc = $this->model->getRussiaStateInc()) { $selectedState = Samo_Request::get('STATEFROM'); if ($states = $this->model->getStates($selectedState)) { if ($registerByInn = array_key_exists($russiaInc, $states) && !$getInn) { if ($selectedState && $selectedState != $russiaInc) { $registerByInn = false; } else { $this->view->assign('states', $states)->js_var('samo.russiaStateInc', $russiaInc); if (!$getInn && $inn) { $this->view->assign('error', $this->messages['REGISTER_AGENCY_ERROR_INN_ERROR']); } } } } } } $this->view ->assign('MAXLONGINT', Samo::MAXLONGINT) ->assign('fields_partner', $partner) ->assign('fields_partpass', $partpass) ->assign('id', 0) ->assign('show_save_partpass_btn', false) ->assign( 'point', [ 'latitude' => '', 'longitude' => '', ] ) ->assign('registerByInn', $registerByInn) ->js_var('samo.use_dadata', $useDadata) ->js_var('samo.ownership_self_employed', $this->model->ownership_self_employed()) ->js_var('samo.getInn', $getInn); $this->view->assign('SESSION', array('NAME' => session_name(), 'ID' => session_id())); parent::default_action(); } public function SAVE() { try { $html = ''; $this->model->check_captcha(); if (false !== ($res = $this->model->save())) { $registration = $this->model->can_create_login(); $this->view->assign('partner', $res)->assign('registration', $registration); $tpl = $this->model->get_template(); $html = ($tpl) ? $this->view->fetch($tpl) : false; if (!$html) { $msg = $registration ? 'SAVE_PASSWORD_OK' : 'SAVE_PARTNER_OK'; $html = $this->messages['SIGNUP_SUCCESS'] . '<BR><BR>' . $this->messages[$msg]; } $this->view->element_text('#register_agency', $html); $this->view->js_call('samo.save_partner_success'); } else { $this->view->element_text('#register_agency', $this->messages['INTERNAL_SERVER_ERROR']); } } catch (Samo_Exception $e) { switch ($e->getCode()) { case 5: case 6: $this->view->element_text('#register_agency', $html . '<BR><BR>' . $e->getMessage()); break; default: $this->view->popup_message($e->getMessage(), $this->messages['PAGE_TITLE'], 350, 100, true); } } } public function TOWN() { try { $res = $this->model->METROSTATION(); $this->view->add_options('.PARTNER_METROSTATION', $res); if (count($res) > 1) { $this->view->js_call('samo.renderMetroStation'); $this->view->element_prop('.PARTNER_METROSTATION', 'disabled', false); } else { $this->view->element_prop('.PARTNER_METROSTATION', 'disabled', true); } $this->view->element_trigger('.PARTNER_METROSTATION', 'chosen:updated'); } catch (Samo_Exception $e) { $this->view->popup_message($e->getMessage(), $this->messages['PAGE_TITLE'], 350, 100, true); } } public function getSuggest() { try { $data = $this->model->suggest(); if ($data) { $this->view->js_call('samo.update_fields', $data); } } catch (Samo_Exception $e) { $this->view->error($e->getMessage()); } } } 