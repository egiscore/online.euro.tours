<?php
 class Sale_Controller extends Samo_Controller { public function construct() { $this->actions = array('INIT' => array('TOWNINC', 'METRO',)); } public function default_action() { $this->_coordset(); $this->init_data(); $this->_resultset(); parent::default_action(); } protected function _coordset() { $mapKey = $this->model->getConfig('MAP_KEY', 'online_config', ''); if ($mapKey) { $result = $this->model->getCoordinates(); if (count($result)) { $sxgeo = new SxGeo(_ROOT . 'vendor/sxgeo/SxGeoCity.dat'); $city = $sxgeo->getCity(Samo_Request::remote_addr()); if ($city) { $this->view->js_var('samo.geoip', $city); } $this->view ->assign('MAP_KEY', $mapKey) ->js_call_onready('samo.saleGoogleMap', $result); } } } protected function _resultset() { $result = $this->model->getSaleList(); $this->view->assign('SALELIST', $result); if ($result) { if (false !== ($pages = $this->model->getPages($result[0]['Pages']))) { $this->view->assign('pages', $pages) ->assign('current_page', $this->model->getPage()); } } } public function TOWNINC() { $this->view->add_options('METRO', $this->model->getMETRO()); $this->_resultset(); $this->view->element_update('resultset', 'resultset.tpl'); } public function SALELIST() { $this->_resultset(); $this->view->element_update('resultset', 'resultset.tpl'); } } 