<?php
 class Sberbank_Controller extends Samo_Controller { public $model; public function default_action() { Samo_Registry::get('response')->not_found(); } public function CHECK() { try { $this->model->isEnabled(); $this->model->getPaymentInfoForSberbank(); foreach (array('paid', 'amount', 'min_amount', 'currency', 'currency_public') as $n) { $this->view->assign('sberbank_' . $n, $this->model->defaults['sberbank'][$n]); } $this->view ->popup_template('form.tpl', $this->messages['SBERBANK_POPUP_TITLE'], 360, 80) ->js_var('samo.CLAIM', $this->model->defaults['CLAIM']) ->js_call('samo.sberbank'); } catch (Samo_Exception $e) { $this->view->popup_message($e->getMessage(), $this->messages['POPUP_TITLE'], 350, 60); } } public function RESULT() { try { $result = $this->model->payResult(); } catch (Samo_Exception $e) { $result = ['error' => 1, 'result' => $e->getMessage()]; } $claim = Samo_Utils::ifs(Samo_Request::intval('CLAIM'), (isset($_SESSION['samo_auth']['CLAIM']) ? $_SESSION['samo_auth']['CLAIM'] : null)); if (defined('SBERBANK_PRE_AUTH') && SBERBANK_PRE_AUTH == 1 && $claim && isset($_SESSION['samo_auth']) && isset($_SESSION['samo_auth']['type']) && $_SESSION['samo_auth']['type'] == 'person') { if (!isset($result['error']) || 0 == $result['error']) { $this->view->redirect_to(Samo_Url::route('cl_refer_person', ['CLAIM' => $claim, 'DOPAY' => 2])); } else { $_SESSION['samo_auth']['pay_error'] = $result['result']; $this->view->redirect_to(Samo_Url::route('cl_refer_person', ['CLAIM' => $claim, 'DOPAY' => 3])); } } else { $this->default_app_env(); $this->view->assign('sberbank_result', $result); $this->view->render('result'); } } public function GET_POST_DATA() { try { $this->model->isEnabled(); $this->view->js_call('samo.submitSberbankForm', $this->model->getSberUrl()); } catch (Samo_Exception $e) { $this->view->element_error('#sberbank_pay_variant_form input', $e->getMessage()); } } } 