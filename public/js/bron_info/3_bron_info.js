
(function($){samo.bron_info=function(){var _ROOT_URL=samo.ROUTES.bron.url,$module_container=$('#bron_info');samo.cache_controls($module_container);samo.controls.bron=$module_container.find('button.bron');samo.controls.calc=$module_container.find('button.calc');samo.controls.CLAIM_NOTE=$module_container.find('.CLAIM_NOTE');var $handleControls=$module_container.find('.human,.lastlname,input[name*=BORN],select[name*=PLACEBORN],input[name*=PSERIE],input[name*=PNUMBER],input[name*=PVALID],select[name*=NATIONALITY]');var oldValues=null;$handleControls.on('blur',function(){oldValues=compareValuesHandleControls($handleControls,oldValues)});function compareValuesHandleControls($controls,oldValues){var newValues='';$controls.each(function(){newValues+=$(this).val();});if(newValues!=oldValues){button_disable(1,'bron');}
return newValues;}
window.onbeforeunload=function(){var modified=false;$module_container.find('input').each(function(){var a=this;if((a.nodeName=='INPUT'&&(a.type=='checkbox'||a.type=='radio')&&a.defaultChecked!=a.checked)||(a.nodeName=='INPUT'&&a.defaultValue!=a.value&&{'text':true,'hidden':true,'file':true,'password':true}[a.type])){modified=true;}});if(!modified){return window.undefined;}
return samo.i18n('UNLOAD_WARNING');};var $contract_url=$('#contract_url');if($contract_url.length>0){samo.download_file=function(url){$contract_url.attr('href',url).on('click',function(e){e.preventDefault();$(this).gdocsViewer();}).removeClass('hidden');};$contract_url.one('click',samo.delayed_download).click();}
function msg(message){$.notify({text:message,type:'error'});}
function button_disable(bron,button){button=button||'bron';samo.controls[button].prop('disabled',bron);}
var init_resultset=function(selector){var $table=$module_container.find(selector).find('table.res');if($table.find('tbody tr').length){$table.show().find('tbody tr:not(.note):odd').removeClass('even').addClass('odd').end().find('tbody tr:not(.note):even').removeClass('odd').addClass('even');}else{$table.hide();}};var init_services=function(){init_resultset('.ASERVICES');};var init_insures=function(){init_resultset('.INSURESINFO');};init_services();init_insures();samo.frplacement_save=function(button,$pTable,$targetResult){button.disabled=true;var data=null,seats={},seats_count=0,titles=[],seats_service={};$peoples=$pTable.find('tbody tr'),$people=null;$peoples.each(function(){$people=$(this);data=$people.data();if(data.inc){seats[data.people]=data.inc;seats_service[data.people]={'serviceinc':data.serviceinc,'partner':data.partner,'routeindex':data.routeindex,'servicedeparture':data.servicedeparture,'servicearrival':data.servicearrival};titles.push($people.find('.frplacement').text());seats_count++;}});var freight=$pTable.data('freight');if(seats_count){$targetResult.data('seats',seats);$targetResult.data('seats_service',seats_service);}else{$targetResult.removeData('seats');$targetResult.removeData('seats_service');}
var freightsContainer=$module_container.find('.freights'),freightsData=freightsContainer.data()||{};var freightSeats=data.seats||{},seatTitles=data.titles||{}
freightSeats[freight]=seats;seatTitles[freight]=titles.join(", ");freightsContainer.data('seats',freightSeats);freightsContainer.data('titles',seatTitles);init_frplacement($targetResult.parents('select'));$.modal.close();};var init_frplacement=function(event){var target=(typeof event.target!='undefined')?event.target:event;var $select=$(target),$btn=$select.parents('tr:first').find('td.frplacement .button'),$option=$select.find('option:selected'),data=$option.data();var freightsContainer=$module_container.find('.freights'),freightSeats=freightsContainer.data('seats')||{};var freightTitles=freightsContainer.data('titles')||{};if(data&&data.frplacement){if(!data.seats){if(typeof freightSeats[$option.val()]!='undefined'){data.seats=freightSeats[$option.val()];}}
if(!$btn.length){var disabled=false;$btn=$select.parents('tr:first').find('td.frplacement').append('<span class="button">&nbsp;</span>').find('.button').on('click',function(){if(disabled){return false;}
disabled=true;var $option=$(this).parents('tr:first').find('select option:selected'),data=$option.data();var params={freight:$option.val()};params.claimDocument=samo.claimDocument(false);params.maxWidth=$module_container.find('.claim_info').width();params.maxHeight=$(window).height();if(data.seats){params.seats=data.seats;}
if(data.seats_service){params.seats_service=data.seats_service;}
$.post(getParams('CHOOSE_FRPLACEMENT'),params,function(){disabled=false;},'script');});}
if(data.seats){var seats=Object.keys(data.seats),scount=seats.length,pcount=parseInt($select.parents('tr:first').find('.fr_peoplecount').text());var title='';if(typeof freightTitles[$option.val()]!='undefined'){title=freightTitles[$option.val()]+", ";}
if(scount>pcount){delete data.seats[seats[scount-1]];$option.data('seats',data.seats);scount=Object.keys(data.seats).length;}
if(scount==pcount){$btn.addClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHANGE'));}
if(scount<pcount){$btn.removeClass('seats').attr('data-title',title+samo.i18n('FRPLACEMENT_CHOOSE'));}}else{$btn.removeClass('seats').attr('data-title',samo.i18n('FRPLACEMENT_CHOOSE'));}}else{if($btn.length){$btn.remove();}}};$module_container.find('.NOTECLAIM').bind('keyup',function(){if(this.value.length>512){this.value=this.value.substr(0,512);$(this).addClass('error');return false;}
$(this).removeClass('error');}).end().find(samo.controls.bron).bind('click',function(){button_disable(1,'calc');button_disable(1,'bron');var $contract=$('#CONRACTAGREE');if($contract.length&&!$contract.is(':checked')){$contract.parents('td:first').addClass('error').get(0).scrollIntoView(true);$contract.bind('click',function(){if(this.checked){$contract.parents('td:first').removeClass('error');}});button_disable(0,'calc');return false;}else{$contract.parents('td:first').removeClass('error');}
var $agree_processing_personal_data=$('#AGREE_PROCESSING_PERSONAL_DATA');if($agree_processing_personal_data.length&&!$agree_processing_personal_data.is(':checked')){$agree_processing_personal_data.parents('td:first').parents('td:first').addClass('error').get(0).scrollIntoView(true);$agree_processing_personal_data.bind('click',function(){if(this.checked){$agree_processing_personal_data.parents('td:first').parents('td:first').removeClass('error');}});button_disable(0,'calc');return false;}else{$agree_processing_personal_data.parents('td:first').parents('td:first').removeClass('error');}
var is_ok=true;is_ok=checkTouristFields()&&is_ok;if(samo.ROUTES.bron.url.indexOf('bron_person')!=-1){is_ok=checkPersonInfo()&&is_ok;}
if(is_ok){if(checkFreights()&&checkServices()){var $owner=$('#CLAIM_OWNER');if($owner.length&&$owner.val()==0){$owner.addClass('error').get(0).scrollIntoView(true);button_disable(0,'calc');msg(samo.i18n('NO_CLAIM_OWNER'));return false;}else{$owner.removeClass('error');}
var params={};var $note=$module_container.find('.NOTECLAIM');params.note=($note.length)?$note.val().substring(0,512):'';if($module_container.find('#payment_schedule').prop('checked')){params.payment_schedule=1;}
params.claimDocument=samo.claimDocument(true);if(params.claimDocument==false){return false;}
var $promocode=$module_container.find('.PROMOCODE');params.promo_codetext=($promocode.length)?$.trim($promocode.val()):'';var $contacts=$module_container.find('.contacts');params.CONTACTS=($contacts.length)?$.trim($contacts.val()):'';var $origin=$module_container.find('.ORIGIN');params.ORIGIN=($origin.length)?$origin.val():0;var claim_note='';samo.controls.CLAIM_NOTE.find(':checked').each(function(){var val_addit=(samo.controls.CLAIM_NOTE).find('input[name=addit_'+this.value+']').val()||'';if(val_addit){val_addit='{'+val_addit.replace(/[{|}|\|]/g,' ')+'}';}
claim_note=claim_note+this.value+val_addit+'|';});params.claim_note=claim_note;if($owner.length){params.CLAIM_OWNER=$owner.val();}
var $preorder=$module_container.find('#CALCULATED_CLAIM');if($preorder.length&&$preorder.is(':checked')){params.CALCULATED_CLAIM=1;}
$.post(getParams('BRON'),params,null,'script');}}
return true;}).end().find('.freights').delegate('select','change',function(){var $this=$(this);if($this.val()>0){var $all=$module_container.find('.freights tbody tr').not('.note');var empty_select=$all.find('option:selected[value=0]').length;var $value=$this.find('option:selected');if($all.last().has($this).length){if(empty_select==0){$(samo.controls.CLAIMPRICE).triggerHandler('ReloadServices',['RELOADSERVICES']);}
$module_container.find('.freights select').each(function(){init_frplacement(this);});}else if($all.first().has($this).length){var params={};params.TOFREIGHTINC=$this.val();params.FRCLASS=$value.data('json').onlineclass;params.BACKFREIGHTINC=$all.last().find('select').val();$.post(getParams('TOFREIGHTINC'),params,function(){var $last=$module_container.find('.freights tbody tr').not('.note').last().find('select');if($last.length){$last.change();}else{if(empty_select==0){$(samo.controls.CLAIMPRICE).triggerHandler('ReloadServices',['RELOADSERVICES']);}}
$module_container.find('.freights select').each(function(){init_frplacement(this);}).chosen();},'script');}
var $note=$this.parents('tr').next('.note:first');if($value.data('note')){$note.removeClass('hidden').find('td').html($value.data('note'));}else{$note.addClass('hidden');}}
samo.disablePrice();}).delegate('select','focus',function(e){var seats_exists=false;$(this).parents('.freights:first').find('select option:selected').each(function(){if($(this).data('seats')){seats_exists=true;}});if(seats_exists){$.notify({text:samo.i18n('FRPLACEMENT_FREIGHT_CHANGE_NOTICE'),iconClass:'ui-icon-alert',styleClass:'ui-state-highlight'});}}).find('select').each(function(){$(this).chosen();init_frplacement(this);}).end().end().find('.offered_additional_service').bind('click',function(e){e.stopPropagation();$(this).unbind('click');$(this).parents('tr:first').attr('data-selected',1);$(this).removeClass('offered_additional_service').addClass('delete_additional_service');$(this).text(samo.LANG.BTN_DELETE);}).end().find('.additional_services').bind('click',function(){var params={};params.claimDocument=samo.claimDocument(false);$.post(getParams('SHOW_ADDITIONAL_SERVICES'),params,function(){var $container=$('#additional_services');$container.find('.tourist_service').bind('click',function(){var mainserviceinc=$(this).data('mainserviceinc');var people=$(this).data('people');var service=$container.find('tr[data-mainserviceinc='+mainserviceinc+']');service.find('span.service_price').addClass('line_through');});$('#ADD_ADDITIONAL_SERVICES').bind('click',function(){var changes=false;$container.find(':checkbox').each(function(){if(this.defaultChecked!=this.checked){return changes=true;}});if(changes){var services=[];$container.find('.mainservice').filter(':checked').each(function(){var data=$(this).parents('tr:first').data();var mainserviceinc=data.mainserviceinc;var service_json=data.json;var serviceNote=$container.find('.note-'+mainserviceinc+' .service_note').html();var service_price=$(this).parents('tr:first').find('span.service_price').html();services[mainserviceinc]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};services[mainserviceinc].service.count=services[mainserviceinc].service.clients.length;});$container.find('.tourist_service').filter(':checked').each(function(){var mainserviceinc=$(this).data('mainserviceinc');var people=$(this).data('people');if(!services[mainserviceinc]){var service=$container.find('tr[data-mainserviceinc='+mainserviceinc+']');var service_json=service.data('json');service_json.clients=[{'peopleKey':people,'common':people}];var serviceNote=$container.find('.note-'+mainserviceinc+' .service_note').html();var service_price=service.find('span.service_price').html();services[mainserviceinc]={'service':service_json,'serviceNote':serviceNote,'service_price':service_price};}else{services[mainserviceinc].service.clients.push({'peopleKey':people,'common':people});}
services[mainserviceinc].service.count=services[mainserviceinc].service.clients.length;});var tpl=$('#services-tpl').html();var content=ejs.render(tpl,{services:services});$('.ASERVICES').html(content);samo.disablePrice();$(samo.controls.CLAIMPRICE).triggerHandler('ReloadServices',['RELOADSERVICES']);}
$.modal.close();});button_disable(0,'calc');},'script');}).end().find('.ASERVICES').delegate('.delete_additional_service','click',function(){delete_service($(this).parent().parent());}).end().find('.INSURESINFO').delegate('.delete_additional_insure','click',function(){delete_insure($(this).parent().parent());}).end().find('.additional_insures').bind('click',function(){var params={};params.claimDocument=samo.claimDocument(false);$.post(getParams('SHOW_ADDITIONAL_INSURES'),params,function(){var $container=$('#additional_insures').delegate('input:checkbox','click',function(){var $cbx=$(this);var complete=$cbx.data('complete');var insuretype=$cbx.parents('tr:first').data('insuretype');var maininsureinc=$cbx.parents('tr:first').data('maininsureinc');var tbody=$cbx.parents('tbody:first');var ttable=$cbx.parents('table:first');if($cbx.is('.maininsure')&&!$cbx.prop('checked')){tbody.find('tr[data-insuretype='+insuretype+'] input:checkbox:not(:disabled)').prop('checked',false);if(complete){ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureinc='+maininsureinc+'] input:checkbox:not(:disabled)').prop('checked',false);}}else{if($cbx.prop('checked')){if($cbx.is('.maininsure')){tbody.find('tr[data-insuretype='+insuretype+'] input:checkbox:not(:disabled)').prop('checked',false);ttable.find('tr[data-insuretype='+insuretype+'] input:checkbox[data-complete=1]:not(:disabled)').prop('checked',false);$cbx.prop('checked',true);if(complete){ttable.find('tr[data-insuretype='+insuretype+'] input:checkbox:not(:disabled)').prop('checked',false);ttable.find('tr[data-insuretype='+insuretype+'][data-maininsureinc='+maininsureinc+'] input:checkbox:not(:disabled)').prop('checked',true);}}else{var $tr=$cbx.parents('tr:first');tbody.find('tr[data-insuretype='+insuretype+'][data-maininsureinc!='+maininsureinc+'] input:checkbox:not(:disabled)').prop('checked',false);$tr.find('input:first').prop('checked',true);}}}});$('#ADD_ADDITIONAL_INSURES').bind('click',function(){var changes=false;$container.find(':checkbox').each(function(){if(this.defaultChecked!=this.checked){return changes=true;}});if(changes){var insureDocument=[];$container.find('input.maininsure').filter(':checked').each(function(){var $tr=$(this).parents('tr:first'),data=$tr.data();var maininsureinc=data.maininsureinc;var datebeg=data.datebeg;var dateend=data.dateend;var people=data.people;insureDocument.push({'type':'stInsurance','insure':maininsureinc,'people':people});$tr.find('input.inscust').filter(':checked').each(function(){var inscust=$(this).val();insureDocument.push({'type':'stInscust','insure':inscust,'maininsure':maininsureinc,'datebeg':datebeg,'dateend':dateend,'people':people});});});var $insures=$module_container.find('.INSURESINFO').hide();var params={insureDocument:insureDocument};samo.disablePrice();$.post(getParams('REDRAW_INSURE'),params,function(){init_insures();$insures.show();},'script');}
$.modal.close();});button_disable(0,'calc');},'script');}).end().find('#CALCULATED_CLAIM').bind('click',function(){if(this.checked){samo.controls.bron.addClass('preorder-btn').text(samo.LANG.BTN_SAVE);}else{samo.controls.bron.removeClass('preorder-btn').text(samo.LANG.BTN_BRON);}}).end().find('select.alternate_hotels').bind('change',function(){var $hotel=$(this).find('option:selected');var hotel_json=$hotel.data('json');var $tr=$(this).parents('tr:first');$tr.data('json',hotel_json);$(samo.controls.CLAIMPRICE).triggerHandler('ReloadServices',['RELOADSERVICES']);}).each(function(){$(this).chosen();});var delete_service=function($service){if(confirm(samo.i18n('BTN_CONFIRM_DELETE_SERVICE'))){$service.parent().find('.note-'+$service.data('inc')).remove();$service.remove();init_services();samo.disablePrice();}};var delete_insure=function($insure){if(confirm(samo.i18n('BTN_CONFIRM_DELETE_INSURE'))){var headuid=$insure.data('inc');$module_container.find('.INSURESINFO tbody tr').each(function(){var insure=$(this).data('json');if(insure.headUid==headuid){$(this).remove();}});$insure.parent().find('.note-'+headuid).remove();$insure.remove();init_insures();samo.disablePrice();}};function syncBuyer(peopleInc){var $lastname=$module_container.find('input[name="frm[People]['+peopleInc+'][LASTNAME]"]');var $firstname=$module_container.find('input[name="frm[People]['+peopleInc+'][FIRSTNAME]"]');var syncBuyerFio=function(){if($lastname.val()||$firstname.val()){$module_container.find('input[name="frm[phys_byer][-1][NAME]"]').val($lastname.val().toUpperCase()+samo.FIO_DELIMTER+$firstname.val().toUpperCase());}else{$module_container.find('input[name="frm[phys_byer][-1][NAME]"]').val('');}};$lastname.on('keyup.sync',syncBuyerFio);$firstname.on('keyup.sync',syncBuyerFio);$lastname.triggerHandler('keyup.sync');var $tourist_field=null;$.each(['PSERIE','PNUMBER','PGIVEN','PGIVENORG','MOBILE','EMAIL','BORN'],function(){var field=this;$tourist_field=$module_container.find('input[name="frm[People]['+peopleInc+']['+field+']"]');if($tourist_field.length==1){$tourist_field.on('keyup.sync',function(){$module_container.find('input[name="frm[phys_byer][-1]['+field+']"]').val(this.value.toUpperCase());}).triggerHandler('keyup.sync');if(field=='PGIVEN'||field=='BORN'){$tourist_field.on('blur',function(){$(this).triggerHandler('keyup.sync');});}}});}
function init_visas($container){$container.find('select.visa').each(function(){$(this).find('option[value="0"]').html('');var options={placeholder_text_single:samo.i18n('EMPTY_VISA')};$(this).chosen(options);});}
function init_tourists(){addinfant_cb_toggle();var $tourists=$module_container.find(".tourists-tabs .tourist").not('.ainfant');samo.tourist_helpers($tourists);init_visas($tourists);$module_container.find('.SAVE_AS_BUYER').on('click',function(){if(this.checked){$module_container.find('.SAVE_AS_BUYER').not(this).prop('checked',false).each(function(){var self=this;var $tourist=$module_container.find('.tourist').filter(function(){return $(this).data('peopleinc')==self.value});$tourist.find('input').off('keyup.sync');});var peopleInc=this.value;syncBuyer(peopleInc);}else{$module_container.find('.tourist').find('input').off('keyup.sync');}});$module_container.find('.addinfant_cb').bind('click',function(){var classVal=($("select[name='class']").val()==1)?"Econom":"Business";$('.freightTable, .freightsFilter, .currency').html('');$module_container.find('.load-external-freights').css('display','inline').triggerHandler('click',classVal);samo.infant_info();}).end().find('.INFANT_FREIGHT_PLACE').bind('click',function(){if(this.checked){$module_container.find('td.fr_peoplecount').each(function(){$(this).html(parseInt($(this).data('peoplecount'))+1);samo.disablePrice();});}else{$module_container.find('td.fr_peoplecount').each(function(){$(this).html($(this).data('peoplecount'));samo.disablePrice();});}
$module_container.find('.freights select').each(function(){init_frplacement(this);});}).end().find('select.visa').bind('change',function(){var $tourist=$(this).closest('.tourist'),$vexpire=$tourist.find('[name*="[VEXPIRE]"]').closest('tr');if($vexpire){var $el=$vexpire.find('label,input');if($el.is('.required')){$el.addClass('default-required');}
if(parseInt(this.value)==-1&&$el.is('.default-required')){$el.addClass('required');}else{$el.removeClass('required');}}
samo.disablePrice();}).each(function(){$(this).triggerHandler('change');});}
samo.infant_info=function(){samo.disablePrice();var $cb=$module_container.find('.addinfant_cb');var status=($cb.prop('checked'))?'block':'none';var add_infant=$cb.prop('checked');var inf_id=$('#infant_add').find('.ainfant').data('peopleinc');var $tour_info=$module_container.find('.tour_info');var peoplecount=parseInt($tour_info.data('peoplecount'));$module_container.find('.addinfant').css('display',status).end().find('.INSURESINFO tbody tr').each(function(){var insure=$(this).data('json');var clients=insure.clients;if(add_infant){if(clients.length==peoplecount){insure.count=insure.count+1;clients.push({'peopleKey':inf_id,'common':inf_id});$.notify({text:samo.i18n('ADD_INFANT_INST'),type:'message'});var id_to=null,id_from=null;if(id_to==null){id_to=$module_container.find('#infant_add input.frm-input:first').attr('name').replace(/frm\[People\]\[([-\d]+)\]\[[\w_]+\]/,'$1');id_from=$module_container.find('.tourist:first input.frm-input:first').attr('name').replace(/frm\[People\]\[([-\d]+)\]\[[\w_]+\]/,'$1');}
$.each(['PSERIE','PNUMBER','PVALID','PGIVEN','PGIVENORG','NATIONALITY','VEXPIRE'],function(i,v){$module_container.find('#infant_add input[name="frm[People]['+id_to+']['+v+']"]').val($module_container.find('.tourist:first input[name="frm[People]['+id_from+']['+v+']"]').val());});}}else{$(clients).each(function(i){if(this.peopleKey==inf_id&&!add_infant){insure.count=insure.count-1;clients.splice(i,1);$.notify({text:samo.i18n('REMOVE_INFANT_INST'),type:'message'});}});}
if(insure.count==0){$(this).remove();}else{insure.clients=clients;$(this).data('json',insure).find('.insure_count').html(insure.count);}}).end().find('.ASERVICES tbody tr').not('.note').each(function(){var service=$(this).data('json');var clients=service.clients;if(add_infant){if(clients.length==peoplecount){service.count=service.count+1;clients.push({'peopleKey':inf_id,'common':inf_id});$.notify({text:samo.i18n('ADD_INFANT_SERVICE')+' '+service.name,type:'message'});}}else{$(clients).each(function(i){if(this.peopleKey==inf_id&&!add_infant){service.count=service.count-1;clients.splice(i,1);$.notify({text:samo.i18n('REMOVE_INFANT_SERVICE')+' '+service.name,type:'message'});}});}
if(service.count==0){$(this).remove();}else{service.clients=clients;$(this).data('json',service).find('.service_count').html(service.count);}});if(!add_infant){$.event.trigger('FreightDelPlace');}else{var $addinfant=$module_container.find('.addinfant')
samo.tourist_helpers($addinfant);init_visas($addinfant);}};samo.agreement=function(){$('#agreement').bind('click',function(){this.disabled=true;$(this).unbind('click');$.post(getParams('AGREE'),{},null,'script');});};samo.bron_form=function(){var $loadExternalFreights=$module_container.find('.load-external-freights').bind('click',function(e,flag){if($module_container.find('.FREIGHTSINFO .freights').length){location.href+='&extfr=1#extfr'}else{var $self=$(this),$container=$module_container.find('.FREIGHTSINFO');$self.prop('disabled',true).addClass('samo-preloader');var $selects=$container.find('select');$selects.prop('disabled',true).addClass('samo-preloader');var params={};params.CATCLAIM=$.getParameter('CATCLAIM',true)||$.getParameter('CLAIM',true);params.CURRENCY=$.getParameter('CURRENCY',true);params.claim_guid=samo.claim_guid;params.samo_action='EXTERNAL_FREIGHTS';params.fClass=(flag&&flag=='Business')?'Business':'Econom';params.inf=$(".addinfant_cb").prop('checked')?1:0;params.extfr=1;$.post(samo.ROUTES.bron.url+$.param(params),{},function(){$self.prop('disabled',false).removeClass('samo-preloader');$container.find('.samo-preloader').prop('disabled',false).removeClass('samo-preloader');if(flag&&flag=='autoload'){$container.find('select.freight:eq(0)').change();}
var filterByClass=$('.filterOptions select[name=class]');var filterByFlyDuration=$('#flyDurationSlider');if(filterByClass.length){var sValue=(params.fClass=='Econom')?1:2;filterByClass.find('option[value='+sValue+']').attr('selected','selected');$module_container.find('.load-external-freights').hide();}
if(filterByFlyDuration.length){samo.filterSliders(filterByFlyDuration);}},'script',function(){$.notify({type:'error',text:samo.i18n('FREIGHT_LOAD_FAILED'),permanent:0});$self.prop('disabled',false).removeClass('samo-preloader').css('display','block');});}});if(typeof samo.external_freights!='undefined'&&samo.external_freights==2){$loadExternalFreights.css('display','none').triggerHandler('click','autoload');}
$module_container.css('display','block');button_disable(1,'bron');samo.controls.BACKFREIGHTS=$module_container.find('td.BACKFREIGHTS');samo.controls.freights=$module_container.find('div.freights');$module_container.find('.checklistbox').bind('click',function(e){if($(e.target).is('a.help')){e.preventDefault();window.open(e.target.href,'_blank');}}).find('a.help').attr('title',samo.i18n('DETAIL')).end().end().find('div.freights').each(function(){var name=this.name||$(this).attr('name')||this.className;samo.controls[name]=this;}).end();var maxWidth=0;samo.controls.CLAIM_NOTE.find('input').bind('click',function(){samo.controls.CLAIM_NOTE.find('input[name=addit_'+this.value+']').prop('disabled',!this.checked);}).end().find('label.has_input').each(function(){maxWidth=Math.max($(this).width(),maxWidth);}).each(function(){$(this).width(maxWidth+3);});samo.disablePrice=function(){$(samo.controls.CLAIMPRICE).addClass('not-actual');$module_container.find('.CLAIMPRICE_NOTICE').css('display','block');button_disable(1);};$('#search_tour_payment_schedule').bind('click',function(){var params={samo_action:'PAYMENTSCHEDULE'};params.CATCLAIM=$.getParameter('CATCLAIM',true)||$.getParameter('CLAIM',true);$.getScript(_ROOT_URL+$.param(params));});$(samo.controls.calc).bind('click',function(){if(checkFreights()&&checkHotels()&&checkServices()){var params={};params.claimDocument=samo.claimDocument(false);if(params.claimDocument==false){return false;}
var $promocode=$module_container.find('.PROMOCODE');params.promo_codetext=($promocode.length)?$.trim($promocode.val()):'';button_disable(1,'calc');button_disable(1,'bron');$.post(getParams('CALC'),params,null,'script');}});$(document).bind('ajaxError',function(){button_disable(0,'calc');});$module_container.find('.toggle_details').bind('click',function(){var $self=$(this);if($self.data('show')==$self.text()){$(samo.controls.COMMISSIONS).slideDown(function(){$self.text($self.data('hide'));});}else{$(samo.controls.COMMISSIONS).slideUp(function(){$self.text($self.data('show'));});}});$(samo.controls.CLAIMPRICE).bind('ReloadServices',function(e,action){var params={};button_disable(1,'calc');button_disable(1,'bron');params.claimDocument=samo.claimDocument(false);$.post(getParams(action),params,function(){$module_container.find('.services_container').css('display','block');init_services();addinfant_cb_toggle();button_disable(0,'calc');},'script');});init_tourists();samo.tourist_helpers($module_container.find('.BUYERINFO'));$module_container.find('.ORIGIN').find('option[value="0"]').html('').end().chosen({placeholder_text_single:samo.i18n('REQUIRED_FIELD_EMPTY')});};function addinfant_cb_toggle(){if(typeof(samo.freeinfant)!='undefined'&&samo.freeinfant>0){$module_container.find('div .add_inf').css('display','block');if(typeof(samo.freeinfant_checked)!='undefined'&&samo.freeinfant_checked>0){samo.infant_info();}}else{$module_container.find('div .add_inf').css('display','none');}}
samo.claimDocument=function(is_bron){var claimDocument={};var $tourists=$module_container.find(".tourists-tabs .tourist");var add_infant=Number($module_container.find('.addinfant_cb').prop('checked'))||0;var $tour_info=$module_container.find('.tour_info');var checkin=$tour_info.data('checkin');var checkout=$tour_info.data('checkout');var peoplecount=parseInt($tour_info.data('peoplecount'));var peoples=peoplecount+add_infant;var _peoples=-1*peoples;var inf_id=$('#infant_add').find('.ainfant').data('peopleinc');var add_inf_inc=$module_container.find('.addinfant_cb').val();var freight_counter=-1;var service_counter=-1;claimDocument['peoples']=[];if(!add_infant){$tourists=$tourists.not('.ainfant');}
function valid_date(field,is_bron){var value='';if(field.length&&field.clearVal().length){value=$.controlValue(field.get(0));value=parseInt(value);if(value>20600000||value<19010000){return error_tourist(samo.i18n('INCORRECT_DATE'),field);}}
return value;}
var clients,x,is_ok=true;if(is_ok&&add_infant){var $tourist=$tourists.first();var human=$tourist.find('[name*="[HUMAN]"]').val();if(typeof human!='undefined'&&human!='MR'&&human!='MRS'){msg(samo.i18n('FIRST_HUMAN_TOURIST'));is_ok=false;}}
$tourists.each(function(i){if(is_ok){var ppl={},date,$field,name,$tourist=$(this);ppl['key']=$tourist.data('peopleinc');ppl['human']=$tourist.find('[name*="[HUMAN]"]').val();if($tourist.is('.ainfant')){if(ppl['human']){ppl['human']='INF';}
ppl['additional']=1;}
ppl['sex']=$tourist.find('[name*="[MALE]"]').filter(':checked').val();if($tourist.find('[name*="[FIRSTNAME]"]').length){name=$tourist.find('[name*="[LASTNAME]"]').val()+samo.FIO_DELIMTER+$tourist.find('[name*="[FIRSTNAME]"]').val();name=name.toUpperCase().substr(0,64);ppl['name']=name;if($tourist.find('[name*="[FIRSTLNAME]"]').length){name=$tourist.find('[name*="[LASTLNAME]"]').val()+samo.FIO_DELIMTER+$tourist.find('[name*="[FIRSTLNAME]"]').val();ppl['lname']=name.toUpperCase().substr(0,64);}else{ppl['lname']=name;}}else{name=$tourist.find('[name*="[LASTLNAME]"]').val()+samo.FIO_DELIMTER+$tourist.find('[name*="[FIRSTLNAME]"]').val();name=name.toUpperCase().substr(0,64);ppl['name']=name;ppl['lname']=name;}
date=valid_date($tourist.find('[name*="[BORN]"]'),is_bron);is_ok=(date!==false);if(is_ok){ppl['born']=date;ppl['pserie']=($tourist.find('[name*="[PSERIE]"]').val()||"").toUpperCase();ppl['pnumber']=($tourist.find('[name*="[PNUMBER]"]').val()||"").toUpperCase();date=valid_date($tourist.find('[name*="[PVALID]"]'),is_bron);is_ok=(false!==date);if(is_ok){ppl['pexpire']=date;date=valid_date($tourist.find('[name*="[PGIVEN]"]'),is_bron);is_ok=(date!==false);if(is_ok){ppl['pgiven']=date;$field=$tourist.find('[name*="[PGIVENORG]"]');ppl['pgivenorg']=$field.length?$field.val():'';ppl['nationalityKey']=$tourist.find('[name*="[NATIONALITY]"]').val()||-2147483647;ppl['bornplaceKey']=$tourist.find('[name*="[PLACEBORN]"]').val()||-2147483647;$field=$tourist.find('[name*="[ADDRESS]"]');ppl['address']=$field.length?$field.val():'';$field=$tourist.find('[name*="[PHONE]"]');ppl['phone']=$field.length?$field.val():'';$field=$tourist.find('[name*="[MOBILE]"]');ppl['mobile']=$field.length?$field.val():'';$field=$tourist.find('[name*="[EMAIL]"]');ppl['email']=$field.length?$field.val():'';ppl['vexpire']=valid_date($tourist.find('[name*="[VEXPIRE]"]'),is_bron);$field=$tourist.find('[name*="[PLACEBORNDETAIL]"]');ppl['bornplaceDetail']=$field.length?$field.val():'';$field=$tourist.find('[name*="[INN]"]');ppl['inn']=$field.length?$field.val():'';}}}
$.each(ppl,function(key,val){ppl[key]=$.trim(val);});claimDocument['peoples'][i]=ppl;}});if(!is_ok){return false;}
claimDocument['transports']=[];freightSelect='.FREIGHTSINFO tbody .freight';if(samo.external_freights!='undefined'&&samo.external_freights==2){freightSelect='.freightTable input[data-checked=checked]';}
$module_container.find(freightSelect).each(function(){var $self=$(this);if($self.val()>0){freight_counter++;var freight=null;if(this.tagName=='SELECT'){freight=$self.find('option:selected');}else{freight=$self;}
var freight_json=freight.data('json'),freight_seats=freight.data('seats'),freight_seats_service=freight.data('seats_service');var clients=[];if(add_infant&&!$module_container.find('.INFANT_FREIGHT_PLACE').is(':checked')){var freight_json2=$.extend({},freight_json);if(freight_seats){clients.push({'peopleKey':-1,'common':-1,'seatKey':freight_seats[-1],'seat_service':freight_seats_service[-1]});clients.push({'peopleKey':inf_id,'common':-1});}else{clients.push({'peopleKey':-1,'common':-1});clients.push({'peopleKey':inf_id,'common':-1});}
freight_json2.classKey=freight_json.adultinfclass;freight_json2.frplaceKey=freight_json.adultinffrplace;freight_json2.count=1;freight_json2.addinfant=1;freight_json2.clients=clients;claimDocument['transports'][freight_counter]=freight_json2;if(peoplecount>1){clients=[];for(x=-2;x>_peoples;x--){if(freight_seats){clients.push({'peopleKey':x,'common':x,seatKey:freight_seats[x]});}else{clients.push({'peopleKey':x,'common':x});}}
freight_counter++;freight_json.count=clients.length;freight_json.addinfant=0;freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}else{for(x=-1;x>=_peoples;x--){if(freight_seats){clients.push({'peopleKey':x,'common':x,seatKey:freight_seats[x],'seat_service':freight_seats_service[x]});}else{clients.push({'peopleKey':x,'common':x});}}
freight_json.count=peoples;freight_json.addinfant=0;freight_json.clients=clients;claimDocument['transports'][freight_counter]=freight_json;}}});claimDocument['hotels']=[];$module_container.find('.HOTELSINFO tbody tr').filter(function(){var hotel_json=$(this).data('json');return typeof hotel_json!=='undefined';}).each(function(i){var hotel_json=$(this).data('json');var j=-1*(i+1);var clients=[];for(var x=-1;x>=_peoples;x--){clients.push({'peopleKey':x,'common':j});}
hotel_json.addinfant=add_infant;hotel_json.clients=clients;claimDocument['hotels'][i]=hotel_json;});claimDocument['services']=[];$module_container.find('.ASERVICES table.res tbody tr[data-selected="1"]').not('.note').each(function(){service_counter++;var service_json=$(this).data('json');var service=$.extend({},service_json);service.addinfant=0;if(add_infant&&service.count==peoples){service.count=service.count-add_infant;service.addinfant=add_infant;}
claimDocument['services'][service_counter]=service;});$module_container.find('.INSURESINFO tbody tr:not(.note)').each(function(){service_counter++;var insure=$(this).data('json');insure.addinfant=add_infant;claimDocument['services'][service_counter]=insure;});var vises={};$tourists.each(function(i){var $tourist=$(this);var peopleinc=$tourist.data('peopleinc');$tourist.find('select.visa').each(function(){var $select=$(this).find('option:selected');var info=$select.data('json'),inc=parseInt(info.key,10);if(inc!=0){var clients=[];if(!vises[inc]){clients.push({'peopleKey':peopleinc,'common':i});info['datebeg']=checkin;info['dateend']=checkout;info['count']=1;info['addinfant']=add_infant;info['clients']=clients;vises[inc]=info;}else{var tmp=vises[inc].clients;tmp.push({'peopleKey':peopleinc,'common':i});vises[inc].count++;}}});});for(var inc in vises){service_counter++;claimDocument['services'][service_counter]=vises[inc];}
var _buyer=$module_container.find('.CLAIMINFO input[name*="[phys_byer]"]');if(_buyer.length){var buyer=claimDocument['buyer']={};_buyer.each(function(){var name=this.name.match(/\[([^\]\[]*)\]$/)[1];buyer[name]=$.trim($.controlValue(this))||"";});}
return claimDocument;};samo.update_backfreights=function(){samo.controls.BACKFREIGHTS=$module_container.find('td.BACKFREIGHTS');};samo.post_calc=function(price){$module_container.find('.BONUS .title span').css('display','none');var bonus_class='';if(price.foragency){bonus_class='bonus_for_agency';}else{bonus_class='bonus_for_manager';}
$module_container.find('.BONUS span.'+bonus_class).css('display','inline');$module_container.find('.BONUS_VALUE').html(price.bonusValue+' '+price.Currency_Alias);$module_container.find('.CLAIMPRICE').html(price.PriceStr+' '+price.Currency_Alias+(price.Converted?('<br><span class="small">'+price.Converted.price+' '+price.Converted.date+'</span>'):'')).removeClass('not-actual').get(0).scrollIntoView(true);$module_container.find('.CLAIMPRICE_NOTICE').css('display','none').end().find('.commission_money').html(price.SumCommission+' '+price.Currency_Alias).end().find('.amount_money').html(price.Amount+' '+price.Currency_Alias).end().find('.toggle_details').css('display','inline');$module_container.find('.PAYMENT_MESSAGE').css('display','none').end().find('.PENALTY_SIZE_MESSAGE').css('display','none').end();if(price.payment_message){$module_container.find('.PAYMENT_MESSAGE').html(price.payment_message).css('display','block');}
if(price.penalty_size_message){$module_container.find('.PENALTY_SIZE_MESSAGE').html(price.penalty_size_message).css('display','block');}
if(price.result_messages){$module_container.find('.RESULT_MESSAGES').html(price.result_messages).css('display','block');}else{$module_container.find('.RESULT_MESSAGES').css('display','none');}
var $promocode=$module_container.find('.PROMOCODE');var promocode_res_display='none';if($promocode.length!==0&&$promocode.val()!==''){var promocode_res_display='inline';}
if($promocode.length!==0&&$promocode.val()!=''&&price.promo_sum==0){samo.field.error(samo.i18n('BRON_INCORRECT_PROMO_CODE'),$promocode);}else{samo.field.clear_error($promocode);}
$module_container.find('.promoaction_money').html(price.promo_sum+' '+price.promo_currency_alias+(price.PromoConverted?('&nbsp;<span class="small">('+price.PromoConverted.price+')</span>'):''));$module_container.find('.promoaction_result').css('display',promocode_res_display);if(price.stop_bron){button_disable(1,'bron');}else{button_disable(0,'bron');}
button_disable(0,'calc');};samo.calc_save_error=function(message){button_disable(1,'bron');button_disable(0,'calc');msg(message);};samo.calc_service_error=function(message,uid){button_disable(1,'bron');button_disable(0,'calc');$module_container.find('.ASERVICES table.res tbody tr').not('.note').each(function(){var service_json=$(this).data('json');$(this).removeClass('unavailable_order');if(service_json.uid==uid){$(this).addClass('unavailable_order').find('td:last').html('<button class="delete_additional_service">'+samo.i18n('BTN_DELETE')+'</button>');$(this).errorField(message);$module_container.find('.services_container').get(0).scrollIntoView(true);}});};function checkServices(){var $result=true;var $disabled=$module_container.find('.ASERVICES :disabled').not(':checked');if($disabled.length!==0){$disabled.each(function(){$(this).parents('fieldset:first').addClass('error');});$result=false;$disabled.get(0).scrollIntoView(false);}
if($module_container.find('.ASERVICES .error').length!==0){$result=false;}
if(!$result){button_disable(0,'calc');}
return $result;}
var error_tourist=samo.error_tourist=function(message,field){samo.field.error(message,field);button_disable(0,'calc');return false;};function checkTouristFields(){var checkout=$module_container.find('.tour_info').data('checkout');var $tourists=$module_container.find('.tourists-tabs .tourist');if(!$module_container.find('input.addinfant_cb').prop('checked')){$tourists=$tourists.not('.ainfant');}
$module_container.find('.tourists-tabs .error').each(function(){samo.field.clear_error(this);});var is_ok=true;$tourists.each(function(){$(this).find('.required').not('label').each(function(){if(!$(this).val().length){is_ok=error_tourist(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}});});if(!is_ok){button_disable(0,'calc');}
return is_ok;}
var error_buyer=error_tourist;function checkPersonInfo(){var is_ok=true;$module_container.find('.CLAIMINFO input[name*="[phys_byer]"]').each(function(){samo.field.clear_error(this);if($(this).is('.required')&&!$.trim(this.value).length){is_ok=error_buyer(samo.i18n('REQUIRED_FIELD_EMPTY'),this);}});if(!is_ok){button_disable(0,'calc');}
return is_ok;}
function getParams(action){var result={};var CLAIM=$.getParameter('CATCLAIM',true)||$.getParameter('CLAIM',true);if(CLAIM){result.CATCLAIM=CLAIM;result.CURRENCY=$.getParameter('CURRENCY',true);}else{var TICKET=$.getParameter('TICKET',true);if(TICKET){result.TICKET=TICKET;}else{result.KEY=$.getParameter('KEY',true);}}
result.claim_guid=samo.claim_guid;result.samo_action=action;if(arguments[1]){$.extend(result,arguments[1]);}
return _ROOT_URL+$.param(result);}
function checkFreights(){if($module_container.find('.claim_info').is('.ticket')){return true;}
if(samo.external_freights!='undefined'&&samo.external_freights==2){if(!$module_container.find('input[name=freight4table]:checked').length){button_disable(1,'bron');button_disable(0,'calc');msg(samo.i18n('NO_FLIGHT_SELECTED'));return false;}}else{if($module_container.find('.freights table tbody tr:not(.note)').length!==$module_container.find('.freights table tbody select').length||$module_container.find('.freights table tbody select option:selected[value=0]').length>0){button_disable(1,'bron');button_disable(0,'calc');msg(samo.i18n('NO_FREIGHTS'));return false;}}
return true;}
function checkHotels(){var $result=true,$hotel=$module_container.find('.main_hotel'),$room=$module_container.find('.main_room'),$htplace=$module_container.find('.main_htplace'),$meal=$module_container.find('.main_meal');if($hotel.length&&$hotel.val()==null){msg(samo.i18n('NO_HOTEL'));$result=false;}
if($result&&$room.length&&$room.val()==null){msg(samo.i18n('NO_ROOM'));$result=false;}
if($result&&$htplace.length&&$htplace.val()==null){msg(samo.i18n('NO_HTPLACE'));$result=false;}
if($result&&$meal.length&&$meal==null){msg(samo.i18n('NO_MEAL'));$result=false;}
if(!$result){button_disable(0,'calc');}
return $result;}
samo.bron_form();samo.initHotelPopup($module_container,{source:'.HOTELSINFO table',object:'.link-hotel'});if($('.freightTable').length){$("body").on('click','.freightTable input[type=radio]',function(){var el=$(this);$('.freightTable input').each(function(){$(this).removeAttr('data-checked');});el.attr('data-checked','checked');el.parent().parent().next().find('input[type=hidden]').attr('data-checked','checked');button_disable(1,'bron');}).on('click','.freightsFilter .hideLink a',function(){$($(this).parent().attr('data-hide-target')).toggle();return false;}).on('change','.freightsFilter select',function(){var filterVal=$(this).find('option:selected').val();var selectName=$(this).attr('name');if(selectName=='flight_types'||selectName=='full_airline'){samo.refreshFreightTable();}else if($(this).attr('name')=='class'){$('.freightTable, .freightsFilter, .currency').html('');var classVal=(filterVal==1)?"Econom":"Business";$('.load-external-freights').css('display','inline').triggerHandler('click',classVal);}});$("tbody.freightTable").on('click','input[type=radio]',function(){unHightlight($(this).parent().parent());}).on('click','td',function(){var self=$(this);if(self.parent().find('input[type=radio]').length){var radio=self.parent().find('input[type=radio]');}else{var radio=self.parent().prev().find('input[type=radio]');}
radio.prop('checked',true);$('tbody.freightTable tr.checked').removeClass('checked');radio.parent().parent().addClass('checked');radio.parent().parent().next().addClass('checked');$('.freightTable input').removeAttr('data-checked');radio.attr('data-checked','checked');radio.parent().parent().next().find('input[type=hidden]').attr('data-checked','checked');button_disable(1,'bron');$(samo.controls.CLAIMPRICE).triggerHandler('ReloadServices',['RELOADSERVICES']);}).on('mouseenter','tr',function(){var self=$(this);if(self.find('input[type=radio]').length){unHightlight(self);}else{unHightlight(self.prev());}}).on('mouseleave',this,function(){if(!$(this).find('input[type=radio]').prop('checked')){$('tbody.freightTable tr.yellow').removeClass('yellow');}});var unHightlight=function(tr){$('tbody.freightTable tr.yellow').removeClass('yellow');tr.addClass('yellow');tr.next().addClass('yellow');}}};samo.filterSliders=function(){var sliders=['flyDurationSlider','departTimeOnSlider','departTimeOffSlider'];var sections=['fly_duration','depart_time_on','depart_time_off'];for(var i=0;i<sliders.length;i++){var slider=document.getElementById(sliders[i]);if(slider){var min=isNaN(parseInt(samo.getValuesBySlideRange('min',sections[i])))?false:parseInt(samo.getValuesBySlideRange('min',sections[i]));var max=isNaN(parseInt(samo.getValuesBySlideRange('max',sections[i])))?false:parseInt(samo.getValuesBySlideRange('max',sections[i]));if(min&&max&&(min!=max)){noUiSlider.create(slider,{start:[min,max],behaviour:'drag-tap',connect:true,step:30,range:{'min':min,'max':max}});}}}
var flyDurationVals=[document.getElementById('fly-duration-value-lower'),document.getElementById('fly-duration-value-upper')];var departTimeOnVals=[document.getElementById('depart-time-on-value-lower'),document.getElementById('depart-time-on-value-upper')];var departTimeOffVals=[document.getElementById('depart-time-off-value-lower'),document.getElementById('depart-time-off-value-upper')];var flyDuration=document.getElementById('flyDurationSlider');var departTimeOn=document.getElementById('departTimeOnSlider');var departTimeOff=document.getElementById('departTimeOffSlider');if(typeof flyDuration.noUiSlider!=='undefined'){flyDuration.noUiSlider.on('update',function(values,handle){flyDurationVals[handle].innerHTML=((parseInt(values[handle]/60)<10)?'0':'')+parseInt(values[handle]/60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});flyDuration.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(flyDuration).parent().parent().hide();}
if(typeof departTimeOn.noUiSlider!=='undefined'){departTimeOn.noUiSlider.on('update',function(values,handle){departTimeOnVals[handle].innerHTML=((parseInt(values[handle]/60)<10)?'0':'')+parseInt(values[handle]/60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOn.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOn).parent().parent().hide();}
if(typeof departTimeOff.noUiSlider!=='undefined'){departTimeOff.noUiSlider.on('update',function(values,handle){departTimeOffVals[handle].innerHTML=((parseInt(values[handle]/60)<10)?'0':'')+parseInt(values[handle]/60)+':'+
((parseFloat(values[handle]%60)>0)?((parseFloat(values[handle]%60)<10)?'0':'')+parseFloat(values[handle]%60):'00');});departTimeOff.noUiSlider.on('end',function(){samo.refreshFreightTable();});}else{$(departTimeOff).parent().parent().hide();}
$('.sortbyduration').on('click',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('fly_duration_on','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('fly_duration_on','asc');}else{$(this).addClass('asc');_gdsSort('fly_duration_on','asc');}
return false;});$('.sortbysurcharge').on('click',function(){if($(this).hasClass('asc')){$(this).removeClass('asc');$(this).addClass('desc');_gdsSort('surcharge','desc');}else if($(this).hasClass('desc')){$(this).removeClass('desc');$(this).addClass('asc');_gdsSort('surcharge','asc');}else{$(this).addClass('asc');_gdsSort('surcharge','asc');}
return false;});function _gdsSort(field,type){type=type||'asc';var grid=document.getElementById('gdsGrid');var tbody=grid.getElementsByTagName('tbody')[0];var rowsArray=[].slice.call(tbody.rows);var tmpTable=[];for(var i=0;i<rowsArray.length;i++){if(i%2==0){var params=JSON.parse(rowsArray[i].dataset.bindFilter);tmpTable.push([rowsArray[i],rowsArray[i+1],params[field]]);}}
var compare=function(rowA,rowB){return rowA[2]-rowB[2];};tmpTable.sort(compare);if(type=='desc'){tmpTable.reverse();}
grid.removeChild(tbody);for(var i=0;i<tmpTable.length;i++){tbody.appendChild(tmpTable[i][0]);tbody.appendChild(tmpTable[i][1]);}
grid.appendChild(tbody);}};samo.refreshFreightTable=function(){var flyDuration=document.getElementById('flyDurationSlider').noUiSlider.get();var departTimeOn=document.getElementById('departTimeOnSlider').noUiSlider.get();var departTimeOff=document.getElementById('departTimeOffSlider').noUiSlider.get();var airlineF=$(".freightsFilter select[name='full_airline'] option:selected");var flightTypesF=$(".freightsFilter select[name='flight_types'] option:selected");$('.freightTable tr').each(function(){$(this).show();var trFilter=JSON.parse($(this).attr('data-bind-filter'));if(airlineF.length&&airlineF.val()!=0){if(trFilter['full_airline']!=airlineF.val()){$(this).hide();}}
if(flightTypesF.length&&flightTypesF.val()!=0){if(trFilter['flight_types']!=flightTypesF.val()){$(this).hide();}}
if(trFilter['fly_duration_on']<parseInt(flyDuration[0])||trFilter['fly_duration_off']<parseInt(flyDuration[0])){$(this).hide();}
if(trFilter['fly_duration_on']>parseInt(flyDuration[1])||trFilter['fly_duration_off']>parseInt(flyDuration[1])){$(this).hide();}
if(trFilter['depart_time_on']<parseInt(departTimeOn[0])){$(this).hide();}
if(trFilter['depart_time_on']>parseInt(departTimeOn[1])){$(this).hide();}
if(trFilter['depart_time_off']<parseInt(departTimeOff[0])){$(this).hide();}
if(trFilter['depart_time_off']>parseInt(departTimeOff[1])){$(this).hide();}});var messagesBlock=$('.freightsRes .messages');if($('.freightTable tr:visible').length==0){messagesBlock.html(samo.i18n('NO_FREIGHTS'));}else{messagesBlock.html('');}};samo.getValuesBySlideRange=function(type,section){var min=999999999;var max=0;$(".freightTable tr:visible").each(function(){var data=JSON.parse($(this).attr('data-bind-filter'));if(section!='fly_duration'){if(data[section]<min){min=data[section];}
if(data[section]>max){max=data[section];}}else{if(data.fly_duration_on<min){min=data.fly_duration_on;}
if(data.fly_duration_off<min){min=data.fly_duration_off;}
if(data.fly_duration_on>max){max=data.fly_duration_on;}
if(data.fly_duration_off>max){max=data.fly_duration_off;}}});if(type=='min'){return min;}
if(type=='max'){return max+1;}
return false;}
samo.price_chart=function(){if(typeof google=='undefined'){$.require('//www.gstatic.com/charts/loader.js',function(){google.charts.load('current',{packages:['corechart','bar'],language:samo.LANG.locale});google.charts.setOnLoadCallback(samo.googlePriceChart);});}else{samo.googlePriceChart();}
samo.helpalt_field($('#search_stat'),'hover');};samo.calendarPrice=function(){if(typeof resultPrices!=='undefined'){var calendar=$("#calendarPrice"),_ROOT_URL=samo.ROUTES.bron.url,params={};var rollR=calendar.find(".roll.right");var rollL=calendar.find(".roll.left");var colDates=calendar.find('.colDates');var abbrDayNames=samo.i18n('DATE_ABBR_DAY_NAMES');var abbrMonthNames=samo.i18n('DATE_ABBR_MONTH_NAMES');var priceDates=$.map(resultPrices.priceList,function(value,index){var seg=index.split('.');return[seg[2]+seg[1]+seg[0]];});priceDates=priceDates.sort();priceDates=$.map(priceDates,function(value,index){var year=value.substr(0,4);var month=value.substr(4,2);var day=value.substr(6,2);return[day+'.'+month+'.'+year];});samo.rollCalendar=function(position){var cellDateIndexFirst,cellDateIndexLast,incrementDate;if(position=='right'){rollL.css('visibility','visible');cellDateIndexFirst=6;cellDateIndexLast=0;incrementDate=1;}else{rollR.css('visibility','visible');cellDateIndexFirst=0;cellDateIndexLast=6;incrementDate=-1;}
var dt=samo.dateFromString(colDates.find('th:eq('+cellDateIndexFirst+')').attr('data-index'));dt.setDate(dt.getDate()+incrementDate);var rd=samo.dateAsString(dt,'dd.mm.yyyy'),oDate=rd.split('.'),strDate=oDate[0]+' '+
abbrMonthNames[(new Date(oDate[2]+'-'+oDate[1]+'-'+oDate[0])).getMonth()]+' , '+
abbrDayNames[(new Date(oDate[2]+'-'+oDate[1]+'-'+oDate[0])).getDay()];colDates.find('th:eq('+cellDateIndexLast+')').remove();var th='<th class="relative dates" data-index="'+rd+'">'+strDate+'</th>';if(position=="right"){colDates.append(th);}else{colDates.prepend(th);}
var lastDate=samo.dateFromString(priceDates[priceDates.length-1]),firstDate=samo.dateFromString(priceDates[0]),thisDate=samo.dateFromString(rd);if(position=='right'&&(lastDate<=thisDate)){rollR.css('visibility','hidden');}else if(position=='left'&&(firstDate>=thisDate)){rollL.css('visibility','hidden');}
var prices=resultPrices.prices[rd];calendar.find('.rows').each(function(){var template='<td class="cells"></td>',elClass,elTitle;var row=$(this),nights=row.find('th.relative.dates').text();row.find('td:eq('+cellDateIndexLast+')').remove();if(typeof prices!=='undefined'&&typeof prices[nights]!=='undefined'){elTitle="<div class='text-center'><b>"+prices.datestr+" | "+
samo.i18n('PRICE_CALENDAR_NIGHTS')+nights+"</b><br>"+prices[nights]+" ";if(prices.diff[nights]>0){elTitle+=" <span class='red'><b>"+prices.diff[nights]+" "+resultPrices.currency+"</b></span> <div class='arrowUp'></div>";}else if(prices.diff[nights]<0){elTitle+="<span class='green'><b>"+prices.diff[nights].toString().substr(1)+" "+
resultPrices.currency+"</b></span> <div class='arrowDown'></div>";}
if(prices.color[nights]!='white'){elTitle+='<br><b>';if(prices.color[nights]=='green'){elTitle+=samo.i18n('TOUR_SEARCH_MOMENT_CONFIRM');elClass='bgreen';}
elTitle+='</b>';}
if(nights==resultPrices.nights&&rd==resultPrices.checkIn){elClass+=' selected ';}
elTitle+="</div>";template='<td class="cells price '+elClass+'">';elClass=prices.color[nights];template+='<div class="flexContainer" data-type="'+elClass+'" '+'title="'+elTitle+'" data-catclaim="'+prices.catclaim[nights]+'"><div class="fcontent">';var tmpClass='',tmpPrice=0,tmpArrow='';if(prices.diff[nights]>0){tmpClass=' cloudred';tmpPrice='+'+prices.diff[nights];tmpArrow='<span class="arrowUp"></span>';}else if(prices.diff[nights]<0){tmpClass=' cloud';tmpPrice=prices.diff[nights];tmpArrow='<span class="arrowDown"></span>';}else{tmpPrice=prices.priceNumber[nights];}
template+='<div class="content'+tmpClass+'">'+tmpPrice+' '+resultPrices.currency
+tmpArrow;template+='</div></div></div>';}
var vEl=$(template),bullet=vEl.find('.flexContainer');bullet.msgBullet({showOn:'hover',bulletText:bullet.attr('title'),bulletType:bullet.attr('data-type'),delay:1});bullet.bind('click',function(){params.CATCLAIM=bullet.attr('data-catclaim');document.location.href=_ROOT_URL+$.param(params);});if(position=='right'){row.append(vEl);}else{row.find('th:eq(0)').after(vEl);}});};rollR.bind('click',function(){samo.rollCalendar('right');samo.refreshCalendar();});rollL.bind('click',function(){samo.rollCalendar('left');samo.refreshCalendar();});samo.refreshCalendar=function(){calendar.find("td").bind('mouseenter',function(){calendar.find("th").each(function(){if($(this).hasClass("dates")){$(this).removeClass('hoveredDate');}});var td=$(this);var col=td.parent().children().index(td)-1;var row=td.parent().parent().children().index(td.parent());var dateRow=calendar.find("tbody th.dates:eq("+row+")");var colRow=calendar.find("thead th.dates:eq("+col+")");dateRow.addClass('hoveredDate');colRow.addClass('hoveredDate');});calendar.find("th").bind('mouseenter',function(){calendar.find("th").each(function(){if($(this).hasClass("dates")){$(this).removeClass('hoveredDate');}});});};calendar.find('td.price div.flexContainer').each(function(){$(this).msgBullet({showOn:'hover',bulletText:$(this).attr('title'),bulletType:$(this).attr('data-type'),delay:1});$(this).bind('click',function(){params.CATCLAIM=$(this).attr('data-catclaim');document.location.href=_ROOT_URL+$.param(params);});});if(calendar.length){samo.refreshCalendar();}}};$(document).ready(samo.bron_info);$(document).ready(samo.calendarPrice);})
(samo.jQuery);