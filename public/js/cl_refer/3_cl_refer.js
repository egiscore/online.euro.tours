
(function($){var container=samo.initModuleContainer('cl_refer');samo.cl_refer=function(){var _ROOT_URL=samo.ROUTES.cl_refer.url,$module_container=container,_controls=$module_container.find('input:text');samo.cache_controls($module_container);$.each(['edit_tourist','deposit','agreement_person'],function(){if(typeof samo.ROUTES[this]!='undefined'){$.require(samo.ROUTES.WWWROOT+'public/js/'+this+'/3_'+this+'.js');}});if(typeof samo.controls.TOURINC==='undefined'){$module_container.find('span.partner_toggle').bind('click',function(){$.getScript(_ROOT_URL+$.param({samo_action:'AGENCYINFO'}));});$module_container.find('span.partner_discount').bind('click',function(){$.getScript(_ROOT_URL+$.param({samo_action:'PARTNER_DISCOUNT'}));});}else{samo.partner_info();}
$module_container.find('.date').datePicker().end().find('.CLAIMBEGIN').numeric().end().find('.resultset').delegate('span.page','click',function(){getClaims($(this).data('page'));}).delegate('.toggle_orders','click',function(){var self=$(this),CLAIM=self.parent().attr('id').replace('orders_','');self.text(samo.i18n('LOADING'));samo.load_orders(CLAIM);}).delegate('span.msg','click',function(){var claim=parseInt($(this).parents('table:first').data('claim'));samo.claim_messages(claim);}).delegate('span.msg-new','click',function(){var claim=parseInt($(this).parents('table:first').data('claim'));samo.claim_message_form(claim);}).delegate('.link.cancel_claim','click',function(e){var claim=parseInt($(this).parents('table:first').data('claim'));$.getScript(samo.ROUTES.cancel_claim.url+$.param({CLAIM:claim}));});$module_container.find('.PARTNERCLAIM,.CLAIMTYPE,.PAYTYPE,.STATECLAIM,.MANAGERCLAIM').chosen({no_results_text:samo.i18n('NODATA'),enable_split_word_search:false,search_contains:true});samo.load_orders=function(CLAIM){$.getScript(getParams('CLAIMORDERS')+'&CLAIM='+CLAIM,function(){samo.short_description();});};function getClaims(){$module_container.find('.resultset').empty().get(0).scrollIntoView();var page=parseInt(arguments[0],10)||1;$.getScript(getParams('RESULT')+'&CLAIMPAGE='+page,function(){samo.short_description();});}
samo.controls.PARTNER=$module_container.find('.PARTNER');samo.loadBtn.bind('click',getClaims);function getParams(action){var useGET=arguments[1]||false;var result={};result.samo_action=action;_controls.each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});if(result.CLAIMBEGIN){$('select.CLAIMTYPE',$module_container).val('1').trigger('chosen:updated');$('select.PAYTYPE',$module_container).val('0').trigger('chosen:updated');$('select.PARTNERCLAIM',$module_container).val('0').trigger('chosen:updated');$('select.STATECLAIM',$module_container).val('0').trigger('chosen:updated');$('select.MANAGERCLAIM',$module_container).val('0').trigger('chosen:updated');}
result.CLAIMTYPE=$('select.CLAIMTYPE',$module_container).val();result.PAYTYPE=$('select.PAYTYPE',$module_container).val();result.PARTNERCLAIM=$('select.PARTNERCLAIM',$module_container).val();result.STATECLAIM=$('select.STATECLAIM',$module_container).val();result.MANAGERCLAIM=$('select.MANAGERCLAIM',$module_container).val();return _ROOT_URL+$.param(result);}
function edit_tourist_link(){var $obj=$(this).parents('.cl_refer_result:first'),CLAIM=$obj.data('claim'),CHECKOUT=$obj.data('checkout'),PEOPLE=$(this).parents('tr:first').data('people');$.getScript(samo.ROUTES.edit_tourist.url+$.param({CLAIM:CLAIM,PEOPLE:PEOPLE,CHECKOUT:CHECKOUT}));}
function visa_status_link(){var $self=$(this),PEOPLE=$self.parents('tr:first').data('people'),CLAIM=parseInt($(this).parents('.cl_refer_result:first').data('claim'),10);$.getScript(samo.ROUTES.visa_status.url+$.param({CLAIM:CLAIM,PEOPLE:PEOPLE}));}
function e_doc_link(){var CLAIM=parseInt($(this).parents('.cl_refer_result:first').data('claim'),10);samo.e_doc(CLAIM)}
samo.e_doc=function(CLAIM){$.getScript(_ROOT_URL+$.param({CLAIM:CLAIM,samo_action:'E_DOC'}));};samo.claim_modules=function(claim){var $c_container=$module_container;if(typeof claim!='undefined'){$c_container=$('#cl_'+claim);}
$c_container.find('td.cl_alink').each(function(){var $this=$(this);var claim=parseInt($this.parents('.cl_refer_result:first').data('claim'),10);if($('#orders_'+claim+' .toggle_orders').length===0){samo.claim_orders(claim);}
$this.find('.e_doc').bind('click',e_doc_link);}).end().find('span.cl_price').bind('click',function(e){var claim=parseInt($(this).parents('.cl_refer_result:first').data('claim'),10);$.getScript(_ROOT_URL+$.param({CLAIM:claim,samo_action:'COST'}),false);}).end().find('button.ClaimConfirmPreOrder').bind('click',function(e){var claim=parseInt($(this).parents('.cl_refer_result:first').data('claim'),10);$.getScript(_ROOT_URL+$.param({CLAIM:claim,samo_action:'CLAIM_CONFIRM_PREORDER'}),false);});};samo.claim_orders=function(claim){var $tbl=$('#cl_'+claim);var cl_status=parseInt($tbl.data('status'),10);var cl_anketa=parseInt($tbl.data('anketa'),10);var cl_confirmed=parseInt($tbl.data('confirmed'),10);var cl_req_cancel_date=$tbl.data('request-cancel-date');var cl_visast_www=$tbl.data('visast_www')||'';var $orders=$('#orders_'+claim);$orders.delegate('.o_pcount','click',function(){var self=$(this).parent(),order=self.data('order');$orders.find('tr.highlight').removeClass('highlight');self.addClass('highlight');samo.highlight_peoples(claim,self.data('peoples'));}).find('.toggle_orders').remove().end().delegate('.frplacement','click',init_frplacement);if(cl_status!=3&&cl_status!=4&&cl_status!=5){if(samo.ROUTES.edit_tourist){$orders.find('td.edit_tourist').each(function(){$(this).append('<span class="link elink">'+samo.i18n('CL_R_P_EDIT')+'</span>').find('.elink').bind('click',edit_tourist_link);});}
if(cl_status!=7){if($orders.find('td.visa').length>0&&cl_confirmed==1&&!cl_req_cancel_date){if(samo.ROUTES.visa_status){$orders.find('td.p_v_status').each(function(){$(this).prepend('&nbsp;&nbsp;&nbsp;<span class="link">'+samo.i18n('CL_R_PRINT_VSTATUS')+'</span>').find('.link').bind('click',visa_status_link);});}}
$orders.find('td.p_v_status').each(function(){if(!cl_req_cancel_date){if(cl_anketa&&samo.ROUTES.anketa&&cl_confirmed==1){var people=$(this).parents('tr:first').data('people');$(this).prepend('<a href="'+samo.ROUTES.anketa.url+$.param({CLAIM:claim,PEOPLE:people})+'" target="_blank">'+samo.i18n('CL_R_P_ANKETA')+'</a>');}else{if(cl_visast_www!=''){$(this).prepend('<a href="'+cl_visast_www+'" target="_blank">'+samo.i18n('CL_R_P_ANKETA')+'</a>');}}
if(cl_confirmed==0){$(this).prepend('<span>'+samo.i18n('CL_ANKETA_NOT_CONFIRMED')+'</span>');}}});}}};samo.cancel_claim=function(claim){$('#agreement').bind('click',function(){var result={};result.CLAIM=claim;if($('#CANCEL_CLAIM_REASON_SELECT')){var reason_value=parseInt($('#CANCEL_CLAIM_REASON_SELECT').val());if(reason_value===0){$.notify({text:samo.i18n('NO_CHOOSE_CANCEL_REASON'),type:'error'})
return false;}
result.CANCEL_CLAIM_REASON_SELECT=reason_value;}
this.disabled=true;$.post(samo.ROUTES.cancel_claim.url+'samo_action=request',result,null,'script');});};samo.claim_cost=function(){$('.cost_close').bind('click',function(){$.modal.close();});$('.pay_claim').bind('click',function(){$.modal.close();var params={CLAIM:$(this).data('claim')};var pay_variant_url=samo.ROUTES.pay_variant.url+$.param(params);window.open(pay_variant_url,'pay_variant_'+params.CLAIM);});};samo.claim_confirm_preorder=function(){$('.close').bind('click',function(){$.modal.close();});$('.load').bind('click',function(){$.modal.close();$.getScript(_ROOT_URL+$.param({CLAIM:$(this).data('claim'),CLAIM_CONFIRM_PREORDER_BRON:1,samo_action:'CLAIM_CONFIRM_PREORDER'}),null);});};samo.highlight_peoples=function(claim,peoples){$(String(peoples).split(',')).each(function(){$('#people_'+this).addClass('highlight');});};samo.partner_info=function(){$('#basicModalContent').find('.frm-row:odd').addClass('odd').end().find('.TOURINC').bind('change',function(){var result={samo_action:'AGENCYDISCOUNT',TOURINC:this.value};$.getScript(_ROOT_URL+$.param(result));}).chosen();};(function(){var claim=$module_container.find('.cl_refer_result');if(claim){samo.claim_modules();}})();samo.initHotelPopup($module_container);samo.short_description();};samo.e_doc_post=function(){var _ROOT_URL=samo.ROUTES.cl_refer.url;var $edoc=$('#e_doc');var mes=$edoc.data('confirm-note');$edoc.find('a.confirm_required').bind('click',function(){if(!confirm(mes)){return false;}}).end().find('a.external').bind('click',samo.delayed_download);$('tr.flash').addClass('blink-once');setTimeout(function(){$('tr.flash').removeClass('blink-once');},3000);$('#e_doc_tabs .e_doc_tab_selected').prop('disabled',true);$('#E_DOC_BTN_PRINT').bind('click',function(){var CLAIM=$('#e_doc').data('claim');$.getScript(_ROOT_URL+$.param({CLAIM:CLAIM,samo_action:'E_DOC'}));});$('#E_DOC_BTN_ADD').bind('click',function(){var CLAIM=$('#e_doc').data('claim');$.getScript(_ROOT_URL+$.param({CLAIM:CLAIM,samo_action:'E_DOC_TAB_ADD'}));});$('#E_DOC_TYPE').bind('change',function(){var doctype=$(this).val(),$container=$('#UPLOAD_DIV');var upload_file_format=$(this).find('option:selected').data('upload_format');var upload_req_people=$(this).find('option:selected').data('upload_req_people');$('.type_note_x').addClass('hidden');$('#upload_file_format').html(upload_file_format);if(doctype>0){$('#type_note_'+doctype).removeClass('hidden');if(upload_req_people==1){$('#E_DOC_PEOPLE_DIV').removeClass('hidden');}else{$('#E_DOC_PEOPLE_DIV').addClass('hidden');}
$container.removeClass('hidden');}else{$container.addClass('hidden');}}).triggerHandler('change');$('#E_DOC_BTN_UPLOAD').bind('click',function(){var CLAIM=$('#e_doc').data('claim');var $elements=$('#edoc_file');var doctype=$('#E_DOC_TYPE').val();var upload_format=$('#E_DOC_TYPE option:selected').data('upload_format');var upload_max_size=$('#E_DOC_TYPE option:selected').data('upload_size');var upload_req_people=$('#E_DOC_TYPE option:selected').data('upload_req_people');var people=$('#E_DOC_PEOPLE').val();var is_ok=(upload_req_people==0)||(upload_req_people==1&&people>0);if(is_ok){if(samo.check_file_extension($elements,upload_format,upload_max_size)){var load_btn=samo.loadBtn;samo.loadBtn=$(this);$.ajax({async:true,dataType:'iframe script',type:'POST',url:_ROOT_URL+$.param({CLAIM:CLAIM,PEOPLEINC:people,EDOC_UPLOAD_DOCTYPE:doctype,samo_action:'UPLOAD_EDOC',is_js:1}),fileInput:$elements});samo.loadBtn=load_btn;}}else{$.notify({text:samo.i18n('UPLOAD_REQ_PEOPLE'),type:'error'});}});};samo.frplacement_save=function(button,$pTable){button.disabled=true;var data=null,_data=null,$peoples=$pTable.find('tbody tr');var seats={},seats_count=0,changes=0;data=$pTable.data();$peoples.each(function(){_data=$(this).data();if(_data.inc){seats[_data.opeople]=_data.inc;seats_count++;}else{seats[_data.opeople]=0;}
if(!data.seats||!data.seats[_data.people]||data.seats[_data.people]!=seats[_data.opeople]){changes++;}});var url=samo.ROUTES.cl_refer.url+$.param({CLAIM:data.claim,ORDER:data.order,samo_action:'SAVE_FRPLACEMENT'});if(changes>0){var params={seats:seats};$.post(url,params,function(){button.disabled=frplacement_disabled=false;if(Object.keys(samo.seats).length==$peoples.length){$('#order_'+data.order).find('.frplacement.pulse').removeClass('pulse');}else{$('#order_'+data.order).find('.frplacement').addClass('pulse');}
samo.seats={};},'script');}else{$.model.close();}};var frplacement_disabled=false;var init_frplacement=function(event){event.stopImmediatePropagation();var $span=$(event.target),$tr=$span.parents('tr:first'),data=$tr.data();if(!frplacement_disabled){var params={freight:data.freight};frplacement_disabled=true;params.maxWidth=container.width();params.maxHeight=$(window).height();var CLAIM=$tr.parents('.cl_refer_result').data('claim');var url=samo.ROUTES.cl_refer.url+$.param({CLAIM:CLAIM,ORDER:data.order,samo_action:'CHOOSE_FRPLACEMENT'});$.post(url,params,function(){frplacement_disabled=false;},'script');}};$(document).ready(samo.cl_refer);})(samo.jQuery);