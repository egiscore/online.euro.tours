
(function($){var container=samo.initModuleContainer('cl_refer');samo.cl_refer_person=function(){var _ROOT_URL=samo.ROUTES.cl_refer_person.url,$module_container=container,_controls=$('input:text',$module_container);samo.cache_controls($module_container);if(samo.ROUTES.edit_tourist){$.require(samo.ROUTES.WWWROOT+'public/js/edit_tourist/3_edit_tourist.js');}
if(samo.ROUTES.psbank){$.require(samo.ROUTES.WWWROOT+'public/js/psbank/3_psbank.js');}
if(samo.ROUTES.platron){$.require(samo.ROUTES.WWWROOT+'public/js/platron/platron.js');}
if(samo.ROUTES.sberbank){$.require(samo.ROUTES.WWWROOT+'public/js/sberbank/sberbank.js');}
if(samo.ROUTES.credit_europe_bank||samo.ROUTES.alfabank||samo.ROUTES.fortebank||samo.ROUTES.paylate||samo.ROUTES.paybox||samo.ROUTES.uniteller||samo.ROUTES.liqpay||samo.ROUTES.platron||samo.ROUTES.fondy||samo.ROUTES.agroindbank||samo.ROUTES.psb||samo.ROUTES.processing_kz||samo.ROUTES.openbank){$.require(samo.ROUTES.WWWROOT+'public/js/acquiring.js');}
if(samo.ROUTES.credit_europe_bank){$.require(samo.ROUTES.WWWROOT+'public/js/credit_europe_bank/credit_europe_bank.js');}
if(samo.ROUTES.liqpay){$.require(samo.ROUTES.WWWROOT+'public/js/liqpay/liqpay.js');}
if(samo.ROUTES.alfabank){$.require(samo.ROUTES.WWWROOT+'public/js/alfabank/alfabank.js');}
if(samo.ROUTES.fortebank){$.require(samo.ROUTES.WWWROOT+'public/js/fortebank/fortebank.js');}
if(samo.ROUTES.openbank){$.require(samo.ROUTES.WWWROOT+'public/js/openbank/openbank.js');}
if(samo.ROUTES.fondy){$.require(samo.ROUTES.WWWROOT+'public/js/fondy/fondy.js');}
if(samo.ROUTES.agroindbank){$.require(samo.ROUTES.WWWROOT+'public/js/agroindbank/agroindbank.js');}
if(samo.ROUTES.processing_kz){$.require(samo.ROUTES.WWWROOT+'public/js/processing_kz/processing_kz.js');}
if(samo.ROUTES.psb){$.require(samo.ROUTES.WWWROOT+'public/js/psb/psb.js');}
if(samo.ROUTES.paylate){$.require(samo.ROUTES.WWWROOT+'public/js/paylate/paylate.js');}
if(samo.ROUTES.paybox){$.require(samo.ROUTES.WWWROOT+'public/js/paybox/paybox.js');}
if(samo.ROUTES.kkb_kz){$.require(samo.ROUTES.WWWROOT+'public/js/kkb_kz/kkb_kz.js');}
if(samo.ROUTES.uniteller){$.require(samo.ROUTES.WWWROOT+'public/js/uniteller/uniteller.js');}
if(samo.ROUTES.invoice){$.require(samo.ROUTES.WWWROOT+'public/js/invoice/3_invoice.js');}
samo.load_orders=function(CLAIM){$.getScript(getParams('CLAIMORDERS')+'&CLAIM='+CLAIM);};function getParams(action){var useGET=arguments[1]||false;var result={};result.samo_action=action;_controls.each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});return _ROOT_URL+$.param(result);}
samo.claim_modules=function(){$module_container.find('td.cl_alink').each(function(){var data=$(this).parent().parent().parent().data();var claim=parseInt(data.claim);if($('#orders_'+claim+' .toggle_orders').length==0){samo.claim_orders(claim);}
$(this).find('.link.psbank').bind('click',psbank_link).end().find('.link.platron').bind('click',platron_link).end().find('.link.sberbank').bind('click',sberbank_link).end().find('.link.credit_europe_bank').bind('click',credit_europe_bank_link).end().find('.link.alfabank').bind('click',alfabank_link).end().find('.link.fortebank').bind('click',fortebank_link).end().find('.link.openbank').bind('click',openbank_link).end().find('.link.fondy').bind('click',fondy_link).end().find('.link.agroindbank').bind('click',agroindbank_link).end().find('.link.processing_kz').bind('click',processing_kz_link).end().find('.link.psb').bind('click',psb_link).end().find('.link.liqpay').bind('click',liqpay_link).end().find('.link.paylate').bind('click',paylate_link).end().find('.link.paybox').bind('click',paybox_link).end().find('.link.kkb_kz').bind('click',kkb_kz_link).end().find('.link.uniteller').bind('click',uniteller_link).end().find('.link.e_doc').bind('click',e_doc_link).end().find('.link.msg').bind('click',function(){samo.claim_messages(claim);}).end().find('.link.msg-new').bind('click',function(){samo.claim_message_form(claim);}).end().find('.link.invoice').bind('click',function(e){e.preventDefault();e.stopPropagation();$.getScript(claim_module_link('invoice',{proxy_action:'CHECK'},this));});}).end().find('button.ClaimConfirmPreOrder').bind('click',function(e){var claim=parseInt($(this).parents('.cl_refer_result:first').data('claim'),10);$.getScript(_ROOT_URL+$.param({samo_action:'CLAIM_CONFIRM_PREORDER',CLAIM:claim}));});$module_container.delegate('.link.cancel_claim','click',function(e){$.getScript(samo.ROUTES.cancel_claim.url+'CLAIM='+parseInt($(this).parents('table:first').data('claim')));});$('.link.phys_byer').bind('click',edit_phys_byer_link);};samo.claim_confirm_order=function(){var claim=parseInt($('button.ClaimConfirmPreOrder').parents('.cl_refer_result:first').data('claim'),10);$.getScript(claim_module_link('cl_refer',{proxy_action:'CLAIM_CONFIRM_PREORDER',CLAIM:claim},this));};samo.claim_confirm_preorder=function(){$('.close').bind('click',function(){$.modal.close();});$('.load').bind('click',function(){$.modal.close();$.getScript(claim_module_link('cl_refer',{proxy_action:'CLAIM_CONFIRM_PREORDER',CLAIM:$(this).data('claim'),CLAIM_CONFIRM_PREORDER_BRON:1},this));});};samo.highlight_peoples=function(claim,peoples){$(String(peoples).split(',')).each(function(){$('#people_'+this).addClass('selected');});};samo.frplacement_disabled=false;samo.init_frplacement_person=function(event){event.stopImmediatePropagation();var $span=$(event.target),$tr=$span.parents('tr:first'),data=$tr.data();if(!samo.frplacement_disabled){var params={freight:data.freight};samo.frplacement_disabled=true;params.maxWidth=container.width();params.maxHeight=$(window).height();var CLAIM=$tr.parents('.cl_refer_result').data('claim');var url=claim_module_link('cl_refer',{CLAIM:CLAIM,ORDER:data.order,proxy_action:'CHOOSE_FRPLACEMENT'},this);$.post(url,params,function(){samo.frplacement_disabled=false;},'script');}};samo.frplacement_save=function(button,$pTable){button.disabled=true;var data=null,_data=null,$peoples=$pTable.find('tbody tr');var seats={},seats_count=0,changes=0;data=$pTable.data();$peoples.each(function(){_data=$(this).data();if(_data.inc){seats[_data.opeople]=_data.inc;seats_count++;}else{seats[_data.opeople]=0;}
if(!data.seats||!data.seats[_data.people]||data.seats[_data.people]!=seats[_data.opeople]){changes++;}});var url=claim_module_link('cl_refer',{CLAIM:data.claim,ORDER:data.order,proxy_action:'SAVE_FRPLACEMENT'},this);if(changes>0){var params={seats:seats};$.post(url,params,function(){button.disabled=frplacement_disabled=false;if(Object.keys(samo.seats).length==$peoples.length){$('#order_'+data.order).find('.frplacement.pulse').removeClass('pulse');}else{$('#order_'+data.order).find('.frplacement').addClass('pulse');}
samo.seats={};},'script');}else{$.model.close();}};samo.claim_orders=function(claim){var data=$('#cl_'+claim).data();var cl_status=parseInt(data.status);var cl_anketa=parseInt(data.anketa);var cl_visast_www=data.visast_www||'';var $orders=$('#orders_'+claim);$orders.delegate('.o_pcount','click',function(){var self=$(this).parent();$orders.find('tr.highlight').removeClass('highlight');self.addClass('highlight');samo.highlight_peoples(claim,self.data('peoples'));}).find('.toggle_orders').remove().end().delegate('.frplacement','click',samo.init_frplacement_person);if(cl_status!=3&&cl_status!=4&&cl_status!=5){if(samo.ROUTES.edit_tourist){$orders.find('td.edit_tourist').each(function(){$(this).append('<span class="link">'+samo.i18n('CL_R_P_EDIT')+'</span>').find('.link').bind('click',edit_tourist_link);});}
if(cl_status!=7){if(samo.ROUTES.visa_status&&$('#orders_'+claim+' td.visa').length>0){$orders.find('td.p_v_status').each(function(){$(this).prepend('&nbsp;&nbsp;&nbsp;<span class="link">'+samo.i18n('CL_R_PRINT_VSTATUS')+'</span>').find('.link').bind('click',visa_status_link);});}
$orders.find('td.p_v_status').each(function(){if(cl_anketa&&samo.ROUTES.anketa){var people=$(this).parents('tr:first').attr('id').replace('people_','');$(this).prepend('<a href="'+claim_module_link('anketa',{PEOPLE:people},this)+'" target="_blank">'+samo.i18n('CL_R_P_ANKETA')+'</a>');}else{if(cl_visast_www!=''){$(this).prepend('<a href="'+cl_visast_www+'" target="_blank">'+samo.i18n('CL_R_P_ANKETA')+'</a>');}}});}}};function edit_tourist_link(){var $obj=$(this).parents('.cl_refer_result:first'),CHECKOUT=$obj.data('checkout'),PEOPLE=$(this).parents('tr:first').attr('id').replace('people_','');$.getScript(claim_module_link('edit_tourist',{PEOPLE:PEOPLE,CHECKOUT:CHECKOUT},this));}
function edit_phys_byer_link(){var $obj=$(this).parents('.cl_refer_result:first'),CLAIM=$obj.data('claim');$.getScript(_ROOT_URL+$.param({samo_action:'phys_byer',CLAIM:CLAIM}));}
function psbank_link(){$.getScript(claim_module_link('psbank',{proxy_action:'CHECK'},this));}
function platron_link(){$.getScript(claim_module_link('platron',{proxy_action:'CHECK'},this));}
function sberbank_link(){$.getScript(claim_module_link('sberbank',{proxy_action:'CHECK'},this));}
function credit_europe_bank_link(){$.getScript(claim_module_link('credit_europe_bank',{proxy_action:'CHECK'},this));}
function alfabank_link(){$.getScript(claim_module_link('alfabank',{proxy_action:'CHECK'},this));}
function fortebank_link(){$.getScript(claim_module_link('fortebank',{proxy_action:'CHECK'},this));}
function openbank_link(){$.getScript(claim_module_link('openbank',{proxy_action:'CHECK'},this));}
function fondy_link(){$.getScript(claim_module_link('fondy',{proxy_action:'CHECK'},this));}
function agroindbank_link(){$.getScript(claim_module_link('agroindbank',{proxy_action:'CHECK'},this));}
function processing_kz_link(){$.getScript(claim_module_link('processing_kz',{proxy_action:'CHECK'},this));}
function psb_link(){$.getScript(claim_module_link('psb',{proxy_action:'CHECK'},this));}
function liqpay_link(){$.getScript(claim_module_link('liqpay',{proxy_action:'CHECK'},this));}
function paylate_link(){$.getScript(claim_module_link('paylate',{proxy_action:'CHECK'},this));}
function paybox_link(){$.getScript(claim_module_link('paybox',{proxy_action:'CHECK'},this));}
function kkb_kz_link(){$.getScript(claim_module_link('kkb_kz',{proxy_action:'CHECK'},this));}
function uniteller_link(){$.getScript(claim_module_link('uniteller',{proxy_action:'CHECK'},this));}
function visa_status_link(){var PEOPLE=$(this).parents('tr:first').attr('id').replace('people_','');$.getScript(claim_module_link('visa_status',{PEOPLE:PEOPLE},this));}
function claim_module_link(module,$params,self){var params={samo_action:'proxy_action',target:module,CLAIM:$(self).parents('.cl_refer_result:first').data('claim')};if($params){params=$.extend({},$params,params);}
return _ROOT_URL+$.param(params);}
function e_doc_link(){$.getScript(claim_module_link('cl_refer',{proxy_action:'E_DOC'},this));}
samo.e_doc_post=function(){var _ROOT_URL=samo.ROUTES.cl_refer.url;var $edoc=$('#e_doc');var mes=$edoc.data('confirm-note');$edoc.find('a.confirm_required').bind('click',function(){if(!confirm(mes)){return false;}}).end().find('a.external').bind('click',samo.delayed_download);$('tr.flash').addClass('blink-once');setTimeout(function(){$('tr.flash').removeClass('blink-once');},3000);$('#e_doc_tabs .e_doc_tab_selected').prop('disabled',true);$('#E_DOC_BTN_PRINT').bind('click',function(){var CLAIM=$('#e_doc').data('claim');$.getScript(_ROOT_URL+$.param({CLAIM:CLAIM,samo_action:'E_DOC'}));});$('#E_DOC_BTN_ADD').bind('click',function(){var CLAIM=$('#e_doc').data('claim');$.getScript(_ROOT_URL+$.param({CLAIM:CLAIM,samo_action:'E_DOC_TAB_ADD'}));});$('#E_DOC_TYPE').bind('change',function(){var doctype=$(this).val(),$container=$('#UPLOAD_DIV');var upload_file_format=$(this).find('option:selected').data('upload_format');var upload_req_people=$(this).find('option:selected').data('upload_req_people');$('.type_note_x').addClass('hidden');$('#upload_file_format').html(upload_file_format);if(doctype>0){$('#type_note_'+doctype).removeClass('hidden');if(upload_req_people==1){$('#E_DOC_PEOPLE_DIV').removeClass('hidden');}else{$('#E_DOC_PEOPLE_DIV').addClass('hidden');}
$container.removeClass('hidden');}else{$container.addClass('hidden');}}).triggerHandler('change');$('#E_DOC_BTN_UPLOAD').bind('click',function(){var CLAIM=$('#e_doc').data('claim');var $elements=$('#edoc_file');var doctype=$('#E_DOC_TYPE').val();var upload_format=$('#E_DOC_TYPE option:selected').data('upload_format');var upload_max_size=$('#E_DOC_TYPE option:selected').data('upload_size');var upload_req_people=$('#E_DOC_TYPE option:selected').data('upload_req_people');var people=$('#E_DOC_PEOPLE').val();var is_ok=(upload_req_people==0)||(upload_req_people==1&&people>0);if(is_ok){if(samo.check_file_extension($elements,upload_format,upload_max_size)){var load_btn=samo.loadBtn;samo.loadBtn=$(this);$.ajax({async:true,dataType:'iframe script',type:'POST',url:_ROOT_URL+$.param({CLAIM:CLAIM,PEOPLEINC:people,EDOC_UPLOAD_DOCTYPE:doctype,samo_action:'UPLOAD_EDOC',is_js:1}),fileInput:$elements});samo.loadBtn=load_btn;}}else{$.notify({text:samo.i18n('UPLOAD_REQ_PEOPLE'),type:'error'});}});var $edoc=$('#e_doc');var mes=$edoc.data('confirm-note');$edoc.find('a.confirm_required').bind('click',function(){if(!confirm(mes)){return false;}}).end().find('a.external').bind('click',samo.delayed_download);};function e_doc_get_external(href){$.getScript(href,e_doc_external_result,false,true,function(){samo.externalDocument={error:samo.i18n('PARSE_ERROR')}
e_doc_external_result();});}
function e_doc_external_result(){var $winEternalDoc=$('#winEternalDoc');if($winEternalDoc.length){if(typeof samo.externalDocument!='undefined'){if(typeof samo.externalDocument.error!='undefined'){$winEternalDoc.html(samo.externalDocument.error).css({color:'red'});}else if(typeof samo.externalDocument.url!='undefined'){$winEternalDoc.html('<a href="'+samo.externalDocument.url+'" target="_blank">'+samo.i18n('CL_R_DOC_DOWNLOAD')+'</a>');}else{setTimeout(function(){e_doc_get_external($winEternalDoc.data('href'));},((typeof samo.externalDocument.wait!='undefined')?samo.externalDocument.wait:30)*1000);}}}
return true}
samo.phys_byer=function(){var $module_container=$('#phys_byer');samo.helpalt_field($module_container);$module_container.find('.load').bind('click',function(){var params={};if(check_fields()){$module_container.find('input').each(function(){params[this.name]=$.controlValue(this);});$.post(_ROOT_URL+$.param({samo_action:'phys_byer_edit',CLAIM:$module_container.data('claim')}),params,function(){if(preorderEvent){samo.claim_confirm_order();}},'script');}}).end().find('.date').datePicker();function check_fields(){var is_ok=true;samo.field.clear_errors($module_container);$module_container.find('.required').not('label').each(function(){if(!$(this).val().length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}});if(is_ok){$module_container.find('.date').each(function(){if(this.value.length&&!valid_date($.controlValue(this))){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
return is_ok;}
function valid_date(value){value=parseInt(value);if(value>20600000||value<19010000){return false;}
return value;}};samo.cancel_claim=function(claim){$('#agreement').bind('click',function(){var result={};result.CLAIM=claim;if($('#CANCEL_CLAIM_REASON_SELECT')){var reason_value=parseInt($('#CANCEL_CLAIM_REASON_SELECT').val());if(reason_value===0){$.notify({text:samo.i18n('NO_CHOOSE_CANCEL_REASON'),type:'error'})
return false;}
result.CANCEL_CLAIM_REASON_SELECT=reason_value;}
this.disabled=true;$.post(samo.ROUTES.cancel_claim.url+'samo_action=request',result,null,'script');});};$module_container.find('.controls select.CLAIM').chosen();var claim=$module_container.find('.cl_refer_result');if(claim.length){samo.claim_modules();}
samo.idleTimer=+new Date;samo.payment_wait=function(){setTimeout(function(){window.location.reload();},60000);};samo.payment_ok=function(){setTimeout(function(){window.location.reload();},60000);};samo.payment_error=function(){$module_container.find('.cl_refer_result').remove();};samo.payment_autostart=function(){$module_container.find('.pay_variants span.link:first').triggerHandler('click');var interval=setInterval(function(){var $popup=$('#modalContainer');if($popup.length>0){clearInterval(interval);$popup.find('.modalCloseImg').remove();$popup.find('[name=amount]').prop('readonly',true);}},300);};var _timeout=1380000,_claim=parseInt(($module_container.find('.cl_refer_result').attr('id')||'').replace('cl_',''));setInterval(function(){if((+new Date-samo.idleTimer)<_timeout){$.getScript(_ROOT_URL+$.param({samo_action:'keepalive',CLAIM:_claim}));}else{setTimeout(function(){window.location.href=window.location.href;},61000);}},_timeout);samo.short_description();$module_container.find('a.external').bind('click',samo.delayed_download);};$(document).ready(samo.cl_refer_person);})(samo.jQuery);