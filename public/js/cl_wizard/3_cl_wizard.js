
(function($){samo.cl_wizard=function(){var _ROOT_URL=samo.ROUTES.cl_wizard.url,$module_container=$('#cl_wizard'),_controls=$('input:text, #STATE, #TOWNFROM, #TOURINC',$module_container);samo.cache_controls($module_container);tour_parameter={};var empty_option=[{inc:0,title:"----",selected:true}];$module_container.find('input.date').datePicker();$('#TOWNFROM, #STATE, #TOURINC',$module_container).bind('change',function(){var name=this.name||$(this).attr('name');if(name=='TOWNFROM'){$('.STATE, .TOURINC',$module_container).find('option').remove();}
if(name=='STATE'){$('.TOURINC',$module_container).find('option').remove();}
$('#DATE_BEG').val('');$('#DATE_END').val('');$.getScript(getParams(name),false);});$('#NEXT').bind('click',function(){var params={};switch(step){case 1:if($('#DATE_BEG').val()===''){$.notify(samo.i18n('CL_W_NO_DATE_BEG'));return false;}
if($('#DATE_END').val()===''){$.notify(samo.i18n('CL_W_NO_DATE_END'));return false;}
if(parseInt($('#TOURINC').val())===0){$.notify(samo.i18n('CL_W_NO_TOUR'));return false;}
if($('tr','#ALL_TOURIST').length===0){$.notify(samo.i18n('CL_W_NO_TOURIST'));return false;}
$('#TOURIST_ERROR').html('').addClass('d_none');if($('#DATE_BEG').val()!=''){params.DATE_BEG=$('#DATE_BEG').val();}
if($('#DATE_END').val()!=''){params.DATE_END=$('#DATE_END').val();}
$.post(_ROOT_URL+$.param({samo_action:'STEP2'}),params,null,'script');break;case 2:$.post(_ROOT_URL+$.param({samo_action:'STEP3'}),params,null,'script');break;case 3:params.NOTE=$('#NOTECLAIM').val();$.post(_ROOT_URL+$.param({samo_action:'BRON'}),params,null,'script');break;default:return false;}
return true;});$('#BACK').bind('click',function(){var params={};switch(step){case 2:window.location.href=_ROOT_URL;break;case 3:window.location.href=_ROOT_URL+$.param({samo_action:'STEP2load'});break;case 4:window.location.href=_ROOT_URL+$.param({samo_action:'STEP3load'});break;default:return false;}
return true;});$('#NEWCLAIM').bind('click',function(){var result={};result.samo_action='NEW_CLAIM';$.getScript(_ROOT_URL+$.param(result),null,false);return true;});$('#ADD_TOURIST_BUTTON').bind('click',function(){_ed_tourist(0);});$('#ORDER_BTN_HOTEL, #ORDER_BTN_FREIGHT, #ORDER_BTN_SERVICE, #ORDER_BTN_INSURE, #ORDER_BTN_VISA').bind('click',function(){var type=$(this).data('otype');_ed_order(type,0);});$('#ORDER_BTN_LOAD').bind('click',function(){if(confirm(samo.i18n('CL_W_ASK_LOAD_ORDER'))){var result={};result.samo_action='LOAD_ORDER';$.getScript(_ROOT_URL+$.param(result),null,false);}});$('#ALL_TOURIST',$module_container).delegate('.a_ed_tourist','click',function(){var inc=$(this).parents('tr:first').data('tourist');_ed_tourist(inc);});$('#ALL_TOURIST',$module_container).delegate('.delete_tourist_botton','click',function(){if(confirm(samo.i18n('CL_W_ASK_DELETE_TOURIST'))){var inc=$(this).parents('tr:first').data('tourist');var result={};result.samo_action='DELETE_TOURIST';result.TOURIST_INC=inc;$.getScript(_ROOT_URL+$.param(result),delete_tourist_post,false);}});$('#ALL_ORDER',$module_container).delegate('.delete_order_botton','click',function(){if(confirm(samo.i18n('CL_W_ASK_DELETE_ORDER'))){var inc=$(this).parent().parent().data('order');var result={};result.samo_action='DELETE_ORDER';result.ORDER_INC=inc;result.DELETE_TOURIST_CONFIRM=0;$.getScript(_ROOT_URL+$.param(result),null,false);}});$('#ALL_ORDER',$module_container).delegate('.link','click',function(){var order_type=$(this).parent().parent().data('order-type');var order_inc=$(this).parent().parent().data('order');_ed_order(order_type,order_inc);});$('#DATE_BEG').bind('change.datepicker',function(e,d){if(ischange(this)){if(d){$(this).data('old',d.formated);var result={};result.samo_action='DATEBEG_CHANGE'
result.DATE_BEG=samo.dateAsString(d.date,'yyyymmdd');result.TOURINC=$('#TOURINC').val();$.getScript(_ROOT_URL+$.param(result),null,false);}}});function delete_tourist_post(){if(tourist_in_order===1&&confirm(samo.i18n('CL_W_CONFIRM_UNLINK_TOURIST'))){var result={};result.samo_action='DELETE_TOURIST';result.TOURIST_INC=tourist_inc;result.DELETE_TOURIST_CONFIRM=1;$.getScript(_ROOT_URL+$.param(result),null,false);}}
function _ed_order(type,inc){var tmp='';if(inc>0){tmp='&ORDER_INC='+inc;}
if(type==='S'&&inc===0){$.getScript(getParams('SERVTYPEFORM')+'&ORDER_TYPE='+type+tmp,edit_order,false);}else{$.getScript(getParams('ORDERFORM')+'&ORDER_TYPE='+type+tmp,edit_order,false);}
return true;}
function edit_order(){$('#SERVTYPE').delegate('.servtype','click',function(){var servtypeinc=$(this).data('servtype');samo.jQuery.modal.close();$.getScript(getParams('ORDERFORM')+'&ORDER_TYPE=S&servtype_inc='+servtypeinc,edit_order,false);});$edit_order_container=$('#edit_order');$edit_order_container.find('input.date').datePicker();$('#ORDER_COUNT').bind('change',function(){var order_type=$('#edit_order').data('order-type');if(order_type==='S'&&$('#ORDER_ADD_INFANT').is(':checked')){$('#ORDER_ADD_INFANT').prop('checked',false);}
var _old=parseInt($(this).data('old'));var _new=parseInt($(this).val());$(this).data('old',_new);Redraw_Opeople(_old,_new);});$('#ORDER_ADD_INFANT').click(function(){var order_type=$('#edit_order').data('order-type');if($(this).is(':checked')){if(order_type==='H'||order_type==='F'){$('.order_opeople',$edit_order_container).each(function(){var tmp=parseInt($(this).attr('size'));$(this).attr('size',tmp+1);$(this).append('<option value="-1">'+samo.i18n('CL_W_EMPTY')+'</option>');});}else if(order_type==='S'){tmp=parseInt($('#ORDER_COUNT').val())+1;$('#ORDER_COUNT').find('option[value='+tmp+']').prop('selected',true).parent().data('old',tmp);OneOrder();}}else{if(order_type==='H'||order_type==='F'){$('.order_opeople',$edit_order_container).each(function(){var tmp,tmp_k;var n=$(this).attr('id').substring(5);$('#ORDER'+n+' option:selected').prop('selected',false);tmp=$('#ORDER'+n+' option:textbegin("INF")');if($(tmp).length!==0){tmp=$('option:textbegin("INF"):last',$(this));}else{tmp=$('option:last',$(this));}
$(tmp).prop('selected',true);$('#FROM_RIGHT_TO_LEFT_BTN'+n).click();$(tmp).remove();tmp_k=parseInt($(this).attr('size'));$(this).attr('size',tmp_k-1);});}else if(order_type==='S'){tmp=parseInt($('#ORDER_COUNT').val())-1;$('#ORDER_COUNT').find('option[value='+tmp+']').prop('selected',true).parent().data('old',tmp);RemoveOrder(tmp);}}});var order_type=$('#edit_order').data('order-type');switch(order_type){case'H':case'I':case'V':$('#ORDER_DATEBEG').bind('change.datepicker',function(e,d){if(ischange(this)){$('#ORDER_DATEEND').data('old','');if(d.date){if(d.date>$('#ORDER_DATEEND').getDate()){$('#ORDER_DATEEND').val(d.formated);}
empty_rhm();}
var dbeg=$('#ORDER_DATEBEG').clearVal();if(dbeg!=''){$('#ORDER_DATEEND').datePicker({start:dbeg}).trigger('change.datepicker',{force:true});}}});break;}
switch(order_type){case'H':function Order_Hotel_DateEndChange(el,opts){if(ischange(el)||(opts&&opts.force)){empty_rhm();$.getScript(getParams('ORDER_HOTEL_TOWN')+'&'+getOrderParams(),EndLoadOpeople,false);}}
$('#ORDER_DATEEND').bind('change.datepicker',function(e,d){Order_Hotel_DateEndChange(this,d);}).bind('blur',function(){Order_Hotel_DateEndChange(this);});$('#ORDER_HOTELINC').bind('change',function(){empty_rhm();$.getScript(getParams('ORDER_HOTELINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_ROOMINC').bind('change',function(){$('#ORDER_HTPLACEINC').empty().addOptions(empty_option);$('#ORDER_MEALINC').empty().addOptions(empty_option);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_ROOMINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_HTPLACEINC').bind('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_HTPLACEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;case'F':function Order_Freight_DateEndChange(el,opts){if(ischange(el)||(opts&&opts.force)){$('#ORDER_TOWNFROM').empty().addOptions(empty_option);$('#ORDER_TOWNTO').empty().addOptions(empty_option);empty_rhm();$.getScript(getParams('ORDER_FREIGHT_DATE')+'&'+getOrderParams(),EndLoadOpeople,false);}}
$('#ORDER_DATEBEG').bind('change.datepicker',function(e,d){Order_Freight_DateEndChange(this,d);}).bind('blur',function(){Order_Freight_DateEndChange(this);});$('#ORDER_TOWNFROM').bind('change',function(){$('#ORDER_TOWNTO').empty().addOptions(empty_option);empty_rhm();$.getScript(getParams('ORDER_TOWNFROM')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_TOWNTO').bind('change',function(){empty_rhm();$.getScript(getParams('ORDER_TOWNTO')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_CLASSINC').bind('change',function(){$('#ORDER_FRPLACEINC').empty().addOptions(empty_option);$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_CLASSINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_FRPLACEINC').bind('change',function(){$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_FRPLACEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_FREIGHTINC').bind('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_FREIGHTINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;case'S':$('#ORDER_DATEBEG').bind('change.datepicker',function(e,d){if(ischange(this)){empty_rhm();$.getScript(getParams('ORDER_SERVICEDATES')+'&'+getOrderParams(),false);}});$('#ORDER_SERVICEINC').bind('change',function(){$('#ORDER_TOWNS_SERVICE').empty().addOptions([{inc:'0|0',title:"----",selected:true}]);$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_SERVICEINC')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_SERVICEINC').bind('load_opeople',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_SERVICEINC_LOAD_OPEOPLE')+'&'+getOrderParams(),EndLoadOpeople,false);});$('#ORDER_TOWNS_SERVICE').bind('change',function(){$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);$.getScript(getParams('ORDER_TOWNS_SERVICE')+'&'+getOrderParams(),null,false);});break;case'I':$('#ORDER_DATEEND').bind('change.datepicker',function(){if(ischange(this)){empty_rhm();$.getScript(getParams('ORDER_INSUREDATES')+'&'+getOrderParams(),EndLoadOpeople,false);}});$('#ORDER_INSUREINC').bind('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_INSUREINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;case'V':$('#ORDER_DATEEND').bind('change.datepicker',function(){if(ischange(this)){empty_rhm();$.getScript(getParams('ORDER_VISADATES')+'&'+getOrderParams(),EndLoadOpeople,false);}});$('#ORDER_VISAINC').bind('change',function(){ClearFIELDSET_OPEOPLE();$.getScript(getParams('ORDER_VISAINC')+'&'+getOrderParams(),EndLoadOpeople,false);});break;default:return false;}
$('.from_left_to_right').bind('click',from_left_to_right);$('.from_right_to_left').bind('click',from_right_to_left);$('.load',$edit_order_container).click(function(){var i,result={},text={},f_save=true,op=[],fq=true,tmp,tmp2;var order_type=$('#edit_order').data('order-type');if(order_type==='H'&&$('#ORDER_MEALINC').val()==='0'){$.notify(samo.i18n('CL_W_NO_CHHOSE_MEAL'));return false;}
for(i=0;i<parseInt($('#ORDER_COUNT').val());i++){tmp2=$('#ORDER'+i+' option').filter(function(){return $(this).val()<0;}).length;if(tmp2==$('#ORDER'+i+' option').length){$.notify(samo.i18n('CL_W_PART_EMPTY_ORDER2'));return false;}
if(tmp2>0){if(fq){if(!confirm(samo.i18n('CL_W_PART_EMPTY_ORDER'))){f_save=false;return false;}else{fq=false;}}}
if(!f_save){return true;}
tmp=[];$('#ORDER'+i+':first option').each(function(){tmp.push(this.value);});op.push(tmp.join(','));}
var opeople=op.join('|');result.ORDER_OPEOPLE=opeople;var order_controls=$('select, input',$edit_order_container);$(order_controls,$edit_order_container).each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this);var tmp=$('option:selected',this).text();if(name&&value&&value!==0){result[name]=value;text[name]=tmp;}});result.ORDER_ADD_INFANT=($('#ORDER_ADD_INFANT').is(':checked'))?1:0;result.ORDER_TYPE=order_type;switch(order_type){case'H':result.townname=$('#ORDER_HOTELINC option:selected').data('townname');result.hotelname=text.ORDER_HOTELINC;result.roomname=text.ORDER_ROOMINC;result.htplacename=text.ORDER_HTPLACEINC;result.mealname=text.ORDER_MEALINC;var tmp=$('#ORDER_TOWN option:selected');result.state_inc=$(tmp).data('state');break;case'F':if(!result.ORDER_FREIGHTINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_FREIGHT'));return false;}
result.class_name=text.ORDER_CLASSINC;result.frplace_name=text.ORDER_FRPLACEINC;var $tmp=$('#ORDER_FREIGHTINC option:selected');result.source_name=text.ORDER_TOWNFROM;result.days=$tmp.data('days')?parseInt($tmp.data('days')):0;var datebeg=samo.dateFromString(result.ORDER_DATEBEG,'yyyymmdd');var dateend=new Date();dateend.setTime(datebeg.getTime());dateend.setDate(datebeg.getDate()+result.days);result.ORDER_DATEEND=samo.dateAsString(dateend,'yyyymmdd');result.srcport=$tmp.data('srcport');result.src_time=$tmp.data('src_time');result.target_name=text.ORDER_TOWNTO;result.trg_port=$tmp.data('trg_port');result.trg_time=$tmp.data('trg_time');result.freight_name=$tmp.data('freight_name');result.tpartner_name=$tmp.data('tpartner_name');break;case'S':if(!result.ORDER_SERVICEINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE'));return false;}
if(result.ORDER_TOWNS_SERVICE=='0|0'){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE_TOWNS'));return false;}
if(!result.ORDER_HOTEL_SERVICE){$.notify(samo.i18n('CL_W_NO_CHHOSE_SERVICE_HOTEL'));return false;}
result.ORDER_DATEEND=result.ORDER_DATEBEG;var $tmp=$('#ORDER_SERVICEINC option:selected');result.servtype_inc=$tmp.data('servtype');result.servtype_name=$tmp.data('servtype-name');result.service_name=$tmp.data('service-name');result.trantype_name=$tmp.data('trantype-name');result.servcategory_inc=$tmp.data('servcategory');result.routeindex=$tmp.data('routeindex');$tmp=$('#ORDER_TOWNS_SERVICE option:selected');result.source_name=$tmp.data('source-name');result.target_name=$tmp.data('target-name');$tmp=$('#ORDER_HOTEL_SERVICE option:selected');result.service_hotel_name=$tmp.data('hotel-name');result.service_roominc=$tmp.data('roominc');result.service_mealinc=$tmp.data('mealinc');break;case'I':if(!result.ORDER_INSUREINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_INSURE'));return false;}
var $tmp=$('#ORDER_INSUREINC option:selected');result.partner_name=$tmp.data('partner-name');result.insure_name=$tmp.data('insure-name');result.state_name=$tmp.data('state-name');result.state_inc=$tmp.data('state');break;case'V':if(!result.ORDER_VISAINC){$.notify(samo.i18n('CL_W_NO_CHHOSE_VISA'));return false;}
var $tmp=$('#ORDER_VISAINC option:selected');result.visa_name=$tmp.data('visa-name');result.days=$tmp.data('days');result.state_name=$tmp.data('state-name');break;default:return false;}
var $order=$('#edit_order');result.ORDER_INC=$order.data('order');result.pcount=$order.data('pcount');result.adult=$order.data('pcount-adult');result.child=$order.data('pcount-child');result.infant=$order.data('pcount-infant');$.post(_ROOT_URL+$.param({samo_action:'SAVE_ORDER'}),result,null,'script');samo.jQuery.modal.close();return true;});var el='';var trigger_name='change';switch(order_type){case'H':el='ORDER_HTPLACEINC';break;case'F':el='ORDER_FREIGHTINC';break;case'S':el='ORDER_SERVICEINC';var trigger_name='load_opeople';break;case'I':el='ORDER_INSUREINC';break;case'V':el='ORDER_VISAINC';break;}
if($('#'+el+' option').length==2&&$('#FIELDSET_OPEOPLE').css('display')=='none'){$('#'+el).triggerHandler(trigger_name);}
return true;}
function EndLoadOpeople(){AutoSetOpeople();}
function AutoSetOpeople(){var order_type=$('#edit_order').data('order-type');if(order_type=='H'){OneOrder(0);}
if($('#ORDER_ALL_TOURIST option').length>0){switch(order_type){case'H':Rasselenie(0);break;case'F':case'S':case'I':case'V':FSIV_AutoSetOpeople();break;default:return false;}}
return true;}
function FSIV_AutoSetOpeople(){var i;var pcount=($('#ORDER_ALL_TOURIST option').length)?$('#ORDER_ALL_TOURIST option').length:1;$('#ORDER_COUNT').find('option[value='+pcount+']').prop('selected',true).parent().data('old',pcount);i=0;for(i=0;i<pcount;i++){OneOrder(i);Rasselenie(i);}}
function OneOrder(n){var tmp=[],i,$order=$('#edit_order');var order_type=$order.data('order-type');var people_count_in_one_order=$order.data('pcount');if((order_type==='H'||order_type==='F')&&$('#ORDER_ADD_INFANT').is(':checked')){people_count_in_one_order++;}
var tmp_i=$('#OPEOPLE .div_order').length;for(i=0;i<people_count_in_one_order;i++){tmp.push({inc:-i-1,title:samo.i18n('CL_W_EMPTY')});}
$('#OPEOPLE').append('<div class="div_order" id="DIV_ORDER'+tmp_i+'"><div class="opeople_btn"><input type="button" id="FROM_LEFT_TO_RIGHT_BTN'+tmp_i+'" class="from_left_to_right" value=">>" data-to="'+tmp_i+'"><br><input type="button" id="FROM_RIGHT_TO_LEFT_BTN'+tmp_i+'" class="from_right_to_left" value="<<" data-from="'+tmp_i+'"></div><div class="order"><select size="'+people_count_in_one_order+'" id="ORDER'+tmp_i+'" class="order_opeople" multiple=""></select></div></div><div class="eraser"/>');$('#ORDER'+tmp_i).addOptions(tmp);$('.from_left_to_right').bind('click',from_left_to_right);$('.from_right_to_left').bind('click',from_right_to_left);}
function movePeopleToOrder(to){if($('#ORDER_ALL_TOURIST option').length===0)return'';var order_type=$('#edit_order').data('order-type');var tmp,f_add_inf=0,mrmrs_cnt=0,chd_cnt=0;inf_cnt=0;if($('#ORDER_ALL_TOURIST option:selected').length===0){tmp=$('#ORDER_ALL_TOURIST option:first');}else{tmp=$('#ORDER_ALL_TOURIST option:selected').eq(0);}
var kogo_text=tmp.text();var kogo_val=parseInt(tmp.val());var to='ORDER'+to;var $tmp_t=$('#'+to+' option').filter(function(){return $(this).val()<0;});if($tmp_t.length===0){return samo.i18n('CL_W_FULL_ORDER');}
if(order_type==='H'||order_type==='F'){var $order=$('#edit_order');var place_peoplecount_adult=$order.data('pcount-adult');var place_peoplecount_child=$order.data('pcount-child');var place_peoplecount_infant=$order.data('pcount-infant');if($('#ORDER_ADD_INFANT').is(':checked')==true){place_peoplecount_infant++;}
$('#'+to+' option').each(function(){var mrmrs=$(this).text().substring(0,3);if(mrmrs==='MR '||mrmrs==='MRS'){mrmrs_cnt++;}else if(mrmrs==='CHD'){if(chd_cnt<place_peoplecount_child){chd_cnt++;}else{mrmrs_cnt++;}}else if(mrmrs==='INF'){if(inf_cnt<place_peoplecount_infant){inf_cnt++;}else if(chd_cnt<place_peoplecount_child){chd_cnt++;}else{inf_cnt++;}}});var kogo=kogo_text.substring(0,3);if((kogo=='MR '||kogo=='MRS')&&(mrmrs_cnt>=place_peoplecount_adult)){return samo.i18n('CL_W_FULL_ADULT_ORDER');}else if(kogo=='CHD'&&(mrmrs_cnt>=place_peoplecount_adult)&&(chd_cnt>=place_peoplecount_child)){return samo.i18n('CL_W_FULL_CHILD_ORDER');}else if(kogo=='INF'&&(mrmrs_cnt>=place_peoplecount_adult)&&(chd_cnt>=place_peoplecount_child)&&(inf_cnt>=place_peoplecount_infant)){return samo.i18n('CL_W_FULL_INFANT_ORDER');}}
var opt=$tmp_t.get(0);opt.text=kogo_text;opt.value=kogo_val;tmp.remove();return'';}
function from_left_to_right(){var tmp;var nto=$(this).data('to');var result=movePeopleToOrder(nto);if(result!==''){$.notify(result);}
return true;}
function from_right_to_left(){var nfrom=$(this).data('from');var from='ORDER'+nfrom;if($('#'+from+' option').length===0)return true;var tmp_i=0,f=false,tmp;tmp_i=$('#'+from+' option:selected').length;if(tmp_i>0){tmp=$('#'+from+' option:selected').get(0);if($(tmp).val()<0){return true;}}else{tmp=$('#'+from+' option').filter(function(){return $(this).val()>0;});if(tmp.length===0)return true;tmp=$(tmp).get(0);}
var kogo_text=tmp.text;var kogo_val=tmp.value;tmp.text=samo.i18n('CL_W_EMPTY');tmp.value=-1;$('#ORDER_ALL_TOURIST').append('<option value="'+kogo_val+'">'+kogo_text+'</option>');return true;}
function Rasselenie(n){$('#ORDER_ALL_TOURIST option:textbegin("MR")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});$('#ORDER_ALL_TOURIST option:textbegin("CHD")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});$('#ORDER_ALL_TOURIST option:textbegin("INF")').each(function(){$(this).prop('selected',true);var result=movePeopleToOrder(n);});return true;}
function Redraw_Opeople(_old,_new){var i;if(_new>_old){for(i=_old+1;i<=_new;i++){OneOrder(i-1);Rasselenie(i-1);}}else{for(i=_old;i>_new;i--){RemoveOrder(i-1);}}}
function RemoveOrder(n){var tmp_k=$('#ORDER'+n+' option').length;for(var i=0;i<tmp_k;i++){$('#FROM_RIGHT_TO_LEFT_BTN'+n).click();}
$('#DIV_ORDER'+n).remove();}
function ClearFIELDSET_OPEOPLE(){$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);$('#FIELDSET_OPEOPLE').css('display','none');$('#ORDER_ALL_TOURIST').empty();$('#OPEOPLE').empty();}
function empty_rhm(){var order_type=$('#edit_order').data('order-type');$('#ORDER_COUNT').find('option[value=1]').prop('selected',true).parent().data('old',1);ClearFIELDSET_OPEOPLE();switch(order_type){case'H':$('#ORDER_ROOMINC').empty().addOptions(empty_option);$('#ORDER_HTPLACEINC').empty().addOptions(empty_option);$('#ORDER_MEALINC').empty().addOptions(empty_option);break;case'F':$('#ORDER_CLASSINC').empty().addOptions(empty_option);$('#ORDER_FRPLACEINC').empty().addOptions(empty_option);$('#ORDER_FREIGHTINC').empty().addOptions(empty_option);break;case'S':$('#ORDER_SERVICEINC').empty().addOptions(empty_option);$('#ORDER_TOWNS_SERVICE').empty().addOptions([{inc:'0|0',title:"----",selected:true}]);$('#ORDER_HOTEL_SERVICE').empty().addOptions(empty_option);break;case'I':$('#ORDER_INSUREINC').empty().addOptions(empty_option);break;case'V':$('#ORDER_VISAINC').empty().addOptions(empty_option);break;default:return false;}
return true;}
function getOrderParams(){var useGET=arguments[1]||false;var result={};$('#edit_order').find('select, input').each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});var $order=$('#edit_order');result['ORDER_INC']=$order.data('order');var order_type=$order.data('order-type');result['ORDER_TYPE']=order_type;if(order_type=='S'){result['servtype_inc']=$order.data('servtype');}
return $.param(result);}
function _ed_tourist(inc){var tmp='';if(Number(inc)!=0){tmp='&TOURIST_INC='+inc;}
$.getScript(getParams('TOURIST_FORM')+tmp,edit_tourist,false);}
function edit_tourist(){var $edit_tourist_container=$('#edit_tourist');samo.tourist_helpers($edit_tourist_container);samo.helpalt_field($edit_tourist_container);var $load=$edit_tourist_container.find('.load');$load.bind('click',function(){$.each(['FIRST','LAST'],function(idx,prefix){$.each(['LNAME','NAME'],function(_idx,suffix){var $el=$edit_tourist_container.find('[name*="['+prefix+suffix+']"]');if($el.length&&!$el.val().length){var tourist=Math.abs($('#edit_tourist').data('tourist'));$el.val((prefix=='LAST')?((suffix=='LNAME')?samo.i18n('CL_W_NO_FIRST_LNAME'):samo.i18n('CL_W_NO_FIRST_NAME')):(((suffix=='LNAME')?samo.i18n('CL_W_NO_LAST_LNAME'):samo.i18n('CL_W_NO_LAST_NAME'))+'~'+tourist));}});});var val=$('#edit_tourist').find('[name*="[PSERIE]"]').val();$('#edit_tourist').find('[name*="[PSERIE]"]').val(val.toUpperCase());val=$('#edit_tourist').find('[name*="[PNUMBER]"]').val();$('#edit_tourist').find('[name*="[PNUMBER]"]').val(val.toUpperCase());var $params=$('#edit_tourist_form').serialize();$.post(_ROOT_URL+$.param({samo_action:'SAVE_TOURIST'}),$params,null,'script');samo.jQuery.modal.close();return true;});if(typeof window.external!="undefined"&&"staSelectPeople"in window.external){var $sta_people=$('<button class="sta_people">'+samo.i18n('CL_W_STA_PEOPLE')+'</button>').css('margin-right','10px');$sta_people.bind('click',function(){try{var result=window.external.staSelectPeople();if(result instanceof Object){var lastname=result.lname.split(' ');$edit_tourist_container.find('[name*="[HUMAN]"]').val(result.age=='ADL'?(result.sex=='MALE'?'MR':'MRS'):result.age);$edit_tourist_container.find('[name*="[MALE]"][value='+(result.sex=='MALE'?1:0)+']').prop('checked',true);$edit_tourist_container.find('[name*="[LASTLNAME]"]').val(lastname[0]);if(lastname.length>1){$edit_tourist_container.find('[name*="[FIRSTLNAME]"]').val(lastname[1]);}
$edit_tourist_container.find('[name*="[BORN]"]').val(result.born?samo.dateFromString(result.born,'yyyy-mm-dd'):'');$edit_tourist_container.find('[name*="[PLACEBORN]"]').find('option[html="'+result.bornplace+'"]').prop('selected',true);$edit_tourist_container.find('[name*="[PSERIE]"]').val(result.pserie);$edit_tourist_container.find('[name*="[PNUMBER]"]').val(result.pnumber);$edit_tourist_container.find('[name*="[PVALID]"]').val(result.pexpire?Date.fromString(result.pexpire,'yyyy-mm-dd').asString():'');$edit_tourist_container.find('[name*="[PGIVEN]"]').val(result.pgiven?Date.fromString(result.pgiven,'yyyy-mm-dd').asString():'');$edit_tourist_container.find('[name*="[PGIVENORG]"]').val(result.pgivenorg);$edit_tourist_container.find('[name*="[NATIONALITY]"]').find('option[html="'+result.nationality+'"]').prop('selected',true);$load.click();}}catch(e){}})
$load.before($sta_people);}}
function valid_date(value,field){var tmp=value;$(field).removeClass('error');value=parseInt(value);if(value>20600000||value<19010000){samo.field.error(samo.i18n('INCORRECT_DATE'),field)
return false;}
return true;}
function getParams(action){var useGET=arguments[1]||false;var result={};result.samo_action=action;_controls.each(function(){var name=this.name||$(this).attr('name');var value=$.controlValue(this,useGET);if(name&&value&&value!==0){result[name]=value;}});return _ROOT_URL+$.param(result);}
function ischange(el){if($(el).val()!=$(el).data('old')){$(el).data('old',$(el).val());return true;}
return false;}}
$.expr[':'].textbegin=function(obj,index,meta,stack){return(obj.textContent||obj.innerText||jQuery(obj).text()||'').indexOf(meta[3])==0;};$(document).ready(samo.cl_wizard);})(samo.jQuery);