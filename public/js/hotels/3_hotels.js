
(function($){var _ROOT_URL=null;var container=samo.initModuleContainer('hotels');samo.hotels=function(){_ROOT_URL=samo.ROUTES.hotels.url;var $module_container=container,HOTELINC=$.getParameter('HOTELINC',true,$module_container);var controls=samo.cache_controls($module_container);controls.resultset=$module_container.find('.resultset')[0];controls.PARAMS=$module_container.find('.PARAMS')[0];controls.VIPTYPE=$module_container.find('.PARAMS--viptype')[0];samo.openedBlock=[];$('.STATEINC,.REGIONINC,.TOWNTO',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}})}).chosen({});var getParams=function(action){var params={samo_action:action};$.each(controls,function(i,v){if(!/_ANY$/.test(i)&&i!='resultset'){if(!$(v).parents('.form').length){return true;}
var type=v.tagName.toLowerCase();if(/^PARAMS-/.test(i)){i='PARAMS';}
if(type=='select'||type=='input'){if(!(/_ANY$/.test(i))&&i!=''){params[i]=$(v).val();}}else{var param=params[i]===undefined?[]:params[i].split(',');$(v).find('span.active').each(function(){param.push($('input',this).val());});if(param.length>0){params[i]=param.join(',');}}}});return samo.getParams(params,$module_container);}
var initPager=function(params){$(controls.resultset).find('span.page').click(function(){params.PAGE=$(this).data('page');$.getScript(_ROOT_URL+$.param(params),function(){initPager(params);},true);})}
$module_container.find('.load').bind('click',function(){var params=getParams('SEARCH');$.getScript(_ROOT_URL+$.param(params),function(){initPager(params);},true);});if($('#hotels.details .load_price').length){samo.hotels.priceRefresh=function(){var params={samo_action:'PRICE'};params.TOWNFROMINC=$.controlValue($('.TOWNFROMINC',$module_container).get(0));params.CURRENCY=$.controlValue($('.CURRENCY',$module_container).get(0));params.CHECKIN_BEG=params.CHECKIN_END=$.controlValue($('.CHECKIN',$module_container).get(0));params.NIGHTS_FROM=$.controlValue($('.NIGHTS_FROM',$module_container).get(0));params.NIGHTS_TILL=$.controlValue($('.NIGHTS_TILL',$module_container).get(0));params.HOTELINC=$.getParameter('HOTELINC',true,$module_container);$module_container.find('.hotel_descr .resultset').html('<div style="text-align: center; margin-bottom: 10px;"><img src="'+samo.ROUTES.WWWROOT+'public/pict/preloader.gif" /></div>');$.getScript(_ROOT_URL+$.param(samo.getParams(params,$module_container)),initPriceResultset,true,true);}
samo.hotels.reDatePicker=function(control,valids,start,value){$('input.date.'+control,$module_container).data('prev',value).datePicker({start:start,valid:valids.toString(),value:value});}
$module_container.find('input.date').each(function(i,v){$(v).data('prev',$(v).val()).datePicker().bind('change.datepicker',function(e,d){if(d&&$(this).data('prev')!=$(this).clearVal()){$(this).data('prev',$(this).val());samo.hotels.priceRefresh();}});});samo.price_helpers($module_container);$('#hotels.details .load_price').find('select, input').bind('change',samo.hotels.priceRefresh);function initPriceResultset(){samo.price_clickable($module_container);$.each($('table.res tr th'),function(i,v){$(v).width($(v).width());});}
samo.hotels.priceRefresh();}
$(controls.STATEINC).bind('change',function(){$.getScript(_ROOT_URL+$.param(samo.getParams(getParams(this.name),$module_container)),true);});$(controls.REGIONINC).bind('change',function(){if($(this).hasClass('location')){window.location=_ROOT_URL+'samo_action=region&REGIONINC='+$(this).val();}else{$.getScript(_ROOT_URL+$.param(samo.getParams(getParams(this.name),$module_container)),true);}
return false;});$(controls.TOWNTO).bind('change',function(){if($(this).hasClass('location')){window.location=_ROOT_URL+'samo_action=town&TOWNTO='+$(this).val();}else{if(samo.hotels.doLoad!==undefined){samo.hotels.doLoad();}}
return false;});$(controls.HOTELNAME).bind('change',function(){if(samo.hotels.doLoad!==undefined){samo.hotels.doLoad();}
return false;});samo.hotels.getWindowSize=function(){var windowWidth,windowHeight;if(self.innerHeight){windowWidth=self.innerWidth;windowHeight=self.innerHeight;}else if(document.documentElement&&document.documentElement.clientHeight){windowWidth=document.documentElement.clientWidth;windowHeight=document.documentElement.clientHeight;}else if(document.body){windowWidth=document.body.clientWidth;windowHeight=document.body.clientHeight;}
return[windowWidth,windowHeight];}
var $photos=$("#hotels .photos");if($photos.length){$photos.find("a.thumbnail").fancybox();}
$("#hotels").find(".textinput input").bind('focus',function(){$(this).parents('.textinput:first').find('.label').hide();}).bind('blur',function(){if(!/[^\n\r\s\t]/.test($(this).val())){$(this).parents('.textinput:first').find('.label').show();}}).focus().blur().end().find('.textinput .label').bind('click',function(){$(this).parents('.textinput:first').find('input').focus();});$(controls.resultset).delegate('#hotels input[type=checkbox].tour','change',function(){$('#hotels input[type=checkbox].tour').each(function(i,v){$(v).parent().css('opacity','');})
if($('#hotels input[type=checkbox].tour:checked').length){$('#hotels input[type=checkbox].tour:not(:checked)').each(function(i,v){$(v).parent().css('opacity','0.3');});}}).delegate('span.link','click',function(){var $this=$(this),$data=$this.parents('tr:first').data();var HOTELINC=$data.hotel;if($this.is('.hotel')){var www=$data.www;if(/^[a-z]{3,5}:\/\//.test(www)){if(/^samo:\/\//.test(www)){www=_ROOT_URL+'samo_action=hotel&HOTELINC='+HOTELINC;}}else{www='http://'+www;}
window.open(www);}else if($this.is('.tour')){var hotel=[];if($this.parent().find('input:checked').length){$.each($('#hotels input[type=checkbox].tour:checked'),function(i,v){hotel.push($(v).val());});}else{$('#hotels input[type=checkbox].tour').prop('checked',false);hotel.push($(this).parent().find('input').prop('checked',true).change().val());}
window.open(samo.ROUTES.search_tour.url+'STATEINC='+$data.state+'&HOTELS='+hotel.join(',')+'&DOLOAD=1');}else{if($this.is('.state')){var STATEINC=$data.state;window.open(_ROOT_URL+'samo_action=state&STATEINC='+STATEINC);}else{if($this.is('.region')){var REGIONINC=$data.region;window.open(_ROOT_URL+'samo_action=region&REGIONINC='+REGIONINC);}else{if($this.is('.town')){var TOWNINC=$data.town;window.open(_ROOT_URL+'samo_action=town&TOWNTO='+TOWNINC);}else{$.getScript(_ROOT_URL+'samo_action=param&HOTELINC='+HOTELINC+'&PARAMINC='+$(this).data('param'),true);}}}}});samo.hotels.pageX=samo.hotels.pageY=null;samo.delegateHotelPopup(controls.resultset,'span.link.hotel');samo.hotels.changeAny=function(obj,v){$(obj).val(v);if(v){$(obj).parent().hide();}else{$(obj).parent().show();}};if($('#hotels .form .block').length){samo.hotels.doLoad=function(){var stamp=loadStamp=(new Date().getTime())+'-'+parseInt(Math.random()*10000);setTimeout(function(){if(stamp==loadStamp){$('.load',$module_container).click()}},1000);return false;}
samo.hotels.prepareBlocks=function(){$.each($('#hotels .block'),function(i,v){var $v=$(v);if(!$v.hasClass('opened')){if($v.find('input[type=checkbox]:not([class$=_ANY]):checked').length){$v.addClass('opened')}else{$v.find('.container').hide();}}
var text=$v.find('.title span').html();if($v.hasClass('opened')&&text!=null){var add=true;$.each(samo.openedBlock,function(ii,vv){if(vv==text){add=false;}});if(add){samo.openedBlock.push(text);}}else{$.each(samo.openedBlock,function(ii,vv){if(vv==text){$v.addClass('opened');$v.find('.container').show();}});}
$v.find('.container .checklistbox input[type=checkbox]').each(function(ii,vv){$('<span class="'+($(vv).is(':checked')?' active':'')+'" />').insertBefore(vv).append($('<input type="hidden">').val($(vv).val()));$(vv).remove();});if(!$v.find('.container').hasClass('no_more')){var count=8;var arr=$v.find('.container .checklistbox label');if(arr.length>count){if(!$v.find('.container .checklistbox .container_more').length){if(!$v.find('.container a.more').length){$v.find('.container .checklistbox').after($('#hotels .form div.more.link').html());}
$v.find('.container .checklistbox').append('<div class="container_more"><div class="checklistbox"></div></div>');var chacked=undefined;$.each(arr,function(ii,vv){if($('span.active',vv).length){if(chacked==undefined){$(v).find('.container .checklistbox:first').prepend($(vv));}else{$(chacked).after($(vv));}
chacked=$(vv);}});var n=0;arr=$v.find('.container .checklistbox label');$.each(arr,function(ii,vv){if(++n==count){$(vv).addClass('last');}else if(n>count){$v.find('.container .container_more .checklistbox').append($(vv));}});}}}});var loadStamp=null;$module_container.find('.block .any:not(.prepared)').bind('click',function(){var obj=$(this).find('input').get(0);if($(obj).val()){$(this).parents('.block').find('label span').removeClass('active');samo.hotels.changeAny(obj,true);}else{if(0==$(this).parents('.block').find('span.active').length){samo.hotels.changeAny(obj,true);}}
$.each($(this).parents('.block:first').find('div[class^=container]'),function(i,v){$(v).find('label:first').addClass('no-click').click();});return false;}).addClass('prepared');$module_container.find('.checklistbox:not(.prepared)').each(function(i,v){var $v=$(v);$v.addClass('prepared');var name=$v.attr('name');var obj=$v.parents('.container:first').find('.any input').get(0);$module_container.find('.checklistbox.'+name).delegate('label','click',function(){var $more=$(this).parents('.'+name+':first').find('.container_more'),$this=$(this);if(!$this.hasClass('no-click')){var $span=$(this).find('span');if($span.hasClass('active')){$span.removeClass('active');}else{$span.addClass('active');}}else{$this.removeClass('no-click');}
if($more.length){var $a_more=$(this).parents('.container:first').find('a.more');var length=$more.find('span.active').length;if(length){$a_data=$a_more.data();$a_more.html($a_data.empty+$a_data.selected.replace('%d',length))}else{$a_more.html($a_more.data('empty'));}}
samo.hotels.changeAny(obj,$this.parents('.container:first').find('span.active').length==0);if(loadStamp){samo.hotels.doLoad();}
return false;})
if($.browser.msie){$module_container.find('.checklistbox.'+name).delegate('label','mouseenter',function(){$(this).addClass('hover');}).delegate('label','mouseleave',function(){$(this).removeClass('hover');});}
$module_container.find('.checklistbox.'+name).find('label:first').addClass('no-click').click();});loadStamp=(new Date().getTime())+'-'+parseInt(Math.random()*10000);}
samo.hotels.prepareBlocks()
$('#hotels .form').delegate('.container a.close','click',function(){$(this).parents('.container_more').hide();});$('#hotels .form').delegate('a.more','click',function(){var obj=$(this).parents('.block').find('.container_more');if($(obj).is(':visible')){$(obj).hide();}else{var _obj=$(this).parents('.block').find('.container');$(obj).width($(_obj).width()).height($(obj).height()).css({position:'absolute',marginLeft:$(_obj).width()+5+'px',marginTop:parseInt(-$(_obj).height()/2)+'px'}).show();}
return false;});$('#hotels .block:not(.opened) .container').hide();$('#hotels').delegate('.block .title','click',function(){var $obj=$(this).parents('.block:first');var text=$(this).find('span').html();if($obj.hasClass('opened')){$obj.removeClass('opened').find('.container').hide().end().find('.any input').prop('checked',true).click();$.each(samo.openedBlock,function(i,v){if(v==text){samo.openedBlock.splice(i,1);}});}else{$obj.addClass('opened');samo.openedBlock.push(text);$obj.find('.container').show();}
return false;});$(document).mouseup(function(e){var container=$('#hotels .form .container_more');if(container.has(e.target).length===0){container.hide();}});}
$(controls.resultset).delegate('.show-detail','click',function(){var $this=$(this);if($this.hasClass('ui-icon-triangle-1-s')){$this.parents('table:first').find('.ui-icon-triangle-1-n').click().end().end().removeClass('ui-icon-triangle-1-s').addClass('ui-icon-triangle-1-n').parent().width($this.parent().width()).find('.briefly').hide().end().parent().find('.details').show();}else{$this.addClass('ui-icon-triangle-1-s').removeClass('ui-icon-triangle-1-n').parent().find('.briefly').show().end().parent().find('.details').hide();}
return false;});if($(controls.resultset).find('span.page').length){initPager(getParams('SEARCH'));}
if($module_container.find('.resultset.scrolling').length){var scrollStamp=null,$resultset=$(controls.resultset);var resulset_offset=$resultset.offset();var offsetResultset=resulset_offset.top;$(window).scroll(function(){var timeout=scrollStamp==null?0:500;var stamp=scrollStamp=(new Date().getTime())+'-'+parseInt(Math.random()*10000);setTimeout(function(){if(stamp==scrollStamp){var top=$resultset.offset().top;var scrollTop=$(document).scrollTop();var windowSize=samo.hotels.getWindowSize();var heightResultset=$resultset.parent().height();var resultsetHeight=$resultset.height();if(!(top<scrollTop&&top+resultsetHeight>scrollTop+windowSize[1])){var margin=0;if(top+resultsetHeight<scrollTop+windowSize[1]&&resultsetHeight>windowSize[1]){margin=scrollTop+windowSize[1]-resultsetHeight-offsetResultset;}else{margin=scrollTop-offsetResultset;}
var height=$resultset.outerHeight();if(heightResultset<margin+height){margin=heightResultset-height;}
if(margin<0){margin=0;}
$resultset.animate({marginTop:margin},timeout*2);}}},timeout);});$(window).scroll();}
samo.blink_element();$('.map_container').samoMap();};$(document).bind('ready',samo.hotels);})(samo.jQuery);