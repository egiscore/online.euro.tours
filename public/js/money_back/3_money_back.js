
(function($){samo.money_back=function(){var dom=samo.dom({module:'money_back',elements:{resultForm:'#result',prepareButton:'button.prepare-document',currencySelect:'select.cur',claimFromField:'.claimFrom',summField:'.summ',nameField:'.name',accountField:'.account',bikField:'.bik',paymentsTableLayout:'.paymentsList',paymentsTable:'#paymentsList tbody',rowTpl:"#rowTpl",uploadTpl:"#uploadTpl"}});dom.init();var node=dom.node,rootUrl=samo.ROUTES.WWWROOT,moduleUrl=samo.ROUTES.money_back.url,apiUrl=rootUrl+'services/api/documents/',delay=1000,progress=10,initData,STATUS_NOT_UPLOAD='MB_NOT_UPLOAD',STATUS_WAIT='MB_WAIT',STATUS_SUCCES='MB_SUCESS',STATUS_ABORT='MB_ABORT',currencies={},rowTemplate=node.rowTpl.html(),uploadTemplate=node.uploadTpl.html();construct();function construct(){node.prepareButton.disable();$.ajax({url:apiUrl+'data',type:'GET',cache:true,success:function(result){if(!checkAuth(result)){return false;}
initData=result;currencies=setCurrencies(result.currencies);node.accountField.val(result.partner.account);node.bikField.val(result.partner.bik);node.prepareButton.enable();setPayments(result.payments);bindEvents();samo.helpalt_field(node.paymentsTable,'hover');},error:function(){$.notify({text:samo.i18n('PARSE_ERROR'),type:'error'});}});}
function bindEvents(){node.prepareButton.on('click',function(){sendForm();});node.container.delegate('.downloadBlank','click',function(e){e.preventDefault();var paymentInc=$(this).data('paymentInc'),key='downloadBlank-'+paymentInc,link;dom.add($(this),key);if(link=node[key]){link.hide();$.ajaxGet(apiUrl+'job_inc?'+$.param({paymentInc:paymentInc}),function(result){if(!checkAuth(result)){return false;}
var response=result.responseJSON;checkJobStatus(response.job.inc,link.parent(),false,false,samo.i18n('MB_DOWNLOAD'),true);});}});node.container.delegate('.uploadLink','click',function(e){node.container.find('.uploadRow').remove();e.preventDefault();var paymentInc=$(this).data('paymentInc'),key='upload-'+paymentInc,link,data={claim:$(this).data('claimFrom'),paymentInc:paymentInc,docType:$(this).data('doctype')};dom.add($(this),key);if(link=node[key]){var row=createUploadForm(link.parent().parent(),key,data);var sendButton=row.find('button.sendFile');dom.add(sendButton,'sendButton');node.sendButton.disable();}});node.container.delegate('.cancelSend','click',function(){node.container.find('.uploadRow').remove();});node.container.delegate('.sendFile','click',function(event){event.stopPropagation();event.preventDefault();node.sendButton.disable();if(!(file=node.iFile[0].files)){return;}
var claim=$(this).data('claim'),el=$(this);$.ajax({url:apiUrl+'upload_file',type:'POST',data:getPostData(file,el),cache:false,dataType:'json',processData:false,contentType:false,success:function(result){if(typeof result.error==='undefined'){updateRowAfterUpload(result,claim,el);}
else{$.notify({text:samo.i18n('MB_UPLOAD_ERROR'),type:'error'});}
node.sendButton.enable();},error:function(jqXHR){if(!checkAuth(jqXHR)){return false;}
node.sendButton.enable();$.notify({text:samo.i18n('MB_UPLOAD_ERROR'),type:'error'});}});});node.container.delegate('.iFile','change',function(){if(this.files&&this.files.length){var name=this.files[0].name.split('.'),ext=name[name.length-1].toLowerCase(),suppotedTypes=initData.eDocTypes.upload_format.split(', '),size=this.files[0].size/1024,error=false;if($.inArray(ext,suppotedTypes)<0){error=samo.i18n('MB_UPLOAD_FORMAT_ERROR')+initData.eDocTypes.upload_format;$.notify({text:error,type:'error'});}else if(size>initData.eDocTypes.upload_size){error=samo.i18n('MB_UPLOAD_SIZE_ERROR')+initData.eDocTypes.upload_size+' kB';$.notify({text:error,type:'error'});}else{dom.add($(this),'iFile');node.sendButton.enable();}}else{node.sendButton.disable();}});node.container.delegate('.downloadLink','click',function(event){dom.add($(this),'dLink');if(node.dLink.getHref()==='#'){event.preventDefault();$.ajax({url:apiUrl+'uploaded_document',type:'POST',data:$.param({claim:node.dLink.data('claim'),document:node.dLink.data('document')}),cache:false,dataType:'json',success:function(result){if(!checkAuth(result)){return false;}
var response=result;if(response&&response.link){node.dLink.setHref(response.link);node.dLink[0].click();}},error:function(response){if(response.query){console.log(response.query);}
$.notify({text:samo.i18n('MB_UPLOAD_ERROR'),type:'error'});}});}});}
function getPostData(file,el){var data=new FormData();$.each(file,function(key,value){data.append(key,value);});data.append('claim',el.data('claim'));data.append('payment',el.data('payment'));data.append('doctype',el.data('doctype'));return data;}
function updateRowAfterUpload(data,claim,el){var key=el.data('parent'),row=node[key].parent().parent();row.find('td.paymentStatusCell').html(samo.i18n(STATUS_WAIT));row.find('td.downloadBlankCell').html('');row.find('td.uploadCell').html(dom.create('a',{href:'#',download:true,className:'downloadLink',label:samo.i18n('MB_PREVIEW'),attr:'data-claim="'+claim+'" data-document="'+data.Inc+'"'}));el.parent().parent().remove();highlightRow(row);}
function createUploadForm(parentRow,key,data){data.parent=key;data.sendButtonLabel=samo.i18n('MSG_SEND_BUTTON');data.cancelButtonLabel=samo.i18n('MSG_CANCEL_BUTTON');var row=ejs.render(uploadTemplate,{upload:data});row=$(row);parentRow.after(row);highlightRow(row,true);return row;}
function setPayments(payments,prepend,newRow){if(payments.length||(payments[0]&&payments[0].inc)){node.paymentsTableLayout.show();$.each(payments,function(key,item){var data=getRowData(item);var row=ejs.render(rowTemplate,{payment:data});row=$(row);if(prepend){node.paymentsTable.prepend(row);}else{node.paymentsTable.append(row);}
if(newRow){highlightRow(row);}});}}
function highlightRow(row,_static){setTimeout(function(){row.addClass('highlight');if(!_static){setTimeout(function(){row.removeClass('highlight');},1500);}},1);}
function getRowData(item){var status=getStatus(item);var downloadBlank=dom.create('a',{href:'#',className:'downloadBlank',label:samo.i18n('MB_REQUEST'),attr:'data-payment-inc="'+item.inc+'"'});var upload=dom.create('a',{href:'#',className:'uploadLink',label:samo.i18n('MB_UPLOAD'),attr:'data-payment-inc="'+item.inc+'" '+'data-claim-from="'+item.claim_from+'" data-doctype="'+item.doctype+'"'});var download=dom.create('a',{href:'#',download:true,className:'downloadLink',label:samo.i18n('MB_PREVIEW'),attr:'data-claim="'+item.claim_from+'" data-document="'+item.external_document+'"'});item.status=samo.i18n(status);if(status===STATUS_NOT_UPLOAD){item.downloadBlankLink=downloadBlank[0].outerHTML;item.uploadLink=upload[0].outerHTML;}else{item.downloadBlankLink='';item.uploadLink=download[0].outerHTML;if(status!==STATUS_WAIT){item.status=samo.i18n(status);item.statusDate=item.status_date;if(status===STATUS_ABORT&&item.status_note){var note=dom.create('span',{className:'helpalt link',label:samo.i18n('MB_ABORT_NOTE_LABEL'),title:item.status_note});item.statusNote=note[0].outerHTML;}}}
return item;}
function getStatus(payment){if(!payment.doc_loaded){return STATUS_NOT_UPLOAD;}else{switch(payment.document_status){case 2:return STATUS_SUCCES;case 3:return STATUS_ABORT;default:return STATUS_WAIT;}}}
function setCurrencies(currencies){$.each(currencies,function(key,item){var option=dom.create('option',{label:item.name,value:item.id});node.currencySelect.append(option);});return currencies;}
function checkAuth(response){if(response){if(response.code===201){window.location.href=moduleUrl;return false;}
return true;}
return false;}
function sendForm(){node.prepareButton.disable();if(checkFields()){var params={claimFrom:node.claimFromField.val(),summ:node.summField.val(),name:node.nameField.val(),account:node.accountField.val(),bik:node.bikField.val(),cur:node.currencySelect.val()};$.ajax({url:apiUrl+'money_back',type:'POST',data:$.param(params),cache:false,dataType:'json',success:function(result){var response=result;if(!checkAuth(result)){return false;}
if(response.error){if(response.query){console.log(response.query);}
$.notify({text:response.error,type:'error'});node.prepareButton.enable();}else{var jobInc=response.job.inc;params.inc=response.payment.inc;params.summa=params.summ;params.claim_from=params.claimFrom;params.currency=currencies[params.cur];params.doctype=response.payment.doctype;params.recipient_name=params.name;setTimeout(function(){checkJobStatus(jobInc,node.resultForm,false,params)},1000);}},error:function(response){if(response){var msg=response.responseJSON;if(msg){if(response.query){console.log(msg.query);}
$.notify({text:msg.error,type:'error'});}}
node.prepareButton.enable();}});}else{node.prepareButton.enable();}}
function createProgressBar(container){var progressBarLayout=dom.create('progressbar');var progressBar=dom.create('span');dom.add(progressBarLayout,'progressBarLayout');dom.add(progressBar,'progressBar');progressBarLayout.append(progressBar);container.prepend(progressBarLayout);return true;}
function checkJobStatus(jobInc,container,progressBar,promise,downloadLabel,animate){if(!progressBar){createProgressBar(container);progressBar={node:node.progressBarLayout,bar:node.progressBar};progressBar.bar.setWidth('10%');}
progressBar.node.show();$.ajaxGet(apiUrl+'job_status?'+$.param({jobInc:jobInc}),function(result){if(!checkAuth(result)){return false;}
var response={jobStatus:0};if(result.responseJSON){response=result.responseJSON;}
delay*=1.3;progress=progressCalc(progress);progressBar.bar.setWidth(progress+'%');if(result.status!==200){if(response.error){if(response.query){console.log(response.query);}
$.notify({text:response.error,type:'error'});}
progressBar.node.hide();progressBar=false;node.prepareButton.enable();return false;}
if(response.jobStatus!==2){setTimeout(function(){checkJobStatus(jobInc,container,progressBar,promise,downloadLabel,animate);},delay);return false;}
progressBar.bar.setWidth('100%');progress=10;delay=1000;setTimeout(function(){node.prepareButton.enable();progressBar.node.hide();progressBar=false;if(promise){setPayments({0:promise},true,true);}
getDownloadLink(response.link,container,downloadLabel,animate);},delay);},null,true)}
function getDownloadLink(url,container,label,animate){if(!label){label=samo.i18n('CLICK_FOR_DOWNLOAD');}
var link=dom.create('a',{href:url,target:'_blank',download:true,label:label});container.html(link);if(animate){highlightRow(container.parent());}
link[0].click();}
function checkFields(){Validator.fields={claimFrom:new Field(node.claimFromField.validate()),summ:new Field(node.summField.validate()),name:new Field(node.nameField.validate()),account:new Field(node.accountField.validate()),bik:new Field(node.bikField.validate())};Validator.errors={claimFrom:'MB_CLAIM_FROM_ERROR',summ:'MB_SUMM_ERROR',name:'MB_NAME_ERROR',account:'MB_ACCOUNT_ERROR',bik:'MB_BIK_ERROR'};Validator.userForm=document.forms['money_back'];Validator.check();if(!Validator.result){for(var e in Validator.errorFields){$.notify({text:samo.i18n(Validator.errorFields[e]),type:'error'});}
return false;}
return true;}
function progressCalc(progress){if(progress<100){progress+=10;}else{progress=10;}
return progress;}};$(document).ready(samo.money_back);})(samo.jQuery);