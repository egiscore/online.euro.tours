
(function($){var container=samo.initModuleContainer('register_agency');samo.register_agency=function(){var _ROOT_URL=samo.ROUTES.register_agency.url,$module_container=container;var ownership_self_employed=(typeof samo.ownership_self_employed!='undefined')?samo.ownership_self_employed:1;$module_container.find('select.PARTNER_TOWN').bind('change',function(){var selected_town=this.value;var phoneprefix=$(this).find('option:selected').data('phonePrefix');$module_container.find('select.PARTNER_METROSTATION').prop('disabled',true).val(0).trigger('chosen:updated');if(selected_town>0){$module_container.find('input.PARTNER_PHONES_PREFIX').val(phoneprefix);$.getScript(_ROOT_URL+$.param({TOWN:selected_town,samo_action:'TOWN'}));}});if(samo.getInn.length>9&&samo.use_dadata){$.getScript(_ROOT_URL+'samo_action=getSuggest&query='+samo.getInn);}else{$module_container.find('select.PARTNER_TOWN').triggerHandler('change');}
samo.set_data_mask($module_container);samo.helpalt_field($module_container);samo.banklist_original={};samo.bank_filter=function(){var $filter=$.trim($module_container.find('input.PARTNER_BIK').val()).toLowerCase(),$strfilter=$filter.length,is_ok=true,$bank=$module_container.find('select.PARTNER_BANK').detach().empty().append('<option value="">---</option>').appendTo('.frm-bik-bank');$.each(samo.banklist_original,function(key,$value){var bik=''+$.trim($value.bik).toLowerCase(),selected='';if(!$strfilter||$filter==bik.substr(0,$strfilter)){selected=(bik==$filter)?'selected="selected"':'';$bank.append($('<option data-search-string=\''+$value.text+'\' data-bik="'+$value.bik+'" '+selected+'></option>').val($value.value).html($value.text));is_ok=false;}});$('.PARTNER_BANK',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}})})
$bank.trigger('chosen:updated');};var default_required=[$module_container.find('input[name*="[PARTNER_KPP]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]').hasClass('required'),$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]').hasClass('required')];$module_container.find('select.PARTNER_BANK option').each(function(key,bank){var $bank=$(bank);samo.banklist_original[key]={'text':$bank.text(),'value':$bank.val(),'bik':$bank.attr('data-bik')};}).end().find('select.PARTNER_OWNERSHIP').bind('change',function(){var val=$(this).val();var $kpp=$module_container.find('input[name*="[PARTNER_KPP]"]');var $registration_organ=$module_container.find('input[name*="[PARTNER_REGISTRATION_ORGAN]"]');var $registration_serie=$module_container.find('input[name*="[PARTNER_REGISTRATION_SERIE]"]');var $registration_number=$module_container.find('input[name*="[PARTNER_REGISTRATION_NUMBER]"]');if(val==ownership_self_employed){$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){el.parents('tr:first').find('label').removeClass('required');el.removeClass('required');});}else{$.each([$kpp,$registration_organ,$registration_serie,$registration_number],function(idx,el){if(default_required[idx]){el.parents('tr:first').find('label').addClass('required');el.addClass('required');}});}}).each(function(){$(this).triggerHandler('change');}).end().find('select.PARTNER_BANK').bind('change',function(){var selected=$(this).find('option:selected').attr('data-bik')||'';$module_container.find('input.PARTNER_BIK').val(selected);if(!selected){samo.bank_filter();}}).end().find('input.date').datePicker().end().find('input.PARTNER_OFFICIALNAME').bind('focus',function(){$(this).val($.trim($(this).val()));if($(this).val()==''){$(this).val($('option:selected',$('select.PARTNER_OWNERSHIP',$module_container)).text());}}).bind('blur',function(){var $name=$module_container.find('input.PARTNER_OFFICIALNAME'),val=$.trim($name.val()),is_ok=false;$module_container.find('select.PARTNER_OWNERSHIP option').each(function(){if(val==$(this).text()){is_ok=true;}
if(is_ok){$name.val('');}});}).end().find('input[type=text]').bind('keypress',samo.key_press_filter).end().find('input[name=save]').bind('click',function(e){e.stopPropagation();e.preventDefault();if(check_fields()){$.post(samo.ROOT_URL+$.param({samo_action:'SAVE'}),$module_container.pseudoForm(),null,'script');}}).end().find('select.PARTNER_METROSTATION').prop('disabled',true).end().find('input.PARTNER_BIK').bind('keyup',function(e){if(e.keyCode==27){$.event.trigger('clearSearch');e.stopPropagation();return;}
samo.bank_filter();}).bind('clearSearch',function(){this.value='';samo.bank_filter();});$('.PARTNER_TOWN,.PARTNER_BANK,.PARTNER_METROSTATION',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}})});$('.PARTNER_TOWN,.PARTNER_BANK',$module_container).chosen({enable_split_word_search:false,search_contains:true});var $metrostation=$module_container.find('.PARTNER_METROSTATION');if($metrostation.length>0){var options={placeholder_text_single:samo.i18n('SELECT_METRO')};if(!$metrostation.is('.required')){options.allow_single_deselect=true;}
$metrostation.chosen(options);}
$('.PARTNER_TAXATION,.PARTNER_OWNERSHIP,.PARTNER_DIRECTORPOSITION,.PARTNER_ACTIVITY',$module_container).chosen({disable_search:true});samo.renderMetroStation=function(){$('.PARTNER_METROSTATION option',$module_container).each(function(){var text=$(this).text();if(text){$(this).attr('data-search-string',(text+' '+text.fixKeyboardLayout()));}});};$('#recaptcha').bind('click',function(){var $cap=$('#icaptcha'),$src=$cap.attr('src').replace(/_=\d+/,'');$cap.attr('src',$src+'_='+Number(new Date())).bind('load',function(){$('#fcaptcha').val('');});});function check_fields(){var is_ok=true;samo.field.clear_errors($module_container);$module_container.find('.required').not('label, :disabled').each(function(){if(!$(this).val().length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}else{if($(this).val()==0&&$(this).hasClass('PARTNER_TOWN')){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}
if($(this).val()==0&&$(this).hasClass('PARTNER_OWNERSHIP')){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}
if($(this).hasClass('PARTNER_OFFICIALNAME')){var ownerShip=$module_container.find('.PARTNER_OWNERSHIP');if(ownerShip.val()==ownership_self_employed){if($(this).val().split(' ').length<3){is_ok=samo.field.error(samo.i18n('REQUIRED_FULL_FIO'),this);return false;}}}}});if(is_ok){$module_container.find('.date').each(function(){if(this.value.length&&!valid_date($.controlValue(this))){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
var el=$module_container.find('input.PARTNER_OFFICIALNAME');if(el.hasClass('required')){var val=$.trim(el.val());var ownership=$.trim($('select.PARTNER_OWNERSHIP option:selected',$module_container).text());if(val==ownership){el.errorField(samo.i18n('OFFICIALNAME_EMPTY'));return false;}}
return is_ok;}
function valid_date(value){value=parseInt(value);if(value>20600000||value<19010000){return false;}
return value;}
if(samo.use_dadata){samo.dadata($module_container,_ROOT_URL);}
samo.bank_filter();samo.googlemap($module_container);var innBlock=$(".innBlock");if(innBlock.length){var innField=innBlock.find(".INN");var registerAgencyByInnForm=$(".register_agency_by_inn_form");var stateInc=registerAgencyByInnForm.find(".STATEFROM");registerAgencyByInnForm.validationEngine({validationEventTrigger:'validate'});stateInc.chosen();stateInc.change(function(){if($(this).val()==samo.russiaStateInc){innField.val('');innBlock.show();}else{innField.val("-1");innBlock.hide();}});}};samo.dadata=function($module_container,_ROOT_URL){var innField=$module_container.find("[name*='PARTNER_INN']");innField.keyup(function(){if($(this).val().length>9){samo.delay(function(){$.getScript(_ROOT_URL+'samo_action=getSuggest&query='+innField.val());},1000);}});};samo.update_fields=function(data){data=JSON.parse(data);if(data['data-okved']&&data['data-okved'].value.length){var okvedParse=data['data-okved'].value.substring(0,2);okvedParse=(parseInt(okvedParse)===79);var tourismActivity=false,otherActivity=false;var activity=$("select.PARTNER_ACTIVITY");if(activity.length){activity.find('option').each(function(){if($(this).val()==1){tourismActivity=$(this);}
if($(this).val()==2){otherActivity=$(this);}});if(okvedParse&&tourismActivity){tourismActivity.prop('selected',true);activity.val(1);}else if(otherActivity){otherActivity.prop('selected',true);activity.val(2);}
activity.trigger('chosen:updated');}}
for(var key in data){var el="[name*='"+data[key].field+"']";if($(el).length){var fieldtype=($('input'+el).length)?'input':'select';if(fieldtype=='input'){if(data[key].field=="PARTNER_REGDATE"){if(data[key].value>0){var date=new Date(data[key].value);var day=(date.getDate()<10)?'0'+date.getDate():date.getDate();var month=((date.getMonth()+1)<10)?'0'+(date.getMonth()+1):(date.getMonth()+1);var dtf=day+'.'+month+'.'+date.getFullYear();$(el).datePicker({'value':dtf});}}else{$(el).val(data[key].value).trigger('change');}}else{if(data[key].field=="PARTNER_TOWN"&&data[key].value==''){$(el).prepend('<option value="0" id="option-empty-town">----</option>').val(0).trigger("chosen:updated");}else if(data[key].field=='PARTNER_OWNERSHIP'&&data[key].value==''){$(el).prepend('<option value="0" id="option-empty-ownership">----</option>').val(0).trigger("chosen:updated");}else{var findFlag=false;$(el+" option").each(function(){if($(this).text()==data[key].value){$(el).val($(this).val()).trigger("chosen:updated");findFlag=true;$(el).trigger('change');return false;}});if(!findFlag){if(data[key].field=="PARTNER_TOWN"){$(el).prepend('<option value="0" id="option-empty-town">----</option>').val(0).trigger("chosen:updated");}
if(data[key].field=="PARTNER_OWNERSHIP"){$(el).prepend('<option value="0" id="option-empty-ownership">----</option>').val(0).trigger("chosen:updated");}
if(data[key].field=="PARTNER_DIRECTORPOSITION"){$(el).prepend('<option value="0" id="option-empty-directorposition">----</option>').val(0).trigger("chosen:updated");}}}}}}};samo.save_partner_success=function(){$('.samo_container .Zebra_DatePicker').remove();};samo.formatINNNumber=function(){var input=document.getElementById('innf');input.value=input.value.replace(/[^\d,]/g,'');};$(document).ready(samo.register_agency);})(samo.jQuery);