
(function($){var container=samo.initModuleContainer('registration');samo.registration=function(){var _ROOT_URL=samo.ROUTES.registration.url,$module_container=container,DOLOAD=(parseInt($.getParameter('DOLOAD',true,$module_container))==1);var _controls=samo.cache_controls($module_container,'select,input');samo.set_data_mask($module_container);samo.helpalt_field($module_container);samo.AGENCY_FOUND=false;_controls.post_password=$('.post_password',$module_container)[0];_controls.password_prepare=$('.password_prepare',$module_container)[0];$('input[type=text]',$module_container).bind('keypress',samo.key_press_filter);$module_container.find('input.date').datePicker();$('.controls',$module_container).css('display','block');$('.load',$module_container).bind('click',function(){$(_controls.password_prepare).css('display','none');$(_controls.resultset).empty();if(validateFields()){$.getScript(getParams('SEARCH'),preparePassword);}});$('.FIRM_TOWN',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}})}).chosen({});$module_container.find('form').bind('submit',function(e){e.stopPropagation();e.preventDefault();if(check_fields_partpass()){$.post(this.action,$(this).serialize(),null,'script');}});function check_fields_partpass(){var is_ok=true;samo.field.clear_errors($('#login'));$('.required',$('#login',$module_container)).not('label').each(function(){if(!$(this).val().length){is_ok=samo.field.error(samo.i18n('REQUIRED_FIELD_EMPTY'),this);return false;}});if(is_ok){$('.date',$('#login',$module_container)).each(function(){if(this.value.length&&!valid_date($.controlValue(this))){is_ok=samo.field.error(samo.i18n('DATE_FORMAT_TITLE'),this);return false;}});}
return is_ok;}
function valid_date(value){value=parseInt(value);if(value>20600000||value<19010000){return false;}
return value;}
function getParams(action){var result={}
result.samo_action=action;$.each(_controls,function(i,v){var name=v.name||$(v).attr('name');var value=$.controlValue(v);if(name&&value&&value!=0)
result[name]=value;});return _ROOT_URL+$.param(result);}
function validateFields(){var $town=$(_controls.FIRM_TOWN);if($town.val()=="0"){$town.errorField(samo.i18n('NOT_SET_FIRM_TOWN'));return false;}
var is_ok=false;$('.FIRM_PHONE,.FIRM_NAME,.FIRM_EMAIL,.FIRM_NDOG,.FIRM_INN',$module_container).each(function(){if(this.value.length){is_ok=true;}});if(!is_ok){$.notify({text:samo.i18n('NOT_SET_AGENCY_INFO'),type:'error'});return false;}
return true;}
function preparePassword(){if(samo.AGENCY_FOUND==true){$('.password_prepare',$module_container).css('display','block');samo.AGENCY_FOUND=false;}else{$('.password_prepare',$module_container).css('display','none');}}
samo.postPassword=function(msg){$('.controls,.resultset,.password_prepare',$module_container).css('display','none');$(_controls.AGENCY_LOGIN).val('');$(_controls.post_password).ehtml(msg).css('display','block');};if(DOLOAD){$module_container.find('.load').triggerHandler('click');}};$(document).ready(samo.registration);})(samo.jQuery);