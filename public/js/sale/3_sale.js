
(function($){var container=samo.initModuleContainer('sale');samo.sale=function(){var _ROOT_URL=samo.ROUTES.sale.url,$module_container=container,DOLOAD=(parseInt($.getParameter('DOLOAD',true,$module_container))==1);var _controls=samo.cache_controls($module_container,'select,input');_controls.resultset=$('.resultset',$module_container)[0];$('.TOWNINC',$module_container).bind('change',function(){$('.METRO').find('option').remove();$.getScript(getParams('TOWNINC'),function(){if($('.METRO').find('option').length<2){$('.metroBlock').css('visibility','hidden');}else{$('.metroBlock').css('visibility','visible');}});});$('.METRO',$module_container).bind('change',function(){if(validateFields()){loadData(1);}});$('.resultset',$module_container).delegate('span.page','click',function(){loadData($(this).data('page'));});function loadData(page){$.getScript(getParams('SALELIST',page),true);}
samo.saleGoogleMap=function(partners){var agencyCoords=null,l=partners.length;var selectedTown=parseInt($(samo.controls.TOWNINC).val());var selectedMetro=parseInt($(samo.controls.METRO).val());var nearestTownFlag=false;$('.TOWNINC,.METRO',$module_container).each(function(){$(this).find('option').each(function(){if($(this).attr('data-search-string')){$(this).attr('data-search-string',$(this).attr('data-search-string')+' '+$(this).attr('data-search-string').fixKeyboardLayout());}})}).chosen({});$(samo.controls.TOWNINC).bind('change',function(){selectedTown=this.value;displayWithoutGeolocation();});$(samo.controls.METRO).bind('change',function(){selectedMetro=this.value;displayWithoutGeolocation();});if(navigator.geolocation&&location.protocol=='https:'&&$.getParameter('TOWNINC',1)==undefined){var timeoutVal=10*1000*1000;navigator.geolocation.getCurrentPosition(displayPosition,displayWithoutGeolocation,{enableHighAccuracy:true,timeout:timeoutVal,maximumAge:0});}else{displayWithoutGeolocation();}
function displayWithoutGeolocation(){if(nearestTownFlag){nearestTownFlag=false;return null;}
var partner=null;for(var i=0;i<l;i++){partner=partners[i];if(selectedTown>0&&selectedTown==partner.townKey){agencyCoords=partner;break;}else if(selectedMetro>0&&selectedMetro==partner.metrostationKey){agencyCoords=partner;break;}}
if(null===agencyCoords){agencyCoords=partners[0];}
displayPosition({coords:partner});}
function displayPosition(position){var map=new google.maps.Map(document.getElementById('map_canvas'),{zoom:12,center:new google.maps.LatLng(position.coords.latitude,position.coords.longitude),mapTypeId:google.maps.MapTypeId.ROADMAP});var center_changed_timer=null;google.maps.event.addListener(map,"center_changed",function(){if(center_changed_timer){clearTimeout(center_changed_timer);}
center_changed_timer=setTimeout(function(){var center=map.getCenter();var centerLatitude=center.lat(),centerLongitude=center.lng();if(map.zoom>=9&&map.zoom<=15){var min={lat:Math.abs(centerLatitude-partners[0].latitude),lng:Math.abs(centerLongitude-partners[0].longitude)};var nearestTown;var l=partners.length,partner=null,diffLatitude=null,diffLongitude=null;for(var i=1;i<l;i++){partner=partners[i];diffLatitude=Math.abs(centerLatitude-partner.latitude);diffLongitude=Math.abs(centerLongitude-partner.longitude)
if(diffLatitude<min.lat&&diffLongitude<min.lng){min={lat:diffLatitude,lng:diffLongitude};nearestTown=partner.townKey;}}
if(selectedTown!=nearestTown&&nearestTown>0){nearestTownFlag=true;$(samo.controls.TOWNINC).val(nearestTown).change();}}},2000);});var infowindow=new google.maps.InfoWindow();var marker,i;var markers=[];var cnt=partners.length,partner=null;for(i=0;i<cnt;i++){partner=partners[i];marker=new google.maps.Marker({position:new google.maps.LatLng(partner.latitude,partner.longitude)});markers.push(marker);var tpl=$('#partner-info-tpl').html();google.maps.event.addListener(marker,'click',(function(marker,i){return function(){var content=ejs.render(tpl,{partner:partners[i]});infowindow.setContent(content);infowindow.open(map,marker);}})(marker,i));}
new MarkerClusterer(map,markers,{imagePath:samo.ROUTES.WWWROOT+'public/pict/marker_clusterer/m'});}};function validateFields(){if(!$.controlValue('TOWNINC',false,$module_container)){$module_container.find('.TOWNINC').errorField(samo.i18n('NOT_SET_TOWNFROMINC'));return false;}
return true;}
function getParams(action){var useGET=arguments[1]||false;var result={};result.samo_action=action;result.PAGE=arguments[1]||1;$.each(_controls,function(i,v){var name=v.name||$(v).attr('name');var value=$.controlValue(v,useGET);if(name&&value&&value!==0)
result[name]=value;});return _ROOT_URL+$.param(result);}};$(document).ready(samo.sale());})(samo.jQuery);