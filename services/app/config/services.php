<?php
 use Phalcon\Mvc\View; use Phalcon\Mvc\View\Engine\Volt; use Phalcon\Mvc\View\Engine\Php as PhpEngine; use Phalcon\Mvc\Url as UrlResolver; use Samo\Session; use Phalcon\Mvc\Dispatcher as MvcDispatcher; use Phalcon\Events\Event; use Phalcon\Events\Manager as EventsManager; use Phalcon\Http\Request; use Samo\DB\DB; $di->set( 'dispatcher', function () { $eventsManager = new EventsManager(); $eventsManager->attach( 'dispatch:afterExecuteRoute', function (Event $event, $dispatcher) { } ); $eventsManager->attach('dispatch:beforeException', new NotFoundPlugin); $dispatcher = new MvcDispatcher(); $dispatcher->setEventsManager($eventsManager); return $dispatcher; }, true ); $di->setShared( 'config', function () { return include APP_PATH . "/config/config.php"; } ); $di->setShared( 'url', function () { $config = $this->getConfig(); $url = new UrlResolver(); $url->setBaseUri($config->application->baseUri); return $url; } ); $di->set( 'view', function () { $config = $this->getConfig(); $view = new View(); $view->setDI($this); $view->setViewsDir($config->application->viewsDir); $view->registerEngines( [ '.volt' => function ($view) { $config = $this->getConfig(); $volt = new Volt($view, $this); $volt->setOptions( [ 'compiledPath' => $config->application->cacheDir, 'compiledSeparator' => '_' ] ); $volt->getCompiler()->addFunction('substr', 'mb_substr'); $volt->getCompiler()->addFunction('date', 'date'); $volt->getCompiler()->addFunction('range', 'range'); $volt->getCompiler()->addFunction('strtotime', 'strtotime'); $volt->getCompiler()->addFunction( 'get_param', function ($name) { return '$this->request->get(' . $name . ')'; } ); return $volt; }, '.phtml' => PhpEngine::class ] ); return $view; } ); $di->setShared( 'db', function () { return new DB(); } ); $di->setShared( 'session', function () { $session = new Session(); $session->setName(SESSION_NAME); $request = new Request(); $sessid = $request->get('sessid') ?: $_COOKIE[SESSION_NAME]; $session->start(); $session->setId($sessid); $session->init(); return $session; } ); 