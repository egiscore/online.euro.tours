<?php
 namespace Samo\Logger; use Phalcon\Di; use Phalcon\DiInterface; use Phalcon\Http\Request; use Phalcon\Mvc\Dispatcher; use Samo\DB\DB; class Logger { protected $db; protected $dispatcher; protected $di; protected $request; public function __construct() { $this->di = Di::getDefault(); $this->dispatcher = $this->di->get('dispatcher'); $this->request = new Request(); $this->db = $this->di->get('db'); } public function updateOnlineStats($token) { if (php_sapi_name() == 'cli') { $controller = 'Cli'; } else { $controller = $this->dispatcher->getControllerName(); } $action = $this->dispatcher->getActiveMethod(); $ipAddress = $this->request->getClientAddress(); $params = [ 'module' => $controller, 'action' => $action, 'client' => ip2long($ipAddress), 'oauth_token' => $token ]; $query = $this->db->prepare('up_WEB_3_online_stats', $params, 'SLAVE'); $result = $this->db->resultCollection($query, 'online_stats'); $onlineStats = $result->findFirst(); if ($onlineStats && $onlineStats->result > 0) { return true; } return false; } } 